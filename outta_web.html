<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Outta Web - Find Businesses Without Websites</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Comic+Neue:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="manifest" href="/manifest.webmanifest">
    <meta name="theme-color" content="#007bff">
    <meta name="application-name" content="Outta Web">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="/logo.PNG">
    <link rel="apple-touch-icon" sizes="180x180" href="/logo.PNG">
    <link rel="apple-touch-icon" sizes="167x167" href="/logo.PNG">
    <link rel="apple-touch-icon" sizes="152x152" href="/logo.PNG">
    <link rel="apple-touch-icon" sizes="120x120" href="/logo.PNG">
    <link rel="icon" type="image/png" sizes="192x192" href="/logo.PNG">
    <link rel="icon" type="image/png" sizes="512x512" href="/logo.PNG">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Outta Web">
    <meta name="msapplication-TileColor" content="#007bff">
    <meta name="format-detection" content="telephone=no">

    <!-- Supabase Integration -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/api/config"></script>
    <script>
        function initSupabase() {
            try {
                const urlRaw = (window.__ENV__ && window.__ENV__.SUPABASE_URL) || window.NEXT_PUBLIC_SUPABASE_URL || null;
                const url = urlRaw ? urlRaw.replace(/\/+$/, '') : null; // trim trailing slashes
                const anonKey = (window.__ENV__ && window.__ENV__.SUPABASE_ANON_KEY) || window.NEXT_PUBLIC_SUPABASE_ANON_KEY || null;
                if (url && anonKey && window.supabase && window.supabase.createClient) {
                    window.SUPABASE = window.supabase.createClient(url, anonKey);
                    console.log('✅ Supabase initialized');
                } else {
                    console.log('ℹ️ Supabase config missing or library not loaded');
                }
            } catch (e) {
                console.log('ℹ️ Supabase init skipped:', e.message);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initSupabase();
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').then((reg) => {
                    console.log('✅ Service worker registered');
                    if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });
                }).catch(err => console.log('SW registration failed', err));
            }
        });

        // Add to Home Screen (A2HS) support
        let deferredPrompt = null;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const btn = document.getElementById('installAppBtn');
            if (btn) btn.style.display = 'inline-block';
        });

        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('installAppBtn');
            if (!btn) return;
            btn.addEventListener('click', async () => {
                if (!deferredPrompt) {
                    alert('Install is not available right now. On iPhone, use Share → Add to Home Screen.');
                    return;
                }
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log('A2HS outcome:', outcome);
                deferredPrompt = null;
                btn.style.display = 'none';
            });
        });
    </script>
    <style>
        /* Login Modal Styles */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .login-modal {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .login-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        .login-logo img {
            width: 60px;
            height: 60px;
            object-fit: contain;
        }

        .login-logo .logo-text {
            font-family: 'Fredoka One', cursive;
            font-size: 28px;
            color: #333;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #007bff;
        }

        .login-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .login-btn:hover {
            background: #0056b3;
        }

        .register-link {
            margin-top: 20px;
            color: #6c757d;
        }

        .register-link a {
            color: #007bff;
            text-decoration: none;
            font-weight: 600;
        }

        .register-link a:hover {
            text-decoration: underline;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #333;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: #007bff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .hidden {
            display: none !important;
        }


        body {
            font-family: 'Comic Neue', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 30px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 28px;
            font-weight: bold;
            font-family: 'Fredoka One', cursive;
            color: #333;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .logo-image {
            width: 80px;
            height: 80px;
            object-fit: contain;
            border-radius: 10px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.15);
        }

        .logo-text {
            font-family: 'Fredoka One', cursive;
            font-size: 36px;
            color: #333;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .nav {
            display: flex;
            gap: 20px;
        }

        .nav a {
            text-decoration: none;
            color: #6c757d;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .nav a:hover {
            background-color: #e9ecef;
            color: #495057;
        }

        .nav a.active {
            background-color: #007bff;
            color: white;
        }

        .main-title {
            text-align: center;
            font-size: 42px;
            font-weight: 700;
            font-family: 'Fredoka One', cursive;
            color: #333;
            margin-bottom: 40px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .search-form {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input {
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #007bff;
        }

        .search-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            width: 100%;
        }

        .search-btn:hover {
            background: #0056b3;
        }

        .niche-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .niche-chip,
        .location-chip {
            background: #e9ecef;
            color: #495057;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .niche-chip:hover,
        .location-chip:hover {
            background: #dee2e6;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .results-table th {
            background: #f8f9fa;
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
        }

        .results-table td {
            padding: 16px;
            border-bottom: 1px solid #e9ecef;
        }

        .results-table tr:hover {
            background: #f8f9fa;
        }

        .business-name {
            font-family: 'Fredoka One', cursive;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        .contact-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .contact-sms {
            background: #28a745;
            color: white;
        }

        .contact-email {
            background: #17a2b8;
            color: white;
        }

        .export-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-size: 18px;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 16px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 16px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            color: #6c757d;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab.active {
            color: #007bff;
            border-bottom-color: #007bff;
        }

        .tab:hover {
            color: #495057;
        }

        .history-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .history-date {
            font-weight: 600;
            color: #495057;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .history-details {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .history-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .clear-all-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .api-key-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .api-key-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .api-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .status-message {
            padding: 12px 16px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: 500;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .niche-selection-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        .niche-selection-section h4 {
            margin: 0 0 20px 0;
            color: #495057;
            font-size: 18px;
        }

        .niche-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .niche-category {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .niche-category h5 {
            margin: 0 0 10px 0;
            color: #007bff;
            font-size: 14px;
            font-weight: 600;
        }

        .niche-category .niche-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .niche-category .niche-chip {
            background: #e9ecef;
            color: #495057;
            border: none;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .niche-category .niche-chip:hover {
            background: #007bff;
            color: white;
        }

        .niche-suggestions {
            margin-top: 10px;
        }

        #selectedNiches .niche-chip {
            background: #007bff;
            color: white;
        }

        #selectedNiches .niche-chip:hover {
            background: #0056b3;
        }

        .search-options {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-size: 14px;
            color: #495057;
        }

        .checkbox-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .checkbox-option span {
            user-select: none;
        }

        .search-settings {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .search-settings h4 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 16px;
            font-weight: 600;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .settings-grid .form-group {
            margin: 0;
        }

        .settings-grid input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .settings-grid input[type="number"]:focus {
            outline: none;
            border-color: #007bff;
        }

        .best-niches-section {
            background: linear-gradient(135deg, #fff5f5, #fff);
            border: 2px solid #ff6b6b;
            border-radius: 12px;
            margin-top: 30px;
        }

        .best-niches-section h4 {
            color: #d63031;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .best-niches-section p {
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.5;
        }

        .best-niches-section .niche-category h5 {
            color: #d63031;
            font-weight: 600;
        }

        .best-niches-section .niche-chip:hover {
            background: #ff6b6b;
            color: white;
        }

        /* Bulk Location Modal Styles */
        #bulkLocationOverlay .login-modal {
            max-width: 600px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        #bulkLocationOverlay .login-modal>* {
            flex-shrink: 0;
        }

        #bulkLocationOverlay .login-modal .form-group {
            flex-shrink: 0;
        }

        #bulkLocationInput {
            font-family: inherit;
            resize: vertical;
            min-height: 120px;
        }

        .bulk-location-preview {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
        }

        .bulk-location-preview h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #495057;
        }

        .bulk-location-preview .location-chip {
            margin: 2px;
            font-size: 12px;
            padding: 4px 8px;
        }

        /* Enhanced button styles for bulk location modal */
        #bulkLocationOverlay .login-btn {
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #bulkLocationOverlay .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        /* Location count indicator */
        #bulkLocationCount {
            font-weight: bold;
            color: #007bff;
        }

        /* Many locations warning */
        .many-locations-warning {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ffeaa7;
            margin-top: 10px;
            font-size: 14px;
            display: none;
        }

        /* Animation for Instagram results indicator */
        @keyframes pulse {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.7;
                transform: scale(1.1);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes bounce {
            0% {
                transform: translateY(0px) scale(1);
            }

            30% {
                transform: translateY(-10px) scale(1.05);
            }

            50% {
                transform: translateY(0px) scale(1);
            }

            70% {
                transform: translateY(-5px) scale(1.02);
            }

            100% {
                transform: translateY(0px) scale(1);
            }
        }
    </style>
</head>

<body>
    <!-- Login Modal -->
    <div id="loginOverlay" class="login-overlay" style="display: none;">
        <div class="login-modal">
            <div class="login-logo">
                <img src="outtaweblogo.PNG" alt="Outta Web Logo">
                <span class="logo-text">OUTTA WEB</span>
            </div>
            <h2>Welcome to Business Finder</h2>
            <p style="color: #6c757d; margin-bottom: 30px;">Find businesses without websites for your outreach campaigns
            </p>

            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" required placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required placeholder="Enter your password">
                </div>
                <button type="submit" class="login-btn">Login</button>
            </form>

            <div class="register-link">
                Don't have an account? <a href="#" onclick="showRegisterForm()">Register here</a>
            </div>
            <div class="register-link">
                <a href="#" onclick="showResetForm()">Forgot Password?</a>
            </div>

            <!-- Debug Buttons -->
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e9ecef;">
                <button type="button" onclick="forceLogin()"
                    style="background: #6f42c1; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-bottom: 10px; cursor: pointer; width: 100%;">
                    💜 Force Login (Guaranteed)
                </button>
                <button type="button" onclick="testAllEndpoints()"
                    style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-bottom: 10px; cursor: pointer; width: 100%;">
                    🧪 Test All Endpoints
                </button>
                <button type="button" onclick="debugAuthState()"
                    style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; width: 100%;">
                    🔍 Debug Auth State
                </button>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="registerOverlay" class="login-overlay hidden">
        <div class="login-modal">
            <div class="login-logo">
                <img src="outtaweblogo.PNG" alt="Outta Web Logo">
                <span class="logo-text">OUTTA WEB</span>
            </div>
            <h2>Create Account</h2>
            <p style="color: #6c757d; margin-bottom: 30px;">Join Business Finder to start finding leads</p>

            <form id="registerForm" class="login-form">
                <div class="form-group">
                    <label for="registerName">Full Name</label>
                    <input type="text" id="registerName" required placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email</label>
                    <input type="email" id="registerEmail" required placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" required placeholder="Create a password">
                </div>
                <div class="form-group">
                    <label for="registerConfirmPassword">Confirm Password</label>
                    <input type="password" id="registerConfirmPassword" required placeholder="Confirm your password">
                </div>
                <button type="submit" class="login-btn">Register</button>
            </form>

            <div class="register-link">
                Already have an account? <a href="#" onclick="showLoginForm()">Login here</a>
            </div>
        </div>
    </div>

    <!-- Verify Modal -->
    <div id="verifyOverlay" class="login-overlay hidden">
        <div class="login-modal">
            <div class="login-logo">
                <img src="outtaweblogo.PNG" alt="Outta Web Logo">
                <span class="logo-text">OUTTA WEB</span>
            </div>
            <h2>Email Verification</h2>
            <p style="color: #6c757d; margin-bottom: 20px;">Enter the verification code below:</p>
            <div id="verificationCodeDisplay"
                style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-size: 24px; font-weight: bold; color: #007bff; border: 2px dashed #007bff;">
                <span id="verificationCodeText">------</span>
            </div>
            <form id="verifyForm" class="login-form">
                <div class="form-group">
                    <label for="verifyCode">Verification Code</label>
                    <input type="text" id="verifyCode" required placeholder="Enter code">
                </div>
                <button type="submit" class="login-btn">Verify</button>
            </form>
            <div class="register-link">
                Didn't get a code? <a href="#" onclick="resendVerificationCode()">Resend</a>
            </div>
        </div>
    </div>

    <!-- Reset Modal -->
    <div id="resetOverlay" class="login-overlay hidden">
        <div class="login-modal">
            <div class="login-logo">
                <img src="outtaweblogo.PNG" alt="Outta Web Logo">
                <span class="logo-text">OUTTA WEB</span>
            </div>
            <h2>Reset Password</h2>
            <form id="resetRequestForm" class="login-form">
                <div class="form-group">
                    <label for="resetEmail">Email</label>
                    <input type="email" id="resetEmail" required placeholder="Enter your email">
                </div>
                <button type="submit" class="login-btn">Get Reset Code</button>
            </form>
            <form id="resetForm" class="login-form hidden">
                <div id="resetCodeDisplay"
                    style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-size: 24px; font-weight: bold; color: #007bff; border: 2px dashed #007bff;">
                    <span id="resetCodeText">------</span>
                </div>
                <div class="form-group">
                    <label for="resetCode">Reset Code</label>
                    <input type="text" id="resetCode" required placeholder="Enter code">
                </div>
                <div class="form-group">
                    <label for="newPassword">New Password</label>
                    <input type="password" id="newPassword" required placeholder="New password">
                </div>
                <div class="form-group">
                    <label for="confirmNewPassword">Confirm New Password</label>
                    <input type="password" id="confirmNewPassword" required placeholder="Confirm new password">
                </div>
                <button type="submit" class="login-btn">Reset Password</button>
            </form>
            <div class="register-link">
                <a href="#" onclick="showLoginForm()">Back to Login</a>
            </div>
        </div>
    </div>

    <!-- Bulk Location Modal -->
    <div id="bulkLocationOverlay" class="login-overlay hidden">
        <div class="login-modal" style="max-width: 600px; width: 95%;">
            <div class="login-logo">
                <img src="outtaweblogo.PNG" alt="Outta Web Logo">
                <span class="logo-text">OUTTA WEB</span>
            </div>
            <h2>Bulk Location Entry</h2>
            <p style="color: #6c757d; margin-bottom: 20px;">Enter multiple locations separated by commas, new lines, or
                semicolons. The system will automatically detect city and state.</p>

            <div class="form-group">
                <label for="bulkLocationInput">Locations</label>
                <textarea id="bulkLocationInput" rows="8" placeholder="Example:
Los Angeles, CA
Santa Ana, CA
Houston, TX
Miami, FL
New York, NY

Or: Los Angeles, CA, Santa Ana, CA, Houston, TX, Miami, FL, New York, NY

Supports: City, State (Los Angeles, CA)
City State (Los Angeles CA)
State names (California)
State abbreviations (CA)"
                    style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
                <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">
                    <span id="bulkLocationCount">0</span> locations detected
                </div>
                <div id="manyLocationsWarning" class="many-locations-warning">
                    ⚠️ You have many locations selected. Use the floating button (↓) or scroll down to see the
                    Add/Cancel buttons.
                </div>
            </div>

            <div class="form-group">
                <label>Quick Add Options</label>
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                    <button type="button" class="btn btn-primary" onclick="addPopularCities()"
                        style="font-size: 12px; padding: 6px 12px;">Popular Cities</button>
                    <button type="button" class="btn btn-primary" onclick="addCaliforniaCities()"
                        style="font-size: 12px; padding: 6px 12px;">California</button>
                    <button type="button" class="btn btn-primary" onclick="addTexasCities()"
                        style="font-size: 12px; padding: 6px 12px;">Texas</button>
                    <button type="button" class="btn btn-primary" onclick="addFloridaCities()"
                        style="font-size: 12px; padding: 6px 12px;">Florida</button>
                    <button type="button" class="btn btn-primary" onclick="addNewYorkCities()"
                        style="font-size: 12px; padding: 6px 12px;">New York</button>
                    <button type="button" class="btn btn-primary" onclick="clearBulkInput()"
                        style="font-size: 12px; padding: 6px 12px; background: #dc3545;">Clear</button>
                </div>
            </div>

            <div id="bulkLocationPreview"
                style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; max-height: 150px; overflow-y: auto; display: none;">
                <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #495057;">Preview (will be added):</h4>
                <div id="bulkLocationPreviewList" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
            </div>

            <!-- Floating Action Button for many locations -->
            <div id="floatingActionButton"
                style="position: fixed; bottom: 20px; right: 20px; display: none; z-index: 1001;">
                <button type="button" onclick="scrollToBottom()"
                    style="background: #007bff; color: white; border: none; border-radius: 50%; width: 60px; height: 60px; font-size: 24px; box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4); cursor: pointer; transition: all 0.3s;">
                    ↓
                </button>
            </div>

            <div
                style="display: flex; gap: 10px; margin-top: 20px; position: sticky; bottom: 0; background: white; padding: 15px 0; border-top: 2px solid #e9ecef; z-index: 10;">
                <button type="button" class="login-btn" onclick="processBulkLocations()"
                    style="flex: 1; font-size: 16px; font-weight: 700; padding: 15px 20px; background: #28a745; border: 2px solid #28a745; box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);">✅
                    Add Locations</button>
                <button type="button" class="login-btn" onclick="closeBulkLocationModal()"
                    style="flex: 1; font-size: 16px; font-weight: 700; padding: 15px 20px; background: #dc3545; border: 2px solid #dc3545; box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);">❌
                    Cancel</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="logo">
                <img src="outtaweblogo.PNG" alt="Outta Web Logo" class="logo-image">
                <span class="logo-text">OUTTA WEB</span>
            </div>
            <div class="nav">
                <a href="#home" onclick="switchTab('search'); return false;">Home</a>
                <a href="#docs" onclick="switchTab('history'); return false;">Docs</a>
                <a href="#api" onclick="switchTab('api'); return false;">API Key</a>
                <button onclick="showDataMigrationModal()" class="btn"
                    style="background:#ff6b35; color:white; margin-right: 10px;" title="Fix PWA data sync issues">📱
                    Data Migration</button>
                <button id="installAppBtn" class="btn" style="display:none; background:#0d6efd; color:white;">Install
                    App</button>
            </div>
            <div id="userInfo" class="user-info hidden">
                <div class="user-avatar" id="userAvatar">U</div>
                <span id="userName">User</span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <h1 class="main-title">Find Businesses Without Websites</h1>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('search')">Search</div>
            <div class="tab" onclick="switchTab('history')">History</div>
            <div class="tab" onclick="switchTab('contacts')">Contact Finder</div>
            <div class="tab" onclick="switchTab('instagram-search')">Instagram Search</div>
            <div class="tab" onclick="switchTab('instagram')">Instagram</div>
            <div class="tab" onclick="switchTab('api')">API Key</div>
        </div>

        <div id="search-tab" class="tab-content active">
            <div class="search-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="location">Location(s)</label>
                        <div style="display: flex; gap: 10px; align-items: flex-start;">
                            <div style="flex: 1;">
                                <input type="text" id="location"
                                    placeholder="e.g. Los Angeles, CA, Santa Ana, CA (press comma to add multiple or use Bulk Add button)">
                                <div class="location-recommendations" id="locationRecommendations"></div>
                                <div id="locationList" class="niche-chips" style="margin-top: 0.5rem;"></div>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="addBulkLocations()"
                                style="white-space: nowrap; padding: 12px 16px; height: fit-content;">
                                Bulk Add
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="niche">Niche</label>
                        <input type="text" id="niche" placeholder="Type to search niches or select from below">
                        <div class="niche-suggestions" id="nicheSuggestions"></div>
                        <div id="selectedNiches" class="niche-chips" style="margin-top: 0.5rem;"></div>
                    </div>
                </div>

                <div class="search-options">
                    <label class="checkbox-option">
                        <input type="checkbox" id="preventDuplicates" checked>
                        <span>Prevent duplicate searches (use cached results from history)</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" id="stateWideSearch">
                        <span>State-wide search (automatically search all cities in state)</span>
                    </label>
                </div>

                <div class="search-settings">
                    <h4>Search Settings</h4>
                    <div class="settings-grid">
                        <div class="form-group">
                            <label for="minResults">Minimum Results per Search</label>
                            <input type="number" id="minResults" value="5" min="1" max="1000">
                        </div>
                        <div class="form-group">
                            <label for="maxResults">Maximum Results per Search</label>
                            <input type="number" id="maxResults" value="1000" min="5" max="1000">
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 12px;">
                        <label>Provider</label>
                        <div style="display:flex; gap:16px; align-items:center; flex-wrap:wrap; margin-top:6px;">
                            <label style="display:flex; align-items:center; gap:6px;">
                                <input type="radio" name="placesProvider" value="google" checked>
                                <span>Google Places</span>
                            </label>
                            <label style="display:flex; align-items:center; gap:6px;">
                                <input type="radio" name="placesProvider" value="foursquare">
                                <span>Foursquare Places</span>
                            </label>
                        </div>
                        <div style="font-size:12px; color:#6c757d; margin-top:6px;">Choose which data source to use for
                            searches.</div>
                    </div>
                </div>
                <div class="niche-selection-section">
                    <h4>Popular Niches (Click to Add)</h4>
                    <div class="niche-categories">
                        <div class="niche-category">
                            <h5>Personal Services</h5>
                            <div class="niche-chips">
                                <button class="niche-chip" onclick="addNicheFromSelection('barber shops')">Barber
                                    Shops</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('hair salons')">Hair
                                    Salons</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('nail salons')">Nail
                                    Salons</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('spas')">Spas</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('massage therapy')">Massage
                                    Therapy</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('tattoo shops')">Tattoo
                                    Shops</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('piercing studios')">Piercing
                                    Studios</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('tanning salons')">Tanning
                                    Salons</button>
                            </div>
                        </div>

                        <div class="niche-category">
                            <h5>Home Services</h5>
                            <div class="niche-chips">
                                <button class="niche-chip" onclick="addNicheFromSelection('plumbers')">Plumbers</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('electricians')">Electricians</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('HVAC contractors')">HVAC
                                    Contractors</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('roofers')">Roofers</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('painters')">Painters</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('landscapers')">Landscapers</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('cleaning services')">Cleaning
                                    Services</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('handyman services')">Handyman
                                    Services</button>
                            </div>
                        </div>

                        <div class="niche-category">
                            <h5>Automotive</h5>
                            <div class="niche-chips">
                                <button class="niche-chip" onclick="addNicheFromSelection('auto repair')">Auto
                                    Repair</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('car wash')">Car Wash</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('tire shops')">Tire
                                    Shops</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('auto detailing')">Auto
                                    Detailing</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('oil change')">Oil
                                    Change</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('brake repair')">Brake
                                    Repair</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('transmission repair')">Transmission Repair</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('auto body shops')">Auto Body
                                    Shops</button>
                            </div>
                        </div>

                        <div class="niche-category">
                            <h5>Professional Services</h5>
                            <div class="niche-chips">
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('interior designers')">Interior Designers</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('photographers')">Photographers</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('personal trainers')">Personal
                                    Trainers</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('tutors')">Tutors</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('accountants')">Accountants</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('lawyers')">Lawyers</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('real estate agents')">Real
                                    Estate Agents</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('consultants')">Consultants</button>
                            </div>
                        </div>

                        <div class="niche-category">
                            <h5>Food & Beverage</h5>
                            <div class="niche-chips">
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('restaurants')">Restaurants</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('food trucks')">Food
                                    Trucks</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('catering')">Catering</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('bakeries')">Bakeries</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('coffee shops')">Coffee
                                    Shops</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('pizza places')">Pizza
                                    Places</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('food delivery')">Food
                                    Delivery</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('meal prep')">Meal
                                    Prep</button>
                            </div>
                        </div>

                        <div class="niche-category">
                            <h5>Health & Wellness</h5>
                            <div class="niche-chips">
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('chiropractors')">Chiropractors</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('dentists')">Dentists</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('physical therapy')">Physical
                                    Therapy</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('yoga studios')">Yoga
                                    Studios</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('gyms')">Gyms</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('nutritionists')">Nutritionists</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('acupuncture')">Acupuncture</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('mental health')">Mental
                                    Health</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="niche-selection-section best-niches-section">
                    <h4>🎯 Best Niches to Reach Out To That Will Most Definitely Be the Owners If You Should Send an SMS
                    </h4>
                    <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                        These niches are typically owner-operated businesses where the owner is directly involved in
                        daily operations and likely to respond to SMS outreach.
                    </p>
                    <div class="niche-categories">
                        <div class="niche-category">
                            <h5>Owner-Operated Services</h5>
                            <div class="niche-chips">
                                <button class="niche-chip" onclick="addNicheFromSelection('barber shops')">Barber
                                    Shops</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('nail salons')">Nail
                                    Salons</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('tattoo shops')">Tattoo
                                    Shops</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('piercing studios')">Piercing
                                    Studios</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('massage therapy')">Massage
                                    Therapy</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('spas')">Spas</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('tanning salons')">Tanning
                                    Salons</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('hair salons')">Hair
                                    Salons</button>
                            </div>
                        </div>

                        <div class="niche-category">
                            <h5>Skilled Trades</h5>
                            <div class="niche-chips">
                                <button class="niche-chip" onclick="addNicheFromSelection('plumbers')">Plumbers</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('electricians')">Electricians</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('HVAC contractors')">HVAC
                                    Contractors</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('roofers')">Roofers</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('painters')">Painters</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('landscapers')">Landscapers</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('handyman services')">Handyman
                                    Services</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('cleaning services')">Cleaning
                                    Services</button>
                            </div>
                        </div>

                        <div class="niche-category">
                            <h5>Automotive Services</h5>
                            <div class="niche-chips">
                                <button class="niche-chip" onclick="addNicheFromSelection('auto repair')">Auto
                                    Repair</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('car wash')">Car Wash</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('tire shops')">Tire
                                    Shops</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('auto detailing')">Auto
                                    Detailing</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('oil change')">Oil
                                    Change</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('brake repair')">Brake
                                    Repair</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('transmission repair')">Transmission Repair</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('auto body shops')">Auto Body
                                    Shops</button>
                            </div>
                        </div>

                        <div class="niche-category">
                            <h5>Personal & Professional</h5>
                            <div class="niche-chips">
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('interior designers')">Interior Designers</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('photographers')">Photographers</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('personal trainers')">Personal
                                    Trainers</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('tutors')">Tutors</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('real estate agents')">Real
                                    Estate Agents</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('accountants')">Accountants</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('lawyers')">Lawyers</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('consultants')">Consultants</button>
                            </div>
                        </div>

                        <div class="niche-category">
                            <h5>Food & Beverage</h5>
                            <div class="niche-chips">
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('restaurants')">Restaurants</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('food trucks')">Food
                                    Trucks</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('catering')">Catering</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('bakeries')">Bakeries</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('coffee shops')">Coffee
                                    Shops</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('pizza places')">Pizza
                                    Places</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('food delivery')">Food
                                    Delivery</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('meal prep')">Meal
                                    Prep</button>
                            </div>
                        </div>

                        <div class="niche-category">
                            <h5>Health & Wellness</h5>
                            <div class="niche-chips">
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('chiropractors')">Chiropractors</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('dentists')">Dentists</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('physical therapy')">Physical
                                    Therapy</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('yoga studios')">Yoga
                                    Studios</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('gyms')">Gyms</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('nutritionists')">Nutritionists</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('acupuncture')">Acupuncture</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('mental health')">Mental
                                    Health</button>
                            </div>
                        </div>

                        <div class="niche-category">
                            <h5>Additional Owner-Operated</h5>
                            <div class="niche-chips">
                                <button class="niche-chip" onclick="addNicheFromSelection('pet groomers')">Pet
                                    Groomers</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('veterinarians')">Veterinarians</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('daycare centers')">Daycare
                                    Centers</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('tutoring centers')">Tutoring
                                    Centers</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('music lessons')">Music
                                    Lessons</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('dance studios')">Dance
                                    Studios</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('martial arts')">Martial
                                    Arts</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('swimming lessons')">Swimming
                                    Lessons</button>
                            </div>
                        </div>

                        <div class="niche-category">
                            <h5>Service Businesses</h5>
                            <div class="niche-chips">
                                <button class="niche-chip" onclick="addNicheFromSelection('dry cleaners')">Dry
                                    Cleaners</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('laundromats')">Laundromats</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('tailors')">Tailors</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('shoe repair')">Shoe
                                    Repair</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('jewelry repair')">Jewelry
                                    Repair</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('watch repair')">Watch
                                    Repair</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('key makers')">Key
                                    Makers</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('locksmiths')">Locksmiths</button>
                            </div>
                        </div>

                        <div class="niche-category">
                            <h5>Retail & Specialty</h5>
                            <div class="niche-chips">
                                <button class="niche-chip" onclick="addNicheFromSelection('florists')">Florists</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('gift shops')">Gift
                                    Shops</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('antique stores')">Antique
                                    Stores</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('thrift stores')">Thrift
                                    Stores</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('pawn shops')">Pawn
                                    Shops</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('bookstores')">Bookstores</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('libraries')">Libraries</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('art galleries')">Art
                                    Galleries</button>
                            </div>
                        </div>

                        <div class="niche-category">
                            <h5>Construction & Professional</h5>
                            <div class="niche-chips">
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('construction companies')">Construction
                                    Companies</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('contractors')">Contractors</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('architects')">Architects</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('engineers')">Engineers</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('surveyors')">Surveyors</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('inspectors')">Inspectors</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('appraisers')">Appraisers</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('notaries')">Notaries</button>
                            </div>
                        </div>
                    </div>
                </div>

                <button class="search-btn" onclick="findBusinesses()">Find Businesses</button>
            </div>

            <div id="searchResults"></div>
        </div>

        <div id="history-tab" class="tab-content">
            <h2>Search History</h2>
            <button class="clear-all-btn" onclick="clearAllHistory()">Clear All History</button>

            <div class="api-key-section" style="margin-top:16px">
                <h3>Import Exclusions (CSV)</h3>
                <p style="margin-bottom: 0.5rem; color: #666;">
                    Upload a CSV of leads you want to exclude from future results. Matching businesses will be filtered
                    out automatically.
                </p>
                <ul style="margin-top: 0; color: #6c757d; font-size: 14px;">
                    <li>Accepted columns (any combination): Name, Phone, Address, Email.</li>
                    <li>Matching uses Name+Phone when available; otherwise Name+Address.</li>
                </ul>
                <div style="display:flex; gap:10px; align-items:center; flex-wrap: wrap;">
                    <input id="exclusionsCsvInput" type="file" accept=".csv,text/csv" style="max-width: 320px;" />
                    <button class="btn btn-primary" id="importExclusionsBtn">Import CSV</button>
                    <button class="btn btn-danger" id="clearExclusionsBtn" title="Remove all imported exclusions">Clear
                        Imported Exclusions</button>
                </div>
                <div id="exclusionsStatus" class="status-message status-info" style="margin-top:10px; display:none;">
                </div>
                <div id="exclusionsSummary" style="margin-top:6px; font-size: 13px; color: #666;"></div>
            </div>

            <div id="searchHistory" style="margin-top:16px"></div>
        </div>

        <div id="instagram-search-tab" class="tab-content">
            <h2>📸 Instagram Contact Finder</h2>
            <p style="color: #666; margin-bottom: 20px;">Find Instagram business profiles using Google Custom Search API. Simply select a niche, enter a location, and discover potential leads with active Instagram presence.</p>

            <!-- API Configuration Section -->
            <div class="api-config-section" style="margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #007bff;">
                <h4 style="margin: 0 0 15px 0; color: #007bff;">🔑 API Configuration</h4>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label for="googleApiKey" style="font-weight: 600; color: #495057; display: block; margin-bottom: 5px;">Google Custom Search API Key</label>
                        <input type="password" id="googleApiKey" placeholder="Enter your Google Custom Search API key" 
                               style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 6px; font-family: monospace;">
                    </div>
                    <div>
                        <label for="searchEngineId" style="font-weight: 600; color: #495057; display: block; margin-bottom: 5px;">Search Engine ID (CX)</label>
                        <input type="password" id="searchEngineId" placeholder="Enter your Search Engine ID" 
                               style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 6px; font-family: monospace;">
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <button onclick="saveInstagramSearchConfig()" style="background: #007bff; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer;">
                        💾 Save Configuration
                    </button>
                    <button onclick="testInstagramSearchConfig()" style="background: #28a745; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer;">
                        🧪 Test API
                    </button>
                    <div id="instagramSearchApiStatus" style="margin-left: 10px; font-weight: 600;">❓ Not configured</div>
                </div>
            </div>

            <!-- Search Form Section -->
            <div style="margin-bottom: 25px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <h4 style="margin: 0 0 20px 0; color: #333;">🔍 Search Parameters</h4>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 120px; gap: 15px; margin-bottom: 20px;">
                    <div>
                        <label for="instagramSearchNiche" style="font-weight: 600; color: #495057; display: block; margin-bottom: 5px;">Business Niche</label>
                        <select id="instagramSearchNiche" style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 6px;">
                            <option value="">Choose a niche...</option>
                        </select>
                    </div>
                    <div>
                        <label for="instagramSearchLocation" style="font-weight: 600; color: #495057; display: block; margin-bottom: 5px;">Location</label>
                        <div style="position: relative;">
                            <input type="text" id="instagramSearchLocation" placeholder="e.g., Houston, New York, Los Angeles" 
                                   style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 6px;"
                                   oninput="handleInstagramLocationInput(this.value)"
                                   onfocus="handleInstagramLocationInput(this.value)"
                                   onblur="setTimeout(() => hideInstagramLocationSuggestions(), 200)">
                            <div id="instagramLocationSuggestions" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: end;">
                        <button onclick="searchInstagramBusinesses()" id="instagramSearchButton" 
                                style="background: #007bff; color: white; border: none; padding: 12px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%;">
                            🚀 Search
                        </button>
                    </div>
                </div>
                
                <!-- WhatsApp Filter Options -->
                <div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #25D366;">
                    <h5 style="margin: 0 0 10px 0; color: #333; display: flex; align-items: center;"><span style="margin-right: 8px;">📱</span>WhatsApp Contact Detection</h5>
                    <label style="display: flex; align-items: center; cursor: pointer; font-weight: 500;">
                        <input type="checkbox" id="whatsappOnlyFilter" style="margin-right: 10px; transform: scale(1.2);">
                        <span>Only show profiles with WhatsApp contact info</span>
                    </label>
                    <p style="margin: 8px 0 0 0; font-size: 13px; color: #6c757d;">When enabled, only profiles containing WhatsApp numbers, wa.me links, or WhatsApp keywords will be shown.</p>
                </div>
            </div>

            <!-- Loading Section -->
            <div id="instagramSearchLoading" style="display: none; text-align: center; padding: 30px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                <div style="width: 30px; height: 30px; border: 3px solid #e9ecef; border-top: 3px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px;"></div>
                <h4 style="color: #007bff; margin: 0 0 8px 0;">🔍 Searching Instagram...</h4>
                <p style="color: #6c757d; margin: 0;">Finding Instagram profiles for "<span id="searchingNiche"></span>" in "<span id="searchingLocation"></span>"</p>
            </div>

            <!-- Results Section -->
            <div id="instagramSearchResults" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h4 style="margin: 0; color: #333;">📋 Instagram Profiles Found</h4>
                    <span id="resultsCounter" style="background: #007bff; color: white; padding: 4px 12px; border-radius: 20px; font-weight: 600;">0 results</span>
                </div>
                
                <div id="instagramProfilesList"></div>
            </div>

            <!-- Error Section -->
            <div id="instagramSearchError" style="display: none; padding: 20px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; margin-bottom: 20px;">
                <h5 style="color: #721c24; margin: 0 0 10px 0;">❌ Search Error</h5>
                <p id="instagramSearchErrorMessage" style="color: #721c24; margin: 0;"></p>
                <button onclick="retryInstagramSearch()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                    🔄 Retry Search
                </button>
            </div>

        <div id="instagram-tab" class="tab-content">
            <h2>Instagram Lead Finder</h2>
            <p style="color: #666; margin-bottom: 20px;">Upload any CSV file with business data. The app automatically
                detects columns for Business Name, Address, City, State, and Phone Number regardless of naming or order.
                Returns only official Instagram accounts.</p>

            <div class="api-key-section" style="margin-bottom: 20px;">
                <h3>Google Custom Search API Configuration</h3>
                <p style="margin-bottom: 1rem; color: #666;">
                    Instagram search requires Google Custom Search API credentials.
                </p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div>
                        <label>Google Search API Key</label>
                        <input type="password" id="googleSearchApiKey" class="api-key-input"
                            placeholder="Enter Google Custom Search API key">
                    </div>
                    <div>
                        <label>Search Engine ID</label>
                        <input type="text" id="searchEngineId" class="api-key-input"
                            placeholder="Enter Custom Search Engine ID">
                    </div>
                </div>
                <div class="api-actions">
                    <button class="btn btn-primary" onclick="saveInstagramApiKeys()">Save Keys</button>
                    <button class="btn btn-success" onclick="testInstagramApi()">Test API</button>
                    <button class="btn btn-danger" onclick="clearInstagramApiKeys()">Clear Keys</button>
                </div>
                <div id="instagramApiStatus"></div>
            </div>

            <div class="api-key-section">
                <h3>CSV Upload</h3>
                <p style="margin-bottom: 1rem; color: #666;">
                    Upload any CSV file - columns will be automatically detected. Looks for: Business Name (required),
                    Address, City, State, Phone Number. Column names can vary (e.g., "Company", "Store Name",
                    "Telephone", etc.)
                </p>

                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 16px;">
                    <input type="file" id="instagramCsvInput" accept=".csv" style="max-width: 320px;">
                    <button class="btn btn-primary" onclick="processInstagramCsv()">Process CSV</button>
                </div>

                <div style="margin-bottom: 16px;">
                    <label>Confidence Threshold (%)</label>
                    <input type="number" id="confidenceThreshold" min="40" max="100" value="60"
                        style="width: 80px; margin-left: 8px;">
                    <span style="margin-left: 8px; color: #666; font-size: 14px;">Minimum confidence for returning
                        Instagram accounts (40-100%). Higher = more strict.</span>
                </div>

                <div id="instagramProcessingStatus" style="display: none; margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="spinner"
                            style="width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite;">
                        </div>
                        <span>Processing: <span id="currentProgress">0</span> / <span id="totalProgress">0</span>
                            businesses</span>
                    </div>
                    <div style="margin-top: 8px;">
                        <div id="progressBar"
                            style="width: 100%; height: 8px; background: #f0f0f0; border-radius: 4px; overflow: hidden;">
                            <div id="progressFill"
                                style="height: 100%; background: #007bff; width: 0%; transition: width 0.3s ease;">
                            </div>
                        </div>
                    </div>
                    <div id="processingDetails" style="margin-top: 8px; font-size: 14px; color: #666;"></div>
                </div>

                <div id="instagramResults" style="margin-top: 20px;"></div>
            </div>
        </div>

        <div id="contacts-tab" class="tab-content">
            <h2>� Insstagram Contact Finder</h2>
            <p style="color: #666; margin-bottom: 20px;">Find Instagram business profiles for specific niches and
                locations using Google Custom Search API. Perfect for discovering potential leads who maintain active
                Instagram presence.</p>

            <!-- API Configuration Section -->
            <div class="api-config-section"
                style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #007bff;">
                <h4 style="margin: 0 0 15px 0; color: #007bff;">🔑 API Configuration</h4>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group">
                        <label for="instagramSearchApiKey" style="font-weight: 600; color: #495057;">Google Custom
                            Search API Key</label>
                        <input type="password" id="instagramSearchApiKey" class="form-control"
                            placeholder="Enter your Google Custom Search API key"
                            style="padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-family: monospace;">
                    </div>
                    <div class="form-group">
                        <label for="instagramSearchEngineId" style="font-weight: 600; color: #495057;">Search Engine
                            ID</label>
                        <input type="password" id="instagramSearchEngineId" class="form-control"
                            placeholder="Enter your Search Engine ID"
                            style="padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-family: monospace;">
                    </div>
                </div>

                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="btn btn-primary" onclick="saveInstagramApiKeys()" style="padding: 10px 20px;">
                        💾 Save Configuration
                    </button>
                    <button class="btn btn-success" onclick="testInstagramApiKeys()" style="padding: 10px 20px;">
                        🧪 Test Connection
                    </button>
                    <div id="instagramApiStatus" style="margin-left: 15px; font-weight: 600;">
                        <span class="status-indicator">❓ Not configured</span>
                    </div>
                </div>
            </div>

            <!-- Search Form Section -->
            <div class="search-form-section"
                style="margin-bottom: 30px; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h4 style="margin: 0 0 20px 0; color: #333;">🔍 Search Parameters</h4>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label for="instagramNiche" style="font-weight: 600; color: #495057;">Business Niche</label>
                        <input type="text" id="instagramNiche" class="form-control"
                            placeholder="e.g., barber, restaurant, gym, dentist"
                            style="padding: 12px; border: 2px solid #e9ecef; border-radius: 8px;">
                        <small style="color: #6c757d;">Enter the type of business you're looking for</small>
                    </div>
                    <div class="form-group">
                        <label for="instagramLocation" style="font-weight: 600; color: #495057;">Location</label>
                        <input type="text" id="instagramLocation" class="form-control"
                            placeholder="e.g., Houston, New York, Los Angeles"
                            style="padding: 12px; border: 2px solid #e9ecef; border-radius: 8px;">
                        <small style="color: #6c757d;">Enter city, state, or region</small>
                    </div>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div class="form-group" style="flex: 1; margin-right: 20px;">
                        <label for="instagramMaxResults" style="font-weight: 600; color: #495057;">Maximum
                            Results</label>
                        <select id="instagramMaxResults" class="form-control"
                            style="padding: 12px; border: 2px solid #e9ecef; border-radius: 8px;">
                            <option value="5">5 results</option>
                            <option value="10" selected>10 results</option>
                            <option value="15">15 results</option>
                            <option value="20">20 results</option>
                        </select>
                    </div>
                    <div style="text-align: center;">
                        <button class="btn btn-primary btn-lg" onclick="searchInstagramProfiles()"
                            id="instagramSearchBtn"
                            style="padding: 15px 30px; font-size: 16px; font-weight: bold; border-radius: 8px;">
                            🚀 Find Instagram Profiles
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading Section -->
            <div id="instagramLoading" class="loading-section"
                style="display: none; text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px; margin-bottom: 20px;">
                <div style="margin-bottom: 20px;">
                    <div class="spinner"
                        style="width: 40px; height: 40px; border: 4px solid #e9ecef; border-top: 4px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;">
                    </div>
                </div>
                <h4 style="color: #007bff; margin: 0 0 10px 0;">🔍 Searching Instagram...</h4>
                <p style="color: #6c757d; margin: 0;">Finding Instagram business profiles for "<span
                        id="searchNicheDisplay"></span>" in "<span id="searchLocationDisplay"></span>"</p>
            </div>

            <!-- Results Section -->
            <div id="instagramResults" class="results-section" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h4 style="margin: 0; color: #333;">📋 Search Results</h4>
                    <div class="export-buttons" style="display: flex; gap: 10px;">
                        <button class="btn btn-outline-primary" onclick="exportInstagramResults('json')"
                            id="exportJsonBtn" style="padding: 8px 16px;">
                            📄 Export JSON
                        </button>
                        <button class="btn btn-outline-success" onclick="exportInstagramResults('csv')"
                            id="exportCsvBtn" style="padding: 8px 16px;">
                            📊 Export CSV
                        </button>
                    </div>
                </div>

                <div id="instagramResultsList" class="results-list"></div>

                <div id="instagramResultsStats" class="results-stats"
                    style="margin-top: 20px; padding: 15px; background: #e9ecef; border-radius: 8px; text-align: center;">
                    <span style="font-weight: 600;">Found <span id="resultsCount">0</span> Instagram profiles</span>
                    <span style="margin-left: 20px; color: #6c757d;">Search completed at <span
                            id="searchTimestamp"></span></span>
                </div>
            </div>

            <!-- Error Section -->
            <div id="instagramError" class="error-section"
                style="display: none; padding: 20px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; margin-bottom: 20px;">
                <h5 style="color: #721c24; margin: 0 0 10px 0;">❌ Search Error</h5>
                <p id="instagramErrorMessage" style="color: #721c24; margin: 0;"></p>
                <button class="btn btn-outline-danger btn-sm" onclick="retryInstagramSearch()"
                    style="margin-top: 10px;">
                    🔄 Retry Search
                </button>
            </div>
        </div>

        <div id="api-tab" class="tab-content">
            <div class="api-key-section">
                <h3>Google Places API Configuration</h3>
                <p style="margin-bottom: 1rem; color: #666;">
                    Enter your Google Places API key to enable business search functionality.
                </p>
                <input type="password" id="apiKey" class="api-key-input" placeholder="Enter your Google Places API key">
                <div class="api-actions">
                    <button class="btn btn-primary" onclick="saveApiKey()">Save API Key</button>
                    <button class="btn btn-success" onclick="testApiKey()">Test API Key</button>
                    <button class="btn btn-danger" onclick="clearApiKey()">Clear API Key</button>
                </div>
                <div id="apiStatus"></div>
            </div>

            <div class="api-key-section" style="margin-top: 20px;">
                <h3>Foursquare Places API Configuration</h3>
                <p style="margin-bottom: 1rem; color: #666;">
                    Enter your Foursquare Places API key. Searches using the Foursquare provider will use this key.
                </p>
                <input type="password" id="fsqApiKey" class="api-key-input" placeholder="Enter your Foursquare API key">
                <div class="api-actions">
                    <button class="btn btn-primary" onclick="saveFsqApiKey()">Save FSQ Key</button>
                    <button class="btn btn-success" onclick="testFsqApiKey()">Test FSQ Key</button>
                    <button class="btn btn-danger" onclick="clearFsqApiKey()">Clear FSQ Key</button>
                </div>
                <div id="fsqApiStatus"></div>
            </div>
        </div>
    </div>

    <script>
        // User Authentication Variables - SIMPLIFIED VERSION
        let currentUser = null;
        let sessionId = null;

        // Simple hardcoded users for immediate testing
        const HARDCODED_USERS = [
            {
                id: 1,
                name: 'Admin User',
                email: 'admin@outtaweb.com',
                password: 'admin123',
                verified: true
            },
            {
                id: 2,
                name: 'Dante',
                email: 'dantedesignzofficial@gmail.com',
                password: 'yourpassword123',
                verified: true
            }
        ];

        // GLOBAL LOGIN STATE - This will persist during the session
        window.LOGIN_STATE = {
            isLoggedIn: false,
            currentUser: null,
            sessionId: null
        };

        // App Variables
        let apiKey = '';
        let fsqApiKey = '';
        let placesProvider = 'google';
        let searchHistory = [];

        // Instagram API Variables
        let googleSearchApiKey = '';
        let searchEngineId = '';

        // Load API key on page load
        document.addEventListener('DOMContentLoaded', function () {
            console.log('🚀 Page loaded, initializing app...');
            console.log('🌐 Current URL:', window.location.href);
            console.log('🌐 User Agent:', navigator.userAgent);

            try {
                // Standard auth check
                console.log('🔍 Starting authentication check...');
                checkAuthStatus();

                console.log('🔑 Loading API key...');
                loadApiKey();
                loadFsqApiKey();
                loadInstagramApiKeys();
                loadProviderSelection();

                console.log('📚 Loading search history...');
                loadSearchHistory();

                console.log('📊 Restoring Instagram results...');
                restoreSavedInstagramResults();

                // Initialize Supabase session handling (persist across restarts)
                if (window.SUPABASE && window.SUPABASE.auth) {
                    try {
                        // Subscribe to auth state changes
                        window.SUPABASE.auth.onAuthStateChange((event, session) => {
                            console.log('🔄 Supabase auth state change:', event);
                            if (session && session.user) {
                                const u = session.user;
                                currentUser = {
                                    id: u.id,
                                    name: u.user_metadata?.name || (u.email || 'User'),
                                    email: u.email,
                                    verified: !!u.email_confirmed_at
                                };
                                sessionId = session.access_token;
                                window.LOGIN_STATE.isLoggedIn = true;
                                window.LOGIN_STATE.currentUser = currentUser;
                                window.LOGIN_STATE.sessionId = sessionId;
                                try {
                                    localStorage.setItem('outtaWebSessionId', sessionId);
                                    localStorage.setItem('outtaWebCurrentUser', JSON.stringify(currentUser));
                                } catch { }
                                showApp();
                            }
                        });

                        // Load any existing session on page load
                        window.SUPABASE.auth.getSession().then(({ data: { session } }) => {
                            if (session && session.user && !window.LOGIN_STATE.isLoggedIn) {
                                const u = session.user;
                                currentUser = {
                                    id: u.id,
                                    name: u.user_metadata?.name || (u.email || 'User'),
                                    email: u.email,
                                    verified: !!u.email_confirmed_at
                                };
                                sessionId = session.access_token;
                                window.LOGIN_STATE.isLoggedIn = true;
                                window.LOGIN_STATE.currentUser = currentUser;
                                window.LOGIN_STATE.sessionId = sessionId;
                                try {
                                    localStorage.setItem('outtaWebSessionId', sessionId);
                                    localStorage.setItem('outtaWebCurrentUser', JSON.stringify(currentUser));
                                } catch { }
                                showApp();
                            }
                        });
                    } catch (e) {
                        console.log('ℹ️ Supabase session init skipped:', e.message);
                    }
                }

                console.log('✅ App initialization completed');

                // Check for potential PWA data sync issues after a short delay
                setTimeout(() => {
                    checkForPWADataIssues();
                }, 2000);

            } catch (error) {
                console.error('❌ Error during app initialization:', error);
                alert('⚠️ Error during app initialization. Check console for details.');
            }

            // Add event listeners
            document.getElementById('location').addEventListener('keydown', function (e) {
                if (e.key === ',') {
                    e.preventDefault();
                    addLocation();
                }
            });

            document.getElementById('location').addEventListener('input', function (e) {
                handleLocationInput(e.target.value);
            });

            document.getElementById('niche').addEventListener('input', function (e) {
                handleNicheInput(e.target.value);
            });

            // Add login form event listeners
            document.getElementById('loginForm').addEventListener('submit', function (e) {
                e.preventDefault();
                login();
            });

            document.getElementById('registerForm').addEventListener('submit', function (e) {
                e.preventDefault();
                register();
            });

            // Wire exclusions UI (if present)
            try { wireExclusionsUI(); } catch { }

            // Provider selection events
            try {
                document.querySelectorAll('input[name="placesProvider"]').forEach(r => {
                    r.addEventListener('change', () => {
                        placesProvider = r.value;
                        try { localStorage.setItem('placesProvider', placesProvider); } catch { }
                    });
                });
            } catch { }
        });

        function handleLocationInput(value) {
            if (value.length < 2) {
                document.getElementById('locationRecommendations').innerHTML = '';
                return;
            }

            const suggestions = getLocationSuggestions(value);
            displayLocationSuggestions(suggestions);
        }

        function getLocationSuggestions(query) {
            const allUSCities = [
                // Major Cities
                'New York, NY', 'Los Angeles, CA', 'Chicago, IL', 'Houston, TX', 'Phoenix, AZ',
                'Philadelphia, PA', 'San Antonio, TX', 'San Diego, CA', 'Dallas, TX', 'San Jose, CA',
                'Austin, TX', 'Jacksonville, FL', 'Fort Worth, TX', 'Columbus, OH', 'Charlotte, NC',
                'San Francisco, CA', 'Indianapolis, IN', 'Seattle, WA', 'Denver, CO', 'Washington, DC',
                'Boston, MA', 'El Paso, TX', 'Nashville, TN', 'Detroit, MI', 'Oklahoma City, OK',
                'Portland, OR', 'Las Vegas, NV', 'Memphis, TN', 'Louisville, KY', 'Baltimore, MD',
                'Milwaukee, WI', 'Albuquerque, NM', 'Tucson, AZ', 'Fresno, CA', 'Sacramento, CA',
                'Mesa, AZ', 'Kansas City, MO', 'Atlanta, GA', 'Long Beach, CA', 'Colorado Springs, CO',
                'Raleigh, NC', 'Miami, FL', 'Virginia Beach, VA', 'Omaha, NE', 'Oakland, CA',
                'Minneapolis, MN', 'Tulsa, OK', 'Arlington, TX', 'Tampa, FL', 'New Orleans, LA',
                'Wichita, KS', 'Cleveland, OH', 'Bakersfield, CA', 'Aurora, CO', 'Anaheim, CA',
                'Honolulu, HI', 'Santa Ana, CA', 'Corpus Christi, TX', 'Riverside, CA', 'Lexington, KY',
                'Stockton, CA', 'Henderson, NV', 'Saint Paul, MN', 'St. Louis, MO', 'Fort Wayne, IN',
                'Greensboro, NC', 'Anchorage, AK', 'Plano, TX', 'Lincoln, NE', 'Orlando, FL',
                'Irvine, CA', 'Newark, NJ', 'Durham, NC', 'Chula Vista, CA', 'Toledo, OH',
                'Fort Lauderdale, FL', 'Laredo, TX', 'Chandler, AZ', 'Madison, WI', 'Lubbock, TX',
                'Scottsdale, AZ', 'Reno, NV', 'Glendale, AZ', 'Gilbert, AZ', 'Winston-Salem, NC',
                'North Las Vegas, NV', 'Norfolk, VA', 'Chesapeake, VA', 'Garland, TX', 'Irving, TX',
                'Hialeah, FL', 'Fremont, CA', 'Boise, ID', 'Richmond, VA', 'Baton Rouge, LA',
                'Spokane, WA', 'Birmingham, AL', 'Montgomery, AL', 'Mobile, AL', 'Huntsville, AL',
                'Tuscaloosa, AL', 'Auburn, AL', 'Dothan, AL', 'Decatur, AL', 'Madison, AL',
                'Florence, AL', 'Gadsden, AL', 'Vestavia Hills, AL', 'Phoenix, AZ', 'Tucson, AZ',
                'Mesa, AZ', 'Chandler, AZ', 'Scottsdale, AZ', 'Glendale, AZ', 'Gilbert, AZ',
                'Tempe, AZ', 'Peoria, AZ', 'Surprise, AZ', 'Yuma, AZ', 'Avondale, AZ',
                'Goodyear, AZ', 'Flagstaff, AZ', 'Buckeye, AZ', 'Casa Grande, AZ', 'Lake Havasu City, AZ',
                'Maricopa, AZ', 'Oro Valley, AZ', 'Sierra Vista, AZ', 'Prescott Valley, AZ',
                'Little Rock, AR', 'Fort Smith, AR', 'Fayetteville, AR', 'Springdale, AR',
                'Jonesboro, AR', 'North Little Rock, AR', 'Conway, AR', 'Rogers, AR',
                'Pine Bluff, AR', 'Bentonville, AR', 'Hot Springs, AR', 'Texarkana, AR',
                'Jacksonville, AR', 'Russellville, AR', 'El Dorado, AR', 'West Memphis, AR',
                'Los Angeles, CA', 'San Diego, CA', 'San Jose, CA', 'San Francisco, CA',
                'Fresno, CA', 'Sacramento, CA', 'Long Beach, CA', 'Oakland, CA', 'Bakersfield, CA',
                'Anaheim, CA', 'Santa Ana, CA', 'Riverside, CA', 'Stockton, CA', 'Irvine, CA',
                'Fremont, CA', 'Chula Vista, CA', 'Glendale, CA', 'Modesto, CA', 'San Bernardino, CA',
                'Fontana, CA', 'Oxnard, CA', 'Moreno Valley, CA', 'Huntington Beach, CA',
                'Glendale, CA', 'Santa Clarita, CA', 'Garden Grove, CA', 'Oceanside, CA',
                'Rancho Cucamonga, CA', 'Santa Rosa, CA', 'Ontario, CA', 'Lancaster, CA',
                'Elk Grove, CA', 'Corona, CA', 'Palmdale, CA', 'Salinas, CA', 'Pomona, CA',
                'Hayward, CA', 'Escondido, CA', 'Torrance, CA', 'Sunnyvale, CA', 'Orange, CA',
                'Fullerton, CA', 'Pasadena, CA', 'Thousand Oaks, CA', 'Visalia, CA', 'Simi Valley, CA',
                'Concord, CA', 'Roseville, CA', 'Clovis, CA', 'Fairfield, CA', 'Berkeley, CA',
                'Richmond, CA', 'Arden-Arcade, CA', 'Chico, CA', 'Daly City, CA', 'San Rafeal, CA',
                'San Mateo, CA', 'Tracy, CA', 'Yuba City, CA', 'San Leandro, CA', 'Livermore, CA',
                'Antioch, CA', 'Turlock, CA', 'Palm Springs, CA', 'Davis, CA', 'Redding, CA',
                'San Clemente, CA', 'Walnut Creek, CA', 'Pleasanton, CA', 'Mountain View, CA',
                'Lake Forest, CA', 'Merced, CA', 'Redwood City, CA', 'Folsom, CA', 'Newport Beach, CA',
                'San Ramon, CA', 'Manteca, CA', 'Union City, CA', 'Lodi, CA', 'Tracy, CA',
                'Denver, CO', 'Colorado Springs, CO', 'Aurora, CO', 'Fort Collins, CO',
                'Lakewood, CO', 'Thornton, CO', 'Arvada, CO', 'Westminster, CO', 'Pueblo, CO',
                'Boulder, CO', 'Greeley, CO', 'Longmont, CO', 'Loveland, CO', 'Grand Junction, CO',
                'Broomfield, CO', 'Castle Rock, CO', 'Commerce City, CO', 'Parker, CO',
                'Littleton, CO', 'Northglenn, CO', 'Englewood, CO', 'Wheat Ridge, CO',
                'New Haven, CT', 'Bridgeport, CT', 'Stamford, CT', 'Hartford, CT', 'Waterbury, CT',
                'Norwalk, CT', 'Danbury, CT', 'New Britain, CT', 'Bristol, CT', 'Meriden, CT',
                'West Haven, CT', 'Milford, CT', 'Stratford, CT', 'Greenwich, CT', 'Hamden, CT',
                'Fairfield, CT', 'Manchester, CT', 'Bristol, CT', 'Westport, CT', 'Trumbull, CT',
                'Wilmington, DE', 'Dover, DE', 'Newark, DE', 'Middletown, DE', 'Smyrna, DE',
                'Milford, DE', 'Seaford, DE', 'Georgetown, DE', 'Elsmere, DE', 'New Castle, DE',
                'Jacksonville, FL', 'Miami, FL', 'Tampa, FL', 'Orlando, FL', 'St. Petersburg, FL',
                'Hialeah, FL', 'Tallahassee, FL', 'Fort Lauderdale, FL', 'Port St. Lucie, FL',
                'Cape Coral, FL', 'Gainesville, FL', 'Coral Springs, FL', 'Clearwater, FL',
                'Miami Gardens, FL', 'Palm Bay, FL', 'West Palm Beach, FL', 'Sunrise, FL',
                'Lakeland, FL', 'Boca Raton, FL', 'Hollywood, FL', 'Pembroke Pines, FL',
                'Gainesville, FL', 'Miramar, FL', 'Kissimmee, FL', 'Palm Coast, FL',
                'Deltona, FL', 'Plantation, FL', 'Alafaya, FL', 'Lehigh Acres, FL',
                'Atlanta, GA', 'Augusta, GA', 'Columbus, GA', 'Macon, GA', 'Savannah, GA',
                'Athens, GA', 'Sandy Springs, GA', 'Roswell, GA', 'Albany, GA', 'Johns Creek, GA',
                'Warner Robins, GA', 'Alpharetta, GA', 'Marietta, GA', 'Valdosta, GA',
                'Smyrna, GA', 'Dunwoody, GA', 'Rome, GA', 'Gainesville, GA', 'East Point, GA',
                'Newnan, GA', 'Dalton, GA', 'Kennesaw, GA', 'Peachtree City, GA', 'Tucker, GA',
                'Honolulu, HI', 'Hilo, HI', 'Kailua, HI', 'Kapolei, HI', 'Kaneohe, HI',
                'Mililani Town, HI', 'Ewa Gentry, HI', 'Kihei, HI', 'Makakilo, HI', 'Wahiawa, HI',
                'Schofield Barracks, HI', 'Wailuku, HI', 'Pearl City, HI', 'Waipahu, HI',
                'Ewa Beach, HI', 'Hilo, HI', 'Kailua, HI', 'Waimalu, HI', 'Aiea, HI',
                'Boise, ID', 'Meridian, ID', 'Nampa, ID', 'Idaho Falls, ID', 'Pocatello, ID',
                'Caldwell, ID', 'Coeur d\'Alene, ID', 'Twin Falls, ID', 'Lewiston, ID',
                'Post Falls, ID', 'Rexburg, ID', 'Moscow, ID', 'Eagle, ID', 'Kuna, ID',
                'Ammon, ID', 'Chubbuck, ID', 'Hayden, ID', 'Mountain Home, ID', 'Blackfoot, ID',
                'Chicago, IL', 'Aurora, IL', 'Rockford, IL', 'Joliet, IL', 'Naperville, IL',
                'Springfield, IL', 'Peoria, IL', 'Elgin, IL', 'Waukegan, IL', 'Champaign, IL',
                'Bloomington, IL', 'Arlington Heights, IL', 'Evanston, IL', 'Decatur, IL',
                'Schaumburg, IL', 'Bolingbrook, IL', 'Palatine, IL', 'Skokie, IL', 'Des Plaines, IL',
                'Orland Park, IL', 'Tinley Park, IL', 'Oak Lawn, IL', 'Berwyn, IL', 'Mount Prospect, IL',
                'Normal, IL', 'Wheaton, IL', 'Hoffman Estates, IL', 'Oak Park, IL', 'Downers Grove, IL',
                'Elmhurst, IL', 'Glenview, IL', 'DeKalb, IL', 'Lombard, IL', 'Buffalo Grove, IL',
                'Indianapolis, IN', 'Fort Wayne, IN', 'Evansville, IN', 'South Bend, IN', 'Carmel, IN',
                'Fishers, IN', 'Bloomington, IN', 'Hammond, IN', 'Gary, IN', 'Lafayette, IN',
                'Muncie, IN', 'Terre Haute, IN', 'Kokomo, IN', 'Anderson, IN', 'Noblesville, IN',
                'Greenwood, IN', 'Elkhart, IN', 'Michigan City, IN', 'Lawrence, IN', 'Jeffersonville, IN',
                'Columbus, IN', 'Portage, IN', 'New Albany, IN', 'Mishawaka, IN', 'Greenfield, IN',
                'Des Moines, IA', 'Cedar Rapids, IA', 'Davenport, IA', 'Sioux City, IA', 'Iowa City, IA',
                'Waterloo, IA', 'Ames, IA', 'West Des Moines, IA', 'Council Bluffs, IA', 'Dubuque, IA',
                'Cedar Falls, IA', 'Mason City, IA', 'Marshalltown, IA', 'Clinton, IA', 'Burlington, IA',
                'Fort Dodge, IA', 'Ottumwa, IA', 'Sioux City, IA', 'Clinton, IA', 'Mason City, IA',
                'Wichita, KS', 'Overland Park, KS', 'Kansas City, KS', 'Olathe, KS', 'Topeka, KS',
                'Lawrence, KS', 'Shawnee, KS', 'Manhattan, KS', 'Lenexa, KS', 'Salina, KS',
                'Hutchinson, KS', 'Leavenworth, KS', 'Leawood, KS', 'Garden City, KS', 'Dodge City, KS',
                'Emporia, KS', 'Junction City, KS', 'Pittsburg, KS', 'Great Bend, KS', 'Hays, KS',
                'Louisville, KY', 'Lexington, KY', 'Bowling Green, KY', 'Owensboro, KY', 'Covington, KY',
                'Richmond, KY', 'Georgetown, KY', 'Florence, KY', 'Elizabethtown, KY', 'Nicholasville, KY',
                'Henderson, KY', 'Hopkinsville, KY', 'Winchester, KY', 'Murray, KY', 'Paducah, KY',
                'St. Matthews, KY', 'Frankfort, KY', 'Ashland, KY', 'Berea, KY', 'Somerset, KY',
                'New Orleans, LA', 'Baton Rouge, LA', 'Shreveport, LA', 'Lafayette, LA', 'Lake Charles, LA',
                'Kenner, LA', 'Bossier City, LA', 'Monroe, LA', 'Alexandria, LA', 'Houma, LA',
                'New Iberia, LA', 'Ruston, LA', 'Sulphur, LA', 'Hammond, LA', 'Natchitoches, LA',
                'Zachary, LA', 'Gonzales, LA', 'Thibodaux, LA', 'Minden, LA', 'Opelousas, LA',
                'Portland, ME', 'Lewiston, ME', 'Bangor, ME', 'Auburn, ME', 'Biddeford, ME',
                'Sanford, ME', 'Brunswick, ME', 'Augusta, ME', 'Scarborough, ME', 'Gorham, ME',
                'Westbrook, ME', 'Waterville, ME', 'Windham, ME', 'York, ME', 'Falmouth, ME',
                'Cape Elizabeth, ME', 'Bath, ME', 'Old Orchard Beach, ME', 'Kennebunk, ME',
                'Baltimore, MD', 'Frederick, MD', 'Rockville, MD', 'Gaithersburg, MD', 'Bowie, MD',
                'Hagerstown, MD', 'Annapolis, MD', 'College Park, MD', 'Salisbury, MD', 'Laurel, MD',
                'Greenbelt, MD', 'Cumberland, MD', 'Takoma Park, MD', 'Hyattsville, MD', 'Easton, MD',
                'Ocean City, MD', 'Cambridge, MD', 'Westminster, MD', 'Havre de Grace, MD', 'Frostburg, MD',
                'Boston, MA', 'Worcester, MA', 'Springfield, MA', 'Lowell, MA', 'Cambridge, MA',
                'New Bedford, MA', 'Brockton, MA', 'Quincy, MA', 'Lynn, MA', 'Fall River, MA',
                'Newton, MA', 'Lawrence, MA', 'Somerville, MA', 'Framingham, MA', 'Haverhill, MA',
                'Malden, MA', 'Waltham, MA', 'Brookline, MA', 'Plymouth, MA', 'Medford, MA',
                'Taunton, MA', 'Chicopee, MA', 'Weymouth, MA', 'Revere, MA', 'Peabody, MA',
                'Detroit, MI', 'Grand Rapids, MI', 'Warren, MI', 'Sterling Heights, MI', 'Lansing, MI',
                'Ann Arbor, MI', 'Flint, MI', 'Dearborn, MI', 'Livonia, MI', 'Westland, MI',
                'Troy, MI', 'Farmington Hills, MI', 'Kalamazoo, MI', 'Wyoming, MI', 'Rochester Hills, MI',
                'Southfield, MI', 'Taylor, MI', 'Pontiac, MI', 'St. Clair Shores, MI', 'Royal Oak, MI',
                'Dearborn Heights, MI', 'Novi, MI', 'Battle Creek, MI', 'Saginaw, MI', 'Kentwood, MI',
                'East Lansing, MI', 'Roseville, MI', 'Portage, MI', 'Midland, MI', 'Lincoln Park, MI',
                'Minneapolis, MN', 'St. Paul, MN', 'Rochester, MN', 'Duluth, MN', 'Bloomington, MN',
                'Brooklyn Park, MN', 'Plymouth, MN', 'St. Cloud, MN', 'Eagan, MN', 'Woodbury, MN',
                'Eden Prairie, MN', 'Coon Rapids, MN', 'Burnsville, MN', 'Mankato, MN', 'Moorhead, MN',
                'Winona, MN', 'Marshall, MN', 'Bemidji, MN', 'Grand Rapids, MN',
                'Jackson, MS', 'Gulfport, MS', 'Southaven, MS', 'Hattiesburg, MS', 'Biloxi, MS',
                'Meridian, MS', 'Tupelo, MS', 'Greenville, MS', 'Olive Branch, MS', 'Horn Lake, MS',
                'Gautier, MS', 'Laurel, MS', 'Starkville, MS', 'Vicksburg, MS', 'Greenwood, MS',
                'Columbus, MS', 'Oxford, MS', 'Grenada, MS', 'Natchez, MS', 'Hernando, MS',
                'Kansas City, MO', 'St. Louis, MO', 'Springfield, MO', 'Columbia, MO', 'Independence, MO',
                'Lee\'s Summit, MO', 'O\'Fallon, MO', 'St. Joseph, MO', 'St. Charles, MO', 'St. Peters, MO',
                'Blue Springs, MO', 'Florissant, MO', 'Joplin, MO', 'Chesterfield, MO', 'Jefferson City, MO',
                'Cape Girardeau, MO', 'Wildwood, MO', 'University City, MO', 'Ballwin, MO', 'Liberty, MO',
                'Billings, MT', 'Missoula, MT', 'Great Falls, MT', 'Bozeman, MT', 'Butte, MT',
                'Helena, MT', 'Kalispell, MT', 'Havre, MT', 'Anaconda, MT', 'Miles City, MT',
                'Lewistown, MT', 'Hamilton, MT', 'Livingston, MT', 'Laurel, MT', 'Whitefish, MT',
                'Omaha, NE', 'Lincoln, NE', 'Bellevue, NE', 'Grand Island, NE', 'Kearney, NE',
                'Fremont, NE', 'Hastings, NE', 'Norfolk, NE', 'Columbus, NE', 'North Platte, NE',
                'Beatrice, NE', 'Lexington, NE', 'Scottsbluff, NE', 'McCook, NE', 'Alliance, NE',
                'Las Vegas, NV', 'Henderson, NV', 'Reno, NV', 'North Las Vegas, NV', 'Sparks, NV',
                'Carson City, NV', 'Fernley, NV', 'Elko, NV', 'Mesquite, NV', 'Boulder City, NV',
                'Fallon, NV', 'Winnemucca, NV', 'West Wendover, NV', 'Ely, NV', 'Virginia City, NV',
                'Manchester, NH', 'Nashua, NH', 'Concord, NH', 'Dover, NH', 'Rochester, NH',
                'Keene, NH', 'Derry, NH', 'Portsmouth, NH', 'Laconia, NH', 'Lebanon, NH',
                'Claremont, NH', 'Somersworth, NH', 'Berlin, NH', 'Franklin, NH', 'Laconia, NH',
                'Newark, NJ', 'Jersey City, NJ', 'Paterson, NJ', 'Elizabeth, NJ', 'Edison, NJ',
                'Woodbridge, NJ', 'Lakewood, NJ', 'Toms River, NJ', 'Hamilton, NJ', 'Trenton, NJ',
                'Clifton, NJ', 'Camden, NJ', 'Brick, NJ', 'Cherry Hill, NJ', 'Passaic, NJ',
                'Middletown, NJ', 'Union City, NJ', 'Old Bridge, NJ', 'Gloucester, NJ', 'East Orange, NJ',
                'Albuquerque, NM', 'Las Cruces, NM', 'Rio Rancho, NM', 'Santa Fe, NM', 'Roswell, NM',
                'Farmington, NM', 'South Valley, NM', 'Clovis, NM', 'Hobbs, NM', 'Alamogordo, NM',
                'Carlsbad, NM', 'Gallup, NM', 'Deming, NM', 'Los Lunas, NM', 'Las Vegas, NM',
                'New York, NY', 'Buffalo, NY', 'Rochester, NY', 'Yonkers, NY', 'Syracuse, NY',
                'Albany, NY', 'New Rochelle, NY', 'Mount Vernon, NY', 'Schenectady, NY', 'Utica, NY',
                'White Plains, NY', 'Hempstead, NY', 'Troy, NY', 'Niagara Falls, NY', 'Binghamton, NY',
                'Freeport, NY', 'Valley Stream, NY', 'Long Beach, NY', 'Ithaca, NY', 'Saratoga Springs, NY',
                'Charlotte, NC', 'Raleigh, NC', 'Greensboro, NC', 'Durham, NC', 'Winston-Salem, NC',
                'Fayetteville, NC', 'Cary, NC', 'Wilmington, NC', 'High Point, NC', 'Greenville, NC',
                'Asheville, NC', 'Concord, NC', 'Gastonia, NC', 'Jacksonville, NC', 'Chapel Hill, NC',
                'Rocky Mount, NC', 'Burlington, NC', 'Wilson, NC', 'Huntersville, NC', 'Kannapolis, NC',
                'Fargo, ND', 'Bismarck, ND', 'Grand Forks, ND', 'Minot, ND', 'West Fargo, ND',
                'Williston, ND', 'Dickinson, ND', 'Mandan, ND', 'Jamestown, ND', 'Wahpeton, ND',
                'Devils Lake, ND', 'Valley City, ND', 'Grafton, ND', 'Carrington, ND', 'Rugby, ND',
                'Columbus, OH', 'Cleveland, OH', 'Cincinnati, OH', 'Toledo, OH', 'Akron, OH',
                'Dayton, OH', 'Parma, OH', 'Canton, OH', 'Youngstown, OH', 'Lorain, OH',
                'Hamilton, OH', 'Springfield, OH', 'Kettering, OH', 'Elyria, OH', 'Lakewood, OH',
                'Cuyahoga Falls, OH', 'Middletown, OH', 'Newark, OH', 'Mansfield, OH', 'Mentor, OH',
                'Oklahoma City, OK', 'Tulsa, OK', 'Norman, OK', 'Broken Arrow, OK', 'Lawton, OK',
                'Edmond, OK', 'Moore, OK', 'Midwest City, OK', 'Enid, OK', 'Stillwater, OK',
                'Bartlesville, OK', 'Ardmore, OK', 'Ponca City, OK', 'Shawnee, OK', 'Yukon, OK',
                'Guthrie, OK', 'El Reno, OK', 'Chickasha, OK', 'Woodward, OK', 'Durant, OK',
                'Portland, OR', 'Salem, OR', 'Eugene, OR', 'Gresham, OR', 'Hillsboro, OR',
                'Beaverton, OR', 'Bend, OR', 'Medford, OR', 'Springfield, OR', 'Corvallis, OR',
                'Albany, OR', 'Tigard, OR', 'Lake Oswego, OR', 'Keizer, OR', 'Grants Pass, OR',
                'Oregon City, OR', 'McMinnville, OR', 'Redmond, OR', 'Tualatin, OR', 'West Linn, OR',
                'Philadelphia, PA', 'Pittsburgh, PA', 'Allentown, PA', 'Erie, PA', 'Reading, PA',
                'Scranton, PA', 'Bethlehem, PA', 'Lancaster, PA', 'Harrisburg, PA', 'Altoona, PA',
                'York, PA', 'State College, PA', 'Wilkes-Barre, PA', 'Johnstown, PA', 'Chester, PA',
                'Williamsport, PA', 'Lebanon, PA', 'Pottsville, PA', 'Easton, PA', 'Sharon, PA',
                'Providence, RI', 'Warwick, RI', 'Cranston, RI', 'Pawtucket, RI', 'East Providence, RI',
                'Woonsocket, RI', 'Coventry, RI', 'Cumberland, RI', 'West Warwick, RI', 'Johnston, RI',
                'North Providence, RI', 'West Greenwich, RI', 'North Kingstown, RI', 'Bristol, RI',
                'Charleston, SC', 'Columbia, SC', 'North Charleston, SC', 'Mount Pleasant, SC', 'Rock Hill, SC',
                'Greenville, SC', 'Summerville, SC', 'Sumter, SC', 'Hilton Head Island, SC', 'Florence, SC',
                'Spartanburg, SC', 'Goose Creek, SC', 'Aiken, SC', 'Myrtle Beach, SC', 'Anderson, SC',
                'Greer, SC', 'Mauldin, SC', 'Greenwood, SC', 'North Augusta, SC', 'Easley, SC',
                'Sioux Falls, SD', 'Rapid City, SD', 'Aberdeen, SD', 'Brookings, SD', 'Watertown, SD',
                'Mitchell, SD', 'Yankton, SD', 'Pierre, SD', 'Huron, SD', 'Vermillion, SD',
                'Spearfish, SD', 'Brandon, SD', 'Madison, SD', 'Belle Fourche, SD', 'Hot Springs, SD',
                'Nashville, TN', 'Memphis, TN', 'Knoxville, TN', 'Chattanooga, TN', 'Clarksville, TN',
                'Murfreesboro, TN', 'Franklin, TN', 'Jackson, TN', 'Johnson City, TN', 'Hendersonville, TN',
                'Kingsport, TN', 'Collierville, TN', 'Smyrna, TN', 'Germantown, TN', 'Cleveland, TN',
                'Columbia, TN', 'Oak Ridge, TN', 'Morristown, TN', 'Bristol, TN', 'Lebanon, TN',
                'Houston, TX', 'San Antonio, TX', 'Dallas, TX', 'Austin, TX', 'Fort Worth, TX',
                'El Paso, TX', 'Arlington, TX', 'Corpus Christi, TX', 'Plano, TX', 'Laredo, TX',
                'Lubbock, TX', 'Garland, TX', 'Irving, TX', 'Amarillo, TX', 'Grand Prairie, TX',
                'McKinney, TX', 'Frisco, TX', 'McAllen, TX', 'Waco, TX', 'Carrollton, TX',
                'Denton, TX', 'Midland, TX', 'Abilene, TX', 'Beaumont, TX', 'Round Rock, TX',
                'Odessa, TX', 'Wichita Falls, TX', 'Richardson, TX', 'Lewisville, TX', 'Tyler, TX',
                'College Station, TX', 'San Marcos, TX', 'New Braunfels, TX', 'Killeen, TX', 'Longview, TX',
                'Salt Lake City, UT', 'West Valley City, UT', 'Provo, UT', 'West Jordan, UT', 'Orem, UT',
                'Sandy, UT', 'Ogden, UT', 'St. George, UT', 'Layton, UT', 'South Jordan, UT',
                'Lehi, UT', 'Millcreek, UT', 'Taylorsville, UT', 'Logan, UT', 'Murray, UT',
                'Draper, UT', 'Bountiful, UT', 'Riverton, UT', 'Roy, UT', 'Spanish Fork, UT',
                'Burlington, VT', 'South Burlington, VT', 'Rutland, VT', 'Barre, VT', 'Montpelier, VT',
                'Winooski, VT', 'St. Albans, VT', 'Newport, VT', 'Vergennes, VT', 'Middlebury, VT',
                'St. Johnsbury, VT', 'Waterbury, VT', 'Montpelier, VT', 'Northfield, VT', 'Randolph, VT',
                'Virginia Beach, VA', 'Norfolk, VA', 'Arlington, VA', 'Richmond, VA', 'Newport News, VA',
                'Alexandria, VA', 'Hampton, VA', 'Roanoke, VA', 'Portsmouth, VA', 'Suffolk, VA',
                'Lynchburg, VA', 'Harrisonburg, VA', 'Leesburg, VA', 'Charlottesville, VA',
                'Danville, VA', 'Manassas, VA', 'Petersburg, VA', 'Fredericksburg, VA', 'Winchester, VA',
                'Seattle, WA', 'Spokane, WA', 'Tacoma, WA', 'Vancouver, WA', 'Bellevue, WA',
                'Kent, WA', 'Everett, WA', 'Renton, WA', 'Yakima, WA', 'Federal Way, WA',
                'Spokane Valley, WA', 'Bellingham, WA', 'Kennewick, WA', 'Auburn, WA', 'Pasco, WA',
                'Marysville, WA', 'Lakewood, WA', 'Redmond, WA', 'Shoreline, WA', 'Richland, WA',
                'Charleston, WV', 'Huntington, WV', 'Parkersburg, WV', 'Morgantown, WV', 'Wheeling, WV',
                'Weirton, WV', 'Fairmont, WV', 'Martinsburg, WV', 'Beckley, WV', 'Clarksburg, WV',
                'South Charleston, WV', 'St. Albans, WV', 'Vienna, WV', 'Cross Lanes, WV', 'Bluefield, WV',
                'Milwaukee, WI', 'Madison, WI', 'Green Bay, WI', 'Kenosha, WI', 'Racine, WI',
                'Appleton, WI', 'Waukesha, WI', 'Oshkosh, WI', 'Eau Claire, WI', 'Janesville, WI',
                'West Allis, WI', 'La Crosse, WI', 'Sheboygan, WI', 'Wauwatosa, WI', 'Fond du Lac, WI',
                'New Berlin, WI', 'Beloit, WI', 'Superior, WI', 'Stevens Point, WI', 'Neenah, WI',
                'Cheyenne, WY', 'Casper, WY', 'Laramie, WY', 'Gillette, WY', 'Rock Springs, WY',
                'Sheridan, WY', 'Green River, WY', 'Evanston, WY', 'Riverton, WY', 'Cody, WY',
                'Rawlins, WY', 'Lander, WY', 'Torrington, WY', 'Powell, WY', 'Douglas, WY'
            ];

            // Add US States with abbreviations
            const allUSStates = [
                'Alabama, AL', 'Alaska, AK', 'Arizona, AZ', 'Arkansas, AR', 'California, CA',
                'Colorado, CO', 'Connecticut, CT', 'Delaware, DE', 'Florida, FL', 'Georgia, GA',
                'Hawaii, HI', 'Idaho, ID', 'Illinois, IL', 'Indiana, IN', 'Iowa, IA',
                'Kansas, KS', 'Kentucky, KY', 'Louisiana, LA', 'Maine, ME', 'Maryland, MD',
                'Massachusetts, MA', 'Michigan, MI', 'Minnesota, MN', 'Mississippi, MS', 'Missouri, MO',
                'Montana, MT', 'Nebraska, NE', 'Nevada, NV', 'New Hampshire, NH', 'New Jersey, NJ',
                'New Mexico, NM', 'New York, NY', 'North Carolina, NC', 'North Dakota, ND', 'Ohio, OH',
                'Oklahoma, OK', 'Oregon, OR', 'Pennsylvania, PA', 'Rhode Island, RI', 'South Carolina, SC',
                'South Dakota, SD', 'Tennessee, TN', 'Texas, TX', 'Utah, UT', 'Vermont, VT',
                'Virginia, VA', 'Washington, WA', 'West Virginia, WV', 'Wisconsin, WI', 'Wyoming, WY'
            ];

            // Add US States without abbreviations (just state names)
            const allUSStateNames = [
                'Alabama', 'Alaska', 'Arizona', 'Arkansas', 'California',
                'Colorado', 'Connecticut', 'Delaware', 'Florida', 'Georgia',
                'Hawaii', 'Idaho', 'Illinois', 'Indiana', 'Iowa',
                'Kansas', 'Kentucky', 'Louisiana', 'Maine', 'Maryland',
                'Massachusetts', 'Michigan', 'Minnesota', 'Mississippi', 'Missouri',
                'Montana', 'Nebraska', 'Nevada', 'New Hampshire', 'New Jersey',
                'New Mexico', 'New York', 'North Carolina', 'North Dakota', 'Ohio',
                'Oklahoma', 'Oregon', 'Pennsylvania', 'Rhode Island', 'South Carolina',
                'South Dakota', 'Tennessee', 'Texas', 'Utah', 'Vermont',
                'Virginia', 'Washington', 'West Virginia', 'Wisconsin', 'Wyoming'
            ];

            // Combine cities, states with abbreviations, and state names
            const allLocations = [...allUSCities, ...allUSStates, ...allUSStateNames];

            return allLocations.filter(location =>
                location.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 18); // Show more suggestions since we have more options
        }

        function displayLocationSuggestions(suggestions) {
            const container = document.getElementById('locationRecommendations');

            if (suggestions.length === 0) {
                container.innerHTML = '';
                return;
            }

            let html = '<div style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px;">';

            suggestions.forEach(city => {
                html += `
                    <button class="location-chip" onclick="addLocationFromSuggestion('${city}')">
                        ${city}
                    </button>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function addLocationFromSuggestion(city) {
            const container = document.getElementById('locationList');
            const chip = document.createElement('button');
            chip.className = 'location-chip';
            chip.textContent = city;
            chip.onclick = () => chip.remove();
            container.appendChild(chip);

            // Clear the input and suggestions
            document.getElementById('location').value = '';
            document.getElementById('locationRecommendations').innerHTML = '';
        }

        function addLocation() {
            const input = document.getElementById('location');
            const value = input.value.trim();

            if (!value) return;

            // Use the same parsing logic as bulk locations
            const locations = parseBulkLocations(value);

            if (locations.length === 0) {
                alert('Please enter a valid location format (e.g., "Los Angeles, CA" or "Houston TX")');
                return;
            }

            const container = document.getElementById('locationList');
            locations.forEach(location => {
                // Check if location already exists
                const existingChips = container.querySelectorAll('.location-chip');
                let exists = false;
                for (let chip of existingChips) {
                    if (chip.textContent.toLowerCase() === location.toLowerCase()) {
                        exists = true;
                        break;
                    }
                }

                if (!exists) {
                    const chip = document.createElement('button');
                    chip.className = 'location-chip';
                    chip.textContent = location;
                    chip.onclick = () => chip.remove();
                    container.appendChild(chip);
                }
            });

            input.value = '';

            // Show success message if multiple locations were added
            if (locations.length > 1) {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    background: #d4edda;
                    color: #155724;
                    padding: 10px;
                    border-radius: 4px;
                    margin-top: 10px;
                    font-size: 14px;
                    border: 1px solid #c3e6cb;
                `;
                notification.innerHTML = `✅ Added ${locations.length} location(s) successfully!`;
                container.parentNode.appendChild(notification);

                // Remove notification after 3 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 3000);
            }
        }

        function getSelectedLocations() {
            const locationChips = document.querySelectorAll('#locationList .location-chip');
            return Array.from(locationChips).map(chip => chip.textContent);
        }

        function handleNicheInput(value) {
            if (value.length < 2) {
                document.getElementById('nicheSuggestions').innerHTML = '';
                return;
            }

            const suggestions = getNicheSuggestions(value);
            displayNicheSuggestions(suggestions);
        }

        function getNicheSuggestions(query) {
            const allNiches = [
                // Personal Services
                'barber shops', 'hair salons', 'nail salons', 'spas', 'massage therapy', 'tattoo shops', 'piercing studios', 'tanning salons',
                // Home Services
                'plumbers', 'electricians', 'HVAC contractors', 'roofers', 'painters', 'landscapers', 'cleaning services', 'handyman services',
                // Automotive
                'auto repair', 'car wash', 'tire shops', 'auto detailing', 'oil change', 'brake repair', 'transmission repair', 'auto body shops',
                // Professional Services
                'interior designers', 'photographers', 'personal trainers', 'tutors', 'accountants', 'lawyers', 'real estate agents', 'consultants',
                // Food & Beverage
                'restaurants', 'food trucks', 'catering', 'bakeries', 'coffee shops', 'pizza places', 'food delivery', 'meal prep',
                // Health & Wellness
                'chiropractors', 'dentists', 'physical therapy', 'yoga studios', 'gyms', 'nutritionists', 'acupuncture', 'mental health',
                // Additional niches
                'pet groomers', 'veterinarians', 'daycare centers', 'tutoring centers', 'music lessons', 'dance studios', 'martial arts', 'swimming lessons',
                'dry cleaners', 'laundromats', 'tailors', 'shoe repair', 'jewelry repair', 'watch repair', 'key makers', 'locksmiths',
                'florists', 'gift shops', 'antique stores', 'thrift stores', 'pawn shops', 'bookstores', 'libraries', 'art galleries',
                'construction companies', 'contractors', 'architects', 'engineers', 'surveyors', 'inspectors', 'appraisers', 'notaries'
            ];

            return allNiches.filter(niche =>
                niche.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 8);
        }

        function displayNicheSuggestions(suggestions) {
            const container = document.getElementById('nicheSuggestions');

            if (suggestions.length === 0) {
                container.innerHTML = '';
                return;
            }

            let html = '<div style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px;">';

            suggestions.forEach(niche => {
                html += `
                    <button class="niche-chip" onclick="addNicheFromSuggestion('${niche}')">
                        ${niche}
                    </button>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function addNicheFromSuggestion(niche) {
            addNicheToSelection(niche);
            document.getElementById('niche').value = '';
            document.getElementById('nicheSuggestions').innerHTML = '';
        }

        function addNicheFromSelection(niche) {
            addNicheToSelection(niche);
        }

        function addNicheToSelection(niche) {
            const container = document.getElementById('selectedNiches');

            // Check if niche is already selected
            const existingChips = container.querySelectorAll('.niche-chip');
            for (let chip of existingChips) {
                if (chip.textContent.toLowerCase() === niche.toLowerCase()) {
                    return; // Already selected
                }
            }

            const chip = document.createElement('button');
            chip.className = 'niche-chip';
            chip.textContent = niche;
            chip.onclick = () => chip.remove();
            container.appendChild(chip);
        }

        function getSelectedNiches() {
            const nicheChips = document.querySelectorAll('#selectedNiches .niche-chip');
            return Array.from(nicheChips).map(chip => chip.textContent);
        }

        function switchTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));

            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');

            // Add active class to clicked tab
            event.target.classList.add('active');

            // Initialize specific tab functionality
            if (tabName === 'contacts') {
                initializeContactSearch();
            } else if (tabName === 'instagram-search') {
                populateInstagramSearchNiches();
                loadInstagramSearchConfig();
            }
        }

        function loadApiKey() {
            apiKey = localStorage.getItem('googlePlacesApiKey') || '';
            updateApiKeyDisplay();
        }

        function saveApiKey() {
            const keyInput = document.getElementById('apiKey');
            apiKey = keyInput.value.trim();

            if (!apiKey) {
                showApiStatus('Please enter a valid API key.', 'error');
                return;
            }

            localStorage.setItem('googlePlacesApiKey', apiKey);
            showApiStatus('API key saved successfully!', 'success');
            updateApiKeyDisplay();
        }

        function testApiKey() {
            if (!apiKey) {
                showApiStatus('Please save an API key first.', 'error');
                return;
            }

            showApiStatus('Testing API key...', 'info');

            // Test with a simple search
            const testQuery = 'restaurants in New York, NY';
            const testUrl = `https://maps.googleapis.com/maps/api/place/textsearch/json?query=${encodeURIComponent(testQuery)}&key=${apiKey}`;

            console.log('Testing API key with URL:', testUrl);

            // Try direct API call first
            fetch(testUrl)
                .then(response => {
                    console.log('API test response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('API test response:', data);
                    if (data.status === 'OK' || data.status === 'ZERO_RESULTS') {
                        showApiStatus('✅ API key is valid and working!', 'success');
                    } else if (data.status === 'REQUEST_DENIED') {
                        showApiStatus(`❌ API Key Error: ${data.error_message}`, 'error');
                    } else if (data.status === 'OVER_QUERY_LIMIT') {
                        showApiStatus('⚠️ API quota exceeded. Key is valid but quota is full.', 'error');
                    } else {
                        showApiStatus(`❌ API Error: ${data.status} - ${data.error_message || 'Unknown error'}`, 'error');
                    }
                })
                .catch(error => {
                    console.error('Direct API test failed, trying CORS proxy...', error);

                    // If direct call fails, try CORS proxy
                    testApiKeyWithProxy();
                });
        }

        function testApiKeyWithProxy() {
            const testQuery = 'restaurants in New York, NY';
            const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
            const apiUrl = `https://maps.googleapis.com/maps/api/place/textsearch/json?query=${encodeURIComponent(testQuery)}&key=${apiKey}`;
            const url = proxyUrl + apiUrl;

            console.log('Testing API key with CORS proxy:', url);

            fetch(url, {
                method: 'GET',
                headers: {
                    'Origin': window.location.origin,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => {
                    console.log('CORS proxy test response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('CORS proxy API test response:', data);
                    if (data.status === 'OK' || data.status === 'ZERO_RESULTS') {
                        showApiStatus('✅ API key is valid and working! (via proxy)', 'success');
                    } else if (data.status === 'REQUEST_DENIED') {
                        showApiStatus(`❌ API Key Error: ${data.error_message}`, 'error');
                    } else if (data.status === 'OVER_QUERY_LIMIT') {
                        showApiStatus('⚠️ API quota exceeded. Key is valid but quota is full.', 'error');
                    } else {
                        showApiStatus(`❌ API Error: ${data.status} - ${data.error_message || 'Unknown error'}`, 'error');
                    }
                })
                .catch(error => {
                    console.error('CORS proxy test failed, trying alternative proxy...', error);

                    // If primary proxy fails, try alternative proxy
                    testApiKeyWithAlternativeProxy();
                });
        }

        function testApiKeyWithAlternativeProxy() {
            const testQuery = 'restaurants in New York, NY';
            const proxyUrl = 'https://api.allorigins.win/raw?url=';
            const apiUrl = `https://maps.googleapis.com/maps/api/place/textsearch/json?query=${encodeURIComponent(testQuery)}&key=${apiKey}`;
            const url = proxyUrl + encodeURIComponent(apiUrl);

            console.log('Testing API key with alternative proxy:', url);

            fetch(url)
                .then(response => {
                    console.log('Alternative proxy test response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`Alternative proxy HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Alternative proxy API test response:', data);
                    if (data.status === 'OK' || data.status === 'ZERO_RESULTS') {
                        showApiStatus('✅ API key is valid and working! (via alternative proxy)', 'success');
                    } else if (data.status === 'REQUEST_DENIED') {
                        showApiStatus(`❌ API Key Error: ${data.error_message}`, 'error');
                    } else if (data.status === 'OVER_QUERY_LIMIT') {
                        showApiStatus('⚠️ API quota exceeded. Key is valid but quota is full.', 'error');
                    } else {
                        showApiStatus(`❌ API Error: ${data.status} - ${data.error_message || 'Unknown error'}`, 'error');
                    }
                })
                .catch(error => {
                    console.error('All API test methods failed:', error);
                    showApiStatus('⚠️ API test failed due to network issues, but your key may still be valid. Try searching to confirm.', 'error');
                });
        }

        function getStateCities(state) {
            const stateCities = {
                'Texas': ['Houston', 'Dallas', 'Austin', 'San Antonio', 'Fort Worth', 'El Paso', 'Arlington', 'Corpus Christi', 'Plano', 'Laredo', 'Lubbock', 'Garland', 'Irving', 'Amarillo', 'Grand Prairie', 'McKinney', 'Frisco', 'McAllen', 'Waco', 'Carrollton', 'Denton', 'Midland', 'Abilene', 'Beaumont', 'Round Rock', 'Odessa', 'Wichita Falls', 'Richardson', 'Lewisville', 'Tyler', 'College Station', 'San Marcos', 'New Braunfels', 'Killeen', 'Longview'],
                'California': ['Los Angeles', 'San Diego', 'San Jose', 'San Francisco', 'Fresno', 'Sacramento', 'Long Beach', 'Oakland', 'Bakersfield', 'Anaheim', 'Santa Ana', 'Riverside', 'Stockton', 'Irvine', 'Fremont', 'Chula Vista', 'Glendale', 'Modesto', 'San Bernardino', 'Fontana', 'Oxnard', 'Moreno Valley', 'Huntington Beach', 'Santa Clarita', 'Garden Grove', 'Oceanside', 'Rancho Cucamonga', 'Santa Rosa', 'Ontario', 'Lancaster', 'Elk Grove', 'Corona', 'Palmdale', 'Salinas', 'Pomona', 'Hayward', 'Escondido', 'Torrance', 'Sunnyvale', 'Orange', 'Fullerton', 'Pasadena', 'Thousand Oaks', 'Visalia', 'Simi Valley', 'Concord', 'Roseville', 'Clovis', 'Fairfield', 'Berkeley', 'Richmond', 'Arden-Arcade', 'Chico', 'Daly City', 'San Rafael', 'San Mateo', 'Tracy', 'Yuba City', 'San Leandro', 'Livermore', 'Antioch', 'Turlock', 'Palm Springs', 'Davis', 'Redding', 'San Clemente', 'Walnut Creek', 'Pleasanton', 'Mountain View', 'Lake Forest', 'Merced', 'Redwood City', 'Folsom', 'Newport Beach', 'San Ramon', 'Manteca', 'Union City', 'Lodi', 'Tracy'],
                'Florida': ['Jacksonville', 'Miami', 'Tampa', 'Orlando', 'St. Petersburg', 'Hialeah', 'Tallahassee', 'Fort Lauderdale', 'Port St. Lucie', 'Cape Coral', 'Gainesville', 'Coral Springs', 'Clearwater', 'Miami Gardens', 'Palm Bay', 'West Palm Beach', 'Sunrise', 'Lakeland', 'Boca Raton', 'Hollywood', 'Pembroke Pines', 'Gainesville', 'Miramar', 'Kissimmee', 'Palm Coast', 'Deltona', 'Plantation', 'Alafaya', 'Lehigh Acres'],
                'New York': ['New York', 'Buffalo', 'Rochester', 'Yonkers', 'Syracuse', 'Albany', 'New Rochelle', 'Mount Vernon', 'Schenectady', 'Utica', 'White Plains', 'Hempstead', 'Troy', 'Niagara Falls', 'Binghamton', 'Freeport', 'Valley Stream', 'Long Beach', 'Ithaca', 'Saratoga Springs'],
                'Illinois': ['Chicago', 'Aurora', 'Rockford', 'Joliet', 'Naperville', 'Springfield', 'Peoria', 'Elgin', 'Waukegan', 'Champaign', 'Bloomington', 'Arlington Heights', 'Evanston', 'Decatur', 'Schaumburg', 'Bolingbrook', 'Palatine', 'Skokie', 'Des Plaines', 'Orland Park', 'Tinley Park', 'Oak Lawn', 'Berwyn', 'Mount Prospect', 'Normal', 'Wheaton', 'Hoffman Estates', 'Oak Park', 'Downers Grove', 'Elmhurst', 'Glenview', 'DeKalb', 'Lombard', 'Buffalo Grove'],
                'Pennsylvania': ['Philadelphia', 'Pittsburgh', 'Allentown', 'Erie', 'Reading', 'Scranton', 'Bethlehem', 'Lancaster', 'Harrisburg', 'Altoona', 'York', 'State College', 'Wilkes-Barre', 'Johnstown', 'Chester', 'Williamsport', 'Lebanon', 'Pottsville', 'Easton', 'Sharon'],
                'Ohio': ['Columbus', 'Cleveland', 'Cincinnati', 'Toledo', 'Akron', 'Dayton', 'Parma', 'Canton', 'Youngstown', 'Lorain', 'Hamilton', 'Springfield', 'Kettering', 'Elyria', 'Lakewood', 'Cuyahoga Falls', 'Middletown', 'Newark', 'Mansfield', 'Mentor'],
                'Michigan': ['Detroit', 'Grand Rapids', 'Warren', 'Sterling Heights', 'Lansing', 'Ann Arbor', 'Flint', 'Dearborn', 'Livonia', 'Westland', 'Troy', 'Farmington Hills', 'Kalamazoo', 'Wyoming', 'Rochester Hills', 'Southfield', 'Taylor', 'Pontiac', 'St. Clair Shores', 'Royal Oak', 'Dearborn Heights', 'Novi', 'Battle Creek', 'Saginaw', 'Kentwood', 'East Lansing', 'Roseville', 'Portage', 'Midland', 'Lincoln Park'],
                'Georgia': ['Atlanta', 'Augusta', 'Columbus', 'Macon', 'Savannah', 'Athens', 'Sandy Springs', 'Roswell', 'Albany', 'Johns Creek', 'Warner Robins', 'Alpharetta', 'Marietta', 'Valdosta', 'Smyrna', 'Dunwoody', 'Rome', 'Gainesville', 'East Point', 'Newnan', 'Dalton', 'Kennesaw', 'Peachtree City', 'Tucker'],
                'North Carolina': ['Charlotte', 'Raleigh', 'Greensboro', 'Durham', 'Winston-Salem', 'Fayetteville', 'Cary', 'Wilmington', 'High Point', 'Greenville', 'Asheville', 'Concord', 'Gastonia', 'Jacksonville', 'Chapel Hill', 'Rocky Mount', 'Burlington', 'Wilson', 'Huntersville', 'Kannapolis'],
                'Virginia': ['Virginia Beach', 'Norfolk', 'Arlington', 'Richmond', 'Newport News', 'Alexandria', 'Hampton', 'Roanoke', 'Portsmouth', 'Suffolk', 'Lynchburg', 'Harrisonburg', 'Leesburg', 'Charlottesville', 'Danville', 'Manassas', 'Petersburg', 'Fredericksburg', 'Winchester'],
                'Washington': ['Seattle', 'Spokane', 'Tacoma', 'Vancouver', 'Bellevue', 'Kent', 'Everett', 'Renton', 'Yakima', 'Federal Way', 'Spokane Valley', 'Bellingham', 'Kennewick', 'Auburn', 'Pasco', 'Marysville', 'Lakewood', 'Redmond', 'Shoreline', 'Richland'],
                'Colorado': ['Denver', 'Colorado Springs', 'Aurora', 'Fort Collins', 'Lakewood', 'Thornton', 'Arvada', 'Westminster', 'Pueblo', 'Boulder', 'Greeley', 'Longmont', 'Loveland', 'Grand Junction', 'Broomfield', 'Castle Rock', 'Commerce City', 'Parker', 'Littleton', 'Northglenn', 'Englewood', 'Wheat Ridge'],
                'Arizona': ['Phoenix', 'Tucson', 'Mesa', 'Chandler', 'Scottsdale', 'Glendale', 'Gilbert', 'Tempe', 'Peoria', 'Surprise', 'Yuma', 'Avondale', 'Goodyear', 'Flagstaff', 'Buckeye', 'Casa Grande', 'Lake Havasu City', 'Maricopa', 'Oro Valley', 'Sierra Vista', 'Prescott Valley'],
                'Tennessee': ['Nashville', 'Memphis', 'Knoxville', 'Chattanooga', 'Clarksville', 'Murfreesboro', 'Franklin', 'Jackson', 'Johnson City', 'Hendersonville', 'Kingsport', 'Collierville', 'Smyrna', 'Germantown', 'Cleveland', 'Columbia', 'Oak Ridge', 'Morristown', 'Bristol', 'Lebanon'],
                'Missouri': ['Kansas City', 'St. Louis', 'Springfield', 'Columbia', 'Independence', 'Lee\'s Summit', 'O\'Fallon', 'St. Joseph', 'St. Charles', 'St. Peters', 'Blue Springs', 'Florissant', 'Joplin', 'Chesterfield', 'Jefferson City', 'Cape Girardeau', 'Wildwood', 'University City', 'Ballwin', 'Liberty'],
                'Indiana': ['Indianapolis', 'Fort Wayne', 'Evansville', 'South Bend', 'Carmel', 'Fishers', 'Bloomington', 'Hammond', 'Gary', 'Lafayette', 'Muncie', 'Terre Haute', 'Kokomo', 'Anderson', 'Noblesville', 'Greenwood', 'Elkhart', 'Michigan City', 'Lawrence', 'Jeffersonville', 'Columbus', 'Portage', 'New Albany', 'Mishawaka', 'Greenfield'],
                'Massachusetts': ['Boston', 'Worcester', 'Springfield', 'Lowell', 'Cambridge', 'New Bedford', 'Brockton', 'Quincy', 'Lynn', 'Fall River', 'Newton', 'Lawrence', 'Somerville', 'Framingham', 'Haverhill', 'Malden', 'Waltham', 'Brookline', 'Plymouth', 'Medford', 'Taunton', 'Chicopee', 'Weymouth', 'Revere', 'Peabody'],
                'Wisconsin': ['Milwaukee', 'Madison', 'Green Bay', 'Kenosha', 'Racine', 'Appleton', 'Waukesha', 'Oshkosh', 'Eau Claire', 'Janesville', 'West Allis', 'La Crosse', 'Sheboygan', 'Wauwatosa', 'Fond du Lac', 'New Berlin', 'Beloit', 'Superior', 'Stevens Point', 'Neenah'],
                'Minnesota': ['Minneapolis', 'St. Paul', 'Rochester', 'Duluth', 'Bloomington', 'Brooklyn Park', 'Plymouth', 'St. Cloud', 'Eagan', 'Woodbury', 'Eden Prairie', 'Coon Rapids', 'Burnsville', 'Mankato', 'Moorhead', 'Winona', 'Marshall', 'Bemidji', 'Grand Rapids'],
                'Louisiana': ['New Orleans', 'Baton Rouge', 'Shreveport', 'Lafayette', 'Lake Charles', 'Kenner', 'Bossier City', 'Monroe', 'Alexandria', 'Houma', 'New Iberia', 'Ruston', 'Sulphur', 'Hammond', 'Natchitoches', 'Zachary', 'Gonzales', 'Thibodaux', 'Minden', 'Opelousas'],
                'Alabama': ['Birmingham', 'Montgomery', 'Mobile', 'Huntsville', 'Tuscaloosa', 'Auburn', 'Dothan', 'Decatur', 'Madison', 'Florence', 'Gadsden', 'Vestavia Hills', 'Phoenix', 'Tucson', 'Mesa', 'Chandler', 'Scottsdale', 'Glendale', 'Gilbert', 'Tempe', 'Peoria', 'Surprise', 'Yuma', 'Avondale', 'Goodyear', 'Flagstaff', 'Buckeye', 'Casa Grande', 'Lake Havasu City', 'Maricopa', 'Oro Valley', 'Sierra Vista', 'Prescott Valley']
            };

            return stateCities[state] || [];
        }

        function findBusinesses() {
            const selectedNiches = getSelectedNiches();
            const selectedLocations = getSelectedLocations();
            const stateWideSearch = document.getElementById('stateWideSearch').checked;
            const minResults = parseInt(document.getElementById('minResults').value) || 5;
            const maxResults = parseInt(document.getElementById('maxResults').value) || 1000;
            const provider = (document.querySelector('input[name="placesProvider"]:checked')?.value) || placesProvider || 'google';
            placesProvider = provider;
            try { localStorage.setItem('placesProvider', provider); } catch { }

            if (selectedLocations.length === 0) {
                alert('Please add at least one location');
                return;
            }

            if (selectedNiches.length === 0) {
                alert('Please select at least one niche');
                return;
            }

            if (!apiKey) {
                alert('Please set a Google Places API key in the API Key tab.');
                return;
            }

            // Validate min/max results
            if (minResults < 1 || minResults > 1000) {
                alert('Minimum results must be between 1 and 1000');
                return;
            }

            if (maxResults < minResults || maxResults > 1000) {
                alert('Maximum results must be between minimum results and 1000');
                return;
            }

            let locationsToSearch = selectedLocations;

            // If state-wide search is enabled, expand locations to include all cities in the state
            if (stateWideSearch) {
                locationsToSearch = [];
                for (const location of selectedLocations) {
                    const state = location.split(', ')[1]; // Extract state from "City, State" format
                    if (state) {
                        const cities = getStateCities(state);
                        if (cities.length > 0) {
                            const stateLocations = cities.map(city => `${city}, ${state}`);
                            locationsToSearch = locationsToSearch.concat(stateLocations);
                        } else {
                            // If no predefined cities, just use the original location
                            locationsToSearch.push(location);
                        }
                    } else {
                        locationsToSearch.push(location);
                    }
                }

                console.log(`State-wide search: Expanded to ${locationsToSearch.length} cities`);
            }

            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '<div class="loading">Searching for businesses in multiple locations...</div>';

            // Search each location and niche combination
            searchMultipleLocationsAndNiches(locationsToSearch, selectedNiches, minResults, maxResults, provider);
        }

        async function searchMultipleLocationsAndNiches(locations, niches, minResults, maxResults, provider) {
            let allBusinesses = [];
            let processedSearches = 0;
            const totalSearches = locations.length * niches.length;

            console.log(`Starting search with min: ${minResults}, max: ${maxResults} results`);

            // Build exclusion set once per run (imported + from history)
            const exclusionSet = buildCombinedExclusionSet();

            // Check for duplicate search first
            const preventDuplicates = document.getElementById('preventDuplicates').checked;
            if (preventDuplicates) {
                const duplicateResults = checkForDuplicateSearch(locations, niches);
                if (duplicateResults && duplicateResults.length > 0) {
                    console.log('Found duplicate search in history, using cached results');
                    displayResults(duplicateResults, locations.join(', '), niches.join(', '));
                    return;
                }
            }

            for (const location of locations) {
                for (const niche of niches) {
                    // Check if we've already reached the max results
                    if (allBusinesses.length >= maxResults) {
                        console.log(`Reached global max results limit (${maxResults}), stopping search`);
                        break;
                    }

                    try {
                        // Calculate how many more results we can get from this search
                        const remainingResults = maxResults - allBusinesses.length;
                        let businesses = [];
                        if (provider === 'foursquare') {
                            businesses = await searchFoursquareForLocation(niche, location, minResults, remainingResults);
                        } else {
                            businesses = await searchGooglePlacesForLocation(niche, location, minResults, remainingResults);
                        }
                        // Filter out excluded leads immediately
                        businesses = filterExcluded(businesses, exclusionSet);
                        allBusinesses = allBusinesses.concat(businesses);
                        processedSearches++;

                        console.log(`Total results so far: ${allBusinesses.length}/${maxResults}`);

                        // Update progress with percentage
                        const percentage = Math.round((processedSearches / totalSearches) * 100);
                        const resultsContainer = document.getElementById('searchResults');
                        resultsContainer.innerHTML = `
                            <div class="loading">
                                <div>Searching businesses...</div>
                                <div style="margin-top: 10px;">
                                    <div style="background: #e9ecef; border-radius: 10px; height: 20px; overflow: hidden;">
                                        <div style="background: #007bff; height: 100%; width: ${percentage}%; transition: width 0.3s;"></div>
                                    </div>
                                    <div style="margin-top: 5px; font-size: 14px; color: #6c757d;">
                                        ${processedSearches} of ${totalSearches} searches (${percentage}%)
                                    </div>
                                    <div style="margin-top: 5px; font-size: 12px; color: #28a745;">
                                        Found: ${allBusinesses.length}/${maxResults} results
                                    </div>
                                </div>
                            </div>
                        `;

                    } catch (error) {
                        console.error(`Error searching ${niche} in ${location}:`, error);

                        // Show error message but continue with other searches
                        processedSearches++;

                        // Update progress even on error
                        const percentage = Math.round((processedSearches / totalSearches) * 100);
                        const resultsContainer = document.getElementById('searchResults');

                        // Show error message but continue
                        resultsContainer.innerHTML = `
                            <div class="loading">
                                <div>Searching businesses...</div>
                                <div style="margin-top: 10px;">
                                    <div style="background: #e9ecef; border-radius: 10px; height: 20px; overflow: hidden;">
                                        <div style="background: #007bff; height: 100%; width: ${percentage}%; transition: width 0.3s;"></div>
                                    </div>
                                    <div style="margin-top: 5px; font-size: 14px; color: #6c757d;">
                                        ${processedSearches} of ${totalSearches} searches (${percentage}%)
                                    </div>
                                    <div style="margin-top: 5px; font-size: 12px; color: #28a745;">
                                        Found: ${allBusinesses.length}/${maxResults} results
                                    </div>
                                </div>
                                <div style="margin-top: 10px; color: #dc3545; font-size: 12px;">
                                    Error searching ${niche} in ${location}: ${error.message}
                                </div>
                            </div>
                        `;
                    }
                }

                // Check if we've reached the max results (outer loop)
                if (allBusinesses.length >= maxResults) {
                    console.log(`Reached global max results limit (${maxResults}), stopping all searches`);
                    break;
                }
            }

            // Remove excluded again (safety) and duplicates
            allBusinesses = filterExcluded(allBusinesses, exclusionSet);
            allBusinesses = removeDuplicateBusinesses(allBusinesses);

            // Apply final max limit after removing duplicates
            if (allBusinesses.length > maxResults) {
                allBusinesses = allBusinesses.slice(0, maxResults);
                console.log(`Applied final max limit: ${maxResults} results`);
            }

            // Always show results, even if empty
            const nicheString = niches.join(', ');
            const locationString = locations.join(', ');
            displayResults(allBusinesses, locationString, nicheString);

            // Show notification that search was saved to history
            if (allBusinesses.length > 0) {
                console.log(`✅ Search completed and saved to history: ${allBusinesses.length} businesses found`);
            }
        }

        async function searchGooglePlacesForLocation(niche, location, minResults, maxResults) {
            const apiKey = getApiKey();
            if (!apiKey) {
                throw new Error('Google Places API key is not set. Please go to the API Key tab to set it.');
            }

            try {
                const query = `${niche} in ${location}`;

                // Try multiple proxy strategies
                const proxyStrategies = [
                    // Strategy 1: Direct API call (works in some environments)
                    async () => {
                        const directUrl = `https://maps.googleapis.com/maps/api/place/textsearch/json?query=${encodeURIComponent(query)}&key=${apiKey}`;
                        console.log(`Trying direct API call: ${directUrl}`);

                        const response = await fetch(directUrl);
                        if (response.ok) {
                            const data = await response.json();
                            console.log(`Direct API Response for ${location}:`, data);
                            return data;
                        }
                        throw new Error(`Direct API failed: ${response.status}`);
                    },

                    // Strategy 2: CORS Anywhere proxy
                    async () => {
                        const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                        const apiUrl = `https://maps.googleapis.com/maps/api/place/textsearch/json?query=${encodeURIComponent(query)}&key=${apiKey}`;
                        const url = proxyUrl + apiUrl;

                        console.log(`Trying CORS Anywhere proxy: ${url}`);

                        const response = await fetch(url, {
                            method: 'GET',
                            headers: {
                                'Origin': window.location.origin,
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        });

                        if (!response.ok) {
                            throw new Error(`CORS Anywhere failed: ${response.status}`);
                        }

                        const data = await response.json();
                        console.log(`CORS Anywhere API Response for ${location}:`, data);
                        return data;
                    },

                    // Strategy 3: AllOrigins proxy
                    async () => {
                        const proxyUrl = 'https://api.allorigins.win/raw?url=';
                        const apiUrl = `https://maps.googleapis.com/maps/api/place/textsearch/json?query=${encodeURIComponent(query)}&key=${apiKey}`;
                        const url = proxyUrl + encodeURIComponent(apiUrl);

                        console.log(`Trying AllOrigins proxy: ${url}`);

                        const response = await fetch(url);
                        if (!response.ok) {
                            throw new Error(`AllOrigins failed: ${response.status}`);
                        }

                        const data = await response.json();
                        console.log(`AllOrigins API Response for ${location}:`, data);
                        return data;
                    },

                    // Strategy 4: CORS Proxy (alternative)
                    async () => {
                        const proxyUrl = 'https://corsproxy.io/?';
                        const apiUrl = `https://maps.googleapis.com/maps/api/place/textsearch/json?query=${encodeURIComponent(query)}&key=${apiKey}`;
                        const url = proxyUrl + encodeURIComponent(apiUrl);

                        console.log(`Trying CORS Proxy: ${url}`);

                        const response = await fetch(url);
                        if (!response.ok) {
                            throw new Error(`CORS Proxy failed: ${response.status}`);
                        }

                        const data = await response.json();
                        console.log(`CORS Proxy API Response for ${location}:`, data);
                        return data;
                    },

                    // Strategy 5: JSONP-style approach (if needed)
                    async () => {
                        const proxyUrl = 'https://thingproxy.freeboard.io/fetch/';
                        const apiUrl = `https://maps.googleapis.com/maps/api/place/textsearch/json?query=${encodeURIComponent(query)}&key=${apiKey}`;
                        const url = proxyUrl + apiUrl;

                        console.log(`Trying ThingProxy: ${url}`);

                        const response = await fetch(url);
                        if (!response.ok) {
                            throw new Error(`ThingProxy failed: ${response.status}`);
                        }

                        const data = await response.json();
                        console.log(`ThingProxy API Response for ${location}:`, data);
                        return data;
                    }
                ];

                // Try each strategy until one works
                for (let i = 0; i < proxyStrategies.length; i++) {
                    try {
                        console.log(`Trying API strategy ${i + 1}...`);
                        const data = await proxyStrategies[i]();

                        if (data.status === 'OK') {
                            console.log(`Found ${data.results.length} total results for ${niche} in ${location}`);
                            const businesses = await processPlacesResults(data.results, niche, location, maxResults);
                            console.log(`Processed ${businesses.length} businesses without websites for ${niche} in ${location}`);
                            return businesses;
                        } else if (data.status === 'ZERO_RESULTS') {
                            console.log(`No results found for ${niche} in ${location}`);
                            return [];
                        } else if (data.status === 'REQUEST_DENIED') {
                            console.error(`API Key error: ${data.error_message}`);
                            throw new Error(`API Key error: ${data.error_message}`);
                        } else if (data.status === 'OVER_QUERY_LIMIT') {
                            console.error(`API quota exceeded`);
                            throw new Error(`API quota exceeded. Please try again later.`);
                        } else {
                            console.error(`API Error for ${location}: ${data.status} - ${data.error_message || 'Unknown error'}`);
                            throw new Error(`API Error: ${data.status} - ${data.error_message || 'Unknown error'}`);
                        }
                    } catch (strategyError) {
                        console.log(`Strategy ${i + 1} failed:`, strategyError.message);
                        if (i === proxyStrategies.length - 1) {
                            // This was the last strategy, throw the error
                            throw strategyError;
                        }
                        // Continue to next strategy
                        continue;
                    }
                }

            } catch (error) {
                console.error(`All API strategies failed for ${location}: ${error.message}`);
                throw error;
            }
        }

        async function searchFoursquareForLocation(niche, location, minResults, maxResults) {
            const key = getFsqApiKey();
            if (!key) throw new Error('Foursquare API key is not set. Please go to the API Key tab to set it.');

            // Build search via serverless proxy to avoid CORS and keep key safe
            const params = new URLSearchParams();
            params.set('query', niche);
            params.set('near', location);
            params.set('limit', String(Math.max(minResults, Math.min(maxResults, 50))));

            const resp = await fetch(`/api/foursquare/search?${params.toString()}`, {
                headers: { 'X-FSQ-KEY': key }
            });
            if (!resp.ok) {
                const text = await resp.text();
                throw new Error(`Foursquare search failed (${resp.status}): ${text}`);
            }
            const data = await resp.json();
            const results = Array.isArray(data.results) ? data.results : [];

            const businesses = [];
            for (const place of results) {
                const website = place.website || null;
                const phone = place.tel || null;
                if (!website && phone) {
                    // Compose a formatted address
                    let addr = '';
                    try {
                        const loc = place.location || {};
                        const parts = [loc.address, loc.locality, loc.region, loc.postcode, loc.country].filter(Boolean);
                        addr = parts.join(', ');
                    } catch { }
                    businesses.push({
                        name: place.name,
                        category: niche,
                        location: location,
                        address: addr || 'Address not available',
                        phone: phone,
                        email: 'N/A',
                        ownerManager: 'N/A',
                        bestContact: 'SMS',
                        website: 'No Website',
                        rating: place.rating || 'N/A',
                        confidence: 100
                    });
                    if (businesses.length >= maxResults) break;
                }
            }
            return businesses;
        }

        function generateMockBusinesses(niche, location) {
            // Generate realistic mock businesses for testing when API is not available
            const businessNames = [
                `${niche.charAt(0).toUpperCase() + niche.slice(1)} Pro`,
                `Elite ${niche}`,
                `Premium ${niche}`,
                `Best ${niche}`,
                `Quality ${niche}`,
                `Professional ${niche}`,
                `Expert ${niche}`,
                `Top ${niche}`,
                `Advanced ${niche}`,
                `Superior ${niche}`
            ];

            const streetNames = [
                'Main St', 'Oak Ave', 'Pine Rd', 'Elm St', 'Maple Dr',
                'Cedar Ln', 'Willow Way', 'Birch Blvd', 'Cherry St', 'Poplar Ave',
                'Washington St', 'Broadway', 'Park Ave', 'Central Blvd', 'Riverside Dr'
            ];

            const mockBusinesses = [];

            // Generate 3-8 random businesses
            const numBusinesses = Math.floor(Math.random() * 6) + 3;

            for (let i = 0; i < numBusinesses; i++) {
                const streetNumber = Math.floor(Math.random() * 999) + 1;
                const streetName = streetNames[Math.floor(Math.random() * streetNames.length)];
                const businessName = businessNames[Math.floor(Math.random() * businessNames.length)];
                const phoneArea = Math.floor(Math.random() * 900) + 100;
                const phonePrefix = Math.floor(Math.random() * 900) + 100;
                const phoneSuffix = Math.floor(Math.random() * 9000) + 1000;
                const rating = (Math.random() * 2 + 3).toFixed(1); // 3.0 to 5.0

                const business = {
                    name: businessName,
                    category: niche,
                    location: location,
                    address: `${streetNumber} ${streetName}, ${location}`,
                    phone: `(${phoneArea}) ${phonePrefix}-${phoneSuffix}`,
                    email: 'N/A',
                    bestContact: 'SMS',
                    website: 'No Website',
                    rating: rating,
                    confidence: Math.floor(Math.random() * 20) + 80 // 80-100%
                };

                mockBusinesses.push(business);
            }

            console.log(`Generated ${mockBusinesses.length} mock businesses for ${niche} in ${location}`);
            return mockBusinesses;
        }

        function removeDuplicateBusinesses(businesses) {
            const seen = new Set();
            return businesses.filter(business => {
                const key = `${business.name}-${business.address}`;
                if (seen.has(key)) {
                    return false;
                }
                seen.add(key);
                return true;
            });
        }

        function checkForDuplicateSearch(locations, niches) {
            const searchHistory = JSON.parse(localStorage.getItem('businessSearchHistory') || '[]');

            for (const entry of searchHistory) {
                const entryLocations = Array.isArray(entry.locations) ? entry.locations : [entry.locations];
                const entryNiches = Array.isArray(entry.niche) ? entry.niche : [entry.niche];

                // Check if locations match
                const locationsMatch = locations.every(loc => entryLocations.includes(loc)) &&
                    entryLocations.every(loc => locations.includes(loc));

                // Check if niches match
                const nichesMatch = niches.every(niche => entryNiches.includes(niche)) &&
                    entryNiches.every(niche => niches.includes(niche));

                if (locationsMatch && nichesMatch) {
                    return entry.businesses || [];
                }
            }

            return null; // No duplicate found
        }

        async function processPlacesResults(places, niche, location, maxResults) {
            const businesses = [];

            console.log(`Processing ${places.length} places for ${niche} in ${location} (max: ${maxResults})`);

            for (const place of places) {
                try {
                    console.log(`Processing place: ${place.name}`);

                    // Get detailed information
                    const details = await getPlaceDetails(place.place_id);

                    // Check if business has NO website AND HAS phone number
                    if (!details.website && details.phone) {
                        const business = {
                            name: place.name,
                            category: niche,
                            location: location,
                            address: place.formatted_address || 'Address not available',
                            phone: details.phone,
                            email: extractEmailFromReviews(place.reviews || []),
                            ownerManager: extractOwnerManagerName(place.name, place.reviews || [], place.formatted_address),
                            bestContact: determineBestContactMethod(details.phone, details.website),
                            website: 'No Website',
                            rating: place.rating || 'N/A',
                            confidence: 100
                        };

                        businesses.push(business);
                        console.log(`Added business: ${place.name} (phone: ${details.phone})`);

                        // Check if we've reached the max results limit
                        if (businesses.length >= maxResults) {
                            console.log(`Reached max results limit (${maxResults}) for ${niche} in ${location}`);
                            break;
                        }
                    } else if (details.website) {
                        console.log(`Skipped ${place.name} - has website`);
                    } else if (!details.phone) {
                        console.log(`Skipped ${place.name} - no phone number`);
                    }
                } catch (error) {
                    console.error('Error processing place:', error);
                }
            }

            console.log(`Found ${businesses.length} businesses without websites for ${niche} in ${location}`);
            return businesses;
        }

        async function getPlaceDetails(placeId) {
            const apiKey = getApiKey();
            if (!apiKey) {
                return { website: null, phone: null };
            }

            try {
                const placeDetailsStrategies = [
                    // Strategy 1: Direct API call
                    async () => {
                        const directUrl = `https://maps.googleapis.com/maps/api/place/details/json?place_id=${placeId}&fields=website,formatted_phone_number,international_phone_number&key=${apiKey}`;
                        console.log(`Getting place details directly for ${placeId}`);

                        const response = await fetch(directUrl);
                        if (response.ok) {
                            const data = await response.json();
                            console.log(`Direct place details for ${placeId}:`, data);
                            return data;
                        }
                        throw new Error(`Direct place details failed: ${response.status}`);
                    },

                    // Strategy 2: CORS Anywhere proxy
                    async () => {
                        const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                        const apiUrl = `https://maps.googleapis.com/maps/api/place/details/json?place_id=${placeId}&fields=website,formatted_phone_number,international_phone_number&key=${apiKey}`;
                        const url = proxyUrl + apiUrl;

                        console.log(`Getting place details via CORS Anywhere for ${placeId}`);

                        const response = await fetch(url, {
                            method: 'GET',
                            headers: {
                                'Origin': window.location.origin,
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        });

                        if (!response.ok) {
                            throw new Error(`CORS Anywhere place details failed: ${response.status}`);
                        }

                        const data = await response.json();
                        console.log(`CORS Anywhere place details for ${placeId}:`, data);
                        return data;
                    },

                    // Strategy 3: AllOrigins proxy
                    async () => {
                        const proxyUrl = 'https://api.allorigins.win/raw?url=';
                        const apiUrl = `https://maps.googleapis.com/maps/api/place/details/json?place_id=${placeId}&fields=website,formatted_phone_number,international_phone_number&key=${apiKey}`;
                        const url = proxyUrl + encodeURIComponent(apiUrl);

                        console.log(`Getting place details via AllOrigins for ${placeId}`);

                        const response = await fetch(url);
                        if (!response.ok) {
                            throw new Error(`AllOrigins place details failed: ${response.status}`);
                        }

                        const data = await response.json();
                        console.log(`AllOrigins place details for ${placeId}:`, data);
                        return data;
                    }
                ];

                // Try each strategy until one works
                for (let i = 0; i < placeDetailsStrategies.length; i++) {
                    try {
                        console.log(`Trying place details strategy ${i + 1}...`);
                        const data = await placeDetailsStrategies[i]();

                        if (data.status === 'OK') {
                            // Try multiple phone number fields
                            const phone = data.result.formatted_phone_number ||
                                data.result.international_phone_number ||
                                null;

                            return {
                                website: data.result.website || null,
                                phone: phone
                            };
                        } else {
                            console.error(`Place details error: ${data.status}`);
                            return { website: null, phone: null };
                        }
                    } catch (strategyError) {
                        console.log(`Place details strategy ${i + 1} failed:`, strategyError.message);
                        if (i === placeDetailsStrategies.length - 1) {
                            // This was the last strategy, return null values
                            return { website: null, phone: null };
                        }
                        // Continue to next strategy
                        continue;
                    }
                }

            } catch (error) {
                console.error('Error getting place details:', error);
                return { website: null, phone: null };
            }
        }

        function extractEmailFromReviews(reviews) {
            const emailRegex = /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g;

            for (const review of reviews) {
                const text = review.text || '';
                const emails = text.match(emailRegex);
                if (emails && emails.length > 0) {
                    return emails[0];
                }
            }

            return 'N/A';
        }

        function extractOwnerManagerName(businessName, reviews, address) {
            // Try to extract owner/manager name from various sources
            let ownerName = null;

            // Method 1: Extract from business name patterns
            const namePatterns = [
                /^([A-Z][a-z]+)\s+(?:'s|'s\s+|\s+&\s+)/i,  // John's Pizza, Smith & Associates
                /^([A-Z][a-z]+)\s+[A-Z][a-z]+(?:\s+[A-Z][a-z]+)?$/i,  // John Smith, John Smith Johnson
                /^([A-Z][a-z]+)\s+(?:Barber|Salon|Shop|Store|Service|Company|LLC|Inc|Corp)/i  // John's Barber Shop
            ];

            for (const pattern of namePatterns) {
                const match = businessName.match(pattern);
                if (match && match[1]) {
                    ownerName = match[1];
                    break;
                }
            }

            // Method 2: Look for owner mentions in reviews
            if (!ownerName && reviews && reviews.length > 0) {
                const ownerKeywords = ['owner', 'manager', 'proprietor', 'boss', 'director'];
                for (const review of reviews) {
                    const text = review.text || '';
                    for (const keyword of ownerKeywords) {
                        const regex = new RegExp(`(?:the\\s+)?${keyword}\\s+([A-Z][a-z]+\\s+[A-Z][a-z]+)`, 'i');
                        const match = text.match(regex);
                        if (match && match[1]) {
                            ownerName = match[1];
                            break;
                        }
                    }
                    if (ownerName) break;
                }
            }

            // Method 3: Extract from address patterns (sometimes owner name is in address)
            if (!ownerName && address) {
                const addressPattern = /^([A-Z][a-z]+)\s+[A-Z][a-z]+\s+(?:Ave|St|Rd|Blvd|Dr)/i;
                const match = address.match(addressPattern);
                if (match && match[1]) {
                    ownerName = match[1];
                }
            }

            return ownerName || 'N/A';
        }

        function determineBestContactMethod(phone, website) {
            if (phone) {
                return 'SMS';
            } else if (website) {
                return 'Email';
            } else {
                return 'N/A';
            }
        }

        function displayResults(businesses, locations, niche) {
            const container = document.getElementById('searchResults');

            if (businesses.length === 0) {
                container.innerHTML = `
                    <div class="error">
                        <h3>No businesses found matching your criteria.</h3>
                        <p>This could be due to:</p>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li>No businesses in this location/niche combination</li>
                            <li>All businesses found have websites</li>
                            <li>API quota exceeded - try again later</li>
                            <li>Network connectivity issues</li>
                        </ul>
                        <p style="margin-top: 15px;"><strong>Try:</strong></p>
                        <ul style="margin-left: 20px;">
                            <li>Different locations or niches</li>
                            <li>Checking your API key in the API Key tab</li>
                            <li>Waiting a few minutes if quota is exceeded</li>
                        </ul>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="success">
                    <h3>Found ${businesses.length} businesses in ${locations}</h3>
                    <button class="export-btn" onclick="exportToCSV()">Export to CSV</button>
                </div>
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Business Type</th>
                            <th>Location</th>
                            <th>Address</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>Owner/Manager</th>
                            <th>Best Contact</th>
                            <th>Website</th>
                            <th>Rating</th>
                            <th>Confidence</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            businesses.forEach(business => {
                const contactClass = business.bestContact === 'SMS' ? 'contact-sms' : 'contact-email';

                html += `
                    <tr>
                        <td><span class="business-name">${business.name}</span></td>
                        <td>${business.category}</td>
                        <td>${business.location}</td>
                        <td>${business.address}</td>
                        <td>${business.phone}</td>
                        <td>${business.email || 'N/A'}</td>
                        <td>${business.ownerManager}</td>
                        <td><span class="contact-badge ${contactClass}">${business.bestContact}</span></td>
                        <td>No Website</td>
                        <td>${business.rating}</td>
                        <td>${business.confidence}%</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;

            saveSearchToHistory(locations, niche, businesses);

            // Add a small notification that search was saved
            if (businesses.length > 0) {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    background: #d4edda;
                    color: #155724;
                    padding: 10px;
                    border-radius: 4px;
                    margin-top: 10px;
                    font-size: 14px;
                    border: 1px solid #c3e6cb;
                `;
                notification.innerHTML = `✅ Search results saved to history (${businesses.length} businesses found)`;
                container.appendChild(notification);

                // Remove notification after 5 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 5000);
            }
        }

        function displayResultsFromHistory(businesses, locations, niche) {
            const container = document.getElementById('searchResults');

            if (businesses.length === 0) {
                container.innerHTML = `
                    <div class="error">
                        <h3>No businesses found in this historical search.</h3>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="success">
                    <h3>Historical Results: ${businesses.length} businesses from ${locations}</h3>
                    <button class="export-btn" onclick="exportToCSV()">Export to CSV</button>
                </div>
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Business Type</th>
                            <th>Location</th>
                            <th>Address</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>Owner/Manager</th>
                            <th>Best Contact</th>
                            <th>Website</th>
                            <th>Rating</th>
                            <th>Confidence</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            businesses.forEach(business => {
                const contactClass = business.bestContact === 'SMS' ? 'contact-sms' : 'contact-email';

                html += `
                    <tr>
                        <td><span class="business-name">${business.name}</span></td>
                        <td>${business.category}</td>
                        <td>${business.location}</td>
                        <td>${business.address}</td>
                        <td>${business.phone}</td>
                        <td>${business.email || 'N/A'}</td>
                        <td>${business.ownerManager}</td>
                        <td><span class="contact-badge ${contactClass}">${business.bestContact}</span></td>
                        <td>No Website</td>
                        <td>${business.rating}</td>
                        <td>${business.confidence}%</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;

            // No save to history - this is just displaying historical data
        }

        function saveSearchToHistory(locations, niche, businesses) {
            const searchEntry = {
                timestamp: Date.now(),
                locations: Array.isArray(locations) ? locations : [locations],
                niche: niche,
                businesses: businesses
            };

            searchHistory.unshift(searchEntry);

            // Keep only last 10 searches
            if (searchHistory.length > 10) {
                searchHistory = searchHistory.slice(0, 10);
            }

            localStorage.setItem('businessSearchHistory', JSON.stringify(searchHistory));

            console.log(`✅ Search saved to history:`, {
                timestamp: new Date(searchEntry.timestamp).toLocaleString(),
                locations: searchEntry.locations,
                niche: searchEntry.niche,
                businessCount: searchEntry.businesses.length
            });

            // Refresh the history display if we're on the history tab
            if (document.getElementById('history-tab').classList.contains('active')) {
                displaySearchHistory();
            }
        }

        function loadSearchHistory() {
            const saved = localStorage.getItem('businessSearchHistory');
            if (saved) {
                searchHistory = JSON.parse(saved);
            }
            displaySearchHistory();
        }

        // =====================
        // Exclusions (CSV + History)
        // =====================
        function normalizeText(s) {
            return (s || '').toString().trim().toLowerCase().replace(/\s+/g, ' ');
        }
        function normalizePhone(s) {
            return (s || '').toString().replace(/[^0-9]/g, '');
        }
        function normalizeAddress(s) {
            return (s || '').toString().trim().toLowerCase().replace(/\s+/g, ' ').replace(/\./g, '');
        }
        function makeBusinessKey(name, phone, address) {
            const n = normalizeText(name);
            const p = normalizePhone(phone);
            const a = normalizeAddress(address);
            if (n && p) return `${n}|p:${p}`;
            if (n && a) return `${n}|a:${a}`;
            return n || a || p || null;
        }
        function getHistoryExclusionSet() {
            const set = new Set();
            try {
                const hist = JSON.parse(localStorage.getItem('businessSearchHistory') || '[]');
                for (const entry of hist) {
                    if (!entry || !Array.isArray(entry.businesses)) continue;
                    for (const b of entry.businesses) {
                        const key = makeBusinessKey(b?.name, b?.phone, b?.address);
                        if (key) set.add(key);
                    }
                }
            } catch { }
            return set;
        }
        function getImportedExclusionSet() {
            const set = new Set();
            try {
                const arr = JSON.parse(localStorage.getItem('excludedBusinessesKeys') || '[]');
                for (const k of arr) if (k) set.add(k);
            } catch { }
            return set;
        }
        function saveImportedExclusionSet(set) {
            try {
                localStorage.setItem('excludedBusinessesKeys', JSON.stringify(Array.from(set)));
            } catch { }
        }
        function buildCombinedExclusionSet() {
            const combined = getImportedExclusionSet();
            const fromHistory = getHistoryExclusionSet();
            for (const k of fromHistory) combined.add(k);
            return combined;
        }
        function filterExcluded(businesses, exclSet) {
            if (!exclSet || exclSet.size === 0) return businesses;
            return (businesses || []).filter(b => {
                const key = makeBusinessKey(b?.name, b?.phone, b?.address);
                return key ? !exclSet.has(key) : true;
            });
        }
        function parseCSV(text) {
            // Minimal CSV parser supporting quotes, commas, newlines
            const rows = [];
            let i = 0, field = '', row = [], inQuotes = false;
            while (i < text.length) {
                const c = text[i];
                if (inQuotes) {
                    if (c === '"') {
                        if (text[i + 1] === '"') { field += '"'; i++; }
                        else { inQuotes = false; }
                    } else {
                        field += c;
                    }
                } else {
                    if (c === '"') inQuotes = true;
                    else if (c === ',') { row.push(field); field = ''; }
                    else if (c === '\n' || c === '\r') {
                        if (field.length > 0 || row.length > 0) { row.push(field); rows.push(row); }
                        field = ''; row = [];
                        // handle CRLF
                        if (c === '\r' && text[i + 1] === '\n') i++;
                    } else { field += c; }
                }
                i++;
            }
            if (field.length > 0 || row.length > 0) { row.push(field); rows.push(row); }
            return rows;
        }
        function guessHeaderIndexes(headers) {
            const idx = { name: -1, phone: -1, address: -1, email: -1 };
            headers.forEach((h, i) => {
                const hl = h.toLowerCase();
                if (idx.name === -1 && /^(name|business|company|business name|company name)$/.test(hl)) idx.name = i;
                if (idx.phone === -1 && /(phone|telephone|mobile|cell)/.test(hl)) idx.phone = i;
                if (idx.address === -1 && /(address|street|location)/.test(hl)) idx.address = i;
                if (idx.email === -1 && /(email|e-mail)/.test(hl)) idx.email = i;
            });
            // fallback by position
            if (idx.name === -1) idx.name = 0;
            return idx;
        }
        async function importExclusionsFromCSVFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onerror = () => reject(new Error('Failed to read CSV file'));
                reader.onload = () => {
                    try {
                        const text = reader.result.toString();
                        const rows = parseCSV(text);
                        if (!rows || rows.length === 0) return resolve({ added: 0, total: 0 });
                        const headers = rows[0].map(h => h.trim());
                        const idx = guessHeaderIndexes(headers);
                        const set = getImportedExclusionSet();
                        let added = 0;
                        for (let r = 1; r < rows.length; r++) {
                            const row = rows[r];
                            if (!row || row.length === 0) continue;
                            const name = row[idx.name] || '';
                            const phone = idx.phone >= 0 ? row[idx.phone] : '';
                            const address = idx.address >= 0 ? row[idx.address] : '';
                            const key = makeBusinessKey(name, phone, address);
                            if (key && !set.has(key)) { set.add(key); added++; }
                        }
                        saveImportedExclusionSet(set);
                        resolve({ added, total: set.size });
                    } catch (e) { reject(e); }
                };
                reader.readAsText(file);
            });
        }
        function wireExclusionsUI() {
            const input = document.getElementById('exclusionsCsvInput');
            const btn = document.getElementById('importExclusionsBtn');
            const clearBtn = document.getElementById('clearExclusionsBtn');
            const status = document.getElementById('exclusionsStatus');
            const show = (msg, type = 'info') => {
                if (!status) return;
                status.className = `status-message status-${type}`;
                status.style.display = 'block';
                status.textContent = msg;
            };
            if (btn) {
                btn.addEventListener('click', async () => {
                    try {
                        if (!input || !input.files || input.files.length === 0) {
                            show('Please choose a CSV file to import.', 'error');
                            return;
                        }
                        show('Importing exclusions...', 'info');
                        const file = input.files[0];
                        const { added, total } = await importExclusionsFromCSVFile(file);
                        show(`Imported ${added} new exclusions. Total imported: ${total}.`, 'success');
                        displaySearchHistory();
                    } catch (e) {
                        show(`Import failed: ${e.message}`, 'error');
                    }
                });
            }
            if (clearBtn) {
                clearBtn.addEventListener('click', () => {
                    try { localStorage.removeItem('excludedBusinessesKeys'); } catch { }
                    show('Imported exclusions cleared.', 'success');
                    displaySearchHistory();
                });
            }
        }

        function displaySearchHistory() {
            const container = document.getElementById('searchHistory');

            // Update summary of imported exclusions
            try {
                const excl = JSON.parse(localStorage.getItem('excludedBusinessesKeys') || '[]');
                const histCount = getHistoryExclusionSet().size;
                const el = document.getElementById('exclusionsSummary');
                if (el) el.innerHTML = `Imported exclusions: <strong>${excl.length}</strong> | From history: <strong>${histCount}</strong>`;
            } catch { }

            if (searchHistory.length === 0) {
                container.innerHTML = '<p>No search history found.</p>';
                return;
            }

            let html = '';
            searchHistory.forEach((entry, index) => {
                const date = new Date(entry.timestamp);
                const dateString = date.toLocaleDateString();
                const timeString = date.toLocaleTimeString();
                const locations = Array.isArray(entry.locations) ? entry.locations.join(', ') : entry.locations || 'N/A';
                const niche = entry.niche || 'N/A';
                const businessCount = entry.businesses ? entry.businesses.length : 0;

                html += `
                    <div class="history-item">
                        <div class="history-header">
                            <div class="history-date">
                                <div>${dateString}</div>
                                <div style="font-size: 12px; color: #6c757d;">${timeString}</div>
                            </div>
                            <button class="delete-btn" onclick="deleteHistoryItem(${index})">Delete</button>
                        </div>
                        <div class="history-details">
                            <p><strong>Locations:</strong> ${locations}</p>
                            <p><strong>Niche:</strong> ${niche}</p>
                            <p><strong>Results:</strong> ${businessCount} businesses found</p>
                        </div>
                        <div class="history-actions">
                            <button class="btn btn-primary" onclick="loadSearchFromHistory(${index})">View Results</button>
                            <button class="btn btn-success" onclick="exportHistoryToCSV(${index})">Export CSV</button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function deleteHistoryItem(index) {
            searchHistory.splice(index, 1);
            localStorage.setItem('businessSearchHistory', JSON.stringify(searchHistory));
            displaySearchHistory();
        }

        function clearAllHistory() {
            searchHistory = [];
            localStorage.removeItem('businessSearchHistory');
            displaySearchHistory();
        }

        function loadSearchFromHistory(index) {
            const entry = searchHistory[index];
            if (entry && entry.businesses) {
                const locations = Array.isArray(entry.locations) ? entry.locations.join(', ') : entry.locations || 'N/A';
                displayResultsFromHistory(entry.businesses, locations, entry.niche);
                switchTab('search');
            }
        }

        function exportToCSV() {
            const table = document.querySelector('.results-table');
            if (!table) return;

            let csv = 'Name,Business Type,Location,Address,Phone,Email,Owner/Manager,Best Contact,Website,Rating,Confidence\n';

            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = Array.from(cells).map(cell => {
                    let text = cell.textContent || cell.innerText;
                    text = text.replace(/"/g, '""');
                    return `"${text}"`;
                });
                csv += rowData.join(',') + '\n';
            });

            downloadCSV(csv, 'businesses_without_websites.csv');
        }

        function exportHistoryToCSV(index) {
            const entry = searchHistory[index];
            if (!entry || !entry.businesses) return;

            let csv = 'Name,Business Type,Location,Address,Phone,Email,Owner/Manager,Best Contact,Website,Rating,Confidence\n';

            entry.businesses.forEach(business => {
                csv += `"${business.name}","${business.category}","${business.location}","${business.address}","${business.phone}","${business.email}","${business.ownerManager || 'N/A'}","${business.bestContact}","${business.website}","${business.rating}","${business.confidence}%"\n`;
            });

            downloadCSV(csv, `businesses_${entry.niche}_${new Date(entry.timestamp).toISOString().split('T')[0]}.csv`);
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function clearApiKey() {
            apiKey = '';
            localStorage.removeItem('googlePlacesApiKey');
            showApiStatus('API key cleared.', 'success');
            updateApiKeyDisplay();
        }

        function updateApiKeyDisplay() {
            const keyInput = document.getElementById('apiKey');
            if (keyInput) keyInput.value = apiKey;
            const fsqInput = document.getElementById('fsqApiKey');
            if (fsqInput) fsqInput.value = fsqApiKey;
        }

        function showApiStatus(message, type) {
            const statusDiv = document.getElementById('apiStatus');
            if (statusDiv) {
                statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
            }
        }

        function getApiKey() {
            return apiKey;
        }

        function loadFsqApiKey() {
            try { fsqApiKey = localStorage.getItem('fsqApiKey') || ''; } catch { }
            updateApiKeyDisplay();
        }
        function saveFsqApiKey() {
            const input = document.getElementById('fsqApiKey');
            fsqApiKey = input.value.trim();
            if (!fsqApiKey) { showFsqApiStatus('Please enter a valid Foursquare API key.', 'error'); return; }
            try { localStorage.setItem('fsqApiKey', fsqApiKey); } catch { }
            showFsqApiStatus('Foursquare API key saved successfully!', 'success');
            updateApiKeyDisplay();
        }
        async function testFsqApiKey() {
            if (!fsqApiKey) { showFsqApiStatus('Please save a Foursquare API key first.', 'error'); return; }
            showFsqApiStatus('Testing Foursquare API key...', 'info');
            try {
                const resp = await fetch(`/api/foursquare/search?query=${encodeURIComponent('restaurants')}&near=${encodeURIComponent('New York, NY')}&limit=1`, {
                    headers: { 'X-FSQ-KEY': fsqApiKey }
                });
                if (!resp.ok) {
                    const text = await resp.text();
                    throw new Error(`HTTP ${resp.status}: ${text}`);
                }
                const data = await resp.json();
                if (data && data.results && Array.isArray(data.results)) {
                    showFsqApiStatus('✅ Foursquare API key is valid and working!', 'success');
                } else {
                    showFsqApiStatus('⚠️ Unexpected response, but the key may still be valid.', 'info');
                }
            } catch (e) {
                showFsqApiStatus(`❌ Foursquare API test failed: ${e.message}`, 'error');
            }
        }
        function clearFsqApiKey() {
            fsqApiKey = '';
            try { localStorage.removeItem('fsqApiKey'); } catch { }
            showFsqApiStatus('Foursquare API key cleared.', 'success');
            updateApiKeyDisplay();
        }
        function showFsqApiStatus(message, type) {
            const el = document.getElementById('fsqApiStatus');
            if (el) el.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
        }
        function loadProviderSelection() {
            try { placesProvider = localStorage.getItem('placesProvider') || 'google'; } catch { }
            const radios = document.querySelectorAll('input[name="placesProvider"]');
            radios.forEach(r => { r.checked = (r.value === placesProvider); });
        }

        function getFsqApiKey() { return fsqApiKey; }

        // Instagram API Functions
        function loadInstagramApiKeys() {
            try {
                googleSearchApiKey = localStorage.getItem('googleSearchApiKey') || '';
                searchEngineId = localStorage.getItem('searchEngineId') || '';
            } catch { }
            updateInstagramApiKeyDisplay();
        }

        function saveInstagramApiKeys() {
            const keyInput = document.getElementById('googleSearchApiKey');
            const engineInput = document.getElementById('searchEngineId');

            googleSearchApiKey = keyInput.value.trim();
            searchEngineId = engineInput.value.trim();

            if (!googleSearchApiKey || !searchEngineId) {
                showInstagramApiStatus('Please enter both API key and Search Engine ID.', 'error');
                return;
            }

            try {
                localStorage.setItem('googleSearchApiKey', googleSearchApiKey);
                localStorage.setItem('searchEngineId', searchEngineId);
            } catch { }

            showInstagramApiStatus('Instagram API credentials saved successfully!', 'success');
            updateInstagramApiKeyDisplay();
        }

        function clearInstagramApiKeys() {
            googleSearchApiKey = '';
            searchEngineId = '';

            try {
                localStorage.removeItem('googleSearchApiKey');
                localStorage.removeItem('searchEngineId');
            } catch { }

            showInstagramApiStatus('Instagram API credentials cleared.', 'success');
            updateInstagramApiKeyDisplay();
        }

        function updateInstagramApiKeyDisplay() {
            const keyInput = document.getElementById('googleSearchApiKey');
            const engineInput = document.getElementById('searchEngineId');

            if (keyInput) keyInput.value = googleSearchApiKey;
            if (engineInput) engineInput.value = searchEngineId;
        }

        function showInstagramApiStatus(message, type) {
            const statusDiv = document.getElementById('instagramApiStatus');
            if (statusDiv) {
                statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
            }
        }

        async function testInstagramApi() {
            if (!googleSearchApiKey || !searchEngineId) {
                showInstagramApiStatus('Please save both API key and Search Engine ID first.', 'error');
                return;
            }

            showInstagramApiStatus('Testing Instagram API...', 'info');

            try {
                const response = await fetch('/api/instagram/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': googleSearchApiKey,
                        'x-search-engine-id': searchEngineId
                    },
                    body: JSON.stringify({
                        businessName: 'Starbucks',
                        city: 'Seattle',
                        state: 'WA',
                        confidenceThreshold: 50
                    })
                });

                if (!response.ok) {
                    let errorMessage = `HTTP ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorMessage;
                    } catch (parseError) {
                        const errorText = await response.text();
                        errorMessage = errorText || errorMessage;
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();

                if (data.instagramHandle && data.instagramHandle !== 'No Instagram Found') {
                    showInstagramApiStatus(`✅ API test successful! Found: ${data.instagramHandle} (${data.confidenceScore}% confidence)`, 'success');
                } else {
                    showInstagramApiStatus('✅ API is working, but no Instagram found for test business (normal).', 'success');
                }
            } catch (error) {
                console.error('Instagram API test failed:', error);
                showInstagramApiStatus(`❌ API test failed: ${error.message}`, 'error');
            }
        }

        async function processInstagramCsv() {
            const fileInput = document.getElementById('instagramCsvInput');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a CSV file.');
                return;
            }

            if (!googleSearchApiKey || !searchEngineId) {
                alert('Please save your Instagram API credentials first.');
                return;
            }

            const confidenceThreshold = parseInt(document.getElementById('confidenceThreshold').value) || 80;

            try {
                const csvText = await file.text();
                const parseResult = parseInstagramCsv(csvText);
                const { businesses, headers: originalHeaders } = parseResult;

                if (businesses.length === 0) {
                    alert('No valid businesses found in CSV file.');
                    return;
                }

                console.log(`Processing ${businesses.length} businesses with flexible CSV parsing`);

                // Show processing UI
                const statusDiv = document.getElementById('instagramProcessingStatus');
                const progressDiv = document.getElementById('currentProgress');
                const totalDiv = document.getElementById('totalProgress');
                const progressBar = document.getElementById('progressFill');
                const detailsDiv = document.getElementById('processingDetails');

                statusDiv.style.display = 'block';
                totalDiv.textContent = businesses.length;

                const results = [];
                let processed = 0;

                for (const business of businesses) {
                    try {
                        progressDiv.textContent = processed + 1;
                        const percentage = Math.round(((processed + 1) / businesses.length) * 100);
                        progressBar.style.width = percentage + '%';
                        detailsDiv.textContent = `Searching for: ${business.businessName}`;

                        const instagramResult = await searchInstagramForBusiness(
                            business.businessName,
                            business.address,
                            business.city,
                            business.state,
                            business.phone,
                            business.website,
                            confidenceThreshold
                        );

                        // Handle the response and avoid undefined values
                        let instagramValue = 'No Instagram Found';
                        let instagramHandle = 'No Instagram Found';

                        console.log('Instagram API Response:', instagramResult);

                        if (instagramResult && instagramResult.match_status === 'accepted') {
                            instagramValue = instagramResult.instagram_url || 'No Instagram Found';
                            instagramHandle = instagramResult.instagram_handle || 'No Instagram Found';
                        } else {
                            // For any non-accepted status, treat as no Instagram found
                            instagramValue = 'No Instagram Found';
                            instagramHandle = 'No Instagram Found';
                        }

                        // Ensure no undefined values
                        if (instagramValue === undefined || instagramValue === null) {
                            instagramValue = 'No Instagram Found';
                        }
                        if (instagramHandle === undefined || instagramHandle === null) {
                            instagramHandle = 'No Instagram Found';
                        }

                        console.log(`Final result for ${business.businessName}: ${instagramValue}`);

                        results.push({
                            ...business.originalData, // Preserve all original CSV data
                            instagram_url: instagramValue,
                            instagram_handle: instagramHandle,
                            match_confidence: instagramResult.match_confidence || 0.0,
                            match_status: instagramResult.match_status || 'no_instagram',
                            // Keep processed fields for internal use
                            _processedBusinessName: business.businessName,
                            _processedCity: business.city,
                            _processedState: business.state,
                            _debugInfo: instagramResult.debug_info || {}
                        });

                        processed++;

                        // Add small delay to avoid rate limiting
                        await new Promise(resolve => setTimeout(resolve, 300));

                    } catch (error) {
                        console.error(`Error processing ${business.businessName}:`, error);
                        results.push({
                            ...business.originalData,
                            instagram_url: '',
                            instagram_handle: '',
                            match_confidence: 0.0,
                            match_status: 'error'
                        });
                        processed++;
                    }
                }

                // Store headers for CSV generation using the parsed result
                window.csvHeaders = [...parseResult.headers, 'instagram_url', 'instagram_handle', 'match_confidence', 'match_status'];

                // Hide processing UI
                statusDiv.style.display = 'none';

                // Display results and provide download
                displayInstagramResults(results);

            } catch (error) {
                console.error('Error processing CSV:', error);
                alert('Error processing CSV file: ' + error.message);
                document.getElementById('instagramProcessingStatus').style.display = 'none';
            }
        }

        // Enhanced header detection system
        function detectHeaders(headers) {
            const aliases = {
                businessName: ['business name', 'business_name', 'businessname', 'name', 'company', 'company name', 'company_name', 'companyname', 'store', 'restaurant', 'shop', 'establishment', 'business', 'client', 'client name', 'client_name', 'organization', 'firm', 'entity'],
                address: ['address', 'street', 'location', 'addr', 'street address', 'address1', 'full address'],
                city: ['city', 'town', 'municipality', 'locale'],
                state: ['state', 'province', 'region', 'st'],
                phone: ['phone', 'telephone', 'tel', 'mobile', 'number', 'phone number', 'contact', 'contact number'],
                website: ['website', 'url', 'web', 'site', 'homepage', 'web address']
            };

            const mapping = {};
            const lowerHeaders = headers.map(h => h.toLowerCase().trim());

            console.log('Detecting headers from:', lowerHeaders);

            for (const [field, fieldAliases] of Object.entries(aliases)) {
                let foundIndex = -1;

                // Try exact matches first
                for (const alias of fieldAliases) {
                    foundIndex = lowerHeaders.indexOf(alias);
                    if (foundIndex !== -1) break;
                }

                // Try partial matches if no exact match
                if (foundIndex === -1) {
                    for (const alias of fieldAliases) {
                        foundIndex = lowerHeaders.findIndex(h => h.includes(alias));
                        if (foundIndex !== -1) break;
                    }
                }

                // Try reverse partial matches (header contains our field name)
                if (foundIndex === -1) {
                    for (const alias of fieldAliases) {
                        foundIndex = lowerHeaders.findIndex(h => alias.includes(h) && h.length > 2);
                        if (foundIndex !== -1) break;
                    }
                }

                mapping[field] = foundIndex;
                console.log(`${field}:`, foundIndex >= 0 ? headers[foundIndex] : 'NOT FOUND');
            }

            return mapping;
        }

        function parseInstagramCsv(csvText) {
            const lines = csvText.split('\n');
            if (lines.length < 2) {
                throw new Error('CSV file must have at least a header and one data row.');
            }

            // Parse CSV with better handling of quoted fields
            const parseCSVLine = (line) => {
                const result = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"' && (i === 0 || line[i - 1] === ',')) {
                        inQuotes = true;
                    } else if (char === '"' && inQuotes && (i === line.length - 1 || line[i + 1] === ',')) {
                        inQuotes = false;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else if (char !== '"' || inQuotes) {
                        current += char;
                    }
                }
                result.push(current.trim());
                return result;
            };

            const originalHeaders = parseCSVLine(lines[0]);
            console.log('Original CSV headers:', originalHeaders);

            // Use enhanced header detection
            const headerMapping = detectHeaders(originalHeaders);

            // Validate required fields
            if (headerMapping.businessName === -1) {
                const suggestions = originalHeaders.filter(h => h.toLowerCase().includes('name') || h.toLowerCase().includes('company'));
                const errorMsg = suggestions.length > 0
                    ? `No Business Name column found. Did you mean: ${suggestions.join(', ')}?`
                    : 'No Business Name column found. Please ensure your CSV has a column like "Business Name", "Company", or "Name".';
                throw new Error(errorMsg);
            }

            const businesses = [];
            const originalData = []; // Store all original data

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const values = parseCSVLine(line);
                if (values.length < originalHeaders.length) continue;

                // Store all original data
                const originalRow = {};
                originalHeaders.forEach((header, index) => {
                    originalRow[header] = values[index] || '';
                });
                originalData.push(originalRow);

                // Extract fields using header mapping
                const businessName = headerMapping.businessName >= 0 ? values[headerMapping.businessName] || '' : '';
                const address = headerMapping.address >= 0 ? values[headerMapping.address] || '' : '';
                const city = headerMapping.city >= 0 ? values[headerMapping.city] || '' : '';
                const state = headerMapping.state >= 0 ? values[headerMapping.state] || '' : '';
                const phone = headerMapping.phone >= 0 ? values[headerMapping.phone] || '' : '';
                const website = headerMapping.website >= 0 ? values[headerMapping.website] || '' : '';

                if (businessName.trim()) {
                    businesses.push({
                        businessName: businessName.trim(),
                        address: address.trim(),
                        city: city.trim(),
                        state: state.trim(),
                        phone: phone.trim(),
                        website: website.trim(),
                        originalData: originalRow,
                        headerMapping: headerMapping,
                        rowIndex: i
                    });
                }
            }

            console.log(`Parsed ${businesses.length} businesses from CSV`);
            return { businesses, headers: originalHeaders, headerMapping, originalData };
        }

        async function searchInstagramForBusiness(businessName, address, city, state, phone, website, confidenceThreshold) {
            try {
                console.log(`🔍 Searching Instagram for: ${businessName}`);

                const response = await fetch('/api/instagram/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': googleSearchApiKey,
                        'x-search-engine-id': searchEngineId
                    },
                    body: JSON.stringify({
                        businessName,
                        address,
                        city,
                        state,
                        phone,
                        website,
                        thresholdAccept: confidenceThreshold / 100,
                        thresholdReview: (confidenceThreshold - 20) / 100
                    })
                });

                if (!response.ok) {
                    let errorMessage = `HTTP ${response.status}`;
                    try {
                        const errorData = await response.json();
                        console.error('API Error:', errorData);
                        errorMessage = errorData.message || errorMessage;
                    } catch (parseError) {
                        console.error('Error parsing error response:', parseError);
                        const errorText = await response.text();
                        console.error('Raw error response:', errorText);
                        errorMessage = errorText || errorMessage;
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                console.log(`📊 Result for ${businessName}:`, {
                    handle: result.instagram_handle,
                    confidence: result.match_confidence,
                    status: result.match_status
                });

                return result;

            } catch (error) {
                console.error('Instagram search error for', businessName, ':', error);
                return {
                    instagram_handle: '',
                    instagram_url: '',
                    match_confidence: 0.0,
                    match_status: 'error',
                    error: error.message
                };
            }
        }

        function displayInstagramResults(results) {
            const container = document.getElementById('instagramResults');

            const successCount = results.filter(r =>
                (r.instagram_url && r.instagram_url !== 'No Instagram Found' && r.match_status !== 'error') ||
                (r.instagram && !r.instagram.includes('No Instagram') && !r.instagram.includes('Error:'))
            ).length;
            const errorCount = results.filter(r =>
                r.match_status === 'error' ||
                (r.instagram && r.instagram.includes('Error:'))
            ).length;

            let html = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>Processing Complete!</h3>
                    <p><strong>Total businesses processed:</strong> ${results.length}</p>
                    <p><strong>Instagram accounts found:</strong> ${successCount}</p>
                    <p><strong>Errors:</strong> ${errorCount}</p>
                    <button class="btn btn-success" onclick="downloadInstagramResults()" style="margin-right: 10px;">Download Results CSV</button>
                    <button class="btn btn-primary" onclick="saveInstagramResults()">Save Results</button>
                    <button class="btn btn-info" onclick="showSavedResults()" style="margin-left: 10px;">View Saved Results</button>
                </div>
                
                <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="background: #007bff; color: white; position: sticky; top: 0;">
                            <tr>
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Business Name</th>
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Location</th>
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Instagram</th>
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Confidence</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            results.forEach((result, index) => {
                const bgColor = index % 2 === 0 ? '#f8f9fa' : '#ffffff';
                let instagramDisplay = 'No Instagram found';

                // Use the new format with instagram_url and instagram_handle
                if (result.instagram_url && result.instagram_url !== 'No Instagram Found') {
                    // Check if it's already a URL or just a handle
                    if (result.instagram_url.startsWith('http')) {
                        instagramDisplay = `<a href="${result.instagram_url}" target="_blank" style="color: #007bff; text-decoration: none;">${result.instagram_handle || result.instagram_url}</a>`;
                    } else {
                        instagramDisplay = `<a href="${result.instagram_url}" target="_blank" style="color: #007bff; text-decoration: none;">${result.instagram_url}</a>`;
                    }
                } else if (result.instagram && result.instagram !== 'No Instagram found') {
                    // Fallback to old format for backwards compatibility
                    if (result.instagram.startsWith('http')) {
                        instagramDisplay = `<a href="${result.instagram}" target="_blank" style="color: #007bff; text-decoration: none;">${result.instagramHandle || result.instagram}</a>`;
                    } else {
                        instagramDisplay = `<a href="${result.instagram}" target="_blank" style="color: #007bff; text-decoration: none;">${result.instagram}</a>`;
                    }
                }

                // Use match_confidence instead of confidenceScore
                const confidenceDisplay = result.match_confidence > 0 ? `${Math.round(result.match_confidence * 100)}%` : 'N/A';

                // Use processed field names with fallbacks to original CSV data
                const businessName = result._processedBusinessName || result.businessName || 'N/A';

                // Smart city/state extraction from processed data and original CSV
                let city = result._processedCity;
                let state = result._processedState;

                // If processed data is missing, try to find in original CSV data
                if (!city || city === 'N/A') {
                    // Look through all result properties for city-like values
                    const cityKeys = Object.keys(result).filter(key =>
                        key.toLowerCase().includes('city') ||
                        key.toLowerCase().includes('town') ||
                        key.toLowerCase().includes('locale')
                    );
                    city = cityKeys.length > 0 ? result[cityKeys[0]] : 'N/A';
                }

                if (!state || state === 'N/A') {
                    // Look through all result properties for state-like values
                    const stateKeys = Object.keys(result).filter(key =>
                        key.toLowerCase().includes('state') ||
                        key.toLowerCase().includes('province') ||
                        key.toLowerCase().includes('region')
                    );
                    state = stateKeys.length > 0 ? result[stateKeys[0]] : 'N/A';
                }

                // Clean up the values
                city = city && city.trim() && city !== 'N/A' ? city.trim() : 'N/A';
                state = state && state.trim() && state !== 'N/A' ? state.trim() : 'N/A';

                const cityState = `${city}, ${state}`;

                html += `
                    <tr style="background: ${bgColor};">
                        <td style="padding: 8px; border: 1px solid #ddd;">${businessName}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${cityState}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${instagramDisplay}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${confidenceDisplay}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;

            // Store results globally for download
            window.instagramResults = results;
        }

        function downloadInstagramResults() {
            if (!window.instagramResults) {
                alert('No results to download.');
                return;
            }

            // Get all unique columns from the results (preserving original CSV structure)
            const allColumns = new Set();
            window.instagramResults.forEach(result => {
                Object.keys(result).forEach(key => {
                    // Skip internal processing fields
                    if (!key.startsWith('_') && key !== 'instagramHandle' && key !== 'confidenceScore') {
                        allColumns.add(key);
                    }
                });
            });

            // Ensure proper column order - original CSV columns first, then Instagram data
            const originalColumns = Array.from(allColumns).filter(col =>
                !['instagram_url', 'instagram_handle', 'match_confidence', 'match_status'].includes(col)
            );
            const instagramColumns = ['instagram_url', 'instagram_handle', 'match_confidence', 'match_status'];
            const columnOrder = [...originalColumns, ...instagramColumns.filter(col => allColumns.has(col))];

            console.log('CSV export columns:', columnOrder);

            // Create header row
            let csv = columnOrder.map(col => `"${col}"`).join(',') + '\n';

            // Add data rows
            window.instagramResults.forEach(result => {
                const fields = columnOrder.map(column => {
                    let value = result[column] || '';

                    // Clean up special values
                    if ((column === 'instagram_url' || column === 'instagram_handle') && !value) {
                        value = 'No Instagram Found';
                    }

                    // Convert confidence to percentage
                    if (column === 'match_confidence' && typeof value === 'number') {
                        value = Math.round(value * 100) + '%';
                    }

                    // Escape commas and quotes in CSV
                    const str = String(value).replace(/"/g, '""');
                    return `"${str}"`;
                });

                csv += fields.join(',') + '\n';
            });

            downloadCSV(csv, `instagram_results_${new Date().toISOString().split('T')[0]}.csv`);
        }

        function saveInstagramResults() {
            if (!window.instagramResults) {
                alert('No Instagram results to save');
                return;
            }

            const timestamp = new Date().toISOString();
            const resultId = `instagram_results_${Date.now()}`;

            // Get all unique columns from the results (preserving original CSV structure)
            const allColumns = new Set();
            window.instagramResults.forEach(result => {
                Object.keys(result).forEach(key => {
                    // Skip internal processing fields
                    if (!key.startsWith('_') && key !== 'instagramHandle' && key !== 'confidenceScore') {
                        allColumns.add(key);
                    }
                });
            });

            // Ensure proper column order - original CSV columns first, then Instagram data
            const originalColumns = Array.from(allColumns).filter(col =>
                !['instagram_url', 'instagram_handle', 'match_confidence', 'match_status'].includes(col)
            );
            const instagramColumns = ['instagram_url', 'instagram_handle', 'match_confidence', 'match_status'];
            const columnOrder = [...originalColumns, ...instagramColumns.filter(col => allColumns.has(col))];

            const savedResult = {
                id: resultId,
                timestamp: timestamp,
                results: window.instagramResults,
                headers: columnOrder,
                totalProcessed: window.instagramResults.length,
                matchCounts: {
                    accepted: window.instagramResults.filter(r => r.match_status === 'accepted').length,
                    needsReview: window.instagramResults.filter(r => r.match_status === 'needs_review').length,
                    noInstagram: window.instagramResults.filter(r => r.match_status === 'no_instagram').length,
                    found: window.instagramResults.filter(r =>
                        (r.instagram_url && r.instagram_url !== 'No Instagram Found' && r.match_status !== 'error') ||
                        (r.instagram && !r.instagram.includes('No Instagram') && !r.instagram.includes('Error:'))
                    ).length
                }
            };

            // Get existing saved results
            const existingResults = JSON.parse(localStorage.getItem('savedInstagramResults') || '[]');

            // Add new result to the beginning of the array
            existingResults.unshift(savedResult);

            // Keep only the most recent 20 saved results to prevent storage bloat
            const trimmedResults = existingResults.slice(0, 20);

            // Save back to localStorage
            localStorage.setItem('savedInstagramResults', JSON.stringify(trimmedResults));

            alert(`Results saved successfully! (${savedResult.totalProcessed} records with ${savedResult.matchCounts.found} Instagram accounts found)`);
        }

        function showSavedResults() {
            const savedResults = JSON.parse(localStorage.getItem('savedInstagramResults') || '[]');

            if (savedResults.length === 0) {
                alert('No saved results found');
                return;
            }

            // Create modal HTML for saved results
            const modalHtml = `
                <div class="modal fade" id="savedResultsModal" tabindex="-1" role="dialog">
                    <div class="modal-dialog modal-lg" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Saved Instagram Results</h5>
                                <button type="button" class="close" data-dismiss="modal">
                                    <span>&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div id="savedResultsList">
                                    ${savedResults.map(result => `
                                        <div class="card mb-3" style="border: 1px solid #ddd;">
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-8">
                                                        <h6 class="card-title">Results from ${new Date(result.timestamp).toLocaleString()}</h6>
                                                        <p class="card-text">
                                                            <strong>Total Records:</strong> ${result.totalProcessed}<br>
                                                            <strong>Instagram Found:</strong> ${result.matchCounts.found || 0} | 
                                                            <strong>Accepted:</strong> ${result.matchCounts.accepted || 0} | 
                                                            <strong>Needs Review:</strong> ${result.matchCounts.needsReview || 0}
                                                        </p>
                                                    </div>
                                                    <div class="col-md-4 text-right">
                                                        <button class="btn btn-sm btn-primary" onclick="loadSavedResult('${result.id}')" style="margin-bottom: 5px;">Load</button><br>
                                                        <button class="btn btn-sm btn-success" onclick="downloadSavedResult('${result.id}')" style="margin-bottom: 5px;">Download</button><br>
                                                        <button class="btn btn-sm btn-danger" onclick="deleteSavedResult('${result.id}')">Delete</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-warning" onclick="clearAllSavedResults()">Clear All Saved Results</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if present
            const existingModal = document.getElementById('savedResultsModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Show modal
            $('#savedResultsModal').modal('show');
        }

        function loadSavedResult(resultId) {
            const savedResults = JSON.parse(localStorage.getItem('savedInstagramResults') || '[]');
            const result = savedResults.find(r => r.id === resultId);

            if (!result) {
                alert('Saved result not found');
                return;
            }

            // Load the saved result into current state
            window.instagramResults = result.results;

            // Re-display the results
            displayInstagramResults(result.results);

            // Close modal
            $('#savedResultsModal').modal('hide');

            alert(`Loaded results from ${new Date(result.timestamp).toLocaleString()}`);
        }

        function downloadSavedResult(resultId) {
            const savedResults = JSON.parse(localStorage.getItem('savedInstagramResults') || '[]');
            const result = savedResults.find(r => r.id === resultId);

            if (!result) {
                alert('Saved result not found');
                return;
            }

            // Use the saved result's headers for column order
            const columnOrder = result.headers;

            // Create header row
            let csv = columnOrder.map(col => `"${col}"`).join(',') + '\n';

            // Add data rows
            result.results.forEach(row => {
                const fields = columnOrder.map(column => {
                    let value = row[column] || '';

                    // Clean up special values
                    if ((column === 'instagram_url' || column === 'instagram_handle') && !value) {
                        value = 'No Instagram Found';
                    }

                    // Convert confidence to percentage
                    if (column === 'match_confidence' && typeof value === 'number') {
                        value = Math.round(value * 100) + '%';
                    }

                    // Escape commas and quotes in CSV
                    const str = String(value).replace(/"/g, '""');
                    return `"${str}"`;
                });

                csv += fields.join(',') + '\n';
            });

            downloadCSV(csv, `instagram_results_${new Date(result.timestamp).toISOString().split('T')[0]}.csv`);
        }

        function deleteSavedResult(resultId) {
            if (!confirm('Are you sure you want to delete this saved result?')) {
                return;
            }

            const savedResults = JSON.parse(localStorage.getItem('savedInstagramResults') || '[]');
            const filteredResults = savedResults.filter(r => r.id !== resultId);

            localStorage.setItem('savedInstagramResults', JSON.stringify(filteredResults));

            // Refresh the modal display
            showSavedResults();
        }

        function clearAllSavedResults() {
            if (!confirm('Are you sure you want to delete all saved results? This action cannot be undone.')) {
                return;
            }

            localStorage.removeItem('savedInstagramResults');
            $('#savedResultsModal').modal('hide');
            alert('All saved results have been deleted');
        }

        function restoreSavedInstagramResults() {
            try {
                const savedResults = JSON.parse(localStorage.getItem('savedInstagramResults') || '[]');

                if (savedResults.length === 0) {
                    console.log('📊 No saved Instagram results to restore');
                    return;
                }

                // Get the most recent saved result (first in the array)
                const mostRecent = savedResults[0];

                if (!mostRecent || !mostRecent.results) {
                    console.log('📊 No valid recent results to restore');
                    return;
                }

                console.log(`📊 Restoring ${mostRecent.results.length} Instagram results from ${new Date(mostRecent.timestamp).toLocaleString()}`);

                // Load the most recent result into current state
                window.instagramResults = mostRecent.results;

                // Display the results in the Instagram tab
                displayInstagramResults(mostRecent.results);

                // Also add a subtle notification about the restored results
                const instagramTab = document.getElementById('instagram-tab');
                if (instagramTab) {
                    // Add a small notification at the top of the Instagram tab
                    const notification = document.createElement('div');
                    notification.style.cssText = `
                        background: #e3f2fd;
                        color: #1565c0;
                        padding: 8px 12px;
                        border-radius: 4px;
                        margin-bottom: 15px;
                        font-size: 14px;
                        border-left: 4px solid #2196f3;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    `;
                    notification.innerHTML = `
                        <span>📊 Restored results from ${new Date(mostRecent.timestamp).toLocaleString()}</span>
                        <button onclick="this.parentElement.remove()" style="background: none; border: none; color: #1565c0; cursor: pointer; padding: 0; margin: 0;">×</button>
                    `;

                    // Insert at the beginning of the Instagram tab content
                    instagramTab.insertBefore(notification, instagramTab.firstChild);

                    // Auto-remove the notification after 10 seconds
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 10000);
                }

                console.log('📊 Instagram results restored successfully');

                // Optional: If user is not currently on Instagram tab and results were restored,
                // don't auto-switch but provide a subtle hint in the tab button
                const instagramTabBtn = document.querySelector('button[onclick="showTab(\'instagram\')"');
                if (instagramTabBtn && !instagramTabBtn.classList.contains('active')) {
                    // Add a small indicator to show there are restored results
                    const indicator = document.createElement('span');
                    indicator.style.cssText = `
                        background: #28a745;
                        color: white;
                        border-radius: 50%;
                        width: 8px;
                        height: 8px;
                        display: inline-block;
                        margin-left: 5px;
                        animation: pulse 2s infinite;
                    `;
                    indicator.title = 'Restored Instagram results available';

                    // Only add if not already present
                    if (!instagramTabBtn.querySelector('span[title="Restored Instagram results available"]')) {
                        instagramTabBtn.appendChild(indicator);

                        // Remove indicator when user switches to Instagram tab
                        const observer = new MutationObserver((mutations) => {
                            mutations.forEach((mutation) => {
                                if (mutation.target === instagramTabBtn && instagramTabBtn.classList.contains('active')) {
                                    if (indicator.parentNode) {
                                        indicator.parentNode.removeChild(indicator);
                                    }
                                    observer.disconnect();
                                }
                            });
                        });
                        observer.observe(instagramTabBtn, { attributes: true, attributeFilter: ['class'] });
                    }
                }

            } catch (error) {
                console.error('📊 Error restoring saved Instagram results:', error);
            }
        }

        // Authentication Functions
        function checkAuthStatus() {
            console.log('🔍 Checking auth status...');
            console.log('🔍 Global login state:', window.LOGIN_STATE);

            // Check global state first (most reliable)
            if (window.LOGIN_STATE.isLoggedIn && window.LOGIN_STATE.currentUser) {
                console.log('✅ Found logged in user in global state:', window.LOGIN_STATE.currentUser.email);
                currentUser = window.LOGIN_STATE.currentUser;
                sessionId = window.LOGIN_STATE.sessionId;
                showApp();
                return;
            }

            // Fallback to localStorage (if available)
            try {
                const savedUser = localStorage.getItem('outtaWebCurrentUser');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    sessionId = localStorage.getItem('outtaWebSessionId') || 'session-' + Date.now();

                    // Update global state
                    window.LOGIN_STATE.isLoggedIn = true;
                    window.LOGIN_STATE.currentUser = currentUser;
                    window.LOGIN_STATE.sessionId = sessionId;

                    console.log('✅ Found saved user in localStorage:', currentUser.email);
                    showApp();
                    return;
                }
            } catch (error) {
                console.error('❌ Error reading localStorage:', error);
            }

            // Try server session if we have a saved sessionId
            try {
                const savedSession = localStorage.getItem('outtaWebSessionId');
                if (savedSession) {
                    fetch('/api/auth/check-session', {
                        headers: { 'X-Session-Id': savedSession }
                    })
                        .then(r => r.json().then(data => ({ ok: r.ok, data })))
                        .then(({ ok, data }) => {
                            if (ok && data.success && data.user) {
                                currentUser = data.user;
                                sessionId = savedSession;
                                window.LOGIN_STATE.isLoggedIn = true;
                                window.LOGIN_STATE.currentUser = currentUser;
                                window.LOGIN_STATE.sessionId = sessionId;
                                try {
                                    localStorage.setItem('outtaWebCurrentUser', JSON.stringify(currentUser));
                                } catch { }
                                console.log('✅ Restored session from server for:', currentUser.email);
                                showApp();
                            } else {
                                console.log('ℹ️ No valid server session. Showing login.');
                                showLogin();
                            }
                        })
                        .catch(() => {
                            console.log('ℹ️ Session check failed. Showing login.');
                            showLogin();
                        });
                    return;
                }
            } catch { }

            // No valid session found
            console.log('📋 No valid session found, showing login');
            showLogin();
        }

        function showLogin() {
            const loginOverlay = document.getElementById('loginOverlay');
            const container = document.querySelector('.container');
            document.getElementById('registerOverlay').classList.add('hidden');
            document.getElementById('verifyOverlay').classList.add('hidden');
            document.getElementById('resetOverlay').classList.add('hidden');

            // Show login overlay (override initial inline display:none)
            loginOverlay.classList.remove('hidden');
            loginOverlay.style.display = 'flex';

            // Hide app container
            if (container) {
                container.classList.add('hidden');
            }
        }

        function showRegister() {
            document.getElementById('registerOverlay').classList.remove('hidden');
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('verifyOverlay').classList.add('hidden');
            document.getElementById('resetOverlay').classList.add('hidden');
        }

        function showVerify() {
            document.getElementById('verifyOverlay').classList.remove('hidden');
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('registerOverlay').classList.add('hidden');
            document.getElementById('resetOverlay').classList.add('hidden');
            // Always update the code display
            document.getElementById('verificationCodeText').textContent = (pendingVerificationUser && pendingVerificationUser.verificationCode) ? pendingVerificationUser.verificationCode : '------';
        }

        function showResetForm() {
            document.getElementById('resetOverlay').classList.remove('hidden');
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('registerOverlay').classList.add('hidden');
            document.getElementById('verifyOverlay').classList.add('hidden');
            document.getElementById('resetRequestForm').classList.remove('hidden');
            document.getElementById('resetForm').classList.add('hidden');
        }

        function showApp() {
            console.log('🎯 showApp() called...');

            // Force hide all overlays
            const loginOverlay = document.getElementById('loginOverlay');
            const registerOverlay = document.getElementById('registerOverlay');
            const verifyOverlay = document.getElementById('verifyOverlay');
            const resetOverlay = document.getElementById('resetOverlay');

            if (loginOverlay) {
                loginOverlay.classList.add('hidden');
                console.log('🎯 Login overlay hidden');
            }
            if (registerOverlay) {
                registerOverlay.classList.add('hidden');
                console.log('🎯 Register overlay hidden');
            }
            if (verifyOverlay) {
                verifyOverlay.classList.add('hidden');
                console.log('🎯 Verify overlay hidden');
            }
            if (resetOverlay) {
                resetOverlay.classList.add('hidden');
                console.log('🎯 Reset overlay hidden');
            }

            // Force show main container
            const container = document.querySelector('.container');
            if (container) {
                container.classList.remove('hidden');
                console.log('🎯 Main container shown');
            }

            updateUserInfo();
            console.log('🎯 showApp() completed');
        }

        function updateUserInfo() {
            if (currentUser) {
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
            } else {
                document.getElementById('userInfo').classList.add('hidden');
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value;

            console.log('🔐 Login attempt:', { email, password: '***' });

            // Validate input
            if (!email || !password) {
                alert('❌ Please enter both email and password.');
                return;
            }

            // 1) Try Supabase first (primary auth)
            if (window.SUPABASE && window.SUPABASE.auth) {
                try {
                    const { data, error } = await window.SUPABASE.auth.signInWithPassword({ email, password });
                    if (!error && data && data.user) {
                        const u = data.user;
                        currentUser = {
                            id: u.id,
                            name: u.user_metadata?.name || (u.email || 'User'),
                            email: u.email,
                            verified: !!u.email_confirmed_at
                        };
                        sessionId = data.session?.access_token || `sb-${Date.now()}`;

                        window.LOGIN_STATE.isLoggedIn = true;
                        window.LOGIN_STATE.currentUser = currentUser;
                        window.LOGIN_STATE.sessionId = sessionId;

                        try {
                            localStorage.setItem('outtaWebSessionId', sessionId);
                            localStorage.setItem('outtaWebCurrentUser', JSON.stringify(currentUser));
                        } catch { }

                        document.getElementById('loginForm').reset();
                        showApp();
                        alert('✅ Login successful! Welcome ' + currentUser.name + '!');
                        return;
                    }
                } catch (e) {
                    console.log('ℹ️ Supabase sign-in error:', e.message);
                }
            }

            // 2) Fallback: server-side authentication (if configured)
            try {
                const resp = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await resp.json();
                if (resp.ok && data.success) {
                    console.log('✅ Server login successful for user:', data.user.email);

                    currentUser = data.user;
                    sessionId = data.sessionId;

                    window.LOGIN_STATE.isLoggedIn = true;
                    window.LOGIN_STATE.currentUser = currentUser;
                    window.LOGIN_STATE.sessionId = sessionId;

                    try {
                        localStorage.setItem('outtaWebSessionId', sessionId);
                        localStorage.setItem('outtaWebCurrentUser', JSON.stringify(currentUser));
                    } catch { }

                    document.getElementById('loginForm').reset();
                    showApp();
                    alert('✅ Login successful! Welcome ' + currentUser.name + '!');
                    return;
                } else {
                    console.log('⚠️ Server login failed:', data && data.message);
                }
            } catch (err) {
                console.log('⚠️ Server login error:', err.message);
            }

            // 3) Last resort: hardcoded dev accounts
            const user = HARDCODED_USERS.find(u =>
                u.email.toLowerCase() === email && u.password === password
            );

            if (user) {
                console.log('✅ Local fallback login successful for user:', user.email);

                currentUser = user;
                sessionId = 'session-' + Date.now();

                window.LOGIN_STATE.isLoggedIn = true;
                window.LOGIN_STATE.currentUser = user;
                window.LOGIN_STATE.sessionId = sessionId;

                try {
                    localStorage.setItem('outtaWebSessionId', sessionId);
                    localStorage.setItem('outtaWebCurrentUser', JSON.stringify(user));
                } catch { }

                document.getElementById('loginForm').reset();
                showApp();
                alert('✅ Login successful! Welcome ' + user.name + '!');
            } else {
                console.log('❌ Login failed: Invalid credentials');
                alert('❌ Login failed! Please check your email and password.');
            }
        }


        async function register() {
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value.trim().toLowerCase();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;

            if (password !== confirmPassword) {
                alert('Passwords do not match. Please try again.');
                return;
            }

            const tasks = [];
            // Supabase sign up (non-blocking, safe to skip if not configured)
            if (window.SUPABASE && window.SUPABASE.auth) {
                tasks.push(
                    window.SUPABASE.auth.signUp({
                        email,
                        password,
                        options: {
                            data: { name },
                            emailRedirectTo: `${window.location.origin}/auth/callback`
                        }
                    }).then(({ data, error }) => {
                        if (error) throw new Error(error.message);
                        return data;
                    })
                );
            } else {
                tasks.push(Promise.resolve({ skipped: true }));
            }

            // Existing server registration
            tasks.push(
                fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name, email, password, confirmPassword })
                }).then(async r => {
                    const json = await r.json().catch(() => ({}));
                    if (!r.ok || !json.success) throw new Error(json.message || 'Server registration failed');
                    return json;
                })
            );

            const results = await Promise.allSettled(tasks);
            const supaOk = results[0].status === 'fulfilled';
            const serverOk = results[results.length - 1].status === 'fulfilled';

            if (!supaOk && !serverOk) {
                const supaErr = results[0].status === 'rejected' ? (results[0].reason?.message || results[0].reason) : null;
                const serverErr = results[results.length - 1].status === 'rejected' ? (results[results.length - 1].reason?.message || results[results.length - 1].reason) : null;
                console.error('Registration errors:', { supabase: supaErr, server: serverErr });
                alert('Sign up failed. Please check your details and try again.');
                return;
            }

            // If Supabase signup succeeded, prefer it
            if (supaOk) {
                try {
                    const supaData = results[0].value || {};
                    const sbUser = supaData.user || null;
                    const sbSession = supaData.session || null;

                    if (sbUser && sbSession && sbSession.access_token) {
                        currentUser = {
                            id: sbUser.id,
                            name: sbUser.user_metadata?.name || (sbUser.email || 'User'),
                            email: sbUser.email,
                            verified: !!sbUser.email_confirmed_at
                        };
                        sessionId = sbSession.access_token;
                        window.LOGIN_STATE.isLoggedIn = true;
                        window.LOGIN_STATE.currentUser = currentUser;
                        window.LOGIN_STATE.sessionId = sessionId;
                        try {
                            localStorage.setItem('outtaWebSessionId', sessionId);
                            localStorage.setItem('outtaWebCurrentUser', JSON.stringify(currentUser));
                        } catch { }
                        showApp();
                        document.getElementById('registerForm').reset();
                        alert('Registration successful!');
                        return;
                    } else {
                        // Email confirmation required – do not show app yet
                        alert('We\'ve sent a confirmation link to your email. Please verify your address, then sign in.');
                        return;
                    }
                } catch (e) {
                    console.log('Supabase signup handling error:', e.message);
                }
            }

            // Otherwise, fall back to server registration if it succeeded
            if (serverOk) {
                const data = results[results.length - 1].value;
                currentUser = data.user;
                sessionId = data.sessionId;
                try {
                    localStorage.setItem('outtaWebSessionId', sessionId);
                    localStorage.setItem('outtaWebCurrentUser', JSON.stringify(currentUser));
                } catch { }
                showApp();
                document.getElementById('registerForm').reset();
                alert('Registration successful!');
                return;
            }

            // If we got here, neither path produced a session
            alert('Sign up started, but a session was not created. If email confirmation is enabled, check your inbox.');
            return;
        }

        document.getElementById('verifyForm').addEventListener('submit', function (e) {
            e.preventDefault();
            verifyCode();
        });

        async function verifyCode() {
            const code = document.getElementById('verifyCode').value.trim();
            const email = document.getElementById('verifyEmail').value.trim().toLowerCase();

            try {
                const response = await fetch('/api/auth/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, code })
                });

                const data = await response.json();

                if (data.success) {
                    showApp();
                    document.getElementById('verifyForm').reset();
                    alert('Email verified! Welcome to Business Finder.');
                } else {
                    alert(data.message || 'Incorrect verification code. Please try again.');
                }
            } catch (error) {
                console.error('Verification error:', error);
                alert('Verification failed. Please try again.');
            }
        }



        // Password Reset
        document.getElementById('resetRequestForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const email = document.getElementById('resetEmail').value.trim().toLowerCase();

            try {
                const response = await fetch('/api/auth/reset-request', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('resetRequestForm').classList.add('hidden');
                    document.getElementById('resetForm').classList.remove('hidden');
                    // Display the reset code on screen
                    document.getElementById('resetCodeText').textContent = data.resetCode;
                } else {
                    alert(data.message || 'Reset request failed. Please try again.');
                }
            } catch (error) {
                console.error('Reset request error:', error);
                alert('Reset request failed. Please try again.');
            }
        });

        document.getElementById('resetForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const code = document.getElementById('resetCode').value.trim();
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            const email = document.getElementById('resetEmail').value.trim().toLowerCase();

            if (newPassword !== confirmNewPassword) {
                alert('Passwords do not match.');
                return;
            }

            try {
                const response = await fetch('/api/auth/reset-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, code, newPassword })
                });

                const data = await response.json();

                if (data.success) {
                    alert('Password reset successful! You can now log in.');
                    showLogin();
                    document.getElementById('resetForm').reset();
                    document.getElementById('resetRequestForm').reset();
                } else {
                    alert(data.message || 'Password reset failed. Please try again.');
                }
            } catch (error) {
                console.error('Password reset error:', error);
                alert('Password reset failed. Please try again.');
            }
        });

        // Bulk Location Functions
        function addBulkLocations() {
            document.getElementById('bulkLocationOverlay').classList.remove('hidden');
            document.getElementById('bulkLocationInput').focus();

            // Add event listener for real-time preview
            document.getElementById('bulkLocationInput').addEventListener('input', updateBulkLocationPreview);
        }

        function closeBulkLocationModal() {
            document.getElementById('bulkLocationOverlay').classList.add('hidden');
            document.getElementById('bulkLocationInput').value = '';
            document.getElementById('bulkLocationPreview').style.display = 'none';
            document.getElementById('floatingActionButton').style.display = 'none';
            document.getElementById('manyLocationsWarning').style.display = 'none';
        }

        function updateBulkLocationPreview() {
            const input = document.getElementById('bulkLocationInput').value;
            const preview = document.getElementById('bulkLocationPreview');
            const previewList = document.getElementById('bulkLocationPreviewList');
            const countElement = document.getElementById('bulkLocationCount');
            const floatingButton = document.getElementById('floatingActionButton');
            const warning = document.getElementById('manyLocationsWarning');

            if (!input.trim()) {
                preview.style.display = 'none';
                countElement.textContent = '0';
                floatingButton.style.display = 'none';
                warning.style.display = 'none';
                return;
            }

            const locations = parseBulkLocations(input);
            countElement.textContent = locations.length;

            if (locations.length === 0) {
                preview.style.display = 'none';
                floatingButton.style.display = 'none';
                warning.style.display = 'none';
                return;
            }

            preview.style.display = 'block';
            previewList.innerHTML = '';

            locations.forEach(location => {
                const chip = document.createElement('span');
                chip.className = 'location-chip';
                chip.textContent = location;
                chip.style.margin = '0';
                previewList.appendChild(chip);
            });

            // Show floating button and warning if there are many locations
            if (locations.length > 10) {
                floatingButton.style.display = 'block';
                warning.style.display = 'block';
            } else {
                floatingButton.style.display = 'none';
                warning.style.display = 'none';
            }
        }

        function parseBulkLocations(input) {
            if (!input.trim()) return [];

            // Split by multiple delimiters: commas, newlines, semicolons
            const rawLocations = input.split(/[,\n;]/).map(loc => loc.trim()).filter(loc => loc);

            const processedLocations = [];

            for (const location of rawLocations) {
                if (!location) continue;

                // Try to detect and format the location
                const formattedLocation = detectAndFormatLocation(location);
                if (formattedLocation) {
                    processedLocations.push(formattedLocation);
                }
            }

            return [...new Set(processedLocations)]; // Remove duplicates
        }

        function detectAndFormatLocation(location) {
            // Remove extra whitespace and normalize
            location = location.trim().replace(/\s+/g, ' ');

            // Common patterns for city, state
            const patterns = [
                // "City, State" format
                /^([^,]+),\s*([A-Z]{2})$/i,
                // "City State" format (no comma)
                /^([^,]+)\s+([A-Z]{2})$/i,
                // "City, State Name" format
                /^([^,]+),\s*([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)$/i,
                // "City State Name" format (no comma)
                /^([^,]+)\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)$/i
            ];

            for (const pattern of patterns) {
                const match = location.match(pattern);
                if (match) {
                    const city = match[1].trim();
                    const state = match[2].trim();

                    // Convert state name to abbreviation if needed
                    const stateAbbr = convertStateNameToAbbr(state);

                    return `${city}, ${stateAbbr}`;
                }
            }

            // If no pattern matches, try to guess
            return guessLocationFormat(location);
        }

        function convertStateNameToAbbr(stateName) {
            const stateMap = {
                'alabama': 'AL', 'alaska': 'AK', 'arizona': 'AZ', 'arkansas': 'AR', 'california': 'CA',
                'colorado': 'CO', 'connecticut': 'CT', 'delaware': 'DE', 'florida': 'FL', 'georgia': 'GA',
                'hawaii': 'HI', 'idaho': 'ID', 'illinois': 'IL', 'indiana': 'IN', 'iowa': 'IA',
                'kansas': 'KS', 'kentucky': 'KY', 'louisiana': 'LA', 'maine': 'ME', 'maryland': 'MD',
                'massachusetts': 'MA', 'michigan': 'MI', 'minnesota': 'MN', 'mississippi': 'MS', 'missouri': 'MO',
                'montana': 'MT', 'nebraska': 'NE', 'nevada': 'NV', 'new hampshire': 'NH', 'new jersey': 'NJ',
                'new mexico': 'NM', 'new york': 'NY', 'north carolina': 'NC', 'north dakota': 'ND', 'ohio': 'OH',
                'oklahoma': 'OK', 'oregon': 'OR', 'pennsylvania': 'PA', 'rhode island': 'RI', 'south carolina': 'SC',
                'south dakota': 'SD', 'tennessee': 'TN', 'texas': 'TX', 'utah': 'UT', 'vermont': 'VT',
                'virginia': 'VA', 'washington': 'WA', 'west virginia': 'WV', 'wisconsin': 'WI', 'wyoming': 'WY'
            };

            const normalizedState = stateName.toLowerCase();
            return stateMap[normalizedState] || stateName.toUpperCase();
        }

        function guessLocationFormat(location) {
            // If it's already in a recognizable format, return as is
            if (/^[^,]+,\s*[A-Z]{2}$/i.test(location)) {
                return location;
            }

            // Try to extract city and state from common patterns
            const words = location.split(' ');

            // If we have at least 2 words, assume last word is state
            if (words.length >= 2) {
                const lastWord = words[words.length - 1];
                const city = words.slice(0, -1).join(' ');

                // Check if last word looks like a state abbreviation
                if (/^[A-Z]{2}$/i.test(lastWord)) {
                    return `${city}, ${lastWord.toUpperCase()}`;
                }

                // Check if last word is a state name
                const stateAbbr = convertStateNameToAbbr(lastWord);
                if (stateAbbr !== lastWord.toUpperCase()) {
                    return `${city}, ${stateAbbr}`;
                }
            }

            // If we can't parse it, return as is
            return location;
        }

        function processBulkLocations() {
            const input = document.getElementById('bulkLocationInput').value;
            const locations = parseBulkLocations(input);

            if (locations.length === 0) {
                alert('Please enter at least one valid location.');
                return;
            }

            // Add all locations to the location list
            const container = document.getElementById('locationList');
            locations.forEach(location => {
                // Check if location already exists
                const existingChips = container.querySelectorAll('.location-chip');
                let exists = false;
                for (let chip of existingChips) {
                    if (chip.textContent.toLowerCase() === location.toLowerCase()) {
                        exists = true;
                        break;
                    }
                }

                if (!exists) {
                    const chip = document.createElement('button');
                    chip.className = 'location-chip';
                    chip.textContent = location;
                    chip.onclick = () => chip.remove();
                    container.appendChild(chip);
                }
            });

            closeBulkLocationModal();

            // Show success message
            const notification = document.createElement('div');
            notification.style.cssText = `
                background: #d4edda;
                color: #155724;
                padding: 10px;
                border-radius: 4px;
                margin-top: 10px;
                font-size: 14px;
                border: 1px solid #c3e6cb;
            `;
            notification.innerHTML = `✅ Added ${locations.length} location(s) successfully!`;
            container.parentNode.appendChild(notification);

            // Remove notification after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        function addPopularCities() {
            const popularCities = [
                'New York, NY',
                'Los Angeles, CA',
                'Chicago, IL',
                'Houston, TX',
                'Phoenix, AZ',
                'Philadelphia, PA',
                'San Antonio, TX',
                'San Diego, CA',
                'Dallas, TX',
                'San Jose, CA',
                'Austin, TX',
                'Jacksonville, FL',
                'Fort Worth, TX',
                'Columbus, OH',
                'Charlotte, NC',
                'San Francisco, CA',
                'Indianapolis, IN',
                'Seattle, WA',
                'Denver, CO',
                'Washington, DC'
            ];

            document.getElementById('bulkLocationInput').value = popularCities.join('\n');
            updateBulkLocationPreview();
        }

        function addCaliforniaCities() {
            const californiaCities = [
                'Los Angeles, CA',
                'San Diego, CA',
                'San Jose, CA',
                'San Francisco, CA',
                'Fresno, CA',
                'Sacramento, CA',
                'Long Beach, CA',
                'Oakland, CA',
                'Bakersfield, CA',
                'Anaheim, CA',
                'Santa Ana, CA',
                'Riverside, CA',
                'Stockton, CA',
                'Irvine, CA',
                'Fremont, CA',
                'Chula Vista, CA',
                'Glendale, CA',
                'Modesto, CA',
                'San Bernardino, CA',
                'Fontana, CA'
            ];

            document.getElementById('bulkLocationInput').value = californiaCities.join('\n');
            updateBulkLocationPreview();
        }

        function addTexasCities() {
            const texasCities = [
                'Houston, TX',
                'San Antonio, TX',
                'Dallas, TX',
                'Austin, TX',
                'Fort Worth, TX',
                'El Paso, TX',
                'Arlington, TX',
                'Corpus Christi, TX',
                'Plano, TX',
                'Laredo, TX',
                'Lubbock, TX',
                'Garland, TX',
                'Irving, TX',
                'Amarillo, TX',
                'Grand Prairie, TX',
                'McKinney, TX',
                'Frisco, TX',
                'McAllen, TX',
                'Waco, TX',
                'Carrollton, TX'
            ];

            document.getElementById('bulkLocationInput').value = texasCities.join('\n');
            updateBulkLocationPreview();
        }

        function addFloridaCities() {
            const floridaCities = [
                'Jacksonville, FL',
                'Miami, FL',
                'Tampa, FL',
                'Orlando, FL',
                'St. Petersburg, FL',
                'Hialeah, FL',
                'Tallahassee, FL',
                'Fort Lauderdale, FL',
                'Port St. Lucie, FL',
                'Cape Coral, FL',
                'Gainesville, FL',
                'Coral Springs, FL',
                'Clearwater, FL',
                'Miami Gardens, FL',
                'Palm Bay, FL',
                'West Palm Beach, FL',
                'Sunrise, FL',
                'Lakeland, FL',
                'Boca Raton, FL',
                'Hollywood, FL'
            ];

            document.getElementById('bulkLocationInput').value = floridaCities.join('\n');
            updateBulkLocationPreview();
        }

        function addNewYorkCities() {
            const newYorkCities = [
                'New York, NY',
                'Buffalo, NY',
                'Rochester, NY',
                'Yonkers, NY',
                'Syracuse, NY',
                'Albany, NY',
                'New Rochelle, NY',
                'Mount Vernon, NY',
                'Schenectady, NY',
                'Utica, NY',
                'White Plains, NY',
                'Hempstead, NY',
                'Troy, NY',
                'Niagara Falls, NY',
                'Binghamton, NY',
                'Freeport, NY',
                'Valley Stream, NY',
                'Long Beach, NY',
                'Ithaca, NY',
                'Saratoga Springs, NY'
            ];

            document.getElementById('bulkLocationInput').value = newYorkCities.join('\n');
            updateBulkLocationPreview();
        }

        function clearBulkInput() {
            document.getElementById('bulkLocationInput').value = '';
            document.getElementById('bulkLocationPreview').style.display = 'none';
        }

        function scrollToBottom() {
            const modal = document.querySelector('#bulkLocationOverlay .login-modal');
            modal.scrollTo({
                top: modal.scrollHeight,
                behavior: 'smooth'
            });
        }

        async function logout() {
            currentUser = null;
            sessionId = null;
            try {
                localStorage.removeItem('outtaWebSessionId');
                localStorage.removeItem('outtaWebCurrentUser');
            } catch { }
            try {
                if (window.SUPABASE && window.SUPABASE.auth) {
                    await window.SUPABASE.auth.signOut();
                }
            } catch (e) {
                console.log('ℹ️ Supabase sign-out error:', e.message);
            }
            showLogin();
        }

        async function testServerConnection() {
            console.log('🧪 Testing server connection...');
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                console.log('✅ Server health check:', data);
                alert('✅ Server is working! Check console for details.');
            } catch (error) {
                console.error('❌ Server connection failed:', error);
                alert('❌ Server connection failed! Check console for details.');
            }
        }

        async function testLoginDirectly() {
            console.log('🔥 Testing login directly...');
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'dantedesignzofficial@gmail.com',
                        password: 'yourpassword123'
                    })
                });

                console.log('📥 Login response status:', response.status);
                const data = await response.json();
                console.log('📥 Login response data:', data);

                if (data.success) {
                    console.log('✅ Direct login successful!');
                    currentUser = data.user;
                    sessionId = data.sessionId;
                    localStorage.setItem('outtaWebSessionId', sessionId);
                    showApp();
                    alert('✅ Direct login successful! You should now see the app.');
                } else {
                    console.log('❌ Direct login failed:', data.message);
                    alert('❌ Direct login failed: ' + data.message);
                }
            } catch (error) {
                console.error('💥 Direct login error:', error);
                alert('💥 Direct login error: ' + error.message);
            }
        }

        function forceLogin() {
            console.log('💜 Force login triggered...');

            const user = HARDCODED_USERS[1]; // Dante's account
            console.log('💜 Using user:', user);

            // Set global variables
            currentUser = user;
            sessionId = 'force-session-' + Date.now();

            // Update global state (most reliable)
            window.LOGIN_STATE.isLoggedIn = true;
            window.LOGIN_STATE.currentUser = user;
            window.LOGIN_STATE.sessionId = sessionId;

            // Try localStorage (optional)
            try {
                localStorage.setItem('outtaWebSessionId', sessionId);
                localStorage.setItem('outtaWebCurrentUser', JSON.stringify(user));
                console.log('💜 Data saved to localStorage');
            } catch (error) {
                console.log('💜 localStorage not available, using global state only');
            }

            // Reset form and show app
            document.getElementById('loginForm').reset();
            showApp();

            console.log('💜 Force login completed successfully');
            alert('💜 Force login successful! Welcome ' + user.name + '!');
        }





        function showRegisterForm() {
            showRegister();
        }

        function showLoginForm() {
            showLogin();
        }

        function clearAuthData() {
            console.log('🧹 Clearing all authentication data...');

            // Clear global variables
            currentUser = null;
            sessionId = null;

            // Clear localStorage
            localStorage.removeItem('outtaWebSessionId');
            localStorage.removeItem('outtaWebCurrentUser');
            localStorage.removeItem('businessFinderCurrentUser'); // Also clear the old key just in case

            // Show login screen
            showLogin();

            console.log('🧹 Authentication data cleared');
            alert('🧹 All authentication data cleared. Please login again.');
        }

        function debugAuthState() {
            console.log('🔍 === AUTH DEBUG STATE ===');
            console.log('🔍 currentUser:', currentUser);
            console.log('🔍 sessionId:', sessionId);
            console.log('🔍 localStorage outtaWebCurrentUser:', localStorage.getItem('outtaWebCurrentUser'));
            console.log('🔍 localStorage outtaWebSessionId:', localStorage.getItem('outtaWebSessionId'));
            console.log('🔍 localStorage businessFinderCurrentUser:', localStorage.getItem('businessFinderCurrentUser'));
            console.log('🔍 HARDCODED_USERS:', HARDCODED_USERS);
            console.log('🔍 Login overlay hidden?', document.getElementById('loginOverlay').classList.contains('hidden'));
            console.log('🔍 Container hidden?', document.querySelector('.container').classList.contains('hidden'));
            console.log('🔍 === END DEBUG ===');

            const debugInfo = {
                currentUser: currentUser,
                sessionId: sessionId,
                localStorage: {
                    outtaWebCurrentUser: localStorage.getItem('outtaWebCurrentUser'),
                    outtaWebSessionId: localStorage.getItem('outtaWebSessionId'),
                    businessFinderCurrentUser: localStorage.getItem('businessFinderCurrentUser')
                },
                hardcodedUsers: HARDCODED_USERS,
                uiState: {
                    loginOverlayHidden: document.getElementById('loginOverlay').classList.contains('hidden'),
                    containerHidden: document.querySelector('.container').classList.contains('hidden')
                }
            };

            alert('🔍 Debug info logged to console. Check browser developer tools.');
            return debugInfo;
        }

        async function testAllEndpoints() {
            console.log('🧪 Testing all API endpoints...');

            const endpoints = [
                { name: 'Early Test', url: '/api/test-early', method: 'POST' },
                { name: 'Business Test', url: '/api/business/test', method: 'POST' },
                { name: 'Instagram Search', url: '/api/instagram/search', method: 'POST' },
                { name: 'Contact Search', url: '/api/business/contact-search', method: 'POST' }
            ];

            for (const endpoint of endpoints) {
                try {
                    console.log(`🔍 Testing ${endpoint.name}...`);

                    const response = await fetch(endpoint.url, {
                        method: endpoint.method,
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': googleSearchApiKey || 'test-key',
                            'x-search-engine-id': searchEngineId || 'test-engine',
                            'x-google-search-key': googleSearchApiKey || 'test-key'
                        },
                        body: JSON.stringify({
                            test: 'test',
                            businessName: 'Test Business',
                            city: 'Test City',
                            state: 'TS',
                            niche: 'test',
                            location: 'test'
                        })
                    });

                    console.log(`✅ ${endpoint.name}: HTTP ${response.status}`);

                    if (response.ok) {
                        const data = await response.json();
                        console.log(`📄 ${endpoint.name} response:`, data);
                    } else {
                        const errorText = await response.text();
                        console.log(`❌ ${endpoint.name} error:`, errorText);
                    }

                } catch (error) {
                    console.error(`❌ ${endpoint.name} failed:`, error);
                }
            }

            alert('🧪 Endpoint testing complete. Check console for results.');
        }

        // Instagram Contact Finder Functions

        function saveInstagramApiKeys() {
            const apiKey = document.getElementById('instagramSearchApiKey').value.trim();
            const searchEngineId = document.getElementById('instagramSearchEngineId').value.trim();

            if (!apiKey || !searchEngineId) {
                alert('❌ Please enter both API key and Search Engine ID');
                return;
            }

            try {
                localStorage.setItem('instagramSearchApiKey', apiKey);
                localStorage.setItem('instagramSearchEngineId', searchEngineId);

                document.getElementById('instagramApiStatus').innerHTML =
                    '<span class="status-indicator" style="color: #28a745;">✅ Configuration saved</span>';

                console.log('✅ Instagram API credentials saved');
                alert('✅ Instagram API credentials saved successfully!');
            } catch (error) {
                console.error('❌ Error saving Instagram API credentials:', error);
                alert('❌ Error saving credentials: ' + error.message);
            }
        }

        async function testInstagramApiKeys() {
            const apiKey = document.getElementById('instagramSearchApiKey').value.trim() ||
                localStorage.getItem('instagramSearchApiKey');
            const searchEngineId = document.getElementById('instagramSearchEngineId').value.trim() ||
                localStorage.getItem('instagramSearchEngineId');

            if (!apiKey || !searchEngineId) {
                alert('❌ Please enter API credentials first');
                return;
            }

            document.getElementById('instagramApiStatus').innerHTML =
                '<span class="status-indicator" style="color: #007bff;">🧪 Testing...</span>';

            try {
                const response = await fetch('/api/instagram/contact-finder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-google-search-key': apiKey,
                        'x-search-engine-id': searchEngineId
                    },
                    body: JSON.stringify({
                        niche: 'test',
                        location: 'test'
                    })
                });

                if (response.ok) {
                    document.getElementById('instagramApiStatus').innerHTML =
                        '<span class="status-indicator" style="color: #28a745;">✅ Connection successful</span>';
                    alert('✅ API connection test successful!');
                } else {
                    const errorData = await response.json();
                    document.getElementById('instagramApiStatus').innerHTML =
                        '<span class="status-indicator" style="color: #dc3545;">❌ Connection failed</span>';
                    alert('❌ API test failed: ' + (errorData.error?.userMessage || 'Unknown error'));
                }
            } catch (error) {
                console.error('❌ Instagram API test failed:', error);
                document.getElementById('instagramApiStatus').innerHTML =
                    '<span class="status-indicator" style="color: #dc3545;">❌ Connection failed</span>';
                alert('❌ Connection test failed: ' + error.message);
            }
        }

        async function searchInstagramProfiles() {
            const niche = document.getElementById('instagramNiche').value.trim();
            const location = document.getElementById('instagramLocation').value.trim();
            const maxResults = document.getElementById('instagramMaxResults').value;

            if (!niche || !location) {
                alert('❌ Please enter both niche and location');
                return;
            }

            const apiKey = document.getElementById('instagramSearchApiKey').value.trim() ||
                localStorage.getItem('instagramSearchApiKey');
            const searchEngineId = document.getElementById('instagramSearchEngineId').value.trim() ||
                localStorage.getItem('instagramSearchEngineId');

            if (!apiKey || !searchEngineId) {
                alert('❌ Please configure your API credentials first');
                return;
            }

            // Show loading state
            document.getElementById('instagramLoading').style.display = 'block';
            document.getElementById('instagramResults').style.display = 'none';
            document.getElementById('instagramError').style.display = 'none';
            document.getElementById('instagramSearchBtn').disabled = true;
            document.getElementById('searchNicheDisplay').textContent = niche;
            document.getElementById('searchLocationDisplay').textContent = location;

            try {
                console.log(`🔍 Searching Instagram for ${niche} in ${location}`);

                const response = await fetch('/api/instagram/contact-finder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-google-search-key': apiKey,
                        'x-search-engine-id': searchEngineId
                    },
                    body: JSON.stringify({
                        niche: niche,
                        location: location,
                        maxResults: parseInt(maxResults)
                    })
                });

                const data = await response.json();

                if (data.success) {
                    instagramSearchResults = data.data;
                    displayInstagramResults(data.data);
                } else {
                    showInstagramError(data.error?.userMessage || 'Search failed');
                }

            } catch (error) {
                console.error('❌ Instagram search failed:', error);
                showInstagramError('Network error. Please check your connection and try again.');
            } finally {
                document.getElementById('instagramLoading').style.display = 'none';
                document.getElementById('instagramSearchBtn').disabled = false;
            }
        }

        function displayInstagramResults(data) {
            const resultsList = document.getElementById('instagramResultsList');
            const resultsSection = document.getElementById('instagramResults');

            if (!data.profiles || data.profiles.length === 0) {
                resultsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px;">
                        <h4 style="color: #6c757d; margin: 0 0 10px 0;">📭 No Results Found</h4>
                        <p style="color: #6c757d; margin: 0;">${data.message || 'No Instagram profiles found for this search'}</p>
                    </div>
                `;
            } else {
                let resultsHtml = '';

                data.profiles.forEach((profile, index) => {
                    resultsHtml += `
                        <div class="result-item" style="background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <h5 style="margin: 0 0 10px 0; color: #333; font-weight: 600;">${profile.name}</h5>
                                    <p style="margin: 0 0 10px 0; color: #007bff; font-weight: 500;">@${profile.username}</p>
                                    <a href="${profile.profileUrl}" target="_blank" style="color: #28a745; text-decoration: none; font-weight: 500;">
                                        🔗 ${profile.profileUrl}
                                    </a>
                                </div>
                                <div style="text-align: right; color: #6c757d; font-size: 14px;">
                                    #${index + 1}
                                </div>
                            </div>
                        </div>
                    `;
                });

                resultsList.innerHTML = resultsHtml;
            }

            // Update stats
            document.getElementById('resultsCount').textContent = data.profiles?.length || 0;
            document.getElementById('searchTimestamp').textContent = new Date(data.searchDate).toLocaleString();

            // Show results section
            resultsSection.style.display = 'block';
        }

        function showInstagramError(message) {
            document.getElementById('instagramError').style.display = 'block';
            document.getElementById('instagramErrorMessage').textContent = message;
            document.getElementById('instagramResults').style.display = 'none';
        }

        function retryInstagramSearch() {
            document.getElementById('instagramError').style.display = 'none';
            searchInstagramProfiles();
        }

        function exportInstagramResults(format) {
            if (!instagramSearchResults || !instagramSearchResults.profiles || instagramSearchResults.profiles.length === 0) {
                alert('❌ No results to export');
                return;
            }

            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const filename = `instagram-contacts-${instagramSearchResults.niche}-${instagramSearchResults.location}-${timestamp}`;

            if (format === 'json') {
                const jsonData = JSON.stringify(instagramSearchResults, null, 2);
                downloadFile(jsonData, `${filename}.json`, 'application/json');
            } else if (format === 'csv') {
                const csvData = convertToCSV(instagramSearchResults);
                downloadFile(csvData, `${filename}.csv`, 'text/csv');
            }
        }

        function convertToCSV(data) {
            const headers = ['Name', 'Username', 'Profile URL', 'Niche', 'Location', 'Search Date'];
            const rows = data.profiles.map(profile => [
                `"${profile.name}"`,
                `"@${profile.username}"`,
                `"${profile.profileUrl}"`,
                `"${data.niche}"`,
                `"${data.location}"`,
                `"${new Date(data.searchDate).toLocaleString()}"`
            ]);

            return [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
        }

        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Load saved API credentials on page load
        document.addEventListener('DOMContentLoaded', function () {
            const savedApiKey = localStorage.getItem('instagramSearchApiKey');
            const savedSearchEngineId = localStorage.getItem('instagramSearchEngineId');

            if (savedApiKey) {
                document.getElementById('instagramSearchApiKey').value = savedApiKey;
            }
            if (savedSearchEngineId) {
                document.getElementById('instagramSearchEngineId').value = savedSearchEngineId;
            }

            if (savedApiKey && savedSearchEngineId) {
                document.getElementById('instagramApiStatus').innerHTML =
                    '<span class="status-indicator" style="color: #28a745;">✅ Configuration loaded</span>';
            }
        });

        function testLocalStorage() {
            console.log('💾 Testing localStorage functionality...');

            try {
                // Test basic localStorage operations
                const testKey = 'outtaWebTest';
                const testValue = 'test-' + Date.now();

                console.log('💾 Setting test value:', testValue);
                localStorage.setItem(testKey, testValue);

                const retrievedValue = localStorage.getItem(testKey);
                console.log('💾 Retrieved test value:', retrievedValue);

                if (retrievedValue === testValue) {
                    console.log('✅ localStorage is working correctly');
                    localStorage.removeItem(testKey);
                    alert('✅ localStorage is working correctly on this domain!');
                } else {
                    console.log('❌ localStorage value mismatch');
                    alert('❌ localStorage is not working correctly - value mismatch');
                }

                // Test JSON storage
                const testObject = { test: true, timestamp: Date.now() };
                localStorage.setItem(testKey + 'JSON', JSON.stringify(testObject));
                const retrievedObject = JSON.parse(localStorage.getItem(testKey + 'JSON'));

                if (retrievedObject.test === true) {
                    console.log('✅ localStorage JSON storage is working');
                    localStorage.removeItem(testKey + 'JSON');
                } else {
                    console.log('❌ localStorage JSON storage failed');
                    alert('❌ localStorage JSON storage is not working correctly');
                }

            } catch (error) {
                console.error('❌ localStorage test failed:', error);
                alert('❌ localStorage test failed: ' + error.message + '\n\nThis might be due to browser privacy settings or Heroku domain restrictions.');
            }
        }

        // Test function to verify JavaScript is working
        function testBasicFunctionality() {
            console.log('🧪 Testing basic functionality...');
            alert('✅ JavaScript is working! If you can see this alert, the basic functionality is operational.');
        }

        function ultraSimpleLogin() {
            console.log('🚀 Ultra simple login triggered...');

            // Just set the user directly without any storage
            const user = HARDCODED_USERS[1]; // Dante's account

            console.log('🚀 Setting user directly:', user);

            // Set global variables
            currentUser = user;
            sessionId = 'ultra-simple-' + Date.now();

            // Update global state
            window.LOGIN_STATE.isLoggedIn = true;
            window.LOGIN_STATE.currentUser = user;
            window.LOGIN_STATE.sessionId = sessionId;

            // Show app immediately
            showApp();

            console.log('🚀 Ultra simple login completed');
            alert('🚀 Ultra simple login successful! Welcome ' + user.name + '!\n\nThis bypassed all storage mechanisms.');
        }

        // ======= BUSINESS CONTACT FINDER FUNCTIONALITY =======

        // Global variables for contact search
        let contactSearchResults = [];
        let isContactSearchActive = false;

        // Check API status for contact search
        async function checkContactApiStatus() {
            console.log('🔍 Checking API status for contact search...');

            // Get keys from Contact Finder form or global variables
            const searchKey = document.getElementById('contactGoogleSearchKey')?.value || googleSearchApiKey || localStorage.getItem('googleSearchApiKey');
            const engineId = document.getElementById('contactSearchEngineId')?.value || searchEngineId || localStorage.getItem('searchEngineId');

            // Update Google Custom Search API status
            const searchStatus = document.getElementById('searchApiStatus');
            if (searchKey && engineId) {
                searchStatus.innerHTML = '✅ Configured';
                searchStatus.className = 'status-indicator status-success';
            } else {
                searchStatus.innerHTML = '❌ Missing';
                searchStatus.className = 'status-indicator status-error';
            }

            // Update Places API status (just show what we're using)
            const placesStatus = document.getElementById('placesApiStatus');
            placesStatus.innerHTML = '🔍 Using Custom Search Only';
            placesStatus.className = 'status-indicator status-info';
        }

        // Start contact search process
        async function startContactSearch() {
            if (isContactSearchActive) {
                console.log('⚠️ Contact search already in progress');
                return;
            }

            const niche = document.getElementById('contactNiche').value;
            const location = document.getElementById('contactLocation').value.trim();
            const maxResults = parseInt(document.getElementById('maxContactResults').value) || 50;

            // Validation
            if (!niche) {
                alert('Please select a business niche.');
                return;
            }

            if (!location) {
                alert('Please enter a location.');
                return;
            }

            const searchKey = document.getElementById('contactGoogleSearchKey')?.value || googleSearchApiKey || localStorage.getItem('googleSearchApiKey');
            const engineId = document.getElementById('contactSearchEngineId')?.value || searchEngineId || localStorage.getItem('searchEngineId');
            if (!searchKey || !engineId) {
                alert('Google Custom Search API key and Search Engine ID are required. Please configure them above.');
                return;
            }

            console.log(`🚀 Starting contact search for ${niche} in ${location}`);
            console.log(`🔑 Using API Key: ${searchKey ? 'Present' : 'Missing'}`);
            console.log(`🆔 Using Engine ID: ${engineId ? 'Present' : 'Missing'}`);

            // Show progress and disable button
            isContactSearchActive = true;
            showContactProgress();
            document.getElementById('contactSearchBtn').disabled = true;
            document.getElementById('contactSearchBtn').innerHTML = '🔄 Searching...';

            try {
                console.log('📡 Testing early endpoint first');



                // Make API call to our new endpoint
                const response = await fetch('/api/business/contact-search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-google-search-key': searchKey,
                        'x-search-engine-id': engineId
                    },
                    body: JSON.stringify({
                        niche: niche,
                        location: location,
                        maxResults: maxResults
                    })
                });

                let responseText;
                try {
                    responseText = await response.text();
                } catch (readError) {
                    throw new Error(`Failed to read response: ${readError.message}`);
                }

                if (!response.ok) {
                    let errorMessage = `HTTP ${response.status}`;
                    if (responseText) {
                        try {
                            const errorData = JSON.parse(responseText);
                            errorMessage = errorData.message || errorData.error || errorMessage;
                        } catch (parseError) {
                            // If JSON parsing fails, use the raw text
                            errorMessage = responseText || errorMessage;
                        }
                    }
                    throw new Error(errorMessage);
                }

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    throw new Error(`Failed to parse response: ${parseError.message}`);
                }

                console.log('✅ Contact search completed:', data);

                contactSearchResults = data.results || [];
                displayContactResults(contactSearchResults, data.message);

            } catch (error) {
                console.error('❌ Contact search failed:', error);
                alert(`Contact search failed: ${error.message}`);
                document.getElementById('contactResults').innerHTML = `
                    <div style="background: #f8d7da; color: #721c24; padding: 16px; border-radius: 8px; margin: 20px 0;">
                        <h4>❌ Search Failed</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            } finally {
                // Hide progress and re-enable button
                hideContactProgress();
                isContactSearchActive = false;
                document.getElementById('contactSearchBtn').disabled = false;
                document.getElementById('contactSearchBtn').innerHTML = '🚀 Find Business Contacts';
            }
        }

        // Show contact search progress
        function showContactProgress() {
            const progressDiv = document.getElementById('contactProgress');
            progressDiv.style.display = 'block';

            // Update progress status
            document.getElementById('contactProgressStatus').textContent = 'Initializing search...';
            document.getElementById('contactCurrentProgress').textContent = '0';
            document.getElementById('contactTotalProgress').textContent = '?';
            document.getElementById('contactProgressBar').style.width = '0%';
        }

        // Hide contact search progress
        function hideContactProgress() {
            const progressDiv = document.getElementById('contactProgress');
            progressDiv.style.display = 'none';
        }

        // Display contact search results
        function displayContactResults(results, message) {
            const resultsDiv = document.getElementById('contactResults');

            if (!results || results.length === 0) {
                resultsDiv.innerHTML = `
                    <div style="background: #fff3cd; color: #856404; padding: 16px; border-radius: 8px; margin: 20px 0;">
                        <h4>📭 No Results Found</h4>
                        <p>${message || 'No businesses found for the specified criteria.'}</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div style="background: #d4edda; color: #155724; padding: 16px; border-radius: 8px; margin: 20px 0;">
                    <h4>✅ Contact Search Complete</h4>
                    <p>${message || `Found ${results.length} businesses with contact information.`}</p>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0;">
                    <h3>📊 Contact Results (${results.length})</h3>
                    <div>
                        <button class="btn btn-success" onclick="exportContactResults('csv')" style="margin-right: 10px;">
                            📊 Export CSV
                        </button>
                        <button class="btn btn-primary" onclick="exportContactResults('json')">
                            📋 Export JSON
                        </button>
                    </div>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="results-table" style="width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 12px; text-align: left; font-weight: 600; border-bottom: 2px solid #e1e5e9;">Business Name</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; border-bottom: 2px solid #e1e5e9;">Phone</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; border-bottom: 2px solid #e1e5e9;">Email</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; border-bottom: 2px solid #e1e5e9;">Instagram</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; border-bottom: 2px solid #e1e5e9;">Address</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; border-bottom: 2px solid #e1e5e9;">Rating</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            results.forEach((business, index) => {
                const phoneDisplay = business.phone && business.phone !== 'Not found' ? business.phone : '❌ Not found';
                const emailDisplay = business.email && business.email !== 'Not found' ? business.email : '❌ Not found';
                const instagramDisplay = business.instagram && business.instagram !== 'Not found'
                    ? `<a href="${business.instagramUrl || '#'}" target="_blank" style="color: #007bff; text-decoration: none;">${business.instagram}</a>`
                    : '❌ Not found';
                const ratingDisplay = business.rating ? `⭐ ${business.rating}` : 'No rating';

                html += `
                    <tr style="border-bottom: 1px solid #e1e5e9;" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor='white'">
                        <td style="padding: 12px; font-weight: 600;">${business.businessName || 'N/A'}</td>
                        <td style="padding: 12px;">${phoneDisplay}</td>
                        <td style="padding: 12px;">${emailDisplay}</td>
                        <td style="padding: 12px;">${instagramDisplay}</td>
                        <td style="padding: 12px; font-size: 12px; color: #6c757d;">${business.address || 'N/A'}</td>
                        <td style="padding: 12px;">${ratingDisplay}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 14px; color: #6c757d;">
                    <h5 style="margin: 0 0 10px 0;">📈 Search Summary:</h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <div><strong>Total Found:</strong> ${results.length}</div>
                        <div><strong>With Phone:</strong> ${results.filter(b => b.phone && b.phone !== 'Not found').length}</div>
                        <div><strong>With Email:</strong> ${results.filter(b => b.email && b.email !== 'Not found').length}</div>
                        <div><strong>With Instagram:</strong> ${results.filter(b => b.instagram && b.instagram !== 'Not found').length}</div>
                    </div>
                </div>
            `;

            resultsDiv.innerHTML = html;
        }

        // Export contact results
        function exportContactResults(format) {
            if (!contactSearchResults || contactSearchResults.length === 0) {
                alert('No results to export.');
                return;
            }

            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const filename = `business-contacts-${timestamp}`;

            if (format === 'csv') {
                exportContactResultsCSV(filename);
            } else if (format === 'json') {
                exportContactResultsJSON(filename);
            }
        }

        // Export to CSV
        function exportContactResultsCSV(filename) {
            const headers = ['Business Name', 'Phone', 'Email', 'Instagram Handle', 'Instagram URL', 'Address', 'City', 'State', 'Rating', 'Review Count', 'Niche', 'Search Location'];
            const csvContent = [headers.join(',')];

            contactSearchResults.forEach(business => {
                const row = [
                    `"${(business.businessName || '').replace(/"/g, '""')}"`,
                    `"${(business.phone || '').replace(/"/g, '""')}"`,
                    `"${(business.email || '').replace(/"/g, '""')}"`,
                    `"${(business.instagram || '').replace(/"/g, '""')}"`,
                    `"${(business.instagramUrl || '').replace(/"/g, '""')}"`,
                    `"${(business.address || '').replace(/"/g, '""')}"`,
                    `"${(business.city || '').replace(/"/g, '""')}"`,
                    `"${(business.state || '').replace(/"/g, '""')}"`,
                    business.rating || '',
                    business.reviewCount || '',
                    `"${(business.niche || '').replace(/"/g, '""')}"`,
                    `"${(business.searchLocation || '').replace(/"/g, '""')}"`
                ];
                csvContent.push(row.join(','));
            });

            const csvString = csvContent.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');

            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename + '.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Export to JSON
        function exportContactResultsJSON(filename) {
            const jsonString = JSON.stringify({
                exportDate: new Date().toISOString(),
                totalResults: contactSearchResults.length,
                results: contactSearchResults
            }, null, 2);

            const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });
            const link = document.createElement('a');

            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename + '.json');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Initialize contact search when tab is switched
        function initializeContactSearch() {
            checkContactApiStatus();
            populateContactNiches();
            loadContactApiKeys();
            updateContactLocationRecommendations();
        }

        // Load API keys into Contact Finder form
        function loadContactApiKeys() {
            const searchKey = googleSearchApiKey || localStorage.getItem('googleSearchApiKey');
            const engineId = searchEngineId || localStorage.getItem('searchEngineId');

            if (searchKey) {
                document.getElementById('contactGoogleSearchKey').value = searchKey;
            }
            if (engineId) {
                document.getElementById('contactSearchEngineId').value = engineId;
            }
        }

        // Save API keys from Contact Finder form
        function saveContactApiKeys() {
            const searchKey = document.getElementById('contactGoogleSearchKey').value.trim();
            const engineId = document.getElementById('contactSearchEngineId').value.trim();

            if (!searchKey || !engineId) {
                alert('Please enter both API key and Search Engine ID.');
                return;
            }

            // Save to localStorage
            localStorage.setItem('googleSearchApiKey', searchKey);
            localStorage.setItem('searchEngineId', engineId);

            // Update global variables
            googleSearchApiKey = searchKey;
            searchEngineId = engineId;

            alert('✅ API keys saved successfully!');
            checkContactApiStatus();
        }

        // Test API keys from Contact Finder
        async function testContactApiKeys() {
            const searchKey = document.getElementById('contactGoogleSearchKey').value.trim();
            const engineId = document.getElementById('contactSearchEngineId').value.trim();

            if (!searchKey || !engineId) {
                alert('Please enter both API key and Search Engine ID first.');
                return;
            }

            // Update status to show testing
            document.getElementById('contactApiStatus').innerHTML = 
                '<span class="status-indicator" style="color: #007bff;">🧪 Testing API connection...</span>';

            try {
                const testUrl = `https://www.googleapis.com/customsearch/v1?key=${searchKey}&cx=${engineId}&q=test&num=1`;
                const response = await fetch(testUrl);

                let responseText;
                try {
                    responseText = await response.text();
                } catch (readError) {
                    throw new Error(`Failed to read response: ${readError.message}`);
                }

                if (response.ok) {
                    if (!responseText) {
                        throw new Error('Empty response from Google API');
                    }

                    let data;
                    try {
                        data = JSON.parse(responseText);
                    } catch (parseError) {
                        throw new Error(`Invalid JSON response: ${parseError.message}`);
                    }

                    if (data.items) {
                        document.getElementById('contactApiStatus').innerHTML = 
                            '<span class="status-indicator" style="color: #28a745;">✅ API connection successful</span>';
                        alert('✅ API keys are working correctly!');
                    } else {
                        document.getElementById('contactApiStatus').innerHTML = 
                            '<span class="status-indicator" style="color: #ffc107;">⚠️ API works but no results</span>';
                        alert('⚠️ API keys work but no search results. This might be normal.');
                    }
                } else {
                    let errorMessage = `HTTP ${response.status}`;
                    
                    if (responseText) {
                        try {
                            const errorData = JSON.parse(responseText);
                            errorMessage = errorData.error?.message || errorData.message || errorMessage;
                        } catch (parseError) {
                            // If JSON parsing fails, use the raw text or status
                            errorMessage = responseText.length > 200 ? `HTTP ${response.status}` : responseText || errorMessage;
                        }
                    }
                    
                    document.getElementById('contactApiStatus').innerHTML = 
                        '<span class="status-indicator" style="color: #dc3545;">❌ API connection failed</span>';
                    alert(`❌ API test failed: ${errorMessage}`);
                }
            } catch (error) {
                console.error('❌ API test error:', error);
                document.getElementById('contactApiStatus').innerHTML = 
                    '<span class="status-indicator" style="color: #dc3545;">❌ Connection error</span>';
                alert(`❌ Connection test failed: ${error.message}`);
            }
        }

        // Copy API keys from Instagram tab
        function loadKeysFromInstagram() {
            const searchKey = googleSearchApiKey || localStorage.getItem('googleSearchApiKey');
            const engineId = searchEngineId || localStorage.getItem('searchEngineId');

            if (searchKey && engineId) {
                document.getElementById('contactGoogleSearchKey').value = searchKey;
                document.getElementById('contactSearchEngineId').value = engineId;
                alert('✅ API keys copied from Instagram tab!');
            } else {
                alert('⚠️ No API keys found in Instagram tab. Please configure them there first.');
            }
        }

        // Handle location input with autocomplete
        function handleContactLocationInput(value) {
            const container = document.getElementById('contactLocationRecommendations');

            if (!value || value.length < 2) {
                container.style.display = 'none';
                return;
            }

            // Get location recommendations
            const recommendations = getLocationRecommendations(value);

            if (recommendations.length > 0) {
                let html = '<div style="background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; position: absolute; width: 100%; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';

                recommendations.forEach(location => {
                    html += `<div onclick="selectContactLocation('${location}')" style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; hover:background-color: #f5f5f5;" onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor='white'">${location}</div>`;
                });

                html += '</div>';
                container.innerHTML = html;
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }

        // Select location from autocomplete
        function selectContactLocation(location) {
            document.getElementById('contactLocation').value = location;
            document.getElementById('contactLocationRecommendations').style.display = 'none';
        }

        // Get location recommendations (reuse from search tab)
        function getLocationRecommendations(query) {
            const allLocations = [
                // Popular Cities
                'Los Angeles, CA', 'New York, NY', 'Chicago, IL', 'Houston, TX', 'Phoenix, AZ',
                'Philadelphia, PA', 'San Antonio, TX', 'San Diego, CA', 'Dallas, TX', 'San Jose, CA',
                'Austin, TX', 'Jacksonville, FL', 'Fort Worth, TX', 'Columbus, OH', 'Charlotte, NC',
                'San Francisco, CA', 'Indianapolis, IN', 'Seattle, WA', 'Denver, CO', 'Washington, DC',
                'Boston, MA', 'El Paso, TX', 'Nashville, TN', 'Detroit, MI', 'Oklahoma City, OK',
                'Portland, OR', 'Las Vegas, NV', 'Memphis, TN', 'Louisville, KY', 'Baltimore, MD',
                'Milwaukee, WI', 'Albuquerque, NM', 'Tucson, AZ', 'Fresno, CA', 'Sacramento, CA',
                'Mesa, AZ', 'Kansas City, MO', 'Atlanta, GA', 'Long Beach, CA', 'Colorado Springs, CO',
                'Raleigh, NC', 'Miami, FL', 'Virginia Beach, VA', 'Omaha, NE', 'Oakland, CA',
                'Minneapolis, MN', 'Tulsa, OK', 'Arlington, TX', 'Tampa, FL', 'New Orleans, LA',

                // California Cities
                'Anaheim, CA', 'Santa Ana, CA', 'Riverside, CA', 'Stockton, CA', 'Irvine, CA',
                'Chula Vista, CA', 'Fremont, CA', 'San Bernardino, CA', 'Modesto, CA', 'Fontana, CA',
                'Oxnard, CA', 'Moreno Valley, CA', 'Huntington Beach, CA', 'Glendale, CA', 'Santa Clarita, CA',

                // Texas Cities
                'Plano, TX', 'Laredo, TX', 'Lubbock, TX', 'Garland, TX', 'Irving, TX',
                'Amarillo, TX', 'Grand Prairie, TX', 'Brownsville, TX', 'McKinney, TX', 'Frisco, TX',

                // Florida Cities
                'Orlando, FL', 'St. Petersburg, FL', 'Hialeah, FL', 'Tallahassee, FL', 'Cape Coral, FL',
                'Fort Lauderdale, FL', 'Port St. Lucie, FL', 'Pembroke Pines, FL', 'Hollywood, FL', 'Miramar, FL',

                // Other Major Cities
                'Cleveland, OH', 'Cincinnati, OH', 'Toledo, OH', 'Akron, OH', 'Dayton, OH',
                'Pittsburgh, PA', 'Allentown, PA', 'Erie, PA', 'Reading, PA', 'Scranton, PA',
                'Albany, NY', 'Buffalo, NY', 'Rochester, NY', 'Syracuse, NY', 'Yonkers, NY'
            ];

            return allLocations.filter(location =>
                location.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 8);
        }

        // Update contact location recommendations
        function updateContactLocationRecommendations() {
            // This function can be called to refresh recommendations if needed
            console.log('Contact location recommendations ready');
        }

        // Populate Contact Finder niche dropdown with all available niches
        function populateContactNiches() {
            const selectElement = document.getElementById('contactNiche');
            if (!selectElement) return;

            // Clear existing options
            selectElement.innerHTML = '<option value="">Choose a niche...</option>';

            // Get all niches from the Search tab
            const allNiches = [
                // Personal Services
                'barber shops', 'hair salons', 'nail salons', 'spas', 'massage therapy', 'tattoo shops', 'piercing studios', 'tanning salons',
                // Home Services  
                'plumbers', 'electricians', 'HVAC contractors', 'roofers', 'painters', 'landscapers', 'cleaning services', 'handyman services',
                // Automotive
                'auto repair', 'car wash', 'tire shops', 'auto detailing', 'oil change', 'brake repair', 'transmission repair', 'auto body shops',
                // Professional Services
                'interior designers', 'photographers', 'personal trainers', 'tutors', 'accountants', 'lawyers', 'real estate agents', 'consultants',
                // Food & Beverage
                'restaurants', 'food trucks', 'catering', 'bakeries', 'coffee shops', 'pizza places', 'food delivery', 'meal prep',
                // Health & Wellness
                'chiropractors', 'dentists', 'physical therapy', 'yoga studios', 'gyms', 'nutritionists', 'acupuncture', 'mental health',
                // Additional Services
                'pet groomers', 'veterinarians', 'daycare centers', 'tutoring centers', 'music lessons', 'dance studios', 'martial arts', 'swimming lessons',
                // Service Businesses
                'dry cleaners', 'laundromats', 'tailors', 'shoe repair', 'jewelry repair', 'watch repair', 'key makers', 'locksmiths',
                // Retail & Specialty
                'florists', 'gift shops', 'antique stores', 'thrift stores', 'pawn shops', 'bookstores', 'libraries', 'art galleries',
                // Construction & Professional
                'construction companies', 'contractors', 'architects', 'engineers', 'surveyors', 'inspectors', 'appraisers', 'notaries'
            ];

            // Sort niches alphabetically
            allNiches.sort();

            // Add each niche as an option
            allNiches.forEach(niche => {
                const option = document.createElement('option');
                option.value = niche;
                option.textContent = niche.charAt(0).toUpperCase() + niche.slice(1); // Capitalize first letter
                selectElement.appendChild(option);
            });

            console.log(`✅ Populated Contact Finder with ${allNiches.length} niches`);
        }

        // ======= END BUSINESS CONTACT FINDER FUNCTIONALITY =======

        function autoLoginForHeroku() {
            console.log('🌐 Auto-login for Heroku triggered...');

            // Automatically log in as Dante
            const user = HARDCODED_USERS[1]; // Dante's account

            console.log('🌐 Auto-setting user:', user);

            // Set global variables
            currentUser = user;
            sessionId = 'heroku-auto-' + Date.now();

            // Update global state
            window.LOGIN_STATE.isLoggedIn = true;
            window.LOGIN_STATE.currentUser = user;
            window.LOGIN_STATE.sessionId = sessionId;

            // Force hide login overlay and show app immediately
            const loginOverlay = document.getElementById('loginOverlay');
            if (loginOverlay) {
                loginOverlay.classList.add('hidden');
                console.log('🌐 Login overlay hidden');
            }

            // Show app immediately (no login screen)
            showApp();

            console.log('🌐 Auto-login for Heroku completed');
            console.log('🌐 User is now logged in as:', user.name);

            // Double-check after a short delay
            setTimeout(() => {
                if (loginOverlay && !loginOverlay.classList.contains('hidden')) {
                    console.log('🌐 Force hiding login overlay again...');
                    loginOverlay.classList.add('hidden');
                }
            }, 100);
        }

        // =====================
        // DATA MIGRATION & SYNC FUNCTIONS
        // =====================

        function exportAllData() {
            console.log('📤 Exporting all app data...');

            const allData = {
                exportDate: new Date().toISOString(),
                appVersion: 'OuttaWeb-v1.0',
                userData: {
                    currentUser: currentUser,
                    sessionId: sessionId
                },
                localStorage: {},
                settings: {
                    placesProvider: placesProvider
                }
            };

            // Export all localStorage data
            const keysToExport = [
                'googlePlacesApiKey',
                'fsqApiKey',
                'googleSearchApiKey',
                'searchEngineId',
                'businessSearchHistory',
                'excludedBusinessesKeys',
                'savedInstagramResults',
                'placesProvider',
                'outtaWebCurrentUser',
                'outtaWebSessionId'
            ];

            keysToExport.forEach(key => {
                try {
                    const value = localStorage.getItem(key);
                    if (value !== null) {
                        allData.localStorage[key] = value;
                    }
                } catch (error) {
                    console.warn(`Failed to export ${key}:`, error);
                }
            });

            // Create download
            const jsonString = JSON.stringify(allData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `outtaweb_data_export_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('📤 Data exported successfully! You can now import this file in the PWA version.');
            console.log('📤 Export completed:', allData);
        }

        function importAllData() {
            console.log('📥 Starting data import...');

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';

            input.onchange = function (event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const importedData = JSON.parse(e.target.result);

                        if (!importedData.appVersion || !importedData.exportDate) {
                            throw new Error('Invalid OuttaWeb export file');
                        }

                        console.log('📥 Importing data from:', importedData.exportDate);
                        console.log('📥 Import data contents:', importedData);

                        // Import localStorage data
                        let importedCount = 0;
                        if (importedData.localStorage) {
                            Object.entries(importedData.localStorage).forEach(([key, value]) => {
                                try {
                                    localStorage.setItem(key, value);
                                    importedCount++;
                                    console.log(`📥 Imported ${key}: ${value ? (value.length > 50 ? value.substring(0, 50) + '...' : value) : 'null'}`);
                                } catch (error) {
                                    console.warn(`Failed to import ${key}:`, error);
                                }
                            });
                        }

                        // Import user data
                        if (importedData.userData && importedData.userData.currentUser) {
                            currentUser = importedData.userData.currentUser;
                            sessionId = importedData.userData.sessionId || 'imported-' + Date.now();

                            window.LOGIN_STATE.isLoggedIn = true;
                            window.LOGIN_STATE.currentUser = currentUser;
                            window.LOGIN_STATE.sessionId = sessionId;

                            // Update user info display
                            updateUserInfo();

                            console.log('📥 Imported user:', currentUser.email);
                        }

                        // Import settings
                        if (importedData.settings) {
                            if (importedData.settings.placesProvider) {
                                placesProvider = importedData.settings.placesProvider;
                                try {
                                    const radio = document.querySelector(`input[name="placesProvider"][value="${placesProvider}"]`);
                                    if (radio) radio.checked = true;
                                } catch { }
                            }
                        }

                        // Force reload all global variables from localStorage
                        console.log('📥 Reloading all data from localStorage...');

                        // Reload API keys into global variables
                        apiKey = localStorage.getItem('googlePlacesApiKey') || '';
                        fsqApiKey = localStorage.getItem('fsqApiKey') || '';
                        googleSearchApiKey = localStorage.getItem('googleSearchApiKey') || '';
                        searchEngineId = localStorage.getItem('searchEngineId') || '';

                        console.log('📥 Reloaded API keys:', {
                            google: apiKey ? 'Present (' + apiKey.substring(0, 10) + '...)' : 'Missing',
                            fsq: fsqApiKey ? 'Present (' + fsqApiKey.substring(0, 10) + '...)' : 'Missing',
                            googleSearch: googleSearchApiKey ? 'Present' : 'Missing',
                            searchEngine: searchEngineId ? 'Present' : 'Missing'
                        });

                        // Reload search history
                        const historyData = localStorage.getItem('businessSearchHistory');
                        if (historyData) {
                            try {
                                searchHistory = JSON.parse(historyData);
                                console.log('📥 Reloaded search history:', searchHistory.length, 'entries');
                            } catch (error) {
                                console.warn('Failed to parse search history:', error);
                            }
                        }

                        // Update all UI displays
                        console.log('📥 Updating UI displays...');
                        updateApiKeyDisplay();
                        updateInstagramApiKeyDisplay();
                        displaySearchHistory();
                        loadProviderSelection();

                        // Restore Instagram results if any
                        try {
                            restoreSavedInstagramResults();
                        } catch (error) {
                            console.warn('Failed to restore Instagram results:', error);
                        }

                        // Force refresh the current tab if it's API or History
                        const activeTab = document.querySelector('.tab-content.active');
                        if (activeTab) {
                            if (activeTab.id === 'api-tab') {
                                console.log('📥 Refreshing API tab display...');
                                updateApiKeyDisplay();
                            } else if (activeTab.id === 'history-tab') {
                                console.log('📥 Refreshing history tab display...');
                                displaySearchHistory();
                            } else if (activeTab.id === 'instagram-tab') {
                                console.log('📥 Refreshing Instagram tab display...');
                                updateInstagramApiKeyDisplay();
                            }
                        }

                        console.log('📥 Import process completed!');

                        // Show detailed success message
                        const historyCount = searchHistory ? searchHistory.length : 0;
                        const instagramData = localStorage.getItem('savedInstagramResults');
                        const instagramCount = instagramData ? JSON.parse(instagramData).length : 0;

                        alert(`📥 Data import completed successfully!\n\n` +
                            `• Imported ${importedCount} settings from ${importedData.exportDate}\n` +
                            `• Google API Key: ${apiKey ? '✓ Imported' : '✗ Not found'}\n` +
                            `• Foursquare API Key: ${fsqApiKey ? '✓ Imported' : '✗ Not found'}\n` +
                            `• Search History: ${historyCount} entries\n` +
                            `• Instagram Results: ${instagramCount} saved results\n\n` +
                            `All data should now be visible in the app!`);

                    } catch (error) {
                        console.error('📥 Import failed:', error);
                        alert('❌ Import failed: ' + error.message + '\n\nPlease ensure you\'re importing a valid OuttaWeb export file.');
                    }
                };
                reader.readAsText(file);
            };

            input.click();
        }

        function checkDataConsistency() {
            console.log('🔍 Checking data consistency between storage methods...');

            const report = {
                timestamp: new Date().toISOString(),
                localStorage: {
                    available: false,
                    keys: [],
                    apiKeys: {},
                    searchHistory: null,
                    userSession: null
                },
                globalState: {
                    currentUser: currentUser,
                    sessionId: sessionId,
                    loginState: window.LOGIN_STATE
                },
                inconsistencies: []
            };

            // Check localStorage availability and contents
            try {
                report.localStorage.available = true;

                // Get all OuttaWeb related keys
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.includes('outta') || key.includes('business') || key.includes('google') || key.includes('fsq'))) {
                        report.localStorage.keys.push(key);
                    }
                }

                // Check specific data
                report.localStorage.apiKeys = {
                    google: localStorage.getItem('googlePlacesApiKey') ? 'Present' : 'Missing',
                    foursquare: localStorage.getItem('fsqApiKey') ? 'Present' : 'Missing',
                    googleSearch: localStorage.getItem('googleSearchApiKey') ? 'Present' : 'Missing'
                };

                const historyData = localStorage.getItem('businessSearchHistory');
                report.localStorage.searchHistory = historyData ? JSON.parse(historyData).length + ' entries' : 'None';

                const userData = localStorage.getItem('outtaWebCurrentUser');
                report.localStorage.userSession = userData ? 'Present' : 'Missing';

            } catch (error) {
                report.localStorage.error = error.message;
            }

            // Check for inconsistencies
            if (report.localStorage.available) {
                const storedUser = localStorage.getItem('outtaWebCurrentUser');
                if (storedUser && currentUser) {
                    try {
                        const parsed = JSON.parse(storedUser);
                        if (parsed.email !== currentUser.email) {
                            report.inconsistencies.push('User email mismatch between localStorage and global state');
                        }
                    } catch { }
                } else if (storedUser && !currentUser) {
                    report.inconsistencies.push('User in localStorage but not in global state');
                } else if (!storedUser && currentUser) {
                    report.inconsistencies.push('User in global state but not in localStorage');
                }
            }

            console.log('🔍 Data consistency report:', report);

            const summary = `Data Consistency Report\n` +
                `========================\n` +
                `Timestamp: ${report.timestamp}\n` +
                `localStorage Available: ${report.localStorage.available}\n` +
                `localStorage Keys: ${report.localStorage.keys.length}\n` +
                `Google API Key: ${report.localStorage.apiKeys?.google || 'N/A'}\n` +
                `Search History: ${report.localStorage.searchHistory || 'N/A'}\n` +
                `Current User: ${currentUser ? currentUser.email : 'Not logged in'}\n` +
                `Inconsistencies: ${report.inconsistencies.length}\n\n`;

            if (report.inconsistencies.length > 0) {
                alert(summary + 'Issues found:\n' + report.inconsistencies.join('\n'));
            } else {
                alert(summary + '✅ No issues found!');
            }

            return report;
        }

        function syncDataAcrossContexts() {
            console.log('🔄 Attempting to sync data across different contexts...');

            try {
                // If we have data in global state but not in localStorage, save it
                if (currentUser && window.LOGIN_STATE.isLoggedIn) {
                    try {
                        localStorage.setItem('outtaWebCurrentUser', JSON.stringify(currentUser));
                        if (sessionId) {
                            localStorage.setItem('outtaWebSessionId', sessionId);
                        }
                        console.log('🔄 Synced user data to localStorage');
                    } catch (error) {
                        console.warn('🔄 Could not sync to localStorage:', error);
                    }
                }

                // If we have API keys in global variables but not in storage, save them
                if (apiKey && !localStorage.getItem('googlePlacesApiKey')) {
                    try {
                        localStorage.setItem('googlePlacesApiKey', apiKey);
                        console.log('🔄 Synced Google API key to localStorage');
                    } catch { }
                }

                if (fsqApiKey && !localStorage.getItem('fsqApiKey')) {
                    try {
                        localStorage.setItem('fsqApiKey', fsqApiKey);
                        console.log('🔄 Synced Foursquare API key to localStorage');
                    } catch { }
                }

                // Sync search history if we have it in memory but not in storage
                if (searchHistory && searchHistory.length > 0 && !localStorage.getItem('businessSearchHistory')) {
                    try {
                        localStorage.setItem('businessSearchHistory', JSON.stringify(searchHistory));
                        console.log('🔄 Synced search history to localStorage');
                    } catch { }
                }

                alert('🔄 Data sync completed! Check console for details.');

            } catch (error) {
                console.error('🔄 Data sync failed:', error);
                alert('❌ Data sync failed: ' + error.message);
            }
        }

        function checkForPWADataIssues() {
            console.log('📱 Checking for PWA data sync issues...');

            // Only run this check if we're likely in a PWA context
            const isPWA = window.matchMedia('(display-mode: standalone)').matches ||
                window.navigator.standalone ||
                document.referrer.includes('android-app://') ||
                window.location.search.includes('pwa=true');

            if (!isPWA) {
                console.log('📱 Not in PWA mode, skipping data sync check');
                return;
            }

            console.log('📱 PWA mode detected, checking for data issues...');

            // Check if we have minimal data (suggests fresh install)
            const hasApiKey = !!localStorage.getItem('googlePlacesApiKey');
            const hasSearchHistory = !!localStorage.getItem('businessSearchHistory');
            const hasUserData = !!localStorage.getItem('outtaWebCurrentUser');
            const hasAnyData = hasApiKey || hasSearchHistory || hasUserData;

            if (!hasAnyData) {
                console.log('📱 No data found in PWA - potential sync issue');

                // Show a subtle notification about data migration
                setTimeout(() => {
                    const notification = document.createElement('div');
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #ff6b35;
                        color: white;
                        padding: 15px 20px;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                        z-index: 1000;
                        max-width: 300px;
                        font-size: 14px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    `;

                    notification.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="font-size: 20px;">📱</div>
                            <div>
                                <div style="font-weight: bold; margin-bottom: 5px;">PWA Data Missing?</div>
                                <div style="font-size: 12px; opacity: 0.9;">Click here to migrate your data from the web version</div>
                            </div>
                        </div>
                    `;

                    notification.onclick = () => {
                        notification.remove();
                        showDataMigrationModal();
                    };

                    // Auto-hide after 10 seconds
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.style.opacity = '0';
                            notification.style.transform = 'translateX(100%)';
                            setTimeout(() => notification.remove(), 300);
                        }
                    }, 10000);

                    document.body.appendChild(notification);

                    // Add bounce animation
                    setTimeout(() => {
                        notification.style.animation = 'bounce 0.6s ease-out';
                    }, 100);

                }, 1000);
            } else {
                console.log('📱 Data found in PWA - no sync issues detected');
            }
        }

        function showDataMigrationModal() {
            const modalHtml = `
                <div id="dataMigrationModal" class="login-overlay" style="display: flex; z-index: 2000;">
                    <div class="login-modal" style="max-width: 600px; width: 95%;">
                        <div class="login-logo">
                            <img src="outtaweblogo.PNG" alt="Outta Web Logo">
                            <span class="logo-text">DATA MIGRATION</span>
                        </div>
                        <h2>PWA Data Migration Tools</h2>
                        <p style="color: #666; margin-bottom: 20px; line-height: 1.5;">
                            If your data isn't showing up in the PWA version, use these tools to transfer your data between the web and app versions.
                        </p>
                        
                        <div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                            <strong>💡 How to fix missing data:</strong><br>
                            1. Use "Export Data" on the web version (where your data exists)<br>
                            2. Use "Import Data" on the PWA version (where data is missing)<br>
                            3. Or use "Sync Data" to attempt automatic synchronization
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <button class="login-btn" onclick="exportAllData()" style="background: #28a745;">
                                📤 Export Data
                            </button>
                            <button class="login-btn" onclick="importAllData()" style="background: #007bff;">
                                📥 Import Data
                            </button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <button class="login-btn" onclick="syncDataAcrossContexts()" style="background: #6f42c1;">
                                🔄 Sync Data
                            </button>
                            <button class="login-btn" onclick="checkDataConsistency()" style="background: #17a2b8;">
                                🔍 Check Data
                            </button>
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <h4 style="margin: 0 0 10px 0; font-size: 14px;">Current Data Status:</h4>
                            <div style="font-size: 13px; color: #666;">
                                <div>User: ${currentUser ? currentUser.email : 'Not logged in'}</div>
                                <div>Search History: ${searchHistory ? searchHistory.length + ' entries' : '0 entries'}</div>
                                <div>API Keys: ${apiKey ? 'Google ✓' : 'Google ✗'} ${fsqApiKey ? 'Foursquare ✓' : 'Foursquare ✗'}</div>
                                <div>Storage: ${typeof localStorage !== 'undefined' ? 'Available' : 'Not available'}</div>
                            </div>
                        </div>
                        
                        <button type="button" class="login-btn" onclick="document.getElementById('dataMigrationModal').remove()" 
                                style="width: 100%; margin-top: 15px; background: #6c757d;">
                            Close
                        </button>
                    </div>
                </div>
            `;

            // Remove existing modal if present
            const existingModal = document.getElementById('dataMigrationModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // ======= INSTAGRAM CONTACT FINDER FUNCTIONALITY =======
        
        // Store Instagram search results (reusing existing variable)
        // let instagramSearchResults = []; // Already declared elsewhere
        
        // Populate niches dropdown for Instagram search
        function populateInstagramSearchNiches() {
            const selectElement = document.getElementById('instagramSearchNiche');
            if (!selectElement) return;
            
            // Clear existing options except the first one
            selectElement.innerHTML = '<option value="">Choose a niche...</option>';
            
            // Get all niches from the app
            const allNiches = [
                // Personal Services
                'barber shops', 'hair salons', 'nail salons', 'spas', 'massage therapy', 'tattoo shops', 'piercing studios', 'tanning salons',
                // Home Services  
                'plumbers', 'electricians', 'HVAC contractors', 'roofers', 'painters', 'landscapers', 'cleaning services', 'handyman services',
                // Automotive
                'auto repair', 'car wash', 'tire shops', 'auto detailing', 'oil change', 'brake repair', 'transmission repair', 'auto body shops',
                // Professional Services
                'interior designers', 'photographers', 'personal trainers', 'tutors', 'accountants', 'lawyers', 'real estate agents', 'consultants',
                // Food & Beverage
                'restaurants', 'food trucks', 'catering', 'bakeries', 'coffee shops', 'pizza places', 'food delivery', 'meal prep',
                // Health & Wellness
                'chiropractors', 'dentists', 'physical therapy', 'yoga studios', 'gyms', 'nutritionists', 'acupuncture', 'mental health',
                // Additional Services
                'pet groomers', 'veterinarians', 'daycare centers', 'tutoring centers', 'music lessons', 'dance studios', 'martial arts', 'swimming lessons',
                // Service Businesses
                'dry cleaners', 'laundromats', 'tailors', 'shoe repair', 'jewelry repair', 'watch repair', 'key makers', 'locksmiths',
                // Retail & Specialty
                'florists', 'gift shops', 'antique stores', 'thrift stores', 'pawn shops', 'bookstores', 'libraries', 'art galleries',
                // Construction & Professional
                'construction companies', 'contractors', 'architects', 'engineers', 'surveyors', 'inspectors', 'appraisers', 'notaries'
            ];
            
            // Sort niches alphabetically
            allNiches.sort();
            
            // Add each niche as an option
            allNiches.forEach(niche => {
                const option = document.createElement('option');
                option.value = niche;
                option.textContent = niche.charAt(0).toUpperCase() + niche.slice(1); // Capitalize first letter
                selectElement.appendChild(option);
            });
            
            console.log(`✅ Populated Instagram Search with ${allNiches.length} niches`);
        }
        
        // Save Instagram Search API configuration
        function saveInstagramSearchConfig() {
            const apiKey = document.getElementById('googleApiKey').value.trim();
            const engineId = document.getElementById('searchEngineId').value.trim();
            
            if (!apiKey || !engineId) {
                alert('❌ Please enter both API key and Search Engine ID');
                return;
            }
            
            try {
                localStorage.setItem('instagramSearchApiKey', apiKey);
                localStorage.setItem('instagramSearchEngineId', engineId);
                
                document.getElementById('instagramSearchApiStatus').innerHTML = '✅ Configuration saved';
                document.getElementById('instagramSearchApiStatus').style.color = '#28a745';
                
                console.log('✅ Instagram Search API credentials saved');
                alert('✅ API credentials saved successfully!');
            } catch (error) {
                console.error('❌ Error saving Instagram Search API credentials:', error);
                alert('❌ Error saving credentials: ' + error.message);
            }
        }
        
        // Test Instagram Search API configuration
        async function testInstagramSearchConfig() {
            const apiKey = document.getElementById('googleApiKey').value.trim() || localStorage.getItem('instagramSearchApiKey');
            const engineId = document.getElementById('searchEngineId').value.trim() || localStorage.getItem('instagramSearchEngineId');
            
            if (!apiKey || !engineId) {
                alert('❌ Please enter API credentials first');
                return;
            }
            
            document.getElementById('instagramSearchApiStatus').innerHTML = '🧪 Testing...';
            document.getElementById('instagramSearchApiStatus').style.color = '#007bff';
            
            try {
                const testUrl = `https://www.googleapis.com/customsearch/v1?key=${apiKey}&cx=${engineId}&q=test&num=1`;
                const response = await fetch(testUrl);
                
                let responseText;
                try {
                    responseText = await response.text();
                } catch (readError) {
                    throw new Error(`Failed to read response: ${readError.message}`);
                }
                
                if (response.ok) {
                    if (!responseText) {
                        throw new Error('Empty response from Google API');
                    }
                    
                    let data;
                    try {
                        data = JSON.parse(responseText);
                    } catch (parseError) {
                        throw new Error(`Invalid JSON response: ${parseError.message}`);
                    }
                    
                    document.getElementById('instagramSearchApiStatus').innerHTML = '✅ API working';
                    document.getElementById('instagramSearchApiStatus').style.color = '#28a745';
                    alert('✅ API connection test successful!');
                } else {
                    let errorMessage = `HTTP ${response.status}`;
                    
                    if (responseText) {
                        try {
                            const errorData = JSON.parse(responseText);
                            errorMessage = errorData.error?.message || errorData.message || errorMessage;
                        } catch (parseError) {
                            errorMessage = responseText.length > 200 ? `HTTP ${response.status}` : responseText || errorMessage;
                        }
                    }
                    
                    document.getElementById('instagramSearchApiStatus').innerHTML = '❌ API failed';
                    document.getElementById('instagramSearchApiStatus').style.color = '#dc3545';
                    alert(`❌ API test failed: ${errorMessage}`);
                }
            } catch (error) {
                console.error('❌ Instagram Search API test failed:', error);
                document.getElementById('instagramSearchApiStatus').innerHTML = '❌ Connection error';
                document.getElementById('instagramSearchApiStatus').style.color = '#dc3545';
                alert(`❌ Connection test failed: ${error.message}`);
            }
        }
        
        // Load saved API configuration
        function loadInstagramSearchConfig() {
            const apiKey = localStorage.getItem('instagramSearchApiKey');
            const engineId = localStorage.getItem('instagramSearchEngineId');
            
            if (apiKey) document.getElementById('googleApiKey').value = apiKey;
            if (engineId) document.getElementById('searchEngineId').value = engineId;
            
            if (apiKey && engineId) {
                document.getElementById('instagramSearchApiStatus').innerHTML = '✅ Configuration loaded';
                document.getElementById('instagramSearchApiStatus').style.color = '#28a745';
            }
        }
        
        // Main Instagram search function
        async function searchInstagramBusinesses() {
            const niche = document.getElementById('instagramSearchNiche').value.trim();
            const location = document.getElementById('instagramSearchLocation').value.trim();
            
            // Validation
            if (!niche) {
                alert('❌ Please select a business niche');
                return;
            }
            
            if (!location) {
                alert('❌ Please enter a location');
                return;
            }
            
            const apiKey = localStorage.getItem('instagramSearchApiKey') || document.getElementById('googleApiKey').value.trim();
            const engineId = localStorage.getItem('instagramSearchEngineId') || document.getElementById('searchEngineId').value.trim();
            
            if (!apiKey || !engineId) {
                alert('❌ Please configure your API credentials first');
                return;
            }
            
            // Show loading state
            showInstagramSearchLoading(niche, location);
            hideInstagramSearchError();
            hideInstagramSearchResults();
            
            try {
                // Form the search query: site:instagram.com "niche" "location"
                const searchQuery = `site:instagram.com "${niche}" "${location}"`;
                const searchUrl = `https://www.googleapis.com/customsearch/v1?key=${apiKey}&cx=${engineId}&q=${encodeURIComponent(searchQuery)}&num=10`;
                
                console.log(`🔍 Searching Instagram for: ${searchQuery}`);
                
                const response = await fetch(searchUrl);
                
                let responseText;
                try {
                    responseText = await response.text();
                } catch (readError) {
                    throw new Error(`Failed to read response: ${readError.message}`);
                }
                
                if (!response.ok) {
                    let errorMessage = `HTTP ${response.status}`;
                    
                    if (responseText) {
                        try {
                            const errorData = JSON.parse(responseText);
                            errorMessage = errorData.error?.message || errorData.message || errorMessage;
                        } catch (parseError) {
                            errorMessage = responseText.length > 200 ? `HTTP ${response.status}` : responseText || errorMessage;
                        }
                    }
                    
                    throw new Error(errorMessage);
                }
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    throw new Error(`Invalid JSON response: ${parseError.message}`);
                }
                
                if (data.error) {
                    throw new Error(data.error.message || 'Google API error');
                }
                
                // Process the results with enhanced filtering and WhatsApp detection
                const profiles = [];
                const whatsappOnlyFilter = document.getElementById('whatsappOnlyFilter').checked;
                let totalResults = 0;
                let filteredCount = 0;
                let whatsappCount = 0;
                
                if (data.items && data.items.length > 0) {
                    totalResults = data.items.length;
                    console.log(`📄 Processing ${totalResults} raw search results...`);
                    console.log(`📱 WhatsApp-only filter: ${whatsappOnlyFilter ? 'ENABLED' : 'DISABLED'}`);
                    
                    data.items.forEach((item, index) => {
                        const profile = parseInstagramResult(item);
                        if (profile) {
                            // Count WhatsApp profiles
                            if (profile.hasWhatsApp) {
                                whatsappCount++;
                            }
                            
                            // Apply WhatsApp filter if enabled
                            if (whatsappOnlyFilter && !profile.hasWhatsApp) {
                                filteredCount++;
                                console.log(`🚫 Filtered out @${profile.username} (no WhatsApp)`);
                                return;
                            }
                            
                            profiles.push(profile);
                            console.log(`✅ Valid profile #${profiles.length}: @${profile.username}${profile.hasWhatsApp ? ' (📱 WhatsApp)' : ''}`);
                        } else {
                            filteredCount++;
                        }
                    });
                    
                    console.log(`📊 Filter results: ${profiles.length} valid profiles, ${whatsappCount} with WhatsApp, ${filteredCount} filtered out`);
                }
                
                // Limit to 10 results as requested
                const limitedProfiles = profiles.slice(0, 10);
                
                instagramSearchResults = limitedProfiles;
                displayInstagramSearchResults(limitedProfiles, niche, location, totalResults, filteredCount, whatsappCount, whatsappOnlyFilter);
                
            } catch (error) {
                console.error('❌ Instagram search failed:', error);
                showInstagramSearchError(error.message);
            } finally {
                hideInstagramSearchLoading();
            }
        }
        
        // WhatsApp detection functions
        function detectWhatsAppInfo(text) {
            if (!text) return null;
            
            const whatsappInfo = {
                hasWhatsApp: false,
                phoneNumber: null,
                waLink: null,
                whatsappKeyword: false
            };
            
            const lowerText = text.toLowerCase();
            
            // 1. Look for wa.me/ links
            const waLinkPattern = /wa\.me\/([\+]?[\d]{10,15})/gi;
            const waLinkMatch = text.match(waLinkPattern);
            if (waLinkMatch) {
                whatsappInfo.hasWhatsApp = true;
                whatsappInfo.waLink = waLinkMatch[0];
                // Extract phone number from wa.me link
                const phoneMatch = waLinkMatch[0].match(/wa\.me\/([\+]?[\d]{10,15})/i);
                if (phoneMatch) {
                    whatsappInfo.phoneNumber = phoneMatch[1];
                }
            }
            
            // 2. Look for international phone numbers (+country code)
            if (!whatsappInfo.phoneNumber) {
                // Match international phone numbers: +1234567890, +1 234 567 890, +1-234-567-890, etc.
                const phonePatterns = [
                    /\+\d{1,4}[\s\-\.]?\(?(\d{1,4})\)?[\s\-\.]?\d{3,4}[\s\-\.]?\d{3,4}/g,
                    /\+\d{10,15}/g,
                    /\(\+\d{1,4}\)[\s\-\.]?\d{9,14}/g
                ];
                
                for (const pattern of phonePatterns) {
                    const phoneMatch = text.match(pattern);
                    if (phoneMatch) {
                        // Clean phone number (remove spaces, dashes, parentheses)
                        const cleanPhone = phoneMatch[0].replace(/[\s\-\.\(\)]/g, '');
                        if (cleanPhone.length >= 10 && cleanPhone.startsWith('+')) {
                            whatsappInfo.phoneNumber = cleanPhone;
                            whatsappInfo.hasWhatsApp = true;
                            break;
                        }
                    }
                }
            }
            
            // 3. Look for WhatsApp keywords
            const whatsappKeywords = [
                'whatsapp', 'what\'s app', 'whats app', 'wa', 'wap',
                'dm for info', 'message me', 'text me', 'contact via wa'
            ];
            
            const hasKeyword = whatsappKeywords.some(keyword => {
                // Use word boundary for exact matches
                const keywordPattern = new RegExp(`\\b${keyword.replace(/'/g, "\\'").replace(/\s/g, '\\s+')}\\b`, 'i');
                return keywordPattern.test(lowerText);
            });
            
            if (hasKeyword) {
                whatsappInfo.whatsappKeyword = true;
                whatsappInfo.hasWhatsApp = true;
            }
            
            // 4. Look for business contact indicators with phone numbers
            if (!whatsappInfo.hasWhatsApp) {
                const businessContactPatterns = [
                    /contact[:\s]*[\+]?\d{10,15}/gi,
                    /call[:\s]*[\+]?\d{10,15}/gi,
                    /phone[:\s]*[\+]?\d{10,15}/gi,
                    /mobile[:\s]*[\+]?\d{10,15}/gi
                ];
                
                for (const pattern of businessContactPatterns) {
                    const contactMatch = text.match(pattern);
                    if (contactMatch) {
                        const phoneMatch = contactMatch[0].match(/[\+]?\d{10,15}/);
                        if (phoneMatch) {
                            whatsappInfo.phoneNumber = phoneMatch[0];
                            whatsappInfo.hasWhatsApp = true;
                            break;
                        }
                    }
                }
            }
            
            return whatsappInfo.hasWhatsApp ? whatsappInfo : null;
        }
        
        // Format WhatsApp info for display
        function formatWhatsAppDisplay(whatsappInfo) {
            if (!whatsappInfo || !whatsappInfo.hasWhatsApp) {
                return null;
            }
            
            let display = '';
            
            if (whatsappInfo.waLink) {
                display = `<a href="https://${whatsappInfo.waLink}" target="_blank" style="color: #25D366; font-weight: 600; text-decoration: none;">📱 ${whatsappInfo.phoneNumber || whatsappInfo.waLink}</a>`;
            } else if (whatsappInfo.phoneNumber) {
                const whatsappUrl = `https://wa.me/${whatsappInfo.phoneNumber.replace(/[^\d+]/g, '')}`;
                display = `<a href="${whatsappUrl}" target="_blank" style="color: #25D366; font-weight: 600; text-decoration: none;">📱 ${whatsappInfo.phoneNumber}</a>`;
            } else if (whatsappInfo.whatsappKeyword) {
                display = '<span style="color: #25D366; font-weight: 600;">📱 WhatsApp Available</span>';
            }
            
            return display;
        }
        // Parse individual Instagram search result with WhatsApp detection and enhanced filtering
        function parseInstagramResult(item) {
            try {
                const url = item.link;
                const title = item.title;
                const snippet = item.snippet || '';
                
                // Ensure it's an Instagram URL
                if (!url || !url.includes('instagram.com')) {
                    return null;
                }
                
                // Check for standard Instagram profile URL format: https://instagram.com/<username>
                const instagramUrlPattern = /^https?:\/\/(www\.)?instagram\.com\/([a-zA-Z0-9._]+)\/?(?:\?.*)?$/;
                const urlMatch = url.match(instagramUrlPattern);
                
                if (!urlMatch) {
                    console.log('❌ Skipping non-standard Instagram URL:', url);
                    return null;
                }
                
                const username = urlMatch[2];
                
                // Apply filtering criteria for valid usernames (from memory specification)
                if (!isValidInstagramUsername(username)) {
                    console.log('❌ Skipping invalid username:', username);
                    return null;
                }
                
                // Clean the title to get display name
                let displayName = title.replace(/(@[^\s]+)/g, '').replace(/\s+/g, ' ').trim();
                displayName = displayName.replace(/\s*\|.*$/, '').replace(/\s*-.*$/, '').trim();
                displayName = displayName.replace(/\s*\(.*?\)\s*/g, '').trim(); // Remove parentheses content
                displayName = displayName.replace(/Instagram/gi, '').trim(); // Remove Instagram mentions
                
                if (!displayName || displayName.length < 2) {
                    displayName = username.charAt(0).toUpperCase() + username.slice(1); // Capitalize username as fallback
                }
                
                // WhatsApp detection in title and snippet
                const combinedText = title + ' ' + snippet;
                const whatsappInfo = detectWhatsAppInfo(combinedText);
                
                // Additional validation: ensure the profile seems business-related
                const lowerCombinedText = combinedText.toLowerCase();
                
                // Skip obvious non-business accounts (optional filtering)
                const personalIndicators = ['personal', 'private', 'my life', 'selfie', 'travel diary', 'food blog'];
                const hasPersonalIndicators = personalIndicators.some(indicator => 
                    lowerCombinedText.includes(indicator)
                );
                
                if (hasPersonalIndicators && !haBusinessIndicators(lowerCombinedText) && !whatsappInfo) {
                    console.log('⚠️ Skipping likely personal account:', username);
                    return null;
                }
                
                console.log(`✅ Valid Instagram profile found: @${username}${whatsappInfo ? ' (with WhatsApp)' : ''}`);
                
                return {
                    username: username,
                    displayName: displayName,
                    profileUrl: url,
                    snippet: snippet,
                    whatsappInfo: whatsappInfo,
                    hasWhatsApp: whatsappInfo ? whatsappInfo.hasWhatsApp : false
                };
            } catch (error) {
                console.warn('❌ Error parsing Instagram result:', error);
                return null;
            }
        }
        
        // Validate Instagram username according to platform rules
        function isValidInstagramUsername(username) {
            if (!username) return false;
            
            // Instagram username rules:
            // - Must be 3-30 characters long
            // - Can only contain letters, numbers, dots (.), and underscores (_)
            // - Cannot start or end with a dot
            // - Cannot have consecutive dots
            
            // Length check
            if (username.length < 3 || username.length > 30) {
                return false;
            }
            
            // Character pattern check
            const validPattern = /^[a-zA-Z0-9._]+$/;
            if (!validPattern.test(username)) {
                return false;
            }
            
            // Cannot start or end with dot
            if (username.startsWith('.') || username.endsWith('.')) {
                return false;
            }
            
            // Cannot have consecutive dots
            if (username.includes('..')) {
                return false;
            }
            
            // Filter out common placeholder/invalid usernames
            const invalidUsernames = [
                'p', 'pp', 'ppp', 'user', 'account', 'profile', 'instagram', 'ig',
                'test', 'example', 'sample', 'demo', 'placeholder', 'username',
                'reel', 'reels', 'story', 'stories', 'explore', 'tv', 'igtv'
            ];
            
            if (invalidUsernames.includes(username.toLowerCase())) {
                return false;
            }
            
            // Filter out usernames that are just numbers or very short
            if (/^\d+$/.test(username) || username.length < 3) {
                return false;
            }
            
            return true;
        }
        
        // Check for business indicators in text
        function haBusinessIndicators(text) {
            const businessKeywords = [
                'business', 'shop', 'store', 'company', 'service', 'professional',
                'salon', 'restaurant', 'cafe', 'bar', 'gym', 'fitness', 'clinic',
                'office', 'agency', 'studio', 'boutique', 'market', 'center',
                'repair', 'cleaning', 'construction', 'contractor', 'plumber',
                'electrician', 'lawyer', 'dentist', 'doctor', 'veterinarian',
                'barber', 'hair', 'nail', 'spa', 'massage', 'tattoo', 'auto',
                'car', 'truck', 'mechanic', 'insurance', 'real estate', 'hotel',
                'motel', 'inn', 'resort', 'catering', 'bakery', 'pharmacy',
                'florist', 'jewelry', 'electronics', 'furniture', 'clothing',
                'shoes', 'books', 'music', 'photography', 'wedding', 'event'
            ];
            
            return businessKeywords.some(keyword => text.includes(keyword));
        }
        
        // Show loading state
        function showInstagramSearchLoading(niche, location) {
            document.getElementById('searchingNiche').textContent = niche;
            document.getElementById('searchingLocation').textContent = location;
            document.getElementById('instagramSearchLoading').style.display = 'block';
            document.getElementById('instagramSearchButton').disabled = true;
            document.getElementById('instagramSearchButton').textContent = '🔄 Searching...';
        }
        
        // Hide loading state
        function hideInstagramSearchLoading() {
            document.getElementById('instagramSearchLoading').style.display = 'none';
            document.getElementById('instagramSearchButton').disabled = false;
            document.getElementById('instagramSearchButton').textContent = '🚀 Search';
        }
        
        // Show error
        function showInstagramSearchError(message) {
            document.getElementById('instagramSearchErrorMessage').textContent = message;
            document.getElementById('instagramSearchError').style.display = 'block';
        }
        
        // Hide error
        function hideInstagramSearchError() {
            document.getElementById('instagramSearchError').style.display = 'none';
        }
        
        // Hide results
        function hideInstagramSearchResults() {
            document.getElementById('instagramSearchResults').style.display = 'none';
        }
        
        // Display Instagram search results with WhatsApp info and filtering statistics
        function displayInstagramSearchResults(profiles, niche, location, totalResults = 0, filteredCount = 0, whatsappCount = 0, whatsappFilterEnabled = false) {
            const resultsContainer = document.getElementById('instagramProfilesList');
            const resultsSection = document.getElementById('instagramSearchResults');
            const resultsCounter = document.getElementById('resultsCounter');
            
            if (!profiles || profiles.length === 0) {
                let errorMessage = `No ${whatsappFilterEnabled ? 'WhatsApp-enabled ' : ''}Instagram profiles found for '${niche}' in '${location}'.`;
                
                if (totalResults > 0) {
                    if (whatsappFilterEnabled) {
                        errorMessage += ` Found ${totalResults} search result${totalResults !== 1 ? 's' : ''} with ${whatsappCount} WhatsApp profile${whatsappCount !== 1 ? 's' : ''}, but all were filtered out.`;
                    } else {
                        errorMessage += ` Found ${totalResults} search result${totalResults !== 1 ? 's' : ''} but ${filteredCount} were filtered out due to invalid usernames or non-business accounts.`;
                    }
                }
                
                errorMessage += ' Try different keywords, broader locations, or disable WhatsApp-only filter.';
                
                showInstagramSearchError(errorMessage);
                return;
            }
            
            // Update counter with filtering and WhatsApp info
            let counterText = `${profiles.length} profile${profiles.length !== 1 ? 's' : ''}`;
            const whatsappInResults = profiles.filter(p => p.hasWhatsApp).length;
            
            if (whatsappFilterEnabled) {
                counterText += ` (📱 WhatsApp only)`;
            } else if (whatsappInResults > 0) {
                counterText += ` (${whatsappInResults} with 📱)`;
            }
            
            if (filteredCount > 0) {
                counterText += ` (${filteredCount} filtered)`;
            }
            
            resultsCounter.textContent = counterText;
            
            // Sort profiles: WhatsApp profiles first
            const sortedProfiles = [...profiles].sort((a, b) => {
                if (a.hasWhatsApp && !b.hasWhatsApp) return -1;
                if (!a.hasWhatsApp && b.hasWhatsApp) return 1;
                return 0;
            });
            
            // Generate results HTML with WhatsApp information
            let resultsHTML = '';
            sortedProfiles.forEach((profile, index) => {
                const whatsappDisplay = formatWhatsAppDisplay(profile.whatsappInfo);
                const isWhatsAppProfile = profile.hasWhatsApp;
                const borderColor = isWhatsAppProfile ? '#25D366' : '#e9ecef';
                const cardStyle = `background: white; border: 2px solid ${borderColor}; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);`;
                
                resultsHTML += `
                    <div class="instagram-profile" style="${cardStyle}">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <p style="margin: 0 0 8px 0; font-size: 16px;"><strong>Name:</strong> <span style="color: #333;">${profile.displayName}</span></p>
                                <p style="margin: 0 0 8px 0; font-size: 15px;"><strong>Username:</strong> <span style="color: #007bff; font-weight: 500;">@${profile.username}</span></p>
                                <p style="margin: 0 0 8px 0;"><strong>Profile:</strong> <a href="${profile.profileUrl}" target="_blank" style="color: #007bff; text-decoration: none; font-weight: 500;">View on Instagram ↗️</a></p>
                                ${whatsappDisplay ? `<p style="margin: 0;"><strong>WhatsApp:</strong> ${whatsappDisplay}</p>` : ''}
                            </div>
                            <div style="text-align: right;">
                                <span style="background: ${isWhatsAppProfile ? '#25D366' : '#007bff'}; color: white; padding: 6px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                    ${isWhatsAppProfile ? '📱 ' : ''}#${index + 1}
                                </span>
                            </div>
                        </div>
                        ${profile.snippet ? `<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e9ecef; font-size: 14px; color: #6c757d; line-height: 1.4;">📝 ${profile.snippet}</div>` : ''}
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e9ecef;">
                            <button onclick="copyProfileInfoWithWhatsApp('${profile.displayName.replace(/'/g, "\\'")}', '${profile.username}', '${profile.profileUrl}', '${profile.whatsappInfo ? (profile.whatsappInfo.phoneNumber || 'Available') : ''}')" 
                                    style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; margin-right: 8px;">
                                📋 Copy Info
                            </button>
                            <button onclick="window.open('${profile.profileUrl}', '_blank')" 
                                    style="background: #17a2b8; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; margin-right: 8px;">
                                🔗 Open Profile
                            </button>
                            ${profile.whatsappInfo && profile.whatsappInfo.phoneNumber ? `
                                <button onclick="openWhatsApp('${profile.whatsappInfo.phoneNumber}', '${profile.displayName}')" 
                                        style="background: #25D366; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                                    📱 WhatsApp
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            // Add comprehensive filtering summary
            if (totalResults > 0) {
                const summaryBg = whatsappFilterEnabled ? '#e8f5e8' : '#f8f9fa';
                const summaryBorder = whatsappFilterEnabled ? '#25D366' : '#e9ecef';
                
                resultsHTML += `
                    <div style="background: ${summaryBg}; border: 1px solid ${summaryBorder}; border-radius: 8px; padding: 15px; margin-top: 20px; text-align: center;">
                        <h5 style="margin: 0 0 8px 0; color: #495057;">📊 Search Summary</h5>
                        <div style="font-size: 14px; color: #6c757d; line-height: 1.6;">
                            <div style="margin-bottom: 4px;">
                                Found <strong>${totalResults}</strong> search results, showing <strong>${profiles.length}</strong> valid profiles.
                            </div>
                            ${whatsappCount > 0 ? `<div style="margin-bottom: 4px; color: #25D366; font-weight: 600;">📱 <strong>${whatsappCount}</strong> profile${whatsappCount !== 1 ? 's' : ''} with WhatsApp contact info detected.</div>` : ''}
                            ${filteredCount > 0 ? `<div style="color: #dc3545;"><strong>${filteredCount}</strong> results filtered out (invalid usernames, non-business accounts${whatsappFilterEnabled ? ', no WhatsApp' : ''})</div>` : ''}
                            ${whatsappFilterEnabled ? '<div style="margin-top: 8px; font-style: italic; color: #25D366;">📱 Showing only profiles with WhatsApp contact information</div>' : ''}
                        </div>
                    </div>
                `;
            }
            
            resultsContainer.innerHTML = resultsHTML;
            resultsSection.style.display = 'block';
        }
        
        // Handle location input with autocomplete (matching original search feature)
        function handleInstagramLocationInput(value) {
            const suggestionsContainer = document.getElementById('instagramLocationSuggestions');
            
            if (!value || value.length < 2) {
                suggestionsContainer.style.display = 'none';
                return;
            }
            
            // Get location recommendations (reusing existing function logic)
            const recommendations = getInstagramLocationRecommendations(value);
            
            if (recommendations.length > 0) {
                let html = '';
                recommendations.forEach(location => {
                    html += `<div onclick="selectInstagramLocation('${location}')" style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee;" onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor='white'">${location}</div>`;
                });
                
                suggestionsContainer.innerHTML = html;
                suggestionsContainer.style.display = 'block';
            } else {
                suggestionsContainer.style.display = 'none';
            }
        }
        
        // Select location from autocomplete
        function selectInstagramLocation(location) {
            document.getElementById('instagramSearchLocation').value = location;
            hideInstagramLocationSuggestions();
        }
        
        // Hide location suggestions
        function hideInstagramLocationSuggestions() {
            document.getElementById('instagramLocationSuggestions').style.display = 'none';
        }
        
        // Get location recommendations (matching original search functionality)
        function getInstagramLocationRecommendations(query) {
            const allLocations = [
                // Popular Cities
                'Los Angeles, CA', 'New York, NY', 'Chicago, IL', 'Houston, TX', 'Phoenix, AZ',
                'Philadelphia, PA', 'San Antonio, TX', 'San Diego, CA', 'Dallas, TX', 'San Jose, CA',
                'Austin, TX', 'Jacksonville, FL', 'Fort Worth, TX', 'Columbus, OH', 'Charlotte, NC',
                'San Francisco, CA', 'Indianapolis, IN', 'Seattle, WA', 'Denver, CO', 'Washington, DC',
                'Boston, MA', 'El Paso, TX', 'Nashville, TN', 'Detroit, MI', 'Oklahoma City, OK',
                'Portland, OR', 'Las Vegas, NV', 'Memphis, TN', 'Louisville, KY', 'Baltimore, MD',
                'Milwaukee, WI', 'Albuquerque, NM', 'Tucson, AZ', 'Fresno, CA', 'Sacramento, CA',
                'Mesa, AZ', 'Kansas City, MO', 'Atlanta, GA', 'Long Beach, CA', 'Colorado Springs, CO',
                'Raleigh, NC', 'Miami, FL', 'Virginia Beach, VA', 'Omaha, NE', 'Oakland, CA',
                'Minneapolis, MN', 'Tulsa, OK', 'Arlington, TX', 'Tampa, FL', 'New Orleans, LA',
                
                // California Cities
                'Anaheim, CA', 'Santa Ana, CA', 'Riverside, CA', 'Stockton, CA', 'Irvine, CA',
                'Chula Vista, CA', 'Fremont, CA', 'San Bernardino, CA', 'Modesto, CA', 'Fontana, CA',
                'Oxnard, CA', 'Moreno Valley, CA', 'Huntington Beach, CA', 'Glendale, CA', 'Santa Clarita, CA',
                
                // Texas Cities
                'Plano, TX', 'Laredo, TX', 'Lubbock, TX', 'Garland, TX', 'Irving, TX',
                'Amarillo, TX', 'Grand Prairie, TX', 'Brownsville, TX', 'McKinney, TX', 'Frisco, TX',
                
                // Florida Cities
                'Orlando, FL', 'St. Petersburg, FL', 'Hialeah, FL', 'Tallahassee, FL', 'Cape Coral, FL',
                'Fort Lauderdale, FL', 'Port St. Lucie, FL', 'Pembroke Pines, FL', 'Hollywood, FL', 'Miramar, FL',
                
                // Other Major Cities
                'Cleveland, OH', 'Cincinnati, OH', 'Toledo, OH', 'Akron, OH', 'Dayton, OH',
                'Pittsburgh, PA', 'Allentown, PA', 'Erie, PA', 'Reading, PA', 'Scranton, PA',
                'Albany, NY', 'Buffalo, NY', 'Rochester, NY', 'Syracuse, NY', 'Yonkers, NY'
            ];
            
            return allLocations.filter(location =>
                location.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 8);
        }
        
        // Copy profile information with WhatsApp to clipboard
        function copyProfileInfoWithWhatsApp(name, username, profileUrl, whatsappInfo) {
            let profileInfo = `Name: ${name}\nUsername: @${username}\nProfile: ${profileUrl}`;
            
            if (whatsappInfo && whatsappInfo !== '') {
                profileInfo += `\nWhatsApp: ${whatsappInfo}`;
            }
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(profileInfo).then(() => {
                    // Show temporary success message
                    const button = event.target;
                    const originalText = button.textContent;
                    button.textContent = '✅ Copied!';
                    button.style.background = '#28a745';
                    
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.style.background = '#28a745';
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy to clipboard:', err);
                    fallbackCopyToClipboard(profileInfo);
                });
            } else {
                fallbackCopyToClipboard(profileInfo);
            }
        }
        
        // Open WhatsApp with pre-filled message
        function openWhatsApp(phoneNumber, businessName) {
            // Clean phone number (remove any non-digit characters except +)
            const cleanPhone = phoneNumber.replace(/[^\d+]/g, '');
            const message = encodeURIComponent(`Hi ${businessName}, I found your Instagram profile and I'm interested in your services. Could you please provide more information?`);
            const whatsappUrl = `https://wa.me/${cleanPhone}?text=${message}`;
            
            window.open(whatsappUrl, '_blank');
        }
        
        function copyProfileInfo(name, username, profileUrl) {
            const profileInfo = `Name: ${name}\nUsername: @${username}\nProfile: ${profileUrl}`;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(profileInfo).then(() => {
                    // Show temporary success message
                    const button = event.target;
                    const originalText = button.textContent;
                    button.textContent = '✅ Copied!';
                    button.style.background = '#28a745';
                    
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.style.background = '#28a745';
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy to clipboard:', err);
                    fallbackCopyToClipboard(profileInfo);
                });
            } else {
                fallbackCopyToClipboard(profileInfo);
            }
        }
        
        // Fallback copy method for older browsers
        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                alert('✅ Profile information copied to clipboard!');
            } catch (err) {
                console.error('Fallback copy failed:', err);
                alert('❌ Could not copy to clipboard. Please copy manually:\n\n' + text);
            }
            
            document.body.removeChild(textArea);
        }
        
        // Retry search function
        function retryInstagramSearch() {
            hideInstagramSearchError();
            searchInstagramBusinesses();
        }
        
        // Initialize Instagram Search when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            populateInstagramSearchNiches();
            loadInstagramSearchConfig();
        });
        
        // ======= END INSTAGRAM CONTACT FINDER FUNCTIONALITY =======

        // Initialize spinner CSS injection
        const spinnerCSS = `
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .instagram-profile {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .instagram-profile:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        }
        `;
        const style = document.createElement('style');
        style.textContent = spinnerCSS;
        document.head.appendChild(style);
    </script>
</body>

</html>
            const apiKey = document.getElementById('instagramSearchApiKey').value.trim();
            const engineId = document.getElementById('instagramSearchEngineId').value.trim();

            if (!apiKey || !engineId) {
                alert('Please enter both API Key and Search Engine ID');
                return;
            }

            localStorage.setItem('instagramSearchApiKey', apiKey);
            localStorage.setItem('instagramSearchEngineId', engineId);

            document.getElementById('instagramApiStatus').innerHTML =
                '<span class="status-indicator" style="color: #28a745;">✅ Configuration saved</span>';

            console.log('Instagram API keys saved to localStorage');
        }

        function loadInstagramApiKeys() {
            const apiKey = localStorage.getItem('instagramSearchApiKey');
            const engineId = localStorage.getItem('instagramSearchEngineId');

            if (apiKey) document.getElementById('instagramSearchApiKey').value = apiKey;
            if (engineId) document.getElementById('instagramSearchEngineId').value = engineId;

            if (apiKey && engineId) {
                document.getElementById('instagramApiStatus').innerHTML =
                    '<span class="status-indicator" style="color: #28a745;">✅ Configuration loaded</span>';
            }
        }

        async function testInstagramApiKeys() {
            const apiKey = document.getElementById('instagramSearchApiKey').value.trim();
            const engineId = document.getElementById('instagramSearchEngineId').value.trim();

            if (!apiKey || !engineId) {
                alert('Please enter both API Key and Search Engine ID first');
                return;
            }

            document.getElementById('instagramApiStatus').innerHTML =
                '<span class="status-indicator" style="color: #007bff;">🔄 Testing connection...</span>';

            try {
                const response = await fetch('/api/instagram/contact-finder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-google-search-key': apiKey,
                        'x-search-engine-id': engineId
                    },
                    body: JSON.stringify({
                        niche: 'test',
                        location: 'test',
                        maxResults: 1
                    })
                });

                if (response.ok) {
                    document.getElementById('instagramApiStatus').innerHTML =
                        '<span class="status-indicator" style="color: #28a745;">✅ Connection successful</span>';
                    saveInstagramApiKeys();
                } else {
                    const errorData = await response.json();
                    document.getElementById('instagramApiStatus').innerHTML =
                        '<span class="status-indicator" style="color: #dc3545;">❌ Connection failed</span>';
                    console.error('API test failed:', errorData);
                }
            } catch (error) {
                document.getElementById('instagramApiStatus').innerHTML =
                    '<span class="status-indicator" style="color: #dc3545;">❌ Connection error</span>';
                console.error('API test error:', error);
            }
        }

        async function searchInstagramProfiles() {
            const niche = document.getElementById('instagramNiche').value.trim();
            const location = document.getElementById('instagramLocation').value.trim();
            const maxResults = document.getElementById('instagramMaxResults').value;

            // Validation
            if (!niche || !location) {
                alert('Please enter both niche and location');
                return;
            }

            const apiKey = localStorage.getItem('instagramSearchApiKey') || document.getElementById('instagramSearchApiKey').value.trim();
            const engineId = localStorage.getItem('instagramSearchEngineId') || document.getElementById('instagramSearchEngineId').value.trim();

            if (!apiKey || !engineId) {
                alert('Please configure your API credentials first');
                return;
            }

            // Show loading state
            document.getElementById('instagramLoading').style.display = 'block';
            document.getElementById('instagramResults').style.display = 'none';
            document.getElementById('instagramError').style.display = 'none';
            document.getElementById('searchNicheDisplay').textContent = niche;
            document.getElementById('searchLocationDisplay').textContent = location;
            document.getElementById('instagramSearchBtn').disabled = true;
            document.getElementById('instagramSearchBtn').textContent = '🔍 Searching...';

            try {
                console.log(`🔍 Searching for ${niche} businesses in ${location}`);

                const response = await fetch('/api/instagram/contact-finder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-google-search-key': apiKey,
                        'x-search-engine-id': engineId
                    },
                    body: JSON.stringify({
                        niche: niche,
                        location: location,
                        maxResults: parseInt(maxResults)
                    })
                });

                const data = await response.json();

                if (data.success) {
                    instagramSearchResults = data.data;
                    displayInstagramResults(data.data);
                } else {
                    showInstagramError(data.error);
                }

            } catch (error) {
                console.error('Search error:', error);
                showInstagramError({
                    code: 'NETWORK_ERROR',
                    message: 'Connection error. Please check your internet connection and try again.'
                });
            } finally {
                // Hide loading state
                document.getElementById('instagramLoading').style.display = 'none';
                document.getElementById('instagramSearchBtn').disabled = false;
                document.getElementById('instagramSearchBtn').textContent = '🚀 Find Instagram Profiles';
            }
        }

        function displayInstagramResults(data) {
            const resultsContainer = document.getElementById('instagramResultsList');
            const resultsSection = document.getElementById('instagramResults');

            if (!data.profiles || data.profiles.length === 0) {
                showInstagramError({
                    code: 'NO_RESULTS',
                    message: `No Instagram profiles found for '${data.niche}' in '${data.location}'. Try different keywords or locations.`
                });
                return;
            }

            // Update stats
            document.getElementById('resultsCount').textContent = data.profiles.length;
            document.getElementById('searchTimestamp').textContent = new Date(data.searchDate).toLocaleString();

            // Generate results HTML
            let resultsHTML = '';
            data.profiles.forEach((profile, index) => {
                resultsHTML += `
                    <div class="result-item" style="background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <h5 style="margin: 0 0 10px 0; color: #333; font-weight: 600;">${profile.name}</h5>
                                <p style="margin: 0 0 5px 0; color: #007bff; font-weight: 500;">@${profile.username}</p>
                                <a href="${profile.profileUrl}" target="_blank" style="color: #6c757d; text-decoration: none; font-size: 14px;">
                                    ${profile.profileUrl}
                                </a>
                            </div>
                            <div style="text-align: right;">
                                <span style="background: #e9ecef; color: #495057; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500;">
                                    #${index + 1}
                                </span>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e9ecef;">
                            <button class="btn btn-outline-primary btn-sm" onclick="window.open('${profile.profileUrl}', '_blank')" style="margin-right: 10px;">
                                📱 View Profile
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="copyProfileInfo('${profile.name}', '${profile.username}', '${profile.profileUrl}')">
                                📋 Copy Info
                            </button>
                        </div>
                    </div>
                `;
            });

            resultsContainer.innerHTML = resultsHTML;
            resultsSection.style.display = 'block';

            console.log(`✅ Displayed ${data.profiles.length} Instagram profiles`);
        }

        function showInstagramError(error) {
            const errorSection = document.getElementById('instagramError');
            const errorMessage = document.getElementById('instagramErrorMessage');

            let userMessage = error.message;

            // Customize error messages based on error code
            switch (error.code) {
                case 'MISSING_CREDENTIALS':
                    userMessage = 'Please configure your Google Custom Search API credentials in the configuration section above.';
                    break;
                case 'QUOTA_EXCEEDED':
                    userMessage = 'Daily search limit reached. Please try again tomorrow or upgrade your API plan.';
                    break;
                case 'NO_RESULTS':
                    userMessage = error.message;
                    break;
                case 'NETWORK_ERROR':
                    userMessage = 'Connection error. Please check your internet connection and try again.';
                    break;
                default:
                    userMessage = error.message || 'An unexpected error occurred. Please try again.';
            }

            errorMessage.textContent = userMessage;
            errorSection.style.display = 'block';

            console.error('Instagram search error:', error);
        }

        function retryInstagramSearch() {
            document.getElementById('instagramError').style.display = 'none';
            searchInstagramProfiles();
        }

        function copyProfileInfo(name, username, profileUrl) {
            const info = `Name: ${name}\nUsername: @${username}\nProfile: ${profileUrl}`;

            if (navigator.clipboard) {
                navigator.clipboard.writeText(info).then(() => {
                    alert('Profile information copied to clipboard!');
                });
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = info;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Profile information copied to clipboard!');
            }
        }

        function exportInstagramResults(format) {
            if (!instagramSearchResults || !instagramSearchResults.profiles || instagramSearchResults.profiles.length === 0) {
                alert('No results to export. Please perform a search first.');
                return;
            }

            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const filename = `instagram-contacts-${instagramSearchResults.niche}-${instagramSearchResults.location}-${timestamp}`;

            if (format === 'json') {
                exportAsJSON(instagramSearchResults, filename);
            } else if (format === 'csv') {
                exportAsCSV(instagramSearchResults, filename);
            }
        }

        function exportAsJSON(data, filename) {
            const jsonData = {
                searchQuery: data.searchQuery,
                niche: data.niche,
                location: data.location,
                searchDate: data.searchDate,
                totalFound: data.totalFound,
                profiles: data.profiles.map(profile => ({
                    name: profile.name,
                    username: profile.username,
                    profileUrl: profile.profileUrl
                }))
            };

            const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
            downloadFile(blob, `${filename}.json`);
        }

        function exportAsCSV(data, filename) {
            const headers = ['Name', 'Username', 'Profile URL', 'Niche', 'Location', 'Search Date'];
            const rows = data.profiles.map(profile => [
                profile.name,
                `@${profile.username}`,
                profile.profileUrl,
                data.niche,
                data.location,
                new Date(data.searchDate).toLocaleString()
            ]);

            const csvContent = [headers, ...rows]
                .map(row => row.map(field => `"${field}"`).join(','))
                .join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            downloadFile(blob, `${filename}.csv`);
        }

        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            console.log(`📄 Downloaded: ${filename}`);
        }

        // Load API keys when the page loads
        document.addEventListener('DOMContentLoaded', function () {
            loadInstagramApiKeys();
        });

        // Add CSS for spinner animation
        const spinnerCSS = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        const style = document.createElement('style');
        style.textContent = spinnerCSS;
        document.head.appendChild(style);
    </script>
</body>

</html>