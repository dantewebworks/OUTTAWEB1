<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Outta Web - Find Businesses Without Websites</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Comic+Neue:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="manifest" href="/manifest.webmanifest">
    <meta name="theme-color" content="#007bff">
    <meta name="application-name" content="Outta Web">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="/logo.PNG">
    <link rel="apple-touch-icon" sizes="180x180" href="/logo.PNG">
    <link rel="apple-touch-icon" sizes="167x167" href="/logo.PNG">
    <link rel="apple-touch-icon" sizes="152x152" href="/logo.PNG">
    <link rel="apple-touch-icon" sizes="120x120" href="/logo.PNG">
    <link rel="icon" type="image/png" sizes="192x192" href="/logo.PNG">
    <link rel="icon" type="image/png" sizes="512x512" href="/logo.PNG">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Outta Web">
    <meta name="msapplication-TileColor" content="#007bff">
    <meta name="format-detection" content="telephone=no">
    
    <!-- Supabase Integration -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/api/config"></script>
    <script>
      function initSupabase() {
        try {
          const urlRaw = (window.__ENV__ && window.__ENV__.SUPABASE_URL) || window.NEXT_PUBLIC_SUPABASE_URL || null;
          const url = urlRaw ? urlRaw.replace(/\/+$/, '') : null; // trim trailing slashes
          const anonKey = (window.__ENV__ && window.__ENV__.SUPABASE_ANON_KEY) || window.NEXT_PUBLIC_SUPABASE_ANON_KEY || null;
          if (url && anonKey && window.supabase && window.supabase.createClient) {
            window.SUPABASE = window.supabase.createClient(url, anonKey);
            console.log('✅ Supabase initialized');
          } else {
            console.log('ℹ️ Supabase config missing or library not loaded');
          }
        } catch (e) {
          console.log('ℹ️ Supabase init skipped:', e.message);
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        initSupabase();
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('/sw.js').then((reg) => {
            console.log('✅ Service worker registered');
            if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });
          }).catch(err => console.log('SW registration failed', err));
        }
      });

      // Add to Home Screen (A2HS) support
      let deferredPrompt = null;
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        const btn = document.getElementById('installAppBtn');
        if (btn) btn.style.display = 'inline-block';
      });

      document.addEventListener('DOMContentLoaded', () => {
        const btn = document.getElementById('installAppBtn');
        if (!btn) return;
        btn.addEventListener('click', async () => {
          if (!deferredPrompt) {
            alert('Install is not available right now. On iPhone, use Share → Add to Home Screen.');
            return;
          }
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          console.log('A2HS outcome:', outcome);
          deferredPrompt = null;
          btn.style.display = 'none';
        });
      });
    </script>
    <style>
        /* Login Modal Styles */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .login-modal {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .login-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        .login-logo img {
            width: 60px;
            height: 60px;
            object-fit: contain;
        }

        .login-logo .logo-text {
            font-family: 'Fredoka One', cursive;
            font-size: 28px;
            color: #333;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #007bff;
        }

        .login-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .login-btn:hover {
            background: #0056b3;
        }

        .register-link {
            margin-top: 20px;
            color: #6c757d;
        }

        .register-link a {
            color: #007bff;
            text-decoration: none;
            font-weight: 600;
        }

        .register-link a:hover {
            text-decoration: underline;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #333;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: #007bff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .hidden {
            display: none !important;
        }
        

        body {
            font-family: 'Comic Neue', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 30px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 28px;
            font-weight: bold;
            font-family: 'Fredoka One', cursive;
            color: #333;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .logo-image {
            width: 80px;
            height: 80px;
            object-fit: contain;
            border-radius: 10px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.15);
        }

        .logo-text {
            font-family: 'Fredoka One', cursive;
            font-size: 36px;
            color: #333;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .nav {
            display: flex;
            gap: 20px;
        }

        .nav a {
            text-decoration: none;
            color: #6c757d;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .nav a:hover {
            background-color: #e9ecef;
            color: #495057;
        }

        .nav a.active {
            background-color: #007bff;
            color: white;
        }

        .main-title {
            text-align: center;
            font-size: 42px;
            font-weight: 700;
            font-family: 'Fredoka One', cursive;
            color: #333;
            margin-bottom: 40px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .search-form {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input {
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #007bff;
        }

        .search-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            width: 100%;
        }

        .search-btn:hover {
            background: #0056b3;
        }

        .niche-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .niche-chip,
        .location-chip {
            background: #e9ecef;
            color: #495057;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .niche-chip:hover,
        .location-chip:hover {
            background: #dee2e6;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .results-table th {
            background: #f8f9fa;
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
        }

        .results-table td {
            padding: 16px;
            border-bottom: 1px solid #e9ecef;
        }

        .results-table tr:hover {
            background: #f8f9fa;
        }

        .business-name {
            font-family: 'Fredoka One', cursive;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        .contact-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .contact-sms {
            background: #28a745;
            color: white;
        }

        .contact-email {
            background: #17a2b8;
            color: white;
        }

        .export-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-size: 18px;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 16px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 16px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            color: #6c757d;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab.active {
            color: #007bff;
            border-bottom-color: #007bff;
        }

        .tab:hover {
            color: #495057;
        }

        .history-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .history-date {
            font-weight: 600;
            color: #495057;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .history-details {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .history-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .clear-all-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .api-key-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .api-key-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .api-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .status-message {
            padding: 12px 16px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: 500;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .niche-selection-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        .niche-selection-section h4 {
            margin: 0 0 20px 0;
            color: #495057;
            font-size: 18px;
        }

        .niche-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .niche-category {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .niche-category h5 {
            margin: 0 0 10px 0;
            color: #007bff;
            font-size: 14px;
            font-weight: 600;
        }

        .niche-category .niche-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .niche-category .niche-chip {
            background: #e9ecef;
            color: #495057;
            border: none;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .niche-category .niche-chip:hover {
            background: #007bff;
            color: white;
        }

        .niche-suggestions {
            margin-top: 10px;
        }

        #selectedNiches .niche-chip {
            background: #007bff;
            color: white;
        }

        #selectedNiches .niche-chip:hover {
            background: #0056b3;
        }

        .search-options {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-size: 14px;
            color: #495057;
        }

        .checkbox-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .checkbox-option span {
            user-select: none;
        }

        .search-settings {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .search-settings h4 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 16px;
            font-weight: 600;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .settings-grid .form-group {
            margin: 0;
        }

        .settings-grid input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .settings-grid input[type="number"]:focus {
            outline: none;
            border-color: #007bff;
        }

        .best-niches-section {
            background: linear-gradient(135deg, #fff5f5, #fff);
            border: 2px solid #ff6b6b;
            border-radius: 12px;
            margin-top: 30px;
        }

        .best-niches-section h4 {
            color: #d63031;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .best-niches-section p {
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.5;
        }

        .best-niches-section .niche-category h5 {
            color: #d63031;
            font-weight: 600;
        }

        .best-niches-section .niche-chip:hover {
            background: #ff6b6b;
            color: white;
        }

        /* Bulk Location Modal Styles */
        #bulkLocationOverlay .login-modal {
            max-width: 600px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        #bulkLocationOverlay .login-modal>* {
            flex-shrink: 0;
        }

        #bulkLocationOverlay .login-modal .form-group {
            flex-shrink: 0;
        }

        #bulkLocationInput {
            font-family: inherit;
            resize: vertical;
            min-height: 120px;
        }

        .bulk-location-preview {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
        }

        .bulk-location-preview h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #495057;
        }

        .bulk-location-preview .location-chip {
            margin: 2px;
            font-size: 12px;
            padding: 4px 8px;
        }

        /* Enhanced button styles for bulk location modal */
        #bulkLocationOverlay .login-btn {
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #bulkLocationOverlay .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        /* Location count indicator */
        #bulkLocationCount {
            font-weight: bold;
            color: #007bff;
        }

        /* Many locations warning */
        .many-locations-warning {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ffeaa7;
            margin-top: 10px;
            font-size: 14px;
            display: none;
        }
    </style>
</head>

    <body>
        <!-- Login Modal -->
        <div id="loginOverlay" class="login-overlay" style="display: none;">
        <div class="login-modal">
            <div class="login-logo">
                <img src="outtaweblogo.PNG" alt="Outta Web Logo">
                <span class="logo-text">OUTTA WEB</span>
            </div>
            <h2>Welcome to Business Finder</h2>
            <p style="color: #6c757d; margin-bottom: 30px;">Find businesses without websites for your outreach campaigns
            </p>
            
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" required placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required placeholder="Enter your password">
                </div>
                <button type="submit" class="login-btn">Login</button>
                </form>
            
                         <div class="register-link">
                 Don't have an account? <a href="#" onclick="showRegisterForm()">Register here</a>
             </div>
             <div class="register-link">
                 <a href="#" onclick="showResetForm()">Forgot Password?</a>
             </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="registerOverlay" class="login-overlay hidden">
        <div class="login-modal">
            <div class="login-logo">
                <img src="outtaweblogo.PNG" alt="Outta Web Logo">
                <span class="logo-text">OUTTA WEB</span>
            </div>
            <h2>Create Account</h2>
            <p style="color: #6c757d; margin-bottom: 30px;">Join Business Finder to start finding leads</p>
            
            <form id="registerForm" class="login-form">
                <div class="form-group">
                    <label for="registerName">Full Name</label>
                    <input type="text" id="registerName" required placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email</label>
                    <input type="email" id="registerEmail" required placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" required placeholder="Create a password">
                </div>
                <div class="form-group">
                    <label for="registerConfirmPassword">Confirm Password</label>
                    <input type="password" id="registerConfirmPassword" required placeholder="Confirm your password">
                </div>
                <button type="submit" class="login-btn">Register</button>
            </form>
            
            <div class="register-link">
                Already have an account? <a href="#" onclick="showLoginForm()">Login here</a>
            </div>
        </div>
    </div>

    <!-- Verify Modal -->
    <div id="verifyOverlay" class="login-overlay hidden">
      <div class="login-modal">
        <div class="login-logo">
          <img src="outtaweblogo.PNG" alt="Outta Web Logo">
          <span class="logo-text">OUTTA WEB</span>
        </div>
        <h2>Email Verification</h2>
        <p style="color: #6c757d; margin-bottom: 20px;">Enter the verification code below:</p>
            <div id="verificationCodeDisplay"
                style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-size: 24px; font-weight: bold; color: #007bff; border: 2px dashed #007bff;">
          <span id="verificationCodeText">------</span>
        </div>
        <form id="verifyForm" class="login-form">
          <div class="form-group">
            <label for="verifyCode">Verification Code</label>
            <input type="text" id="verifyCode" required placeholder="Enter code">
          </div>
          <button type="submit" class="login-btn">Verify</button>
        </form>
        <div class="register-link">
          Didn't get a code? <a href="#" onclick="resendVerificationCode()">Resend</a>
        </div>
      </div>
    </div>

    <!-- Reset Modal -->
    <div id="resetOverlay" class="login-overlay hidden">
      <div class="login-modal">
        <div class="login-logo">
          <img src="outtaweblogo.PNG" alt="Outta Web Logo">
          <span class="logo-text">OUTTA WEB</span>
        </div>
        <h2>Reset Password</h2>
        <form id="resetRequestForm" class="login-form">
          <div class="form-group">
            <label for="resetEmail">Email</label>
            <input type="email" id="resetEmail" required placeholder="Enter your email">
          </div>
          <button type="submit" class="login-btn">Get Reset Code</button>
        </form>
        <form id="resetForm" class="login-form hidden">
                <div id="resetCodeDisplay"
                    style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-size: 24px; font-weight: bold; color: #007bff; border: 2px dashed #007bff;">
            <span id="resetCodeText">------</span>
          </div>
          <div class="form-group">
            <label for="resetCode">Reset Code</label>
            <input type="text" id="resetCode" required placeholder="Enter code">
          </div>
          <div class="form-group">
            <label for="newPassword">New Password</label>
            <input type="password" id="newPassword" required placeholder="New password">
          </div>
          <div class="form-group">
            <label for="confirmNewPassword">Confirm New Password</label>
            <input type="password" id="confirmNewPassword" required placeholder="Confirm new password">
          </div>
          <button type="submit" class="login-btn">Reset Password</button>
        </form>
        <div class="register-link">
          <a href="#" onclick="showLoginForm()">Back to Login</a>
        </div>
      </div>
    </div>

    <!-- Bulk Location Modal -->
    <div id="bulkLocationOverlay" class="login-overlay hidden">
        <div class="login-modal" style="max-width: 600px; width: 95%;">
            <div class="login-logo">
                <img src="outtaweblogo.PNG" alt="Outta Web Logo">
                <span class="logo-text">OUTTA WEB</span>
            </div>
            <h2>Bulk Location Entry</h2>
            <p style="color: #6c757d; margin-bottom: 20px;">Enter multiple locations separated by commas, new lines, or
                semicolons. The system will automatically detect city and state.</p>

            <div class="form-group">
                <label for="bulkLocationInput">Locations</label>
                <textarea id="bulkLocationInput" rows="8" placeholder="Example:
Los Angeles, CA
Santa Ana, CA
Houston, TX
Miami, FL
New York, NY

Or: Los Angeles, CA, Santa Ana, CA, Houston, TX, Miami, FL, New York, NY

Supports: City, State (Los Angeles, CA)
City State (Los Angeles CA)
State names (California)
State abbreviations (CA)"
                    style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
                <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">
                    <span id="bulkLocationCount">0</span> locations detected
                </div>
                <div id="manyLocationsWarning" class="many-locations-warning">
                    ⚠️ You have many locations selected. Use the floating button (↓) or scroll down to see the
                    Add/Cancel buttons.
                </div>
            </div>

            <div class="form-group">
                <label>Quick Add Options</label>
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                    <button type="button" class="btn btn-primary" onclick="addPopularCities()"
                        style="font-size: 12px; padding: 6px 12px;">Popular Cities</button>
                    <button type="button" class="btn btn-primary" onclick="addCaliforniaCities()"
                        style="font-size: 12px; padding: 6px 12px;">California</button>
                    <button type="button" class="btn btn-primary" onclick="addTexasCities()"
                        style="font-size: 12px; padding: 6px 12px;">Texas</button>
                    <button type="button" class="btn btn-primary" onclick="addFloridaCities()"
                        style="font-size: 12px; padding: 6px 12px;">Florida</button>
                    <button type="button" class="btn btn-primary" onclick="addNewYorkCities()"
                        style="font-size: 12px; padding: 6px 12px;">New York</button>
                    <button type="button" class="btn btn-primary" onclick="clearBulkInput()"
                        style="font-size: 12px; padding: 6px 12px; background: #dc3545;">Clear</button>
                </div>
            </div>

            <div id="bulkLocationPreview"
                style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; max-height: 150px; overflow-y: auto; display: none;">
                <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #495057;">Preview (will be added):</h4>
                <div id="bulkLocationPreviewList" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
            </div>

            <!-- Floating Action Button for many locations -->
            <div id="floatingActionButton"
                style="position: fixed; bottom: 20px; right: 20px; display: none; z-index: 1001;">
                <button type="button" onclick="scrollToBottom()"
                    style="background: #007bff; color: white; border: none; border-radius: 50%; width: 60px; height: 60px; font-size: 24px; box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4); cursor: pointer; transition: all 0.3s;">
                    ↓
                </button>
            </div>

            <div
                style="display: flex; gap: 10px; margin-top: 20px; position: sticky; bottom: 0; background: white; padding: 15px 0; border-top: 2px solid #e9ecef; z-index: 10;">
                <button type="button" class="login-btn" onclick="processBulkLocations()"
                    style="flex: 1; font-size: 16px; font-weight: 700; padding: 15px 20px; background: #28a745; border: 2px solid #28a745; box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);">✅
                    Add Locations</button>
                <button type="button" class="login-btn" onclick="closeBulkLocationModal()"
                    style="flex: 1; font-size: 16px; font-weight: 700; padding: 15px 20px; background: #dc3545; border: 2px solid #dc3545; box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);">❌
                    Cancel</button>
        </div>
      </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="logo">
                <img src="outtaweblogo.PNG" alt="Outta Web Logo" class="logo-image">
                <span class="logo-text">OUTTA WEB</span>
            </div>
            <div class="nav">
                <a href="#home" onclick="switchTab('search'); return false;">Home</a>
                <a href="#docs" onclick="switchTab('history'); return false;">Docs</a>
                <a href="#api" onclick="switchTab('api'); return false;">API Key</a>
                <button id="installAppBtn" class="btn" style="display:none; background:#0d6efd; color:white;">Install App</button>
            </div>
            <div id="userInfo" class="user-info hidden">
                <div class="user-avatar" id="userAvatar">U</div>
                <span id="userName">User</span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <h1 class="main-title">Find Businesses Without Websites</h1>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('search')">Search</div>
            <div class="tab" onclick="switchTab('history')">History</div>
            <div class="tab" onclick="switchTab('instagram')">Instagram</div>
            <div class="tab" onclick="switchTab('api')">API Key</div>
        </div>

        <div id="search-tab" class="tab-content active">
            <div class="search-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="location">Location(s)</label>
                        <div style="display: flex; gap: 10px; align-items: flex-start;">
                            <div style="flex: 1;">
                                <input type="text" id="location"
                                    placeholder="e.g. Los Angeles, CA, Santa Ana, CA (press comma to add multiple or use Bulk Add button)">
                        <div class="location-recommendations" id="locationRecommendations"></div>
                        <div id="locationList" class="niche-chips" style="margin-top: 0.5rem;"></div>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="addBulkLocations()"
                                style="white-space: nowrap; padding: 12px 16px; height: fit-content;">
                                Bulk Add
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="niche">Niche</label>
                        <input type="text" id="niche" placeholder="Type to search niches or select from below">
                        <div class="niche-suggestions" id="nicheSuggestions"></div>
                        <div id="selectedNiches" class="niche-chips" style="margin-top: 0.5rem;"></div>
                    </div>
                </div>
                
                <div class="search-options">
                    <label class="checkbox-option">
                        <input type="checkbox" id="preventDuplicates" checked>
                        <span>Prevent duplicate searches (use cached results from history)</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" id="stateWideSearch">
                        <span>State-wide search (automatically search all cities in state)</span>
                    </label>
                </div>
                
<div class="search-settings">
                    <h4>Search Settings</h4>
                    <div class="settings-grid">
                        <div class="form-group">
                            <label for="minResults">Minimum Results per Search</label>
                            <input type="number" id="minResults" value="5" min="1" max="1000">
                        </div>
                        <div class="form-group">
                            <label for="maxResults">Maximum Results per Search</label>
                            <input type="number" id="maxResults" value="1000" min="5" max="1000">
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 12px;">
                        <label>Provider</label>
                        <div style="display:flex; gap:16px; align-items:center; flex-wrap:wrap; margin-top:6px;">
                            <label style="display:flex; align-items:center; gap:6px;">
                                <input type="radio" name="placesProvider" value="google" checked>
                                <span>Google Places</span>
                            </label>
                            <label style="display:flex; align-items:center; gap:6px;">
                                <input type="radio" name="placesProvider" value="foursquare">
                                <span>Foursquare Places</span>
                            </label>
                        </div>
                        <div style="font-size:12px; color:#6c757d; margin-top:6px;">Choose which data source to use for searches.</div>
                    </div>
                </div>
                <div class="niche-selection-section">
                    <h4>Popular Niches (Click to Add)</h4>
                    <div class="niche-categories">
                        <div class="niche-category">
                            <h5>Personal Services</h5>
                            <div class="niche-chips">
                                <button class="niche-chip" onclick="addNicheFromSelection('barber shops')">Barber
                                    Shops</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('hair salons')">Hair
                                    Salons</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('nail salons')">Nail
                                    Salons</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('spas')">Spas</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('massage therapy')">Massage
                                    Therapy</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('tattoo shops')">Tattoo
                                    Shops</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('piercing studios')">Piercing
                                    Studios</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('tanning salons')">Tanning
                                    Salons</button>
                            </div>
                        </div>
                        
                        <div class="niche-category">
                            <h5>Home Services</h5>
                            <div class="niche-chips">
                                <button class="niche-chip" onclick="addNicheFromSelection('plumbers')">Plumbers</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('electricians')">Electricians</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('HVAC contractors')">HVAC
                                    Contractors</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('roofers')">Roofers</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('painters')">Painters</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('landscapers')">Landscapers</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('cleaning services')">Cleaning
                                    Services</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('handyman services')">Handyman
                                    Services</button>
                            </div>
                        </div>
                        
                        <div class="niche-category">
                            <h5>Automotive</h5>
                            <div class="niche-chips">
                                <button class="niche-chip" onclick="addNicheFromSelection('auto repair')">Auto
                                    Repair</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('car wash')">Car Wash</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('tire shops')">Tire
                                    Shops</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('auto detailing')">Auto
                                    Detailing</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('oil change')">Oil
                                    Change</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('brake repair')">Brake
                                    Repair</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('transmission repair')">Transmission Repair</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('auto body shops')">Auto Body
                                    Shops</button>
                            </div>
                        </div>
                        
                        <div class="niche-category">
                            <h5>Professional Services</h5>
                            <div class="niche-chips">
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('interior designers')">Interior Designers</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('photographers')">Photographers</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('personal trainers')">Personal
                                    Trainers</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('tutors')">Tutors</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('accountants')">Accountants</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('lawyers')">Lawyers</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('real estate agents')">Real
                                    Estate Agents</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('consultants')">Consultants</button>
                            </div>
                        </div>
                        
                        <div class="niche-category">
                            <h5>Food & Beverage</h5>
                            <div class="niche-chips">
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('restaurants')">Restaurants</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('food trucks')">Food
                                    Trucks</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('catering')">Catering</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('bakeries')">Bakeries</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('coffee shops')">Coffee
                                    Shops</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('pizza places')">Pizza
                                    Places</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('food delivery')">Food
                                    Delivery</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('meal prep')">Meal
                                    Prep</button>
                            </div>
                        </div>
                        
                        <div class="niche-category">
                            <h5>Health & Wellness</h5>
                            <div class="niche-chips">
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('chiropractors')">Chiropractors</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('dentists')">Dentists</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('physical therapy')">Physical
                                    Therapy</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('yoga studios')">Yoga
                                    Studios</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('gyms')">Gyms</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('nutritionists')">Nutritionists</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('acupuncture')">Acupuncture</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('mental health')">Mental
                                    Health</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="niche-selection-section best-niches-section">
                    <h4>🎯 Best Niches to Reach Out To That Will Most Definitely Be the Owners If You Should Send an SMS
                    </h4>
                    <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                        These niches are typically owner-operated businesses where the owner is directly involved in
                        daily operations and likely to respond to SMS outreach.
                    </p>
                    <div class="niche-categories">
                        <div class="niche-category">
                            <h5>Owner-Operated Services</h5>
                            <div class="niche-chips">
                                <button class="niche-chip" onclick="addNicheFromSelection('barber shops')">Barber
                                    Shops</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('nail salons')">Nail
                                    Salons</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('tattoo shops')">Tattoo
                                    Shops</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('piercing studios')">Piercing
                                    Studios</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('massage therapy')">Massage
                                    Therapy</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('spas')">Spas</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('tanning salons')">Tanning
                                    Salons</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('hair salons')">Hair
                                    Salons</button>
                            </div>
                        </div>
                        
                        <div class="niche-category">
                            <h5>Skilled Trades</h5>
                            <div class="niche-chips">
                                <button class="niche-chip" onclick="addNicheFromSelection('plumbers')">Plumbers</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('electricians')">Electricians</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('HVAC contractors')">HVAC
                                    Contractors</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('roofers')">Roofers</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('painters')">Painters</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('landscapers')">Landscapers</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('handyman services')">Handyman
                                    Services</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('cleaning services')">Cleaning
                                    Services</button>
                            </div>
                        </div>
                        
                        <div class="niche-category">
                            <h5>Automotive Services</h5>
                            <div class="niche-chips">
                                <button class="niche-chip" onclick="addNicheFromSelection('auto repair')">Auto
                                    Repair</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('car wash')">Car Wash</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('tire shops')">Tire
                                    Shops</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('auto detailing')">Auto
                                    Detailing</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('oil change')">Oil
                                    Change</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('brake repair')">Brake
                                    Repair</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('transmission repair')">Transmission Repair</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('auto body shops')">Auto Body
                                    Shops</button>
                            </div>
                        </div>
                        
                        <div class="niche-category">
                            <h5>Personal & Professional</h5>
                            <div class="niche-chips">
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('interior designers')">Interior Designers</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('photographers')">Photographers</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('personal trainers')">Personal
                                    Trainers</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('tutors')">Tutors</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('real estate agents')">Real
                                    Estate Agents</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('accountants')">Accountants</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('lawyers')">Lawyers</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('consultants')">Consultants</button>
                            </div>
                        </div>
                        
                        <div class="niche-category">
                            <h5>Food & Beverage</h5>
                            <div class="niche-chips">
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('restaurants')">Restaurants</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('food trucks')">Food
                                    Trucks</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('catering')">Catering</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('bakeries')">Bakeries</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('coffee shops')">Coffee
                                    Shops</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('pizza places')">Pizza
                                    Places</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('food delivery')">Food
                                    Delivery</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('meal prep')">Meal
                                    Prep</button>
                            </div>
                        </div>
                        
                        <div class="niche-category">
                            <h5>Health & Wellness</h5>
                            <div class="niche-chips">
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('chiropractors')">Chiropractors</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('dentists')">Dentists</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('physical therapy')">Physical
                                    Therapy</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('yoga studios')">Yoga
                                    Studios</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('gyms')">Gyms</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('nutritionists')">Nutritionists</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('acupuncture')">Acupuncture</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('mental health')">Mental
                                    Health</button>
                            </div>
                        </div>
                        
                        <div class="niche-category">
                            <h5>Additional Owner-Operated</h5>
                            <div class="niche-chips">
                                <button class="niche-chip" onclick="addNicheFromSelection('pet groomers')">Pet
                                    Groomers</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('veterinarians')">Veterinarians</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('daycare centers')">Daycare
                                    Centers</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('tutoring centers')">Tutoring
                                    Centers</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('music lessons')">Music
                                    Lessons</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('dance studios')">Dance
                                    Studios</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('martial arts')">Martial
                                    Arts</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('swimming lessons')">Swimming
                                    Lessons</button>
                            </div>
                        </div>
                        
                        <div class="niche-category">
                            <h5>Service Businesses</h5>
                            <div class="niche-chips">
                                <button class="niche-chip" onclick="addNicheFromSelection('dry cleaners')">Dry
                                    Cleaners</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('laundromats')">Laundromats</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('tailors')">Tailors</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('shoe repair')">Shoe
                                    Repair</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('jewelry repair')">Jewelry
                                    Repair</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('watch repair')">Watch
                                    Repair</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('key makers')">Key
                                    Makers</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('locksmiths')">Locksmiths</button>
                            </div>
                        </div>
                        
                        <div class="niche-category">
                            <h5>Retail & Specialty</h5>
                            <div class="niche-chips">
                                <button class="niche-chip" onclick="addNicheFromSelection('florists')">Florists</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('gift shops')">Gift
                                    Shops</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('antique stores')">Antique
                                    Stores</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('thrift stores')">Thrift
                                    Stores</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('pawn shops')">Pawn
                                    Shops</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('bookstores')">Bookstores</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('libraries')">Libraries</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('art galleries')">Art
                                    Galleries</button>
                            </div>
                        </div>
                        
                        <div class="niche-category">
                            <h5>Construction & Professional</h5>
                            <div class="niche-chips">
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('construction companies')">Construction
                                    Companies</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('contractors')">Contractors</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('architects')">Architects</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('engineers')">Engineers</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('surveyors')">Surveyors</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('inspectors')">Inspectors</button>
                                <button class="niche-chip"
                                    onclick="addNicheFromSelection('appraisers')">Appraisers</button>
                                <button class="niche-chip" onclick="addNicheFromSelection('notaries')">Notaries</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button class="search-btn" onclick="findBusinesses()">Find Businesses</button>
            </div>
            
            <div id="searchResults"></div>
        </div>

        <div id="history-tab" class="tab-content">
            <h2>Search History</h2>
            <button class="clear-all-btn" onclick="clearAllHistory()">Clear All History</button>

            <div class="api-key-section" style="margin-top:16px">
                <h3>Import Exclusions (CSV)</h3>
                <p style="margin-bottom: 0.5rem; color: #666;">
                    Upload a CSV of leads you want to exclude from future results. Matching businesses will be filtered out automatically.
                </p>
                <ul style="margin-top: 0; color: #6c757d; font-size: 14px;">
                    <li>Accepted columns (any combination): Name, Phone, Address, Email.</li>
                    <li>Matching uses Name+Phone when available; otherwise Name+Address.</li>
                </ul>
                <div style="display:flex; gap:10px; align-items:center; flex-wrap: wrap;">
                    <input id="exclusionsCsvInput" type="file" accept=".csv,text/csv" style="max-width: 320px;" />
                    <button class="btn btn-primary" id="importExclusionsBtn">Import CSV</button>
                    <button class="btn btn-danger" id="clearExclusionsBtn" title="Remove all imported exclusions">Clear Imported Exclusions</button>
                </div>
                <div id="exclusionsStatus" class="status-message status-info" style="margin-top:10px; display:none;"></div>
                <div id="exclusionsSummary" style="margin-top:6px; font-size: 13px; color: #666;"></div>
            </div>

            <div id="searchHistory" style="margin-top:16px"></div>
        </div>

        <div id="instagram-tab" class="tab-content">
            <h2>Instagram Lead Finder</h2>
            <p style="color: #666; margin-bottom: 20px;">Upload any CSV file with business data. The app automatically detects columns for Business Name, Address, City, State, and Phone Number regardless of naming or order. Returns only official Instagram accounts.</p>

            <div class="api-key-section" style="margin-bottom: 20px;">
                <h3>Google Custom Search API Configuration</h3>
                <p style="margin-bottom: 1rem; color: #666;">
                    Instagram search requires Google Custom Search API credentials.
                </p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div>
                        <label>Google Search API Key</label>
                        <input type="password" id="googleSearchApiKey" class="api-key-input" placeholder="Enter Google Custom Search API key">
                    </div>
                    <div>
                        <label>Search Engine ID</label>
                        <input type="text" id="searchEngineId" class="api-key-input" placeholder="Enter Custom Search Engine ID">
                    </div>
                </div>
                <div class="api-actions">
                    <button class="btn btn-primary" onclick="saveInstagramApiKeys()">Save Keys</button>
                    <button class="btn btn-success" onclick="testInstagramApi()">Test API</button>
                    <button class="btn btn-danger" onclick="clearInstagramApiKeys()">Clear Keys</button>
                </div>
                <div id="instagramApiStatus"></div>
            </div>

            <div class="api-key-section">
                <h3>CSV Upload</h3>
                <p style="margin-bottom: 1rem; color: #666;">
                    Upload any CSV file - columns will be automatically detected. Looks for: Business Name (required), Address, City, State, Phone Number. Column names can vary (e.g., "Company", "Store Name", "Telephone", etc.)
                </p>
                
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 16px;">
                    <input type="file" id="instagramCsvInput" accept=".csv" style="max-width: 320px;">
                    <button class="btn btn-primary" onclick="processInstagramCsv()">Process CSV</button>
                </div>

                <div style="margin-bottom: 16px;">
                    <label>Confidence Threshold (%)</label>
                    <input type="number" id="confidenceThreshold" min="40" max="100" value="60" style="width: 80px; margin-left: 8px;">
                    <span style="margin-left: 8px; color: #666; font-size: 14px;">Minimum confidence for returning Instagram accounts (40-100%). Higher = more strict.</span>
                </div>

                <div id="instagramProcessingStatus" style="display: none; margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="spinner" style="width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <span>Processing: <span id="currentProgress">0</span> / <span id="totalProgress">0</span> businesses</span>
                    </div>
                    <div style="margin-top: 8px;">
                        <div id="progressBar" style="width: 100%; height: 8px; background: #f0f0f0; border-radius: 4px; overflow: hidden;">
                            <div id="progressFill" style="height: 100%; background: #007bff; width: 0%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                    <div id="processingDetails" style="margin-top: 8px; font-size: 14px; color: #666;"></div>
                </div>

                <div id="instagramResults" style="margin-top: 20px;"></div>
            </div>
        </div>

<div id="api-tab" class="tab-content">
            <div class="api-key-section">
                <h3>Google Places API Configuration</h3>
                <p style="margin-bottom: 1rem; color: #666;">
                    Enter your Google Places API key to enable business search functionality.
                </p>
                <input type="password" id="apiKey" class="api-key-input" placeholder="Enter your Google Places API key">
                <div class="api-actions">
                    <button class="btn btn-primary" onclick="saveApiKey()">Save API Key</button>
                    <button class="btn btn-success" onclick="testApiKey()">Test API Key</button>
                    <button class="btn btn-danger" onclick="clearApiKey()">Clear API Key</button>
                </div>
                <div id="apiStatus"></div>
            </div>

            <div class="api-key-section" style="margin-top: 20px;">
                <h3>Foursquare Places API Configuration</h3>
                <p style="margin-bottom: 1rem; color: #666;">
                    Enter your Foursquare Places API key. Searches using the Foursquare provider will use this key.
                </p>
                <input type="password" id="fsqApiKey" class="api-key-input" placeholder="Enter your Foursquare API key">
                <div class="api-actions">
                    <button class="btn btn-primary" onclick="saveFsqApiKey()">Save FSQ Key</button>
                    <button class="btn btn-success" onclick="testFsqApiKey()">Test FSQ Key</button>
                    <button class="btn btn-danger" onclick="clearFsqApiKey()">Clear FSQ Key</button>
                </div>
                <div id="fsqApiStatus"></div>
            </div>
        </div>
    </div>

    <script>
        // User Authentication Variables - SIMPLIFIED VERSION
        let currentUser = null;
        let sessionId = null;
        
        // Simple hardcoded users for immediate testing
        const HARDCODED_USERS = [
            {
                id: 1,
                name: 'Admin User',
                email: 'admin@outtaweb.com',
                password: 'admin123',
                verified: true
            },
            {
                id: 2,
                name: 'Dante',
                email: 'dantedesignzofficial@gmail.com',
                password: 'yourpassword123',
                verified: true
            }
        ];
        
        // GLOBAL LOGIN STATE - This will persist during the session
        window.LOGIN_STATE = {
            isLoggedIn: false,
            currentUser: null,
            sessionId: null
        };
        
        // App Variables
let apiKey = '';
        let fsqApiKey = '';
        let placesProvider = 'google';
        let searchHistory = [];
        
        // Instagram API Variables
        let googleSearchApiKey = '';
        let searchEngineId = '';

        // Load API key on page load
        document.addEventListener('DOMContentLoaded', function () {
            console.log('🚀 Page loaded, initializing app...');
            console.log('🌐 Current URL:', window.location.href);
            console.log('🌐 User Agent:', navigator.userAgent);

            try {
                // Standard auth check
                console.log('🔍 Starting authentication check...');
                checkAuthStatus();
            
                console.log('🔑 Loading API key...');
loadApiKey();
                loadFsqApiKey();
                loadInstagramApiKeys();
                loadProviderSelection();

                console.log('📚 Loading search history...');
                loadSearchHistory();

                // Initialize Supabase session handling (persist across restarts)
                if (window.SUPABASE && window.SUPABASE.auth) {
                    try {
                        // Subscribe to auth state changes
                        window.SUPABASE.auth.onAuthStateChange((event, session) => {
                            console.log('🔄 Supabase auth state change:', event);
                            if (session && session.user) {
                                const u = session.user;
                                currentUser = {
                                    id: u.id,
                                    name: u.user_metadata?.name || (u.email || 'User'),
                                    email: u.email,
                                    verified: !!u.email_confirmed_at
                                };
                                sessionId = session.access_token;
                                window.LOGIN_STATE.isLoggedIn = true;
                                window.LOGIN_STATE.currentUser = currentUser;
                                window.LOGIN_STATE.sessionId = sessionId;
                                try {
                                    localStorage.setItem('outtaWebSessionId', sessionId);
                                    localStorage.setItem('outtaWebCurrentUser', JSON.stringify(currentUser));
                                } catch {}
                                showApp();
                            }
                        });

                        // Load any existing session on page load
                        window.SUPABASE.auth.getSession().then(({ data: { session } }) => {
                            if (session && session.user && !window.LOGIN_STATE.isLoggedIn) {
                                const u = session.user;
                                currentUser = {
                                    id: u.id,
                                    name: u.user_metadata?.name || (u.email || 'User'),
                                    email: u.email,
                                    verified: !!u.email_confirmed_at
                                };
                                sessionId = session.access_token;
                                window.LOGIN_STATE.isLoggedIn = true;
                                window.LOGIN_STATE.currentUser = currentUser;
                                window.LOGIN_STATE.sessionId = sessionId;
                                try {
                                    localStorage.setItem('outtaWebSessionId', sessionId);
                                    localStorage.setItem('outtaWebCurrentUser', JSON.stringify(currentUser));
                                } catch {}
                                showApp();
                            }
                        });
                    } catch (e) {
                        console.log('ℹ️ Supabase session init skipped:', e.message);
                    }
                }

                console.log('✅ App initialization completed');
            } catch (error) {
                console.error('❌ Error during app initialization:', error);
                alert('⚠️ Error during app initialization. Check console for details.');
            }
            
            // Add event listeners
            document.getElementById('location').addEventListener('keydown', function (e) {
                if (e.key === ',') {
                    e.preventDefault();
                    addLocation();
                }
            });
            
            document.getElementById('location').addEventListener('input', function (e) {
                handleLocationInput(e.target.value);
            });
            
            document.getElementById('niche').addEventListener('input', function (e) {
                handleNicheInput(e.target.value);
            });
            
            // Add login form event listeners
            document.getElementById('loginForm').addEventListener('submit', function (e) {
                e.preventDefault();
                login();
            });
            
            document.getElementById('registerForm').addEventListener('submit', function (e) {
                e.preventDefault();
                register();
            });

// Wire exclusions UI (if present)
            try { wireExclusionsUI(); } catch {}

            // Provider selection events
            try {
                document.querySelectorAll('input[name="placesProvider"]').forEach(r => {
                    r.addEventListener('change', () => {
                        placesProvider = r.value;
                        try { localStorage.setItem('placesProvider', placesProvider); } catch {}
                    });
                });
            } catch {}
        });

        function handleLocationInput(value) {
            if (value.length < 2) {
                document.getElementById('locationRecommendations').innerHTML = '';
                return;
            }
            
            const suggestions = getLocationSuggestions(value);
            displayLocationSuggestions(suggestions);
        }

        function getLocationSuggestions(query) {
            const allUSCities = [
                // Major Cities
                'New York, NY', 'Los Angeles, CA', 'Chicago, IL', 'Houston, TX', 'Phoenix, AZ',
                'Philadelphia, PA', 'San Antonio, TX', 'San Diego, CA', 'Dallas, TX', 'San Jose, CA',
                'Austin, TX', 'Jacksonville, FL', 'Fort Worth, TX', 'Columbus, OH', 'Charlotte, NC',
                'San Francisco, CA', 'Indianapolis, IN', 'Seattle, WA', 'Denver, CO', 'Washington, DC',
                'Boston, MA', 'El Paso, TX', 'Nashville, TN', 'Detroit, MI', 'Oklahoma City, OK',
                'Portland, OR', 'Las Vegas, NV', 'Memphis, TN', 'Louisville, KY', 'Baltimore, MD',
                'Milwaukee, WI', 'Albuquerque, NM', 'Tucson, AZ', 'Fresno, CA', 'Sacramento, CA',
                'Mesa, AZ', 'Kansas City, MO', 'Atlanta, GA', 'Long Beach, CA', 'Colorado Springs, CO',
                'Raleigh, NC', 'Miami, FL', 'Virginia Beach, VA', 'Omaha, NE', 'Oakland, CA',
                'Minneapolis, MN', 'Tulsa, OK', 'Arlington, TX', 'Tampa, FL', 'New Orleans, LA',
                'Wichita, KS', 'Cleveland, OH', 'Bakersfield, CA', 'Aurora, CO', 'Anaheim, CA',
                'Honolulu, HI', 'Santa Ana, CA', 'Corpus Christi, TX', 'Riverside, CA', 'Lexington, KY',
                'Stockton, CA', 'Henderson, NV', 'Saint Paul, MN', 'St. Louis, MO', 'Fort Wayne, IN',
                'Greensboro, NC', 'Anchorage, AK', 'Plano, TX', 'Lincoln, NE', 'Orlando, FL',
                'Irvine, CA', 'Newark, NJ', 'Durham, NC', 'Chula Vista, CA', 'Toledo, OH',
                'Fort Lauderdale, FL', 'Laredo, TX', 'Chandler, AZ', 'Madison, WI', 'Lubbock, TX',
                'Scottsdale, AZ', 'Reno, NV', 'Glendale, AZ', 'Gilbert, AZ', 'Winston-Salem, NC',
                'North Las Vegas, NV', 'Norfolk, VA', 'Chesapeake, VA', 'Garland, TX', 'Irving, TX',
                'Hialeah, FL', 'Fremont, CA', 'Boise, ID', 'Richmond, VA', 'Baton Rouge, LA',
                'Spokane, WA', 'Birmingham, AL', 'Montgomery, AL', 'Mobile, AL', 'Huntsville, AL',
                'Tuscaloosa, AL', 'Auburn, AL', 'Dothan, AL', 'Decatur, AL', 'Madison, AL',
                'Florence, AL', 'Gadsden, AL', 'Vestavia Hills, AL', 'Phoenix, AZ', 'Tucson, AZ',
                'Mesa, AZ', 'Chandler, AZ', 'Scottsdale, AZ', 'Glendale, AZ', 'Gilbert, AZ',
                'Tempe, AZ', 'Peoria, AZ', 'Surprise, AZ', 'Yuma, AZ', 'Avondale, AZ',
                'Goodyear, AZ', 'Flagstaff, AZ', 'Buckeye, AZ', 'Casa Grande, AZ', 'Lake Havasu City, AZ',
                'Maricopa, AZ', 'Oro Valley, AZ', 'Sierra Vista, AZ', 'Prescott Valley, AZ',
                'Little Rock, AR', 'Fort Smith, AR', 'Fayetteville, AR', 'Springdale, AR',
                'Jonesboro, AR', 'North Little Rock, AR', 'Conway, AR', 'Rogers, AR',
                'Pine Bluff, AR', 'Bentonville, AR', 'Hot Springs, AR', 'Texarkana, AR',
                'Jacksonville, AR', 'Russellville, AR', 'El Dorado, AR', 'West Memphis, AR',
                'Los Angeles, CA', 'San Diego, CA', 'San Jose, CA', 'San Francisco, CA',
                'Fresno, CA', 'Sacramento, CA', 'Long Beach, CA', 'Oakland, CA', 'Bakersfield, CA',
                'Anaheim, CA', 'Santa Ana, CA', 'Riverside, CA', 'Stockton, CA', 'Irvine, CA',
                'Fremont, CA', 'Chula Vista, CA', 'Glendale, CA', 'Modesto, CA', 'San Bernardino, CA',
                'Fontana, CA', 'Oxnard, CA', 'Moreno Valley, CA', 'Huntington Beach, CA',
                'Glendale, CA', 'Santa Clarita, CA', 'Garden Grove, CA', 'Oceanside, CA',
                'Rancho Cucamonga, CA', 'Santa Rosa, CA', 'Ontario, CA', 'Lancaster, CA',
                'Elk Grove, CA', 'Corona, CA', 'Palmdale, CA', 'Salinas, CA', 'Pomona, CA',
                'Hayward, CA', 'Escondido, CA', 'Torrance, CA', 'Sunnyvale, CA', 'Orange, CA',
                'Fullerton, CA', 'Pasadena, CA', 'Thousand Oaks, CA', 'Visalia, CA', 'Simi Valley, CA',
                'Concord, CA', 'Roseville, CA', 'Clovis, CA', 'Fairfield, CA', 'Berkeley, CA',
                'Richmond, CA', 'Arden-Arcade, CA', 'Chico, CA', 'Daly City, CA', 'San Rafeal, CA',
                'San Mateo, CA', 'Tracy, CA', 'Yuba City, CA', 'San Leandro, CA', 'Livermore, CA',
                'Antioch, CA', 'Turlock, CA', 'Palm Springs, CA', 'Davis, CA', 'Redding, CA',
                'San Clemente, CA', 'Walnut Creek, CA', 'Pleasanton, CA', 'Mountain View, CA',
                'Lake Forest, CA', 'Merced, CA', 'Redwood City, CA', 'Folsom, CA', 'Newport Beach, CA',
                'San Ramon, CA', 'Manteca, CA', 'Union City, CA', 'Lodi, CA', 'Tracy, CA',
                'Denver, CO', 'Colorado Springs, CO', 'Aurora, CO', 'Fort Collins, CO',
                'Lakewood, CO', 'Thornton, CO', 'Arvada, CO', 'Westminster, CO', 'Pueblo, CO',
                'Boulder, CO', 'Greeley, CO', 'Longmont, CO', 'Loveland, CO', 'Grand Junction, CO',
                'Broomfield, CO', 'Castle Rock, CO', 'Commerce City, CO', 'Parker, CO',
                'Littleton, CO', 'Northglenn, CO', 'Englewood, CO', 'Wheat Ridge, CO',
                'New Haven, CT', 'Bridgeport, CT', 'Stamford, CT', 'Hartford, CT', 'Waterbury, CT',
                'Norwalk, CT', 'Danbury, CT', 'New Britain, CT', 'Bristol, CT', 'Meriden, CT',
                'West Haven, CT', 'Milford, CT', 'Stratford, CT', 'Greenwich, CT', 'Hamden, CT',
                'Fairfield, CT', 'Manchester, CT', 'Bristol, CT', 'Westport, CT', 'Trumbull, CT',
                'Wilmington, DE', 'Dover, DE', 'Newark, DE', 'Middletown, DE', 'Smyrna, DE',
                'Milford, DE', 'Seaford, DE', 'Georgetown, DE', 'Elsmere, DE', 'New Castle, DE',
                'Jacksonville, FL', 'Miami, FL', 'Tampa, FL', 'Orlando, FL', 'St. Petersburg, FL',
                'Hialeah, FL', 'Tallahassee, FL', 'Fort Lauderdale, FL', 'Port St. Lucie, FL',
                'Cape Coral, FL', 'Gainesville, FL', 'Coral Springs, FL', 'Clearwater, FL',
                'Miami Gardens, FL', 'Palm Bay, FL', 'West Palm Beach, FL', 'Sunrise, FL',
                'Lakeland, FL', 'Boca Raton, FL', 'Hollywood, FL', 'Pembroke Pines, FL',
                'Gainesville, FL', 'Miramar, FL', 'Kissimmee, FL', 'Palm Coast, FL',
                'Deltona, FL', 'Plantation, FL', 'Alafaya, FL', 'Lehigh Acres, FL',
                'Atlanta, GA', 'Augusta, GA', 'Columbus, GA', 'Macon, GA', 'Savannah, GA',
                'Athens, GA', 'Sandy Springs, GA', 'Roswell, GA', 'Albany, GA', 'Johns Creek, GA',
                'Warner Robins, GA', 'Alpharetta, GA', 'Marietta, GA', 'Valdosta, GA',
                'Smyrna, GA', 'Dunwoody, GA', 'Rome, GA', 'Gainesville, GA', 'East Point, GA',
                'Newnan, GA', 'Dalton, GA', 'Kennesaw, GA', 'Peachtree City, GA', 'Tucker, GA',
                'Honolulu, HI', 'Hilo, HI', 'Kailua, HI', 'Kapolei, HI', 'Kaneohe, HI',
                'Mililani Town, HI', 'Ewa Gentry, HI', 'Kihei, HI', 'Makakilo, HI', 'Wahiawa, HI',
                'Schofield Barracks, HI', 'Wailuku, HI', 'Pearl City, HI', 'Waipahu, HI',
                'Ewa Beach, HI', 'Hilo, HI', 'Kailua, HI', 'Waimalu, HI', 'Aiea, HI',
                'Boise, ID', 'Meridian, ID', 'Nampa, ID', 'Idaho Falls, ID', 'Pocatello, ID',
                'Caldwell, ID', 'Coeur d\'Alene, ID', 'Twin Falls, ID', 'Lewiston, ID',
                'Post Falls, ID', 'Rexburg, ID', 'Moscow, ID', 'Eagle, ID', 'Kuna, ID',
                'Ammon, ID', 'Chubbuck, ID', 'Hayden, ID', 'Mountain Home, ID', 'Blackfoot, ID',
                'Chicago, IL', 'Aurora, IL', 'Rockford, IL', 'Joliet, IL', 'Naperville, IL',
                'Springfield, IL', 'Peoria, IL', 'Elgin, IL', 'Waukegan, IL', 'Champaign, IL',
                'Bloomington, IL', 'Arlington Heights, IL', 'Evanston, IL', 'Decatur, IL',
                'Schaumburg, IL', 'Bolingbrook, IL', 'Palatine, IL', 'Skokie, IL', 'Des Plaines, IL',
                'Orland Park, IL', 'Tinley Park, IL', 'Oak Lawn, IL', 'Berwyn, IL', 'Mount Prospect, IL',
                'Normal, IL', 'Wheaton, IL', 'Hoffman Estates, IL', 'Oak Park, IL', 'Downers Grove, IL',
                'Elmhurst, IL', 'Glenview, IL', 'DeKalb, IL', 'Lombard, IL', 'Buffalo Grove, IL',
                'Indianapolis, IN', 'Fort Wayne, IN', 'Evansville, IN', 'South Bend, IN', 'Carmel, IN',
                'Fishers, IN', 'Bloomington, IN', 'Hammond, IN', 'Gary, IN', 'Lafayette, IN',
                'Muncie, IN', 'Terre Haute, IN', 'Kokomo, IN', 'Anderson, IN', 'Noblesville, IN',
                'Greenwood, IN', 'Elkhart, IN', 'Michigan City, IN', 'Lawrence, IN', 'Jeffersonville, IN',
                'Columbus, IN', 'Portage, IN', 'New Albany, IN', 'Mishawaka, IN', 'Greenfield, IN',
                'Des Moines, IA', 'Cedar Rapids, IA', 'Davenport, IA', 'Sioux City, IA', 'Iowa City, IA',
                'Waterloo, IA', 'Ames, IA', 'West Des Moines, IA', 'Council Bluffs, IA', 'Dubuque, IA',
                'Cedar Falls, IA', 'Mason City, IA', 'Marshalltown, IA', 'Clinton, IA', 'Burlington, IA',
                'Fort Dodge, IA', 'Ottumwa, IA', 'Sioux City, IA', 'Clinton, IA', 'Mason City, IA',
                'Wichita, KS', 'Overland Park, KS', 'Kansas City, KS', 'Olathe, KS', 'Topeka, KS',
                'Lawrence, KS', 'Shawnee, KS', 'Manhattan, KS', 'Lenexa, KS', 'Salina, KS',
                'Hutchinson, KS', 'Leavenworth, KS', 'Leawood, KS', 'Garden City, KS', 'Dodge City, KS',
                'Emporia, KS', 'Junction City, KS', 'Pittsburg, KS', 'Great Bend, KS', 'Hays, KS',
                'Louisville, KY', 'Lexington, KY', 'Bowling Green, KY', 'Owensboro, KY', 'Covington, KY',
                'Richmond, KY', 'Georgetown, KY', 'Florence, KY', 'Elizabethtown, KY', 'Nicholasville, KY',
                'Henderson, KY', 'Hopkinsville, KY', 'Winchester, KY', 'Murray, KY', 'Paducah, KY',
                'St. Matthews, KY', 'Frankfort, KY', 'Ashland, KY', 'Berea, KY', 'Somerset, KY',
                'New Orleans, LA', 'Baton Rouge, LA', 'Shreveport, LA', 'Lafayette, LA', 'Lake Charles, LA',
                'Kenner, LA', 'Bossier City, LA', 'Monroe, LA', 'Alexandria, LA', 'Houma, LA',
                'New Iberia, LA', 'Ruston, LA', 'Sulphur, LA', 'Hammond, LA', 'Natchitoches, LA',
                'Zachary, LA', 'Gonzales, LA', 'Thibodaux, LA', 'Minden, LA', 'Opelousas, LA',
                'Portland, ME', 'Lewiston, ME', 'Bangor, ME', 'Auburn, ME', 'Biddeford, ME',
                'Sanford, ME', 'Brunswick, ME', 'Augusta, ME', 'Scarborough, ME', 'Gorham, ME',
                'Westbrook, ME', 'Waterville, ME', 'Windham, ME', 'York, ME', 'Falmouth, ME',
                'Cape Elizabeth, ME', 'Bath, ME', 'Old Orchard Beach, ME', 'Kennebunk, ME',
                'Baltimore, MD', 'Frederick, MD', 'Rockville, MD', 'Gaithersburg, MD', 'Bowie, MD',
                'Hagerstown, MD', 'Annapolis, MD', 'College Park, MD', 'Salisbury, MD', 'Laurel, MD',
                'Greenbelt, MD', 'Cumberland, MD', 'Takoma Park, MD', 'Hyattsville, MD', 'Easton, MD',
                'Ocean City, MD', 'Cambridge, MD', 'Westminster, MD', 'Havre de Grace, MD', 'Frostburg, MD',
                'Boston, MA', 'Worcester, MA', 'Springfield, MA', 'Lowell, MA', 'Cambridge, MA',
                'New Bedford, MA', 'Brockton, MA', 'Quincy, MA', 'Lynn, MA', 'Fall River, MA',
                'Newton, MA', 'Lawrence, MA', 'Somerville, MA', 'Framingham, MA', 'Haverhill, MA',
                'Malden, MA', 'Waltham, MA', 'Brookline, MA', 'Plymouth, MA', 'Medford, MA',
                'Taunton, MA', 'Chicopee, MA', 'Weymouth, MA', 'Revere, MA', 'Peabody, MA',
                'Detroit, MI', 'Grand Rapids, MI', 'Warren, MI', 'Sterling Heights, MI', 'Lansing, MI',
                'Ann Arbor, MI', 'Flint, MI', 'Dearborn, MI', 'Livonia, MI', 'Westland, MI',
                'Troy, MI', 'Farmington Hills, MI', 'Kalamazoo, MI', 'Wyoming, MI', 'Rochester Hills, MI',
                'Southfield, MI', 'Taylor, MI', 'Pontiac, MI', 'St. Clair Shores, MI', 'Royal Oak, MI',
                'Dearborn Heights, MI', 'Novi, MI', 'Battle Creek, MI', 'Saginaw, MI', 'Kentwood, MI',
                'East Lansing, MI', 'Roseville, MI', 'Portage, MI', 'Midland, MI', 'Lincoln Park, MI',
                'Minneapolis, MN', 'St. Paul, MN', 'Rochester, MN', 'Duluth, MN', 'Bloomington, MN',
                'Brooklyn Park, MN', 'Plymouth, MN', 'St. Cloud, MN', 'Eagan, MN', 'Woodbury, MN',
                'Eden Prairie, MN', 'Coon Rapids, MN', 'Burnsville, MN', 'Mankato, MN', 'Moorhead, MN',
                'Winona, MN', 'Marshall, MN', 'Bemidji, MN', 'Grand Rapids, MN',
                'Jackson, MS', 'Gulfport, MS', 'Southaven, MS', 'Hattiesburg, MS', 'Biloxi, MS',
                'Meridian, MS', 'Tupelo, MS', 'Greenville, MS', 'Olive Branch, MS', 'Horn Lake, MS',
                'Gautier, MS', 'Laurel, MS', 'Starkville, MS', 'Vicksburg, MS', 'Greenwood, MS',
                'Columbus, MS', 'Oxford, MS', 'Grenada, MS', 'Natchez, MS', 'Hernando, MS',
                'Kansas City, MO', 'St. Louis, MO', 'Springfield, MO', 'Columbia, MO', 'Independence, MO',
                'Lee\'s Summit, MO', 'O\'Fallon, MO', 'St. Joseph, MO', 'St. Charles, MO', 'St. Peters, MO',
                'Blue Springs, MO', 'Florissant, MO', 'Joplin, MO', 'Chesterfield, MO', 'Jefferson City, MO',
                'Cape Girardeau, MO', 'Wildwood, MO', 'University City, MO', 'Ballwin, MO', 'Liberty, MO',
                'Billings, MT', 'Missoula, MT', 'Great Falls, MT', 'Bozeman, MT', 'Butte, MT',
                'Helena, MT', 'Kalispell, MT', 'Havre, MT', 'Anaconda, MT', 'Miles City, MT',
                'Lewistown, MT', 'Hamilton, MT', 'Livingston, MT', 'Laurel, MT', 'Whitefish, MT',
                'Omaha, NE', 'Lincoln, NE', 'Bellevue, NE', 'Grand Island, NE', 'Kearney, NE',
                'Fremont, NE', 'Hastings, NE', 'Norfolk, NE', 'Columbus, NE', 'North Platte, NE',
                'Beatrice, NE', 'Lexington, NE', 'Scottsbluff, NE', 'McCook, NE', 'Alliance, NE',
                'Las Vegas, NV', 'Henderson, NV', 'Reno, NV', 'North Las Vegas, NV', 'Sparks, NV',
                'Carson City, NV', 'Fernley, NV', 'Elko, NV', 'Mesquite, NV', 'Boulder City, NV',
                'Fallon, NV', 'Winnemucca, NV', 'West Wendover, NV', 'Ely, NV', 'Virginia City, NV',
                'Manchester, NH', 'Nashua, NH', 'Concord, NH', 'Dover, NH', 'Rochester, NH',
                'Keene, NH', 'Derry, NH', 'Portsmouth, NH', 'Laconia, NH', 'Lebanon, NH',
                'Claremont, NH', 'Somersworth, NH', 'Berlin, NH', 'Franklin, NH', 'Laconia, NH',
                'Newark, NJ', 'Jersey City, NJ', 'Paterson, NJ', 'Elizabeth, NJ', 'Edison, NJ',
                'Woodbridge, NJ', 'Lakewood, NJ', 'Toms River, NJ', 'Hamilton, NJ', 'Trenton, NJ',
                'Clifton, NJ', 'Camden, NJ', 'Brick, NJ', 'Cherry Hill, NJ', 'Passaic, NJ',
                'Middletown, NJ', 'Union City, NJ', 'Old Bridge, NJ', 'Gloucester, NJ', 'East Orange, NJ',
                'Albuquerque, NM', 'Las Cruces, NM', 'Rio Rancho, NM', 'Santa Fe, NM', 'Roswell, NM',
                'Farmington, NM', 'South Valley, NM', 'Clovis, NM', 'Hobbs, NM', 'Alamogordo, NM',
                'Carlsbad, NM', 'Gallup, NM', 'Deming, NM', 'Los Lunas, NM', 'Las Vegas, NM',
                'New York, NY', 'Buffalo, NY', 'Rochester, NY', 'Yonkers, NY', 'Syracuse, NY',
                'Albany, NY', 'New Rochelle, NY', 'Mount Vernon, NY', 'Schenectady, NY', 'Utica, NY',
                'White Plains, NY', 'Hempstead, NY', 'Troy, NY', 'Niagara Falls, NY', 'Binghamton, NY',
                'Freeport, NY', 'Valley Stream, NY', 'Long Beach, NY', 'Ithaca, NY', 'Saratoga Springs, NY',
                'Charlotte, NC', 'Raleigh, NC', 'Greensboro, NC', 'Durham, NC', 'Winston-Salem, NC',
                'Fayetteville, NC', 'Cary, NC', 'Wilmington, NC', 'High Point, NC', 'Greenville, NC',
                'Asheville, NC', 'Concord, NC', 'Gastonia, NC', 'Jacksonville, NC', 'Chapel Hill, NC',
                'Rocky Mount, NC', 'Burlington, NC', 'Wilson, NC', 'Huntersville, NC', 'Kannapolis, NC',
                'Fargo, ND', 'Bismarck, ND', 'Grand Forks, ND', 'Minot, ND', 'West Fargo, ND',
                'Williston, ND', 'Dickinson, ND', 'Mandan, ND', 'Jamestown, ND', 'Wahpeton, ND',
                'Devils Lake, ND', 'Valley City, ND', 'Grafton, ND', 'Carrington, ND', 'Rugby, ND',
                'Columbus, OH', 'Cleveland, OH', 'Cincinnati, OH', 'Toledo, OH', 'Akron, OH',
                'Dayton, OH', 'Parma, OH', 'Canton, OH', 'Youngstown, OH', 'Lorain, OH',
                'Hamilton, OH', 'Springfield, OH', 'Kettering, OH', 'Elyria, OH', 'Lakewood, OH',
                'Cuyahoga Falls, OH', 'Middletown, OH', 'Newark, OH', 'Mansfield, OH', 'Mentor, OH',
                'Oklahoma City, OK', 'Tulsa, OK', 'Norman, OK', 'Broken Arrow, OK', 'Lawton, OK',
                'Edmond, OK', 'Moore, OK', 'Midwest City, OK', 'Enid, OK', 'Stillwater, OK',
                'Bartlesville, OK', 'Ardmore, OK', 'Ponca City, OK', 'Shawnee, OK', 'Yukon, OK',
                'Guthrie, OK', 'El Reno, OK', 'Chickasha, OK', 'Woodward, OK', 'Durant, OK',
                'Portland, OR', 'Salem, OR', 'Eugene, OR', 'Gresham, OR', 'Hillsboro, OR',
                'Beaverton, OR', 'Bend, OR', 'Medford, OR', 'Springfield, OR', 'Corvallis, OR',
                'Albany, OR', 'Tigard, OR', 'Lake Oswego, OR', 'Keizer, OR', 'Grants Pass, OR',
                'Oregon City, OR', 'McMinnville, OR', 'Redmond, OR', 'Tualatin, OR', 'West Linn, OR',
                'Philadelphia, PA', 'Pittsburgh, PA', 'Allentown, PA', 'Erie, PA', 'Reading, PA',
                'Scranton, PA', 'Bethlehem, PA', 'Lancaster, PA', 'Harrisburg, PA', 'Altoona, PA',
                'York, PA', 'State College, PA', 'Wilkes-Barre, PA', 'Johnstown, PA', 'Chester, PA',
                'Williamsport, PA', 'Lebanon, PA', 'Pottsville, PA', 'Easton, PA', 'Sharon, PA',
                'Providence, RI', 'Warwick, RI', 'Cranston, RI', 'Pawtucket, RI', 'East Providence, RI',
                'Woonsocket, RI', 'Coventry, RI', 'Cumberland, RI', 'West Warwick, RI', 'Johnston, RI',
                'North Providence, RI', 'West Greenwich, RI', 'North Kingstown, RI', 'Bristol, RI',
                'Charleston, SC', 'Columbia, SC', 'North Charleston, SC', 'Mount Pleasant, SC', 'Rock Hill, SC',
                'Greenville, SC', 'Summerville, SC', 'Sumter, SC', 'Hilton Head Island, SC', 'Florence, SC',
                'Spartanburg, SC', 'Goose Creek, SC', 'Aiken, SC', 'Myrtle Beach, SC', 'Anderson, SC',
                'Greer, SC', 'Mauldin, SC', 'Greenwood, SC', 'North Augusta, SC', 'Easley, SC',
                'Sioux Falls, SD', 'Rapid City, SD', 'Aberdeen, SD', 'Brookings, SD', 'Watertown, SD',
                'Mitchell, SD', 'Yankton, SD', 'Pierre, SD', 'Huron, SD', 'Vermillion, SD',
                'Spearfish, SD', 'Brandon, SD', 'Madison, SD', 'Belle Fourche, SD', 'Hot Springs, SD',
                'Nashville, TN', 'Memphis, TN', 'Knoxville, TN', 'Chattanooga, TN', 'Clarksville, TN',
                'Murfreesboro, TN', 'Franklin, TN', 'Jackson, TN', 'Johnson City, TN', 'Hendersonville, TN',
                'Kingsport, TN', 'Collierville, TN', 'Smyrna, TN', 'Germantown, TN', 'Cleveland, TN',
                'Columbia, TN', 'Oak Ridge, TN', 'Morristown, TN', 'Bristol, TN', 'Lebanon, TN',
                'Houston, TX', 'San Antonio, TX', 'Dallas, TX', 'Austin, TX', 'Fort Worth, TX',
                'El Paso, TX', 'Arlington, TX', 'Corpus Christi, TX', 'Plano, TX', 'Laredo, TX',
                'Lubbock, TX', 'Garland, TX', 'Irving, TX', 'Amarillo, TX', 'Grand Prairie, TX',
                'McKinney, TX', 'Frisco, TX', 'McAllen, TX', 'Waco, TX', 'Carrollton, TX',
                'Denton, TX', 'Midland, TX', 'Abilene, TX', 'Beaumont, TX', 'Round Rock, TX',
                'Odessa, TX', 'Wichita Falls, TX', 'Richardson, TX', 'Lewisville, TX', 'Tyler, TX',
                'College Station, TX', 'San Marcos, TX', 'New Braunfels, TX', 'Killeen, TX', 'Longview, TX',
                'Salt Lake City, UT', 'West Valley City, UT', 'Provo, UT', 'West Jordan, UT', 'Orem, UT',
                'Sandy, UT', 'Ogden, UT', 'St. George, UT', 'Layton, UT', 'South Jordan, UT',
                'Lehi, UT', 'Millcreek, UT', 'Taylorsville, UT', 'Logan, UT', 'Murray, UT',
                'Draper, UT', 'Bountiful, UT', 'Riverton, UT', 'Roy, UT', 'Spanish Fork, UT',
                'Burlington, VT', 'South Burlington, VT', 'Rutland, VT', 'Barre, VT', 'Montpelier, VT',
                'Winooski, VT', 'St. Albans, VT', 'Newport, VT', 'Vergennes, VT', 'Middlebury, VT',
                'St. Johnsbury, VT', 'Waterbury, VT', 'Montpelier, VT', 'Northfield, VT', 'Randolph, VT',
                'Virginia Beach, VA', 'Norfolk, VA', 'Arlington, VA', 'Richmond, VA', 'Newport News, VA',
                'Alexandria, VA', 'Hampton, VA', 'Roanoke, VA', 'Portsmouth, VA', 'Suffolk, VA',
                'Lynchburg, VA', 'Harrisonburg, VA', 'Leesburg, VA', 'Charlottesville, VA',
                'Danville, VA', 'Manassas, VA', 'Petersburg, VA', 'Fredericksburg, VA', 'Winchester, VA',
                'Seattle, WA', 'Spokane, WA', 'Tacoma, WA', 'Vancouver, WA', 'Bellevue, WA',
                'Kent, WA', 'Everett, WA', 'Renton, WA', 'Yakima, WA', 'Federal Way, WA',
                'Spokane Valley, WA', 'Bellingham, WA', 'Kennewick, WA', 'Auburn, WA', 'Pasco, WA',
                'Marysville, WA', 'Lakewood, WA', 'Redmond, WA', 'Shoreline, WA', 'Richland, WA',
                'Charleston, WV', 'Huntington, WV', 'Parkersburg, WV', 'Morgantown, WV', 'Wheeling, WV',
                'Weirton, WV', 'Fairmont, WV', 'Martinsburg, WV', 'Beckley, WV', 'Clarksburg, WV',
                'South Charleston, WV', 'St. Albans, WV', 'Vienna, WV', 'Cross Lanes, WV', 'Bluefield, WV',
                'Milwaukee, WI', 'Madison, WI', 'Green Bay, WI', 'Kenosha, WI', 'Racine, WI',
                'Appleton, WI', 'Waukesha, WI', 'Oshkosh, WI', 'Eau Claire, WI', 'Janesville, WI',
                'West Allis, WI', 'La Crosse, WI', 'Sheboygan, WI', 'Wauwatosa, WI', 'Fond du Lac, WI',
                'New Berlin, WI', 'Beloit, WI', 'Superior, WI', 'Stevens Point, WI', 'Neenah, WI',
                'Cheyenne, WY', 'Casper, WY', 'Laramie, WY', 'Gillette, WY', 'Rock Springs, WY',
                'Sheridan, WY', 'Green River, WY', 'Evanston, WY', 'Riverton, WY', 'Cody, WY',
                'Rawlins, WY', 'Lander, WY', 'Torrington, WY', 'Powell, WY', 'Douglas, WY'
            ];
            
            // Add US States with abbreviations
            const allUSStates = [
                'Alabama, AL', 'Alaska, AK', 'Arizona, AZ', 'Arkansas, AR', 'California, CA',
                'Colorado, CO', 'Connecticut, CT', 'Delaware, DE', 'Florida, FL', 'Georgia, GA',
                'Hawaii, HI', 'Idaho, ID', 'Illinois, IL', 'Indiana, IN', 'Iowa, IA',
                'Kansas, KS', 'Kentucky, KY', 'Louisiana, LA', 'Maine, ME', 'Maryland, MD',
                'Massachusetts, MA', 'Michigan, MI', 'Minnesota, MN', 'Mississippi, MS', 'Missouri, MO',
                'Montana, MT', 'Nebraska, NE', 'Nevada, NV', 'New Hampshire, NH', 'New Jersey, NJ',
                'New Mexico, NM', 'New York, NY', 'North Carolina, NC', 'North Dakota, ND', 'Ohio, OH',
                'Oklahoma, OK', 'Oregon, OR', 'Pennsylvania, PA', 'Rhode Island, RI', 'South Carolina, SC',
                'South Dakota, SD', 'Tennessee, TN', 'Texas, TX', 'Utah, UT', 'Vermont, VT',
                'Virginia, VA', 'Washington, WA', 'West Virginia, WV', 'Wisconsin, WI', 'Wyoming, WY'
            ];
            
            // Add US States without abbreviations (just state names)
            const allUSStateNames = [
                'Alabama', 'Alaska', 'Arizona', 'Arkansas', 'California',
                'Colorado', 'Connecticut', 'Delaware', 'Florida', 'Georgia',
                'Hawaii', 'Idaho', 'Illinois', 'Indiana', 'Iowa',
                'Kansas', 'Kentucky', 'Louisiana', 'Maine', 'Maryland',
                'Massachusetts', 'Michigan', 'Minnesota', 'Mississippi', 'Missouri',
                'Montana', 'Nebraska', 'Nevada', 'New Hampshire', 'New Jersey',
                'New Mexico', 'New York', 'North Carolina', 'North Dakota', 'Ohio',
                'Oklahoma', 'Oregon', 'Pennsylvania', 'Rhode Island', 'South Carolina',
                'South Dakota', 'Tennessee', 'Texas', 'Utah', 'Vermont',
                'Virginia', 'Washington', 'West Virginia', 'Wisconsin', 'Wyoming'
            ];
            
            // Combine cities, states with abbreviations, and state names
            const allLocations = [...allUSCities, ...allUSStates, ...allUSStateNames];
            
            return allLocations.filter(location => 
                location.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 18); // Show more suggestions since we have more options
        }

        function displayLocationSuggestions(suggestions) {
            const container = document.getElementById('locationRecommendations');
            
            if (suggestions.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            let html = '<div style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px;">';
            
            suggestions.forEach(city => {
                html += `
                    <button class="location-chip" onclick="addLocationFromSuggestion('${city}')">
                        ${city}
                    </button>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function addLocationFromSuggestion(city) {
            const container = document.getElementById('locationList');
            const chip = document.createElement('button');
            chip.className = 'location-chip';
            chip.textContent = city;
            chip.onclick = () => chip.remove();
            container.appendChild(chip);
            
            // Clear the input and suggestions
            document.getElementById('location').value = '';
            document.getElementById('locationRecommendations').innerHTML = '';
        }

        function addLocation() {
            const input = document.getElementById('location');
            const value = input.value.trim();
            
            if (!value) return;
            
            // Use the same parsing logic as bulk locations
            const locations = parseBulkLocations(value);

            if (locations.length === 0) {
                alert('Please enter a valid location format (e.g., "Los Angeles, CA" or "Houston TX")');
                return;
            }

                const container = document.getElementById('locationList');
            locations.forEach(location => {
                // Check if location already exists
                const existingChips = container.querySelectorAll('.location-chip');
                let exists = false;
                for (let chip of existingChips) {
                    if (chip.textContent.toLowerCase() === location.toLowerCase()) {
                        exists = true;
                        break;
                    }
                }

                if (!exists) {
                const chip = document.createElement('button');
                chip.className = 'location-chip';
                chip.textContent = location;
                chip.onclick = () => chip.remove();
                container.appendChild(chip);
                }
            });
            
            input.value = '';

            // Show success message if multiple locations were added
            if (locations.length > 1) {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    background: #d4edda;
                    color: #155724;
                    padding: 10px;
                    border-radius: 4px;
                    margin-top: 10px;
                    font-size: 14px;
                    border: 1px solid #c3e6cb;
                `;
                notification.innerHTML = `✅ Added ${locations.length} location(s) successfully!`;
                container.parentNode.appendChild(notification);

                // Remove notification after 3 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 3000);
            }
        }

        function getSelectedLocations() {
            const locationChips = document.querySelectorAll('#locationList .location-chip');
            return Array.from(locationChips).map(chip => chip.textContent);
        }

        function handleNicheInput(value) {
            if (value.length < 2) {
                document.getElementById('nicheSuggestions').innerHTML = '';
                return;
            }
            
            const suggestions = getNicheSuggestions(value);
            displayNicheSuggestions(suggestions);
        }

        function getNicheSuggestions(query) {
            const allNiches = [
                // Personal Services
                'barber shops', 'hair salons', 'nail salons', 'spas', 'massage therapy', 'tattoo shops', 'piercing studios', 'tanning salons',
                // Home Services
                'plumbers', 'electricians', 'HVAC contractors', 'roofers', 'painters', 'landscapers', 'cleaning services', 'handyman services',
                // Automotive
                'auto repair', 'car wash', 'tire shops', 'auto detailing', 'oil change', 'brake repair', 'transmission repair', 'auto body shops',
                // Professional Services
                'interior designers', 'photographers', 'personal trainers', 'tutors', 'accountants', 'lawyers', 'real estate agents', 'consultants',
                // Food & Beverage
                'restaurants', 'food trucks', 'catering', 'bakeries', 'coffee shops', 'pizza places', 'food delivery', 'meal prep',
                // Health & Wellness
                'chiropractors', 'dentists', 'physical therapy', 'yoga studios', 'gyms', 'nutritionists', 'acupuncture', 'mental health',
                // Additional niches
                'pet groomers', 'veterinarians', 'daycare centers', 'tutoring centers', 'music lessons', 'dance studios', 'martial arts', 'swimming lessons',
                'dry cleaners', 'laundromats', 'tailors', 'shoe repair', 'jewelry repair', 'watch repair', 'key makers', 'locksmiths',
                'florists', 'gift shops', 'antique stores', 'thrift stores', 'pawn shops', 'bookstores', 'libraries', 'art galleries',
                'construction companies', 'contractors', 'architects', 'engineers', 'surveyors', 'inspectors', 'appraisers', 'notaries'
            ];
            
            return allNiches.filter(niche => 
                niche.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 8);
        }

        function displayNicheSuggestions(suggestions) {
            const container = document.getElementById('nicheSuggestions');
            
            if (suggestions.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            let html = '<div style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px;">';
            
            suggestions.forEach(niche => {
                html += `
                    <button class="niche-chip" onclick="addNicheFromSuggestion('${niche}')">
                        ${niche}
                    </button>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function addNicheFromSuggestion(niche) {
            addNicheToSelection(niche);
            document.getElementById('niche').value = '';
            document.getElementById('nicheSuggestions').innerHTML = '';
        }

        function addNicheFromSelection(niche) {
            addNicheToSelection(niche);
        }

        function addNicheToSelection(niche) {
            const container = document.getElementById('selectedNiches');
            
            // Check if niche is already selected
            const existingChips = container.querySelectorAll('.niche-chip');
            for (let chip of existingChips) {
                if (chip.textContent.toLowerCase() === niche.toLowerCase()) {
                    return; // Already selected
                }
            }
            
            const chip = document.createElement('button');
            chip.className = 'niche-chip';
            chip.textContent = niche;
            chip.onclick = () => chip.remove();
            container.appendChild(chip);
        }

        function getSelectedNiches() {
            const nicheChips = document.querySelectorAll('#selectedNiches .niche-chip');
            return Array.from(nicheChips).map(chip => chip.textContent);
        }

        function switchTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        function loadApiKey() {
            apiKey = localStorage.getItem('googlePlacesApiKey') || '';
            updateApiKeyDisplay();
        }

        function saveApiKey() {
            const keyInput = document.getElementById('apiKey');
            apiKey = keyInput.value.trim();
            
            if (!apiKey) {
                showApiStatus('Please enter a valid API key.', 'error');
                return;
            }
            
            localStorage.setItem('googlePlacesApiKey', apiKey);
            showApiStatus('API key saved successfully!', 'success');
            updateApiKeyDisplay();
        }

        function testApiKey() {
            if (!apiKey) {
                showApiStatus('Please save an API key first.', 'error');
                return;
            }
            
            showApiStatus('Testing API key...', 'info');
            
            // Test with a simple search
            const testQuery = 'restaurants in New York, NY';
            const testUrl = `https://maps.googleapis.com/maps/api/place/textsearch/json?query=${encodeURIComponent(testQuery)}&key=${apiKey}`;
            
            console.log('Testing API key with URL:', testUrl);
            
            // Try direct API call first
            fetch(testUrl)
                .then(response => {
                    console.log('API test response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('API test response:', data);
                    if (data.status === 'OK' || data.status === 'ZERO_RESULTS') {
                        showApiStatus('✅ API key is valid and working!', 'success');
                    } else if (data.status === 'REQUEST_DENIED') {
                        showApiStatus(`❌ API Key Error: ${data.error_message}`, 'error');
                    } else if (data.status === 'OVER_QUERY_LIMIT') {
                        showApiStatus('⚠️ API quota exceeded. Key is valid but quota is full.', 'error');
                    } else {
                        showApiStatus(`❌ API Error: ${data.status} - ${data.error_message || 'Unknown error'}`, 'error');
                    }
                })
                .catch(error => {
                    console.error('Direct API test failed, trying CORS proxy...', error);
                    
                    // If direct call fails, try CORS proxy
                    testApiKeyWithProxy();
                });
        }

        function testApiKeyWithProxy() {
            const testQuery = 'restaurants in New York, NY';
            const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
            const apiUrl = `https://maps.googleapis.com/maps/api/place/textsearch/json?query=${encodeURIComponent(testQuery)}&key=${apiKey}`;
            const url = proxyUrl + apiUrl;
            
            console.log('Testing API key with CORS proxy:', url);
            
            fetch(url, {
                method: 'GET',
                headers: {
                    'Origin': window.location.origin,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                console.log('CORS proxy test response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('CORS proxy API test response:', data);
                if (data.status === 'OK' || data.status === 'ZERO_RESULTS') {
                    showApiStatus('✅ API key is valid and working! (via proxy)', 'success');
                } else if (data.status === 'REQUEST_DENIED') {
                    showApiStatus(`❌ API Key Error: ${data.error_message}`, 'error');
                } else if (data.status === 'OVER_QUERY_LIMIT') {
                    showApiStatus('⚠️ API quota exceeded. Key is valid but quota is full.', 'error');
                } else {
                    showApiStatus(`❌ API Error: ${data.status} - ${data.error_message || 'Unknown error'}`, 'error');
                }
            })
            .catch(error => {
                console.error('CORS proxy test failed, trying alternative proxy...', error);
                
                // If primary proxy fails, try alternative proxy
                testApiKeyWithAlternativeProxy();
            });
        }

        function testApiKeyWithAlternativeProxy() {
            const testQuery = 'restaurants in New York, NY';
            const proxyUrl = 'https://api.allorigins.win/raw?url=';
            const apiUrl = `https://maps.googleapis.com/maps/api/place/textsearch/json?query=${encodeURIComponent(testQuery)}&key=${apiKey}`;
            const url = proxyUrl + encodeURIComponent(apiUrl);
            
            console.log('Testing API key with alternative proxy:', url);
            
            fetch(url)
            .then(response => {
                console.log('Alternative proxy test response status:', response.status);
                if (!response.ok) {
                    throw new Error(`Alternative proxy HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Alternative proxy API test response:', data);
                if (data.status === 'OK' || data.status === 'ZERO_RESULTS') {
                    showApiStatus('✅ API key is valid and working! (via alternative proxy)', 'success');
                } else if (data.status === 'REQUEST_DENIED') {
                    showApiStatus(`❌ API Key Error: ${data.error_message}`, 'error');
                } else if (data.status === 'OVER_QUERY_LIMIT') {
                    showApiStatus('⚠️ API quota exceeded. Key is valid but quota is full.', 'error');
                } else {
                    showApiStatus(`❌ API Error: ${data.status} - ${data.error_message || 'Unknown error'}`, 'error');
                }
            })
            .catch(error => {
                console.error('All API test methods failed:', error);
                showApiStatus('⚠️ API test failed due to network issues, but your key may still be valid. Try searching to confirm.', 'error');
            });
        }

        function getStateCities(state) {
            const stateCities = {
                'Texas': ['Houston', 'Dallas', 'Austin', 'San Antonio', 'Fort Worth', 'El Paso', 'Arlington', 'Corpus Christi', 'Plano', 'Laredo', 'Lubbock', 'Garland', 'Irving', 'Amarillo', 'Grand Prairie', 'McKinney', 'Frisco', 'McAllen', 'Waco', 'Carrollton', 'Denton', 'Midland', 'Abilene', 'Beaumont', 'Round Rock', 'Odessa', 'Wichita Falls', 'Richardson', 'Lewisville', 'Tyler', 'College Station', 'San Marcos', 'New Braunfels', 'Killeen', 'Longview'],
                'California': ['Los Angeles', 'San Diego', 'San Jose', 'San Francisco', 'Fresno', 'Sacramento', 'Long Beach', 'Oakland', 'Bakersfield', 'Anaheim', 'Santa Ana', 'Riverside', 'Stockton', 'Irvine', 'Fremont', 'Chula Vista', 'Glendale', 'Modesto', 'San Bernardino', 'Fontana', 'Oxnard', 'Moreno Valley', 'Huntington Beach', 'Santa Clarita', 'Garden Grove', 'Oceanside', 'Rancho Cucamonga', 'Santa Rosa', 'Ontario', 'Lancaster', 'Elk Grove', 'Corona', 'Palmdale', 'Salinas', 'Pomona', 'Hayward', 'Escondido', 'Torrance', 'Sunnyvale', 'Orange', 'Fullerton', 'Pasadena', 'Thousand Oaks', 'Visalia', 'Simi Valley', 'Concord', 'Roseville', 'Clovis', 'Fairfield', 'Berkeley', 'Richmond', 'Arden-Arcade', 'Chico', 'Daly City', 'San Rafael', 'San Mateo', 'Tracy', 'Yuba City', 'San Leandro', 'Livermore', 'Antioch', 'Turlock', 'Palm Springs', 'Davis', 'Redding', 'San Clemente', 'Walnut Creek', 'Pleasanton', 'Mountain View', 'Lake Forest', 'Merced', 'Redwood City', 'Folsom', 'Newport Beach', 'San Ramon', 'Manteca', 'Union City', 'Lodi', 'Tracy'],
                'Florida': ['Jacksonville', 'Miami', 'Tampa', 'Orlando', 'St. Petersburg', 'Hialeah', 'Tallahassee', 'Fort Lauderdale', 'Port St. Lucie', 'Cape Coral', 'Gainesville', 'Coral Springs', 'Clearwater', 'Miami Gardens', 'Palm Bay', 'West Palm Beach', 'Sunrise', 'Lakeland', 'Boca Raton', 'Hollywood', 'Pembroke Pines', 'Gainesville', 'Miramar', 'Kissimmee', 'Palm Coast', 'Deltona', 'Plantation', 'Alafaya', 'Lehigh Acres'],
                'New York': ['New York', 'Buffalo', 'Rochester', 'Yonkers', 'Syracuse', 'Albany', 'New Rochelle', 'Mount Vernon', 'Schenectady', 'Utica', 'White Plains', 'Hempstead', 'Troy', 'Niagara Falls', 'Binghamton', 'Freeport', 'Valley Stream', 'Long Beach', 'Ithaca', 'Saratoga Springs'],
                'Illinois': ['Chicago', 'Aurora', 'Rockford', 'Joliet', 'Naperville', 'Springfield', 'Peoria', 'Elgin', 'Waukegan', 'Champaign', 'Bloomington', 'Arlington Heights', 'Evanston', 'Decatur', 'Schaumburg', 'Bolingbrook', 'Palatine', 'Skokie', 'Des Plaines', 'Orland Park', 'Tinley Park', 'Oak Lawn', 'Berwyn', 'Mount Prospect', 'Normal', 'Wheaton', 'Hoffman Estates', 'Oak Park', 'Downers Grove', 'Elmhurst', 'Glenview', 'DeKalb', 'Lombard', 'Buffalo Grove'],
                'Pennsylvania': ['Philadelphia', 'Pittsburgh', 'Allentown', 'Erie', 'Reading', 'Scranton', 'Bethlehem', 'Lancaster', 'Harrisburg', 'Altoona', 'York', 'State College', 'Wilkes-Barre', 'Johnstown', 'Chester', 'Williamsport', 'Lebanon', 'Pottsville', 'Easton', 'Sharon'],
                'Ohio': ['Columbus', 'Cleveland', 'Cincinnati', 'Toledo', 'Akron', 'Dayton', 'Parma', 'Canton', 'Youngstown', 'Lorain', 'Hamilton', 'Springfield', 'Kettering', 'Elyria', 'Lakewood', 'Cuyahoga Falls', 'Middletown', 'Newark', 'Mansfield', 'Mentor'],
                'Michigan': ['Detroit', 'Grand Rapids', 'Warren', 'Sterling Heights', 'Lansing', 'Ann Arbor', 'Flint', 'Dearborn', 'Livonia', 'Westland', 'Troy', 'Farmington Hills', 'Kalamazoo', 'Wyoming', 'Rochester Hills', 'Southfield', 'Taylor', 'Pontiac', 'St. Clair Shores', 'Royal Oak', 'Dearborn Heights', 'Novi', 'Battle Creek', 'Saginaw', 'Kentwood', 'East Lansing', 'Roseville', 'Portage', 'Midland', 'Lincoln Park'],
                'Georgia': ['Atlanta', 'Augusta', 'Columbus', 'Macon', 'Savannah', 'Athens', 'Sandy Springs', 'Roswell', 'Albany', 'Johns Creek', 'Warner Robins', 'Alpharetta', 'Marietta', 'Valdosta', 'Smyrna', 'Dunwoody', 'Rome', 'Gainesville', 'East Point', 'Newnan', 'Dalton', 'Kennesaw', 'Peachtree City', 'Tucker'],
                'North Carolina': ['Charlotte', 'Raleigh', 'Greensboro', 'Durham', 'Winston-Salem', 'Fayetteville', 'Cary', 'Wilmington', 'High Point', 'Greenville', 'Asheville', 'Concord', 'Gastonia', 'Jacksonville', 'Chapel Hill', 'Rocky Mount', 'Burlington', 'Wilson', 'Huntersville', 'Kannapolis'],
                'Virginia': ['Virginia Beach', 'Norfolk', 'Arlington', 'Richmond', 'Newport News', 'Alexandria', 'Hampton', 'Roanoke', 'Portsmouth', 'Suffolk', 'Lynchburg', 'Harrisonburg', 'Leesburg', 'Charlottesville', 'Danville', 'Manassas', 'Petersburg', 'Fredericksburg', 'Winchester'],
                'Washington': ['Seattle', 'Spokane', 'Tacoma', 'Vancouver', 'Bellevue', 'Kent', 'Everett', 'Renton', 'Yakima', 'Federal Way', 'Spokane Valley', 'Bellingham', 'Kennewick', 'Auburn', 'Pasco', 'Marysville', 'Lakewood', 'Redmond', 'Shoreline', 'Richland'],
                'Colorado': ['Denver', 'Colorado Springs', 'Aurora', 'Fort Collins', 'Lakewood', 'Thornton', 'Arvada', 'Westminster', 'Pueblo', 'Boulder', 'Greeley', 'Longmont', 'Loveland', 'Grand Junction', 'Broomfield', 'Castle Rock', 'Commerce City', 'Parker', 'Littleton', 'Northglenn', 'Englewood', 'Wheat Ridge'],
                'Arizona': ['Phoenix', 'Tucson', 'Mesa', 'Chandler', 'Scottsdale', 'Glendale', 'Gilbert', 'Tempe', 'Peoria', 'Surprise', 'Yuma', 'Avondale', 'Goodyear', 'Flagstaff', 'Buckeye', 'Casa Grande', 'Lake Havasu City', 'Maricopa', 'Oro Valley', 'Sierra Vista', 'Prescott Valley'],
                'Tennessee': ['Nashville', 'Memphis', 'Knoxville', 'Chattanooga', 'Clarksville', 'Murfreesboro', 'Franklin', 'Jackson', 'Johnson City', 'Hendersonville', 'Kingsport', 'Collierville', 'Smyrna', 'Germantown', 'Cleveland', 'Columbia', 'Oak Ridge', 'Morristown', 'Bristol', 'Lebanon'],
                'Missouri': ['Kansas City', 'St. Louis', 'Springfield', 'Columbia', 'Independence', 'Lee\'s Summit', 'O\'Fallon', 'St. Joseph', 'St. Charles', 'St. Peters', 'Blue Springs', 'Florissant', 'Joplin', 'Chesterfield', 'Jefferson City', 'Cape Girardeau', 'Wildwood', 'University City', 'Ballwin', 'Liberty'],
                'Indiana': ['Indianapolis', 'Fort Wayne', 'Evansville', 'South Bend', 'Carmel', 'Fishers', 'Bloomington', 'Hammond', 'Gary', 'Lafayette', 'Muncie', 'Terre Haute', 'Kokomo', 'Anderson', 'Noblesville', 'Greenwood', 'Elkhart', 'Michigan City', 'Lawrence', 'Jeffersonville', 'Columbus', 'Portage', 'New Albany', 'Mishawaka', 'Greenfield'],
                'Massachusetts': ['Boston', 'Worcester', 'Springfield', 'Lowell', 'Cambridge', 'New Bedford', 'Brockton', 'Quincy', 'Lynn', 'Fall River', 'Newton', 'Lawrence', 'Somerville', 'Framingham', 'Haverhill', 'Malden', 'Waltham', 'Brookline', 'Plymouth', 'Medford', 'Taunton', 'Chicopee', 'Weymouth', 'Revere', 'Peabody'],
                'Wisconsin': ['Milwaukee', 'Madison', 'Green Bay', 'Kenosha', 'Racine', 'Appleton', 'Waukesha', 'Oshkosh', 'Eau Claire', 'Janesville', 'West Allis', 'La Crosse', 'Sheboygan', 'Wauwatosa', 'Fond du Lac', 'New Berlin', 'Beloit', 'Superior', 'Stevens Point', 'Neenah'],
                'Minnesota': ['Minneapolis', 'St. Paul', 'Rochester', 'Duluth', 'Bloomington', 'Brooklyn Park', 'Plymouth', 'St. Cloud', 'Eagan', 'Woodbury', 'Eden Prairie', 'Coon Rapids', 'Burnsville', 'Mankato', 'Moorhead', 'Winona', 'Marshall', 'Bemidji', 'Grand Rapids'],
                'Louisiana': ['New Orleans', 'Baton Rouge', 'Shreveport', 'Lafayette', 'Lake Charles', 'Kenner', 'Bossier City', 'Monroe', 'Alexandria', 'Houma', 'New Iberia', 'Ruston', 'Sulphur', 'Hammond', 'Natchitoches', 'Zachary', 'Gonzales', 'Thibodaux', 'Minden', 'Opelousas'],
                'Alabama': ['Birmingham', 'Montgomery', 'Mobile', 'Huntsville', 'Tuscaloosa', 'Auburn', 'Dothan', 'Decatur', 'Madison', 'Florence', 'Gadsden', 'Vestavia Hills', 'Phoenix', 'Tucson', 'Mesa', 'Chandler', 'Scottsdale', 'Glendale', 'Gilbert', 'Tempe', 'Peoria', 'Surprise', 'Yuma', 'Avondale', 'Goodyear', 'Flagstaff', 'Buckeye', 'Casa Grande', 'Lake Havasu City', 'Maricopa', 'Oro Valley', 'Sierra Vista', 'Prescott Valley']
            };
            
            return stateCities[state] || [];
        }

function findBusinesses() {
            const selectedNiches = getSelectedNiches();
            const selectedLocations = getSelectedLocations();
            const stateWideSearch = document.getElementById('stateWideSearch').checked;
            const minResults = parseInt(document.getElementById('minResults').value) || 5;
            const maxResults = parseInt(document.getElementById('maxResults').value) || 1000;
            const provider = (document.querySelector('input[name="placesProvider"]:checked')?.value) || placesProvider || 'google';
            placesProvider = provider;
            try { localStorage.setItem('placesProvider', provider); } catch {}
            
            if (selectedLocations.length === 0) {
                alert('Please add at least one location');
                return;
            }
            
            if (selectedNiches.length === 0) {
                alert('Please select at least one niche');
                return;
            }
            
            if (!apiKey) {
                alert('Please set a Google Places API key in the API Key tab.');
                return;
            }
            
            // Validate min/max results
            if (minResults < 1 || minResults > 1000) {
                alert('Minimum results must be between 1 and 1000');
                return;
            }
            
            if (maxResults < minResults || maxResults > 1000) {
                alert('Maximum results must be between minimum results and 1000');
                return;
            }
            
            let locationsToSearch = selectedLocations;
            
            // If state-wide search is enabled, expand locations to include all cities in the state
            if (stateWideSearch) {
                locationsToSearch = [];
                for (const location of selectedLocations) {
                    const state = location.split(', ')[1]; // Extract state from "City, State" format
                    if (state) {
                        const cities = getStateCities(state);
                        if (cities.length > 0) {
                            const stateLocations = cities.map(city => `${city}, ${state}`);
                            locationsToSearch = locationsToSearch.concat(stateLocations);
                        } else {
                            // If no predefined cities, just use the original location
                            locationsToSearch.push(location);
                        }
                    } else {
                        locationsToSearch.push(location);
                    }
                }
                
                console.log(`State-wide search: Expanded to ${locationsToSearch.length} cities`);
            }
            
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '<div class="loading">Searching for businesses in multiple locations...</div>';
            
            // Search each location and niche combination
searchMultipleLocationsAndNiches(locationsToSearch, selectedNiches, minResults, maxResults, provider);
        }

async function searchMultipleLocationsAndNiches(locations, niches, minResults, maxResults, provider) {
            let allBusinesses = [];
            let processedSearches = 0;
            const totalSearches = locations.length * niches.length;
            
            console.log(`Starting search with min: ${minResults}, max: ${maxResults} results`);
            
            // Build exclusion set once per run (imported + from history)
            const exclusionSet = buildCombinedExclusionSet();
            
            // Check for duplicate search first
            const preventDuplicates = document.getElementById('preventDuplicates').checked;
            if (preventDuplicates) {
                const duplicateResults = checkForDuplicateSearch(locations, niches);
                if (duplicateResults && duplicateResults.length > 0) {
                    console.log('Found duplicate search in history, using cached results');
                    displayResults(duplicateResults, locations.join(', '), niches.join(', '));
                    return;
                }
            }
            
            for (const location of locations) {
                for (const niche of niches) {
                    // Check if we've already reached the max results
                    if (allBusinesses.length >= maxResults) {
                        console.log(`Reached global max results limit (${maxResults}), stopping search`);
                        break;
                    }
                    
                    try {
                        // Calculate how many more results we can get from this search
                        const remainingResults = maxResults - allBusinesses.length;
let businesses = [];
                        if (provider === 'foursquare') {
                            businesses = await searchFoursquareForLocation(niche, location, minResults, remainingResults);
                        } else {
                            businesses = await searchGooglePlacesForLocation(niche, location, minResults, remainingResults);
                        }
                        // Filter out excluded leads immediately
                        businesses = filterExcluded(businesses, exclusionSet);
                        allBusinesses = allBusinesses.concat(businesses);
                        processedSearches++;
                        
                        console.log(`Total results so far: ${allBusinesses.length}/${maxResults}`);
                        
                        // Update progress with percentage
                        const percentage = Math.round((processedSearches / totalSearches) * 100);
                        const resultsContainer = document.getElementById('searchResults');
                        resultsContainer.innerHTML = `
                            <div class="loading">
                                <div>Searching businesses...</div>
                                <div style="margin-top: 10px;">
                                    <div style="background: #e9ecef; border-radius: 10px; height: 20px; overflow: hidden;">
                                        <div style="background: #007bff; height: 100%; width: ${percentage}%; transition: width 0.3s;"></div>
                                    </div>
                                    <div style="margin-top: 5px; font-size: 14px; color: #6c757d;">
                                        ${processedSearches} of ${totalSearches} searches (${percentage}%)
                                    </div>
                                    <div style="margin-top: 5px; font-size: 12px; color: #28a745;">
                                        Found: ${allBusinesses.length}/${maxResults} results
                                    </div>
                                </div>
                            </div>
                        `;
                        
                    } catch (error) {
                        console.error(`Error searching ${niche} in ${location}:`, error);
                        
                        // Show error message but continue with other searches
                        processedSearches++;
                        
                        // Update progress even on error
                        const percentage = Math.round((processedSearches / totalSearches) * 100);
                        const resultsContainer = document.getElementById('searchResults');
                        
                        // Show error message but continue
                        resultsContainer.innerHTML = `
                            <div class="loading">
                                <div>Searching businesses...</div>
                                <div style="margin-top: 10px;">
                                    <div style="background: #e9ecef; border-radius: 10px; height: 20px; overflow: hidden;">
                                        <div style="background: #007bff; height: 100%; width: ${percentage}%; transition: width 0.3s;"></div>
                                    </div>
                                    <div style="margin-top: 5px; font-size: 14px; color: #6c757d;">
                                        ${processedSearches} of ${totalSearches} searches (${percentage}%)
                                    </div>
                                    <div style="margin-top: 5px; font-size: 12px; color: #28a745;">
                                        Found: ${allBusinesses.length}/${maxResults} results
                                    </div>
                                </div>
                                <div style="margin-top: 10px; color: #dc3545; font-size: 12px;">
                                    Error searching ${niche} in ${location}: ${error.message}
                                </div>
                            </div>
                        `;
                    }
                }
                
                // Check if we've reached the max results (outer loop)
                if (allBusinesses.length >= maxResults) {
                    console.log(`Reached global max results limit (${maxResults}), stopping all searches`);
                    break;
                }
            }
            
            // Remove excluded again (safety) and duplicates
            allBusinesses = filterExcluded(allBusinesses, exclusionSet);
            allBusinesses = removeDuplicateBusinesses(allBusinesses);
            
            // Apply final max limit after removing duplicates
            if (allBusinesses.length > maxResults) {
                allBusinesses = allBusinesses.slice(0, maxResults);
                console.log(`Applied final max limit: ${maxResults} results`);
            }
            
            // Always show results, even if empty
            const nicheString = niches.join(', ');
            const locationString = locations.join(', ');
            displayResults(allBusinesses, locationString, nicheString);
            
            // Show notification that search was saved to history
            if (allBusinesses.length > 0) {
                console.log(`✅ Search completed and saved to history: ${allBusinesses.length} businesses found`);
            }
        }

        async function searchGooglePlacesForLocation(niche, location, minResults, maxResults) {
            const apiKey = getApiKey();
            if (!apiKey) {
                throw new Error('Google Places API key is not set. Please go to the API Key tab to set it.');
            }
            
            try {
                const query = `${niche} in ${location}`;
                
                // Try multiple proxy strategies
                const proxyStrategies = [
                    // Strategy 1: Direct API call (works in some environments)
                    async () => {
                        const directUrl = `https://maps.googleapis.com/maps/api/place/textsearch/json?query=${encodeURIComponent(query)}&key=${apiKey}`;
                        console.log(`Trying direct API call: ${directUrl}`);
                        
                        const response = await fetch(directUrl);
                        if (response.ok) {
                            const data = await response.json();
                            console.log(`Direct API Response for ${location}:`, data);
                            return data;
                        }
                        throw new Error(`Direct API failed: ${response.status}`);
                    },
                    
                    // Strategy 2: CORS Anywhere proxy
                    async () => {
                        const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                        const apiUrl = `https://maps.googleapis.com/maps/api/place/textsearch/json?query=${encodeURIComponent(query)}&key=${apiKey}`;
                        const url = proxyUrl + apiUrl;
                        
                        console.log(`Trying CORS Anywhere proxy: ${url}`);
                        
                        const response = await fetch(url, {
                            method: 'GET',
                            headers: {
                                'Origin': window.location.origin,
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        });
                        
                        if (!response.ok) {
                            throw new Error(`CORS Anywhere failed: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        console.log(`CORS Anywhere API Response for ${location}:`, data);
                        return data;
                    },
                    
                    // Strategy 3: AllOrigins proxy
                    async () => {
                        const proxyUrl = 'https://api.allorigins.win/raw?url=';
                        const apiUrl = `https://maps.googleapis.com/maps/api/place/textsearch/json?query=${encodeURIComponent(query)}&key=${apiKey}`;
                        const url = proxyUrl + encodeURIComponent(apiUrl);
                        
                        console.log(`Trying AllOrigins proxy: ${url}`);
                        
                        const response = await fetch(url);
                        if (!response.ok) {
                            throw new Error(`AllOrigins failed: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        console.log(`AllOrigins API Response for ${location}:`, data);
                        return data;
                    },
                    
                    // Strategy 4: CORS Proxy (alternative)
                    async () => {
                        const proxyUrl = 'https://corsproxy.io/?';
                        const apiUrl = `https://maps.googleapis.com/maps/api/place/textsearch/json?query=${encodeURIComponent(query)}&key=${apiKey}`;
                        const url = proxyUrl + encodeURIComponent(apiUrl);
                        
                        console.log(`Trying CORS Proxy: ${url}`);
                        
                        const response = await fetch(url);
                        if (!response.ok) {
                            throw new Error(`CORS Proxy failed: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        console.log(`CORS Proxy API Response for ${location}:`, data);
                        return data;
                    },
                    
                    // Strategy 5: JSONP-style approach (if needed)
                    async () => {
                        const proxyUrl = 'https://thingproxy.freeboard.io/fetch/';
                        const apiUrl = `https://maps.googleapis.com/maps/api/place/textsearch/json?query=${encodeURIComponent(query)}&key=${apiKey}`;
                        const url = proxyUrl + apiUrl;
                        
                        console.log(`Trying ThingProxy: ${url}`);
                        
                        const response = await fetch(url);
                        if (!response.ok) {
                            throw new Error(`ThingProxy failed: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        console.log(`ThingProxy API Response for ${location}:`, data);
                        return data;
                    }
                ];
                
                // Try each strategy until one works
                for (let i = 0; i < proxyStrategies.length; i++) {
                    try {
                        console.log(`Trying API strategy ${i + 1}...`);
                        const data = await proxyStrategies[i]();
                        
                        if (data.status === 'OK') {
                            console.log(`Found ${data.results.length} total results for ${niche} in ${location}`);
                            const businesses = await processPlacesResults(data.results, niche, location, maxResults);
                            console.log(`Processed ${businesses.length} businesses without websites for ${niche} in ${location}`);
                            return businesses;
                        } else if (data.status === 'ZERO_RESULTS') {
                            console.log(`No results found for ${niche} in ${location}`);
                            return [];
                        } else if (data.status === 'REQUEST_DENIED') {
                            console.error(`API Key error: ${data.error_message}`);
                            throw new Error(`API Key error: ${data.error_message}`);
                        } else if (data.status === 'OVER_QUERY_LIMIT') {
                            console.error(`API quota exceeded`);
                            throw new Error(`API quota exceeded. Please try again later.`);
                        } else {
                            console.error(`API Error for ${location}: ${data.status} - ${data.error_message || 'Unknown error'}`);
                            throw new Error(`API Error: ${data.status} - ${data.error_message || 'Unknown error'}`);
                        }
                    } catch (strategyError) {
                        console.log(`Strategy ${i + 1} failed:`, strategyError.message);
                        if (i === proxyStrategies.length - 1) {
                            // This was the last strategy, throw the error
                            throw strategyError;
                        }
                        // Continue to next strategy
                        continue;
                    }
                }
                
            } catch (error) {
                console.error(`All API strategies failed for ${location}: ${error.message}`);
                throw error;
            }
        }

async function searchFoursquareForLocation(niche, location, minResults, maxResults) {
            const key = getFsqApiKey();
            if (!key) throw new Error('Foursquare API key is not set. Please go to the API Key tab to set it.');

            // Build search via serverless proxy to avoid CORS and keep key safe
            const params = new URLSearchParams();
            params.set('query', niche);
            params.set('near', location);
            params.set('limit', String(Math.max(minResults, Math.min(maxResults, 50))));

            const resp = await fetch(`/api/foursquare/search?${params.toString()}`, {
                headers: { 'X-FSQ-KEY': key }
            });
            if (!resp.ok) {
                const text = await resp.text();
                throw new Error(`Foursquare search failed (${resp.status}): ${text}`);
            }
            const data = await resp.json();
            const results = Array.isArray(data.results) ? data.results : [];

            const businesses = [];
            for (const place of results) {
                const website = place.website || null;
                const phone = place.tel || null;
                if (!website && phone) {
                    // Compose a formatted address
                    let addr = '';
                    try {
                        const loc = place.location || {};
                        const parts = [loc.address, loc.locality, loc.region, loc.postcode, loc.country].filter(Boolean);
                        addr = parts.join(', ');
                    } catch {}
                    businesses.push({
                        name: place.name,
                        category: niche,
                        location: location,
                        address: addr || 'Address not available',
                        phone: phone,
                        email: 'N/A',
                        ownerManager: 'N/A',
                        bestContact: 'SMS',
                        website: 'No Website',
                        rating: place.rating || 'N/A',
                        confidence: 100
                    });
                    if (businesses.length >= maxResults) break;
                }
            }
            return businesses;
        }

        function generateMockBusinesses(niche, location) {
            // Generate realistic mock businesses for testing when API is not available
            const businessNames = [
                `${niche.charAt(0).toUpperCase() + niche.slice(1)} Pro`,
                `Elite ${niche}`,
                `Premium ${niche}`,
                `Best ${niche}`,
                `Quality ${niche}`,
                `Professional ${niche}`,
                `Expert ${niche}`,
                `Top ${niche}`,
                `Advanced ${niche}`,
                `Superior ${niche}`
            ];
            
            const streetNames = [
                'Main St', 'Oak Ave', 'Pine Rd', 'Elm St', 'Maple Dr',
                'Cedar Ln', 'Willow Way', 'Birch Blvd', 'Cherry St', 'Poplar Ave',
                'Washington St', 'Broadway', 'Park Ave', 'Central Blvd', 'Riverside Dr'
            ];
            
            const mockBusinesses = [];
            
            // Generate 3-8 random businesses
            const numBusinesses = Math.floor(Math.random() * 6) + 3;
            
            for (let i = 0; i < numBusinesses; i++) {
                const streetNumber = Math.floor(Math.random() * 999) + 1;
                const streetName = streetNames[Math.floor(Math.random() * streetNames.length)];
                const businessName = businessNames[Math.floor(Math.random() * businessNames.length)];
                const phoneArea = Math.floor(Math.random() * 900) + 100;
                const phonePrefix = Math.floor(Math.random() * 900) + 100;
                const phoneSuffix = Math.floor(Math.random() * 9000) + 1000;
                const rating = (Math.random() * 2 + 3).toFixed(1); // 3.0 to 5.0
                
                const business = {
                    name: businessName,
                    category: niche,
                    location: location,
                    address: `${streetNumber} ${streetName}, ${location}`,
                    phone: `(${phoneArea}) ${phonePrefix}-${phoneSuffix}`,
                    email: 'N/A',
                    bestContact: 'SMS',
                    website: 'No Website',
                    rating: rating,
                    confidence: Math.floor(Math.random() * 20) + 80 // 80-100%
                };
                
                mockBusinesses.push(business);
            }
            
            console.log(`Generated ${mockBusinesses.length} mock businesses for ${niche} in ${location}`);
            return mockBusinesses;
        }

        function removeDuplicateBusinesses(businesses) {
            const seen = new Set();
            return businesses.filter(business => {
                const key = `${business.name}-${business.address}`;
                if (seen.has(key)) {
                    return false;
                }
                seen.add(key);
                return true;
            });
        }

        function checkForDuplicateSearch(locations, niches) {
            const searchHistory = JSON.parse(localStorage.getItem('businessSearchHistory') || '[]');
            
            for (const entry of searchHistory) {
                const entryLocations = Array.isArray(entry.locations) ? entry.locations : [entry.locations];
                const entryNiches = Array.isArray(entry.niche) ? entry.niche : [entry.niche];
                
                // Check if locations match
                const locationsMatch = locations.every(loc => entryLocations.includes(loc)) && 
                                    entryLocations.every(loc => locations.includes(loc));
                
                // Check if niches match
                const nichesMatch = niches.every(niche => entryNiches.includes(niche)) && 
                                  entryNiches.every(niche => niches.includes(niche));
                
                if (locationsMatch && nichesMatch) {
                    return entry.businesses || [];
                }
            }
            
            return null; // No duplicate found
        }

        async function processPlacesResults(places, niche, location, maxResults) {
            const businesses = [];
            
            console.log(`Processing ${places.length} places for ${niche} in ${location} (max: ${maxResults})`);
            
            for (const place of places) {
                try {
                    console.log(`Processing place: ${place.name}`);
                    
                    // Get detailed information
                    const details = await getPlaceDetails(place.place_id);
                    
                    // Check if business has NO website AND HAS phone number
                    if (!details.website && details.phone) {
                        const business = {
                            name: place.name,
                            category: niche,
                            location: location,
                            address: place.formatted_address || 'Address not available',
                            phone: details.phone,
                            email: extractEmailFromReviews(place.reviews || []),
                            ownerManager: extractOwnerManagerName(place.name, place.reviews || [], place.formatted_address),
                            bestContact: determineBestContactMethod(details.phone, details.website),
                            website: 'No Website',
                            rating: place.rating || 'N/A',
                            confidence: 100
                        };
                        
                        businesses.push(business);
                        console.log(`Added business: ${place.name} (phone: ${details.phone})`);
                        
                        // Check if we've reached the max results limit
                        if (businesses.length >= maxResults) {
                            console.log(`Reached max results limit (${maxResults}) for ${niche} in ${location}`);
                            break;
                        }
                    } else if (details.website) {
                        console.log(`Skipped ${place.name} - has website`);
                    } else if (!details.phone) {
                        console.log(`Skipped ${place.name} - no phone number`);
                    }
                } catch (error) {
                    console.error('Error processing place:', error);
                }
            }
            
            console.log(`Found ${businesses.length} businesses without websites for ${niche} in ${location}`);
            return businesses;
        }

        async function getPlaceDetails(placeId) {
            const apiKey = getApiKey();
            if (!apiKey) {
                return { website: null, phone: null };
            }
            
            try {
                const placeDetailsStrategies = [
                    // Strategy 1: Direct API call
                    async () => {
                        const directUrl = `https://maps.googleapis.com/maps/api/place/details/json?place_id=${placeId}&fields=website,formatted_phone_number,international_phone_number&key=${apiKey}`;
                        console.log(`Getting place details directly for ${placeId}`);
                        
                        const response = await fetch(directUrl);
                        if (response.ok) {
                            const data = await response.json();
                            console.log(`Direct place details for ${placeId}:`, data);
                            return data;
                        }
                        throw new Error(`Direct place details failed: ${response.status}`);
                    },
                    
                    // Strategy 2: CORS Anywhere proxy
                    async () => {
                        const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                        const apiUrl = `https://maps.googleapis.com/maps/api/place/details/json?place_id=${placeId}&fields=website,formatted_phone_number,international_phone_number&key=${apiKey}`;
                        const url = proxyUrl + apiUrl;
                        
                        console.log(`Getting place details via CORS Anywhere for ${placeId}`);
                        
                        const response = await fetch(url, {
                            method: 'GET',
                            headers: {
                                'Origin': window.location.origin,
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        });
                        
                        if (!response.ok) {
                            throw new Error(`CORS Anywhere place details failed: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        console.log(`CORS Anywhere place details for ${placeId}:`, data);
                        return data;
                    },
                    
                    // Strategy 3: AllOrigins proxy
                    async () => {
                        const proxyUrl = 'https://api.allorigins.win/raw?url=';
                        const apiUrl = `https://maps.googleapis.com/maps/api/place/details/json?place_id=${placeId}&fields=website,formatted_phone_number,international_phone_number&key=${apiKey}`;
                        const url = proxyUrl + encodeURIComponent(apiUrl);
                        
                        console.log(`Getting place details via AllOrigins for ${placeId}`);
                        
                        const response = await fetch(url);
                        if (!response.ok) {
                            throw new Error(`AllOrigins place details failed: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        console.log(`AllOrigins place details for ${placeId}:`, data);
                        return data;
                    }
                ];
                
                // Try each strategy until one works
                for (let i = 0; i < placeDetailsStrategies.length; i++) {
                    try {
                        console.log(`Trying place details strategy ${i + 1}...`);
                        const data = await placeDetailsStrategies[i]();
                        
                        if (data.status === 'OK') {
                            // Try multiple phone number fields
                            const phone = data.result.formatted_phone_number || 
                                        data.result.international_phone_number || 
                                        null;
                            
                            return {
                                website: data.result.website || null,
                                phone: phone
                            };
                        } else {
                            console.error(`Place details error: ${data.status}`);
                            return { website: null, phone: null };
                        }
                    } catch (strategyError) {
                        console.log(`Place details strategy ${i + 1} failed:`, strategyError.message);
                        if (i === placeDetailsStrategies.length - 1) {
                            // This was the last strategy, return null values
                            return { website: null, phone: null };
                        }
                        // Continue to next strategy
                        continue;
                    }
                }
                
            } catch (error) {
                console.error('Error getting place details:', error);
                return { website: null, phone: null };
            }
        }

        function extractEmailFromReviews(reviews) {
            const emailRegex = /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g;
            
            for (const review of reviews) {
                const text = review.text || '';
                const emails = text.match(emailRegex);
                if (emails && emails.length > 0) {
                    return emails[0];
                }
            }
            
            return 'N/A';
        }

        function extractOwnerManagerName(businessName, reviews, address) {
            // Try to extract owner/manager name from various sources
            let ownerName = null;
            
            // Method 1: Extract from business name patterns
            const namePatterns = [
                /^([A-Z][a-z]+)\s+(?:'s|'s\s+|\s+&\s+)/i,  // John's Pizza, Smith & Associates
                /^([A-Z][a-z]+)\s+[A-Z][a-z]+(?:\s+[A-Z][a-z]+)?$/i,  // John Smith, John Smith Johnson
                /^([A-Z][a-z]+)\s+(?:Barber|Salon|Shop|Store|Service|Company|LLC|Inc|Corp)/i  // John's Barber Shop
            ];
            
            for (const pattern of namePatterns) {
                const match = businessName.match(pattern);
                if (match && match[1]) {
                    ownerName = match[1];
                    break;
                }
            }
            
            // Method 2: Look for owner mentions in reviews
            if (!ownerName && reviews && reviews.length > 0) {
                const ownerKeywords = ['owner', 'manager', 'proprietor', 'boss', 'director'];
                for (const review of reviews) {
                    const text = review.text || '';
                    for (const keyword of ownerKeywords) {
                        const regex = new RegExp(`(?:the\\s+)?${keyword}\\s+([A-Z][a-z]+\\s+[A-Z][a-z]+)`, 'i');
                        const match = text.match(regex);
                        if (match && match[1]) {
                            ownerName = match[1];
                            break;
                        }
                    }
                    if (ownerName) break;
                }
            }
            
            // Method 3: Extract from address patterns (sometimes owner name is in address)
            if (!ownerName && address) {
                const addressPattern = /^([A-Z][a-z]+)\s+[A-Z][a-z]+\s+(?:Ave|St|Rd|Blvd|Dr)/i;
                const match = address.match(addressPattern);
                if (match && match[1]) {
                    ownerName = match[1];
                }
            }
            
            return ownerName || 'N/A';
        }

        function determineBestContactMethod(phone, website) {
            if (phone) {
                return 'SMS';
            } else if (website) {
                return 'Email';
            } else {
                return 'N/A';
            }
        }

        function displayResults(businesses, locations, niche) {
            const container = document.getElementById('searchResults');
            
            if (businesses.length === 0) {
                container.innerHTML = `
                    <div class="error">
                        <h3>No businesses found matching your criteria.</h3>
                        <p>This could be due to:</p>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li>No businesses in this location/niche combination</li>
                            <li>All businesses found have websites</li>
                            <li>API quota exceeded - try again later</li>
                            <li>Network connectivity issues</li>
                        </ul>
                        <p style="margin-top: 15px;"><strong>Try:</strong></p>
                        <ul style="margin-left: 20px;">
                            <li>Different locations or niches</li>
                            <li>Checking your API key in the API Key tab</li>
                            <li>Waiting a few minutes if quota is exceeded</li>
                        </ul>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="success">
                    <h3>Found ${businesses.length} businesses in ${locations}</h3>
                    <button class="export-btn" onclick="exportToCSV()">Export to CSV</button>
                </div>
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Business Type</th>
                            <th>Location</th>
                            <th>Address</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>Owner/Manager</th>
                            <th>Best Contact</th>
                            <th>Website</th>
                            <th>Rating</th>
                            <th>Confidence</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            businesses.forEach(business => {
                const contactClass = business.bestContact === 'SMS' ? 'contact-sms' : 'contact-email';
                
                html += `
                    <tr>
                        <td><span class="business-name">${business.name}</span></td>
                        <td>${business.category}</td>
                        <td>${business.location}</td>
                        <td>${business.address}</td>
                        <td>${business.phone}</td>
                        <td>${business.email || 'N/A'}</td>
                        <td>${business.ownerManager}</td>
                        <td><span class="contact-badge ${contactClass}">${business.bestContact}</span></td>
                        <td>No Website</td>
                        <td>${business.rating}</td>
                        <td>${business.confidence}%</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
            
            saveSearchToHistory(locations, niche, businesses);
            
            // Add a small notification that search was saved
            if (businesses.length > 0) {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    background: #d4edda;
                    color: #155724;
                    padding: 10px;
                    border-radius: 4px;
                    margin-top: 10px;
                    font-size: 14px;
                    border: 1px solid #c3e6cb;
                `;
                notification.innerHTML = `✅ Search results saved to history (${businesses.length} businesses found)`;
                container.appendChild(notification);
                
                // Remove notification after 5 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 5000);
            }
        }

        function displayResultsFromHistory(businesses, locations, niche) {
            const container = document.getElementById('searchResults');
            
            if (businesses.length === 0) {
                container.innerHTML = `
                    <div class="error">
                        <h3>No businesses found in this historical search.</h3>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="success">
                    <h3>Historical Results: ${businesses.length} businesses from ${locations}</h3>
                    <button class="export-btn" onclick="exportToCSV()">Export to CSV</button>
                </div>
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Business Type</th>
                            <th>Location</th>
                            <th>Address</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>Owner/Manager</th>
                            <th>Best Contact</th>
                            <th>Website</th>
                            <th>Rating</th>
                            <th>Confidence</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            businesses.forEach(business => {
                const contactClass = business.bestContact === 'SMS' ? 'contact-sms' : 'contact-email';
                
                html += `
                    <tr>
                        <td><span class="business-name">${business.name}</span></td>
                        <td>${business.category}</td>
                        <td>${business.location}</td>
                        <td>${business.address}</td>
                        <td>${business.phone}</td>
                        <td>${business.email || 'N/A'}</td>
                        <td>${business.ownerManager}</td>
                        <td><span class="contact-badge ${contactClass}">${business.bestContact}</span></td>
                        <td>No Website</td>
                        <td>${business.rating}</td>
                        <td>${business.confidence}%</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
            
            // No save to history - this is just displaying historical data
        }

        function saveSearchToHistory(locations, niche, businesses) {
            const searchEntry = {
                timestamp: Date.now(),
                locations: Array.isArray(locations) ? locations : [locations],
                niche: niche,
                businesses: businesses
            };
            
            searchHistory.unshift(searchEntry);
            
            // Keep only last 10 searches
            if (searchHistory.length > 10) {
                searchHistory = searchHistory.slice(0, 10);
            }
            
            localStorage.setItem('businessSearchHistory', JSON.stringify(searchHistory));
            
            console.log(`✅ Search saved to history:`, {
                timestamp: new Date(searchEntry.timestamp).toLocaleString(),
                locations: searchEntry.locations,
                niche: searchEntry.niche,
                businessCount: searchEntry.businesses.length
            });
            
            // Refresh the history display if we're on the history tab
            if (document.getElementById('history-tab').classList.contains('active')) {
                displaySearchHistory();
            }
        }

        function loadSearchHistory() {
            const saved = localStorage.getItem('businessSearchHistory');
            if (saved) {
                searchHistory = JSON.parse(saved);
            }
            displaySearchHistory();
        }

        // =====================
        // Exclusions (CSV + History)
        // =====================
        function normalizeText(s) {
            return (s || '').toString().trim().toLowerCase().replace(/\s+/g, ' ');
        }
        function normalizePhone(s) {
            return (s || '').toString().replace(/[^0-9]/g, '');
        }
        function normalizeAddress(s) {
            return (s || '').toString().trim().toLowerCase().replace(/\s+/g, ' ').replace(/\./g, '');
        }
        function makeBusinessKey(name, phone, address) {
            const n = normalizeText(name);
            const p = normalizePhone(phone);
            const a = normalizeAddress(address);
            if (n && p) return `${n}|p:${p}`;
            if (n && a) return `${n}|a:${a}`;
            return n || a || p || null;
        }
        function getHistoryExclusionSet() {
            const set = new Set();
            try {
                const hist = JSON.parse(localStorage.getItem('businessSearchHistory') || '[]');
                for (const entry of hist) {
                    if (!entry || !Array.isArray(entry.businesses)) continue;
                    for (const b of entry.businesses) {
                        const key = makeBusinessKey(b?.name, b?.phone, b?.address);
                        if (key) set.add(key);
                    }
                }
            } catch {}
            return set;
        }
        function getImportedExclusionSet() {
            const set = new Set();
            try {
                const arr = JSON.parse(localStorage.getItem('excludedBusinessesKeys') || '[]');
                for (const k of arr) if (k) set.add(k);
            } catch {}
            return set;
        }
        function saveImportedExclusionSet(set) {
            try {
                localStorage.setItem('excludedBusinessesKeys', JSON.stringify(Array.from(set)));
            } catch {}
        }
        function buildCombinedExclusionSet() {
            const combined = getImportedExclusionSet();
            const fromHistory = getHistoryExclusionSet();
            for (const k of fromHistory) combined.add(k);
            return combined;
        }
        function filterExcluded(businesses, exclSet) {
            if (!exclSet || exclSet.size === 0) return businesses;
            return (businesses || []).filter(b => {
                const key = makeBusinessKey(b?.name, b?.phone, b?.address);
                return key ? !exclSet.has(key) : true;
            });
        }
        function parseCSV(text) {
            // Minimal CSV parser supporting quotes, commas, newlines
            const rows = [];
            let i = 0, field = '', row = [], inQuotes = false;
            while (i < text.length) {
                const c = text[i];
                if (inQuotes) {
                    if (c === '"') {
                        if (text[i + 1] === '"') { field += '"'; i++; }
                        else { inQuotes = false; }
                    } else {
                        field += c;
                    }
                } else {
                    if (c === '"') inQuotes = true;
                    else if (c === ',') { row.push(field); field = ''; }
                    else if (c === '\n' || c === '\r') {
                        if (field.length > 0 || row.length > 0) { row.push(field); rows.push(row); }
                        field = ''; row = [];
                        // handle CRLF
                        if (c === '\r' && text[i + 1] === '\n') i++;
                    } else { field += c; }
                }
                i++;
            }
            if (field.length > 0 || row.length > 0) { row.push(field); rows.push(row); }
            return rows;
        }
        function guessHeaderIndexes(headers) {
            const idx = { name: -1, phone: -1, address: -1, email: -1 };
            headers.forEach((h, i) => {
                const hl = h.toLowerCase();
                if (idx.name === -1 && /^(name|business|company|business name|company name)$/.test(hl)) idx.name = i;
                if (idx.phone === -1 && /(phone|telephone|mobile|cell)/.test(hl)) idx.phone = i;
                if (idx.address === -1 && /(address|street|location)/.test(hl)) idx.address = i;
                if (idx.email === -1 && /(email|e-mail)/.test(hl)) idx.email = i;
            });
            // fallback by position
            if (idx.name === -1) idx.name = 0;
            return idx;
        }
        async function importExclusionsFromCSVFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onerror = () => reject(new Error('Failed to read CSV file'));
                reader.onload = () => {
                    try {
                        const text = reader.result.toString();
                        const rows = parseCSV(text);
                        if (!rows || rows.length === 0) return resolve({ added: 0, total: 0 });
                        const headers = rows[0].map(h => h.trim());
                        const idx = guessHeaderIndexes(headers);
                        const set = getImportedExclusionSet();
                        let added = 0;
                        for (let r = 1; r < rows.length; r++) {
                            const row = rows[r];
                            if (!row || row.length === 0) continue;
                            const name = row[idx.name] || '';
                            const phone = idx.phone >= 0 ? row[idx.phone] : '';
                            const address = idx.address >= 0 ? row[idx.address] : '';
                            const key = makeBusinessKey(name, phone, address);
                            if (key && !set.has(key)) { set.add(key); added++; }
                        }
                        saveImportedExclusionSet(set);
                        resolve({ added, total: set.size });
                    } catch (e) { reject(e); }
                };
                reader.readAsText(file);
            });
        }
        function wireExclusionsUI() {
            const input = document.getElementById('exclusionsCsvInput');
            const btn = document.getElementById('importExclusionsBtn');
            const clearBtn = document.getElementById('clearExclusionsBtn');
            const status = document.getElementById('exclusionsStatus');
            const show = (msg, type='info') => {
                if (!status) return;
                status.className = `status-message status-${type}`;
                status.style.display = 'block';
                status.textContent = msg;
            };
            if (btn) {
                btn.addEventListener('click', async () => {
                    try {
                        if (!input || !input.files || input.files.length === 0) {
                            show('Please choose a CSV file to import.', 'error');
                            return;
                        }
                        show('Importing exclusions...', 'info');
                        const file = input.files[0];
                        const { added, total } = await importExclusionsFromCSVFile(file);
                        show(`Imported ${added} new exclusions. Total imported: ${total}.`, 'success');
                        displaySearchHistory();
                    } catch (e) {
                        show(`Import failed: ${e.message}`, 'error');
                    }
                });
            }
            if (clearBtn) {
                clearBtn.addEventListener('click', () => {
                    try { localStorage.removeItem('excludedBusinessesKeys'); } catch {}
                    show('Imported exclusions cleared.', 'success');
                    displaySearchHistory();
                });
            }
        }

        function displaySearchHistory() {
            const container = document.getElementById('searchHistory');
            
            // Update summary of imported exclusions
            try {
                const excl = JSON.parse(localStorage.getItem('excludedBusinessesKeys') || '[]');
                const histCount = getHistoryExclusionSet().size;
                const el = document.getElementById('exclusionsSummary');
                if (el) el.innerHTML = `Imported exclusions: <strong>${excl.length}</strong> | From history: <strong>${histCount}</strong>`;
            } catch {}
            
            if (searchHistory.length === 0) {
                container.innerHTML = '<p>No search history found.</p>';
                return;
            }
            
            let html = '';
            searchHistory.forEach((entry, index) => {
                const date = new Date(entry.timestamp);
                const dateString = date.toLocaleDateString();
                const timeString = date.toLocaleTimeString();
                const locations = Array.isArray(entry.locations) ? entry.locations.join(', ') : entry.locations || 'N/A';
                const niche = entry.niche || 'N/A';
                const businessCount = entry.businesses ? entry.businesses.length : 0;
                
                html += `
                    <div class="history-item">
                        <div class="history-header">
                            <div class="history-date">
                                <div>${dateString}</div>
                                <div style="font-size: 12px; color: #6c757d;">${timeString}</div>
                            </div>
                            <button class="delete-btn" onclick="deleteHistoryItem(${index})">Delete</button>
                        </div>
                        <div class="history-details">
                            <p><strong>Locations:</strong> ${locations}</p>
                            <p><strong>Niche:</strong> ${niche}</p>
                            <p><strong>Results:</strong> ${businessCount} businesses found</p>
                        </div>
                        <div class="history-actions">
                            <button class="btn btn-primary" onclick="loadSearchFromHistory(${index})">View Results</button>
                            <button class="btn btn-success" onclick="exportHistoryToCSV(${index})">Export CSV</button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function deleteHistoryItem(index) {
            searchHistory.splice(index, 1);
            localStorage.setItem('businessSearchHistory', JSON.stringify(searchHistory));
            displaySearchHistory();
        }

        function clearAllHistory() {
            searchHistory = [];
            localStorage.removeItem('businessSearchHistory');
            displaySearchHistory();
        }

        function loadSearchFromHistory(index) {
            const entry = searchHistory[index];
            if (entry && entry.businesses) {
                const locations = Array.isArray(entry.locations) ? entry.locations.join(', ') : entry.locations || 'N/A';
                displayResultsFromHistory(entry.businesses, locations, entry.niche);
                switchTab('search');
            }
        }

        function exportToCSV() {
            const table = document.querySelector('.results-table');
            if (!table) return;
            
            let csv = 'Name,Business Type,Location,Address,Phone,Email,Owner/Manager,Best Contact,Website,Rating,Confidence\n';
            
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = Array.from(cells).map(cell => {
                    let text = cell.textContent || cell.innerText;
                    text = text.replace(/"/g, '""');
                    return `"${text}"`;
                });
                csv += rowData.join(',') + '\n';
            });
            
            downloadCSV(csv, 'businesses_without_websites.csv');
        }

        function exportHistoryToCSV(index) {
            const entry = searchHistory[index];
            if (!entry || !entry.businesses) return;
            
            let csv = 'Name,Business Type,Location,Address,Phone,Email,Owner/Manager,Best Contact,Website,Rating,Confidence\n';
            
            entry.businesses.forEach(business => {
                csv += `"${business.name}","${business.category}","${business.location}","${business.address}","${business.phone}","${business.email}","${business.ownerManager || 'N/A'}","${business.bestContact}","${business.website}","${business.rating}","${business.confidence}%"\n`;
            });
            
            downloadCSV(csv, `businesses_${entry.niche}_${new Date(entry.timestamp).toISOString().split('T')[0]}.csv`);
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function clearApiKey() {
            apiKey = '';
            localStorage.removeItem('googlePlacesApiKey');
            showApiStatus('API key cleared.', 'success');
            updateApiKeyDisplay();
        }

function updateApiKeyDisplay() {
            const keyInput = document.getElementById('apiKey');
            if (keyInput) keyInput.value = apiKey;
            const fsqInput = document.getElementById('fsqApiKey');
            if (fsqInput) fsqInput.value = fsqApiKey;
        }

        function showApiStatus(message, type) {
            const statusDiv = document.getElementById('apiStatus');
            if (statusDiv) {
                statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
            }
        }

function getApiKey() {
            return apiKey;
        }

        function loadFsqApiKey() {
            try { fsqApiKey = localStorage.getItem('foursquareApiKey') || ''; } catch {}
            updateApiKeyDisplay();
        }
        function saveFsqApiKey() {
            const input = document.getElementById('fsqApiKey');
            fsqApiKey = input.value.trim();
            if (!fsqApiKey) { showFsqApiStatus('Please enter a valid Foursquare API key.', 'error'); return; }
            try { localStorage.setItem('foursquareApiKey', fsqApiKey); } catch {}
            showFsqApiStatus('Foursquare API key saved successfully!', 'success');
            updateApiKeyDisplay();
        }
        async function testFsqApiKey() {
            if (!fsqApiKey) { showFsqApiStatus('Please save a Foursquare API key first.', 'error'); return; }
            showFsqApiStatus('Testing Foursquare API key...', 'info');
            try {
                const resp = await fetch(`/api/foursquare/search?query=${encodeURIComponent('restaurants')}&near=${encodeURIComponent('New York, NY')}&limit=1`, {
                    headers: { 'X-FSQ-KEY': fsqApiKey }
                });
                if (!resp.ok) {
                    const text = await resp.text();
                    throw new Error(`HTTP ${resp.status}: ${text}`);
                }
                const data = await resp.json();
                if (data && data.results && Array.isArray(data.results)) {
                    showFsqApiStatus('✅ Foursquare API key is valid and working!', 'success');
                } else {
                    showFsqApiStatus('⚠️ Unexpected response, but the key may still be valid.', 'info');
                }
            } catch (e) {
                showFsqApiStatus(`❌ Foursquare API test failed: ${e.message}`, 'error');
            }
        }
        function clearFsqApiKey() {
            fsqApiKey = '';
            try { localStorage.removeItem('foursquareApiKey'); } catch {}
            showFsqApiStatus('Foursquare API key cleared.', 'success');
            updateApiKeyDisplay();
        }
        function showFsqApiStatus(message, type) {
            const el = document.getElementById('fsqApiStatus');
            if (el) el.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
        }
        function loadProviderSelection() {
            try { placesProvider = localStorage.getItem('placesProvider') || 'google'; } catch {}
            const radios = document.querySelectorAll('input[name="placesProvider"]');
            radios.forEach(r => { r.checked = (r.value === placesProvider); });
        }

        function getFsqApiKey() { return fsqApiKey; }

        // Instagram API Functions
        function loadInstagramApiKeys() {
            try {
                googleSearchApiKey = localStorage.getItem('googleSearchApiKey') || '';
                searchEngineId = localStorage.getItem('searchEngineId') || '';
            } catch {}
            updateInstagramApiKeyDisplay();
        }

        function saveInstagramApiKeys() {
            const keyInput = document.getElementById('googleSearchApiKey');
            const engineInput = document.getElementById('searchEngineId');
            
            googleSearchApiKey = keyInput.value.trim();
            searchEngineId = engineInput.value.trim();
            
            if (!googleSearchApiKey || !searchEngineId) {
                showInstagramApiStatus('Please enter both API key and Search Engine ID.', 'error');
                return;
            }
            
            try {
                localStorage.setItem('googleSearchApiKey', googleSearchApiKey);
                localStorage.setItem('searchEngineId', searchEngineId);
            } catch {}
            
            showInstagramApiStatus('Instagram API credentials saved successfully!', 'success');
            updateInstagramApiKeyDisplay();
        }

        function clearInstagramApiKeys() {
            googleSearchApiKey = '';
            searchEngineId = '';
            
            try {
                localStorage.removeItem('googleSearchApiKey');
                localStorage.removeItem('searchEngineId');
            } catch {}
            
            showInstagramApiStatus('Instagram API credentials cleared.', 'success');
            updateInstagramApiKeyDisplay();
        }

        function updateInstagramApiKeyDisplay() {
            const keyInput = document.getElementById('googleSearchApiKey');
            const engineInput = document.getElementById('searchEngineId');
            
            if (keyInput) keyInput.value = googleSearchApiKey;
            if (engineInput) engineInput.value = searchEngineId;
        }

        function showInstagramApiStatus(message, type) {
            const statusDiv = document.getElementById('instagramApiStatus');
            if (statusDiv) {
                statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
            }
        }

        async function testInstagramApi() {
            if (!googleSearchApiKey || !searchEngineId) {
                showInstagramApiStatus('Please save both API key and Search Engine ID first.', 'error');
                return;
            }
            
            showInstagramApiStatus('Testing Instagram API...', 'info');
            
            try {
                const response = await fetch('/api/instagram/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': googleSearchApiKey,
                        'x-search-engine-id': searchEngineId
                    },
                    body: JSON.stringify({
                        businessName: 'Starbucks',
                        city: 'Seattle',
                        state: 'WA',
                        confidenceThreshold: 50
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.instagramHandle && data.instagramHandle !== 'No Instagram Found') {
                    showInstagramApiStatus(`✅ API test successful! Found: ${data.instagramHandle} (${data.confidenceScore}% confidence)`, 'success');
                } else {
                    showInstagramApiStatus('✅ API is working, but no Instagram found for test business (normal).', 'success');
                }
            } catch (error) {
                console.error('Instagram API test failed:', error);
                showInstagramApiStatus(`❌ API test failed: ${error.message}`, 'error');
            }
        }

        async function processInstagramCsv() {
            const fileInput = document.getElementById('instagramCsvInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a CSV file.');
                return;
            }
            
            if (!googleSearchApiKey || !searchEngineId) {
                alert('Please save your Instagram API credentials first.');
                return;
            }
            
            const confidenceThreshold = parseInt(document.getElementById('confidenceThreshold').value) || 80;
            
            try {
                const csvText = await file.text();
                const parseResult = parseInstagramCsv(csvText);
                const { businesses, headers: originalHeaders } = parseResult;
                
                if (businesses.length === 0) {
                    alert('No valid businesses found in CSV file.');
                    return;
                }
                
                console.log(`Processing ${businesses.length} businesses with flexible CSV parsing`);
                
                // Show processing UI
                const statusDiv = document.getElementById('instagramProcessingStatus');
                const progressDiv = document.getElementById('currentProgress');
                const totalDiv = document.getElementById('totalProgress');
                const progressBar = document.getElementById('progressFill');
                const detailsDiv = document.getElementById('processingDetails');
                
                statusDiv.style.display = 'block';
                totalDiv.textContent = businesses.length;
                
                const results = [];
                let processed = 0;
                
                for (const business of businesses) {
                    try {
                        progressDiv.textContent = processed + 1;
                        const percentage = Math.round(((processed + 1) / businesses.length) * 100);
                        progressBar.style.width = percentage + '%';
                        detailsDiv.textContent = `Searching for: ${business.businessName}`;
                        
                        const instagramResult = await searchInstagramForBusiness(
                            business.businessName,
                            business.address,
                            business.city,
                            business.state,
                            business.phone,
                            business.website,
                            confidenceThreshold
                        );
                        
                        // Handle the response and avoid undefined values
                        let instagramValue = 'No Instagram Found';
                        let instagramHandle = 'No Instagram Found';
                        
                        console.log('Instagram API Response:', instagramResult);
                        
                        if (instagramResult && (instagramResult.match_status === 'accepted' || instagramResult.match_status === 'needs_review')) {
                            instagramValue = instagramResult.instagram_url || 'No Instagram Found';
                            instagramHandle = instagramResult.instagram_handle || 'No Instagram Found';
                        } else if (instagramResult && instagramResult.instagram_url) {
                            instagramValue = instagramResult.instagram_url;
                            instagramHandle = instagramResult.instagram_handle || 'No Instagram Found';
                        }
                        
                        // Ensure no undefined values
                        if (instagramValue === undefined || instagramValue === null) {
                            instagramValue = 'No Instagram Found';
                        }
                        if (instagramHandle === undefined || instagramHandle === null) {
                            instagramHandle = 'No Instagram Found';
                        }
                        
                        console.log(`Final result for ${business.businessName}: ${instagramValue}`);
                        
                        results.push({
                            ...business.originalData, // Preserve all original CSV data
                            instagram_url: instagramValue,
                            instagram_handle: instagramHandle,
                            match_confidence: instagramResult.match_confidence || 0.0,
                            match_status: instagramResult.match_status || 'no_instagram',
                            // Keep processed fields for internal use
                            _processedBusinessName: business.businessName,
                            _processedCity: business.city,
                            _processedState: business.state,
                            _debugInfo: instagramResult.debug_info || {}
                        });
                        
                        processed++;
                        
                        // Add small delay to avoid rate limiting
                        await new Promise(resolve => setTimeout(resolve, 300));
                        
                    } catch (error) {
                        console.error(`Error processing ${business.businessName}:`, error);
                        results.push({
                            ...business.originalData,
                            instagram_url: '',
                            instagram_handle: '',
                            match_confidence: 0.0,
                            match_status: 'error'
                        });
                        processed++;
                    }
                }
                
                // Store headers for CSV generation using the parsed result
                window.csvHeaders = [...parseResult.headers, 'instagram_url', 'instagram_handle', 'match_confidence', 'match_status'];
                
                // Hide processing UI
                statusDiv.style.display = 'none';
                
                // Display results and provide download
                displayInstagramResults(results);
                
            } catch (error) {
                console.error('Error processing CSV:', error);
                alert('Error processing CSV file: ' + error.message);
                document.getElementById('instagramProcessingStatus').style.display = 'none';
            }
        }

        // Enhanced header detection system
        function detectHeaders(headers) {
            const aliases = {
                businessName: ['business name', 'business_name', 'name', 'company', 'company name', 'store', 'restaurant', 'shop'],
                address: ['address', 'street', 'location', 'addr', 'street address'],
                city: ['city', 'town', 'municipality'],
                state: ['state', 'province', 'region'],
                phone: ['phone', 'telephone', 'tel', 'mobile', 'number', 'phone number'],
                website: ['website', 'url', 'web', 'site']
            };
            
            const mapping = {};
            const lowerHeaders = headers.map(h => h.toLowerCase().trim());
            
            console.log('Detecting headers from:', lowerHeaders);
            
            for (const [field, fieldAliases] of Object.entries(aliases)) {
                let foundIndex = -1;
                
                // Try exact matches first
                for (const alias of fieldAliases) {
                    foundIndex = lowerHeaders.indexOf(alias);
                    if (foundIndex !== -1) break;
                }
                
                // Try partial matches if no exact match
                if (foundIndex === -1) {
                    for (const alias of fieldAliases) {
                        foundIndex = lowerHeaders.findIndex(h => h.includes(alias));
                        if (foundIndex !== -1) break;
                    }
                }
                
                mapping[field] = foundIndex;
                console.log(`${field}:`, foundIndex >= 0 ? headers[foundIndex] : 'NOT FOUND');
            }
            
            return mapping;
        }
        
        function parseInstagramCsv(csvText) {
            const lines = csvText.split('\n');
            if (lines.length < 2) {
                throw new Error('CSV file must have at least a header and one data row.');
            }
            
            // Parse CSV with better handling of quoted fields
            const parseCSVLine = (line) => {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"' && (i === 0 || line[i-1] === ',')) {
                        inQuotes = true;
                    } else if (char === '"' && inQuotes && (i === line.length - 1 || line[i+1] === ',')) {
                        inQuotes = false;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else if (char !== '"' || inQuotes) {
                        current += char;
                    }
                }
                result.push(current.trim());
                return result;
            };
            
            const originalHeaders = parseCSVLine(lines[0]);
            console.log('Original CSV headers:', originalHeaders);
            
            // Use enhanced header detection
            const headerMapping = detectHeaders(originalHeaders);
            
            // Validate required fields
            if (headerMapping.businessName === -1) {
                const suggestions = originalHeaders.filter(h => h.toLowerCase().includes('name') || h.toLowerCase().includes('company'));
                const errorMsg = suggestions.length > 0 
                    ? `No Business Name column found. Did you mean: ${suggestions.join(', ')}?`
                    : 'No Business Name column found. Please ensure your CSV has a column like "Business Name", "Company", or "Name".';
                throw new Error(errorMsg);
            }
            
            const businesses = [];
            const originalData = []; // Store all original data
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = parseCSVLine(line);
                if (values.length < originalHeaders.length) continue;
                
                // Store all original data
                const originalRow = {};
                originalHeaders.forEach((header, index) => {
                    originalRow[header] = values[index] || '';
                });
                originalData.push(originalRow);
                
                // Extract fields using header mapping
                const businessName = headerMapping.businessName >= 0 ? values[headerMapping.businessName] || '' : '';
                const address = headerMapping.address >= 0 ? values[headerMapping.address] || '' : '';
                const city = headerMapping.city >= 0 ? values[headerMapping.city] || '' : '';
                const state = headerMapping.state >= 0 ? values[headerMapping.state] || '' : '';
                const phone = headerMapping.phone >= 0 ? values[headerMapping.phone] || '' : '';
                const website = headerMapping.website >= 0 ? values[headerMapping.website] || '' : '';
                
                if (businessName.trim()) {
                    businesses.push({
                        businessName: businessName.trim(),
                        address: address.trim(),
                        city: city.trim(),
                        state: state.trim(),
                        phone: phone.trim(),
                        website: website.trim(),
                        originalData: originalRow,
                        headerMapping: headerMapping,
                        rowIndex: i
                    });
                }
            }
            
            console.log(`Parsed ${businesses.length} businesses from CSV`);
            return { businesses, headers: originalHeaders, headerMapping, originalData };
        }

        async function searchInstagramForBusiness(businessName, address, city, state, phone, website, confidenceThreshold) {
            try {
                console.log(`🔍 Searching Instagram for: ${businessName}`);
                
                const response = await fetch('/api/instagram/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': googleSearchApiKey,
                        'x-search-engine-id': searchEngineId
                    },
                    body: JSON.stringify({
                        businessName,
                        address,
                        city,
                        state,
                        phone,
                        website,
                        thresholdAccept: confidenceThreshold / 100,
                        thresholdReview: (confidenceThreshold - 20) / 100
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('API Error:', errorData);
                    throw new Error(errorData.message || `HTTP ${response.status}`);
                }
                
                const result = await response.json();
                console.log(`📊 Result for ${businessName}:`, {
                    handle: result.instagram_handle,
                    confidence: result.match_confidence,
                    status: result.match_status
                });
                
                return result;
                
            } catch (error) {
                console.error('Instagram search error for', businessName, ':', error);
                return {
                    instagram_handle: '',
                    instagram_url: '',
                    match_confidence: 0.0,
                    match_status: 'error',
                    error: error.message
                };
            }
        }

        function displayInstagramResults(results) {
            const container = document.getElementById('instagramResults');
            
            const successCount = results.filter(r => 
                (r.instagram_url && r.instagram_url !== 'No Instagram Found' && r.match_status !== 'error') ||
                (r.instagram && !r.instagram.includes('No Instagram') && !r.instagram.includes('Error:'))
            ).length;
            const errorCount = results.filter(r => 
                r.match_status === 'error' || 
                (r.instagram && r.instagram.includes('Error:'))
            ).length;
            
            let html = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>Processing Complete!</h3>
                    <p><strong>Total businesses processed:</strong> ${results.length}</p>
                    <p><strong>Instagram accounts found:</strong> ${successCount}</p>
                    <p><strong>Errors:</strong> ${errorCount}</p>
                    <button class="btn btn-success" onclick="downloadInstagramResults()">Download Results CSV</button>
                </div>
                
                <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="background: #007bff; color: white; position: sticky; top: 0;">
                            <tr>
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Business Name</th>
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Location</th>
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Instagram</th>
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Confidence</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            results.forEach((result, index) => {
                const bgColor = index % 2 === 0 ? '#f8f9fa' : '#ffffff';
                let instagramDisplay = 'No Instagram found';
                
                // Use the new format with instagram_url and instagram_handle
                if (result.instagram_url && result.instagram_url !== 'No Instagram Found') {
                    // Check if it's already a URL or just a handle
                    if (result.instagram_url.startsWith('http')) {
                        instagramDisplay = `<a href="${result.instagram_url}" target="_blank" style="color: #007bff; text-decoration: none;">${result.instagram_handle || result.instagram_url}</a>`;
                    } else {
                        instagramDisplay = `<a href="${result.instagram_url}" target="_blank" style="color: #007bff; text-decoration: none;">${result.instagram_url}</a>`;
                    }
                } else if (result.instagram && result.instagram !== 'No Instagram found') {
                    // Fallback to old format for backwards compatibility
                    if (result.instagram.startsWith('http')) {
                        instagramDisplay = `<a href="${result.instagram}" target="_blank" style="color: #007bff; text-decoration: none;">${result.instagramHandle || result.instagram}</a>`;
                    } else {
                        instagramDisplay = `<a href="${result.instagram}" target="_blank" style="color: #007bff; text-decoration: none;">${result.instagram}</a>`;
                    }
                }
                
                // Use match_confidence instead of confidenceScore
                const confidenceDisplay = result.match_confidence > 0 ? `${Math.round(result.match_confidence * 100)}%` : 'N/A';
                
                // Use processed field names with fallbacks
                const businessName = result._processedBusinessName || result.businessName || 'N/A';
                const cityState = `${result._processedCity || result.city || 'N/A'}, ${result._processedState || result.state || 'N/A'}`;
                
                html += `
                    <tr style="background: ${bgColor};">
                        <td style="padding: 8px; border: 1px solid #ddd;">${businessName}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${cityState}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${instagramDisplay}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${confidenceDisplay}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Store results globally for download
            window.instagramResults = results;
        }

        function downloadInstagramResults() {
            if (!window.instagramResults) {
                alert('No results to download.');
                return;
            }
            
            // Get all unique columns from the results (preserving original CSV structure)
            const allColumns = new Set();
            window.instagramResults.forEach(result => {
                Object.keys(result).forEach(key => {
                    // Skip internal processing fields
                    if (!key.startsWith('_') && key !== 'instagramHandle' && key !== 'confidenceScore') {
                        allColumns.add(key);
                    }
                });
            });
            
            // Ensure proper column order - original CSV columns first, then Instagram data
            const originalColumns = Array.from(allColumns).filter(col => 
                !['instagram_url', 'instagram_handle', 'match_confidence', 'match_status'].includes(col)
            );
            const instagramColumns = ['instagram_url', 'instagram_handle', 'match_confidence', 'match_status'];
            const columnOrder = [...originalColumns, ...instagramColumns.filter(col => allColumns.has(col))];
            
            console.log('CSV export columns:', columnOrder);
            
            // Create header row
            let csv = columnOrder.map(col => `"${col}"`).join(',') + '\n';
            
            // Add data rows
            window.instagramResults.forEach(result => {
                const fields = columnOrder.map(column => {
                    let value = result[column] || '';
                    
                    // Clean up special values
                    if ((column === 'instagram_url' || column === 'instagram_handle') && !value) {
                        value = 'No Instagram Found';
                    }
                    
                    // Convert confidence to percentage
                    if (column === 'match_confidence' && typeof value === 'number') {
                        value = Math.round(value * 100) + '%';
                    }
                    
                    // Escape commas and quotes in CSV
                    const str = String(value).replace(/"/g, '""');
                    return `"${str}"`;
                });
                
                csv += fields.join(',') + '\n';
            });
            
            downloadCSV(csv, `instagram_results_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // Authentication Functions
        function checkAuthStatus() {
            console.log('🔍 Checking auth status...');
            console.log('🔍 Global login state:', window.LOGIN_STATE);
            
            // Check global state first (most reliable)
            if (window.LOGIN_STATE.isLoggedIn && window.LOGIN_STATE.currentUser) {
                console.log('✅ Found logged in user in global state:', window.LOGIN_STATE.currentUser.email);
                currentUser = window.LOGIN_STATE.currentUser;
                sessionId = window.LOGIN_STATE.sessionId;
                showApp();
                return;
            }
            
            // Fallback to localStorage (if available)
            try {
                const savedUser = localStorage.getItem('outtaWebCurrentUser');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    sessionId = localStorage.getItem('outtaWebSessionId') || 'session-' + Date.now();
                    
                    // Update global state
                    window.LOGIN_STATE.isLoggedIn = true;
                    window.LOGIN_STATE.currentUser = currentUser;
                    window.LOGIN_STATE.sessionId = sessionId;
                    
                    console.log('✅ Found saved user in localStorage:', currentUser.email);
                    showApp();
                    return;
                }
            } catch (error) {
                console.error('❌ Error reading localStorage:', error);
            }
            
            // Try server session if we have a saved sessionId
            try {
                const savedSession = localStorage.getItem('outtaWebSessionId');
                if (savedSession) {
                    fetch('/api/auth/check-session', {
                        headers: { 'X-Session-Id': savedSession }
                    })
                    .then(r => r.json().then(data => ({ ok: r.ok, data })))
                    .then(({ ok, data }) => {
                        if (ok && data.success && data.user) {
                            currentUser = data.user;
                            sessionId = savedSession;
                            window.LOGIN_STATE.isLoggedIn = true;
                            window.LOGIN_STATE.currentUser = currentUser;
                            window.LOGIN_STATE.sessionId = sessionId;
                            try {
                                localStorage.setItem('outtaWebCurrentUser', JSON.stringify(currentUser));
                            } catch {}
                            console.log('✅ Restored session from server for:', currentUser.email);
                            showApp();
                        } else {
                            console.log('ℹ️ No valid server session. Showing login.');
                            showLogin();
                        }
                    })
                    .catch(() => {
                        console.log('ℹ️ Session check failed. Showing login.');
                        showLogin();
                    });
                    return;
                }
            } catch {}

            // No valid session found
            console.log('📋 No valid session found, showing login');
            showLogin();
        }

        function showLogin() {
            const loginOverlay = document.getElementById('loginOverlay');
            const container = document.querySelector('.container');
            document.getElementById('registerOverlay').classList.add('hidden');
            document.getElementById('verifyOverlay').classList.add('hidden');
            document.getElementById('resetOverlay').classList.add('hidden');

            // Show login overlay (override initial inline display:none)
            loginOverlay.classList.remove('hidden');
            loginOverlay.style.display = 'flex';

            // Hide app container
            if (container) {
                container.classList.add('hidden');
            }
        }

        function showRegister() {
            document.getElementById('registerOverlay').classList.remove('hidden');
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('verifyOverlay').classList.add('hidden');
            document.getElementById('resetOverlay').classList.add('hidden');
        }

        function showVerify() {
            document.getElementById('verifyOverlay').classList.remove('hidden');
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('registerOverlay').classList.add('hidden');
            document.getElementById('resetOverlay').classList.add('hidden');
            // Always update the code display
            document.getElementById('verificationCodeText').textContent = (pendingVerificationUser && pendingVerificationUser.verificationCode) ? pendingVerificationUser.verificationCode : '------';
        }

        function showResetForm() {
            document.getElementById('resetOverlay').classList.remove('hidden');
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('registerOverlay').classList.add('hidden');
            document.getElementById('verifyOverlay').classList.add('hidden');
            document.getElementById('resetRequestForm').classList.remove('hidden');
            document.getElementById('resetForm').classList.add('hidden');
        }

        function showApp() {
            console.log('🎯 showApp() called...');
            
            // Force hide all overlays
            const loginOverlay = document.getElementById('loginOverlay');
            const registerOverlay = document.getElementById('registerOverlay');
            const verifyOverlay = document.getElementById('verifyOverlay');
            const resetOverlay = document.getElementById('resetOverlay');
            
            if (loginOverlay) {
                loginOverlay.classList.add('hidden');
                console.log('🎯 Login overlay hidden');
            }
            if (registerOverlay) {
                registerOverlay.classList.add('hidden');
                console.log('🎯 Register overlay hidden');
            }
            if (verifyOverlay) {
                verifyOverlay.classList.add('hidden');
                console.log('🎯 Verify overlay hidden');
            }
            if (resetOverlay) {
                resetOverlay.classList.add('hidden');
                console.log('🎯 Reset overlay hidden');
            }
            
            // Force show main container
            const container = document.querySelector('.container');
            if (container) {
                container.classList.remove('hidden');
                console.log('🎯 Main container shown');
            }
            
            updateUserInfo();
            console.log('🎯 showApp() completed');
        }

        function updateUserInfo() {
            if (currentUser) {
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
            } else {
                document.getElementById('userInfo').classList.add('hidden');
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value;

            console.log('🔐 Login attempt:', { email, password: '***' });

            // Validate input
            if (!email || !password) {
                alert('❌ Please enter both email and password.');
                return;
            }

            // 1) Try Supabase first (primary auth)
            if (window.SUPABASE && window.SUPABASE.auth) {
                try {
                    const { data, error } = await window.SUPABASE.auth.signInWithPassword({ email, password });
                    if (!error && data && data.user) {
                        const u = data.user;
                        currentUser = {
                            id: u.id,
                            name: u.user_metadata?.name || (u.email || 'User'),
                            email: u.email,
                            verified: !!u.email_confirmed_at
                        };
                        sessionId = data.session?.access_token || `sb-${Date.now()}`;

                        window.LOGIN_STATE.isLoggedIn = true;
                        window.LOGIN_STATE.currentUser = currentUser;
                        window.LOGIN_STATE.sessionId = sessionId;

                        try {
                            localStorage.setItem('outtaWebSessionId', sessionId);
                            localStorage.setItem('outtaWebCurrentUser', JSON.stringify(currentUser));
                        } catch {}

                        document.getElementById('loginForm').reset();
                        showApp();
                        alert('✅ Login successful! Welcome ' + currentUser.name + '!');
                        return;
                    }
                } catch (e) {
                    console.log('ℹ️ Supabase sign-in error:', e.message);
                }
            }

            // 2) Fallback: server-side authentication (if configured)
            try {
                const resp = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await resp.json();
                if (resp.ok && data.success) {
                    console.log('✅ Server login successful for user:', data.user.email);

                    currentUser = data.user;
                    sessionId = data.sessionId;

                    window.LOGIN_STATE.isLoggedIn = true;
                    window.LOGIN_STATE.currentUser = currentUser;
                    window.LOGIN_STATE.sessionId = sessionId;

                    try {
                        localStorage.setItem('outtaWebSessionId', sessionId);
                        localStorage.setItem('outtaWebCurrentUser', JSON.stringify(currentUser));
                    } catch {}

                    document.getElementById('loginForm').reset();
                    showApp();
                    alert('✅ Login successful! Welcome ' + currentUser.name + '!');
                    return;
                } else {
                    console.log('⚠️ Server login failed:', data && data.message);
                }
            } catch (err) {
                console.log('⚠️ Server login error:', err.message);
            }

            // 3) Last resort: hardcoded dev accounts
            const user = HARDCODED_USERS.find(u =>
                u.email.toLowerCase() === email && u.password === password
            );

            if (user) {
                console.log('✅ Local fallback login successful for user:', user.email);

                currentUser = user;
                sessionId = 'session-' + Date.now();

                window.LOGIN_STATE.isLoggedIn = true;
                window.LOGIN_STATE.currentUser = user;
                window.LOGIN_STATE.sessionId = sessionId;

                try {
                    localStorage.setItem('outtaWebSessionId', sessionId);
                    localStorage.setItem('outtaWebCurrentUser', JSON.stringify(user));
                } catch {}

                document.getElementById('loginForm').reset();
                showApp();
                alert('✅ Login successful! Welcome ' + user.name + '!');
            } else {
                console.log('❌ Login failed: Invalid credentials');
                alert('❌ Login failed! Please check your email and password.');
            }
        }


        async function register() {
             const name = document.getElementById('registerName').value;
             const email = document.getElementById('registerEmail').value.trim().toLowerCase();
             const password = document.getElementById('registerPassword').value;
             const confirmPassword = document.getElementById('registerConfirmPassword').value;

             if (password !== confirmPassword) {
                 alert('Passwords do not match. Please try again.');
                 return;
             }

            const tasks = [];
            // Supabase sign up (non-blocking, safe to skip if not configured)
            if (window.SUPABASE && window.SUPABASE.auth) {
                tasks.push(
                    window.SUPABASE.auth.signUp({
                        email,
                        password,
                        options: {
                            data: { name },
                            emailRedirectTo: `${window.location.origin}/auth/callback`
                        }
                    }).then(({ data, error }) => {
                        if (error) throw new Error(error.message);
                        return data;
                    })
                );
            } else {
                tasks.push(Promise.resolve({ skipped: true }));
            }

            // Existing server registration
            tasks.push(
                fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name, email, password, confirmPassword })
                }).then(async r => {
                    const json = await r.json().catch(() => ({}));
                    if (!r.ok || !json.success) throw new Error(json.message || 'Server registration failed');
                    return json;
                })
            );

            const results = await Promise.allSettled(tasks);
            const supaOk = results[0].status === 'fulfilled';
            const serverOk = results[results.length - 1].status === 'fulfilled';

            if (!supaOk && !serverOk) {
                const supaErr = results[0].status === 'rejected' ? (results[0].reason?.message || results[0].reason) : null;
                const serverErr = results[results.length - 1].status === 'rejected' ? (results[results.length - 1].reason?.message || results[results.length - 1].reason) : null;
                console.error('Registration errors:', { supabase: supaErr, server: serverErr });
                alert('Sign up failed. Please check your details and try again.');
                return;
            }

            // If Supabase signup succeeded, prefer it
            if (supaOk) {
                try {
                    const supaData = results[0].value || {};
                    const sbUser = supaData.user || null;
                    const sbSession = supaData.session || null;

                    if (sbUser && sbSession && sbSession.access_token) {
                        currentUser = {
                            id: sbUser.id,
                            name: sbUser.user_metadata?.name || (sbUser.email || 'User'),
                            email: sbUser.email,
                            verified: !!sbUser.email_confirmed_at
                        };
                        sessionId = sbSession.access_token;
                        window.LOGIN_STATE.isLoggedIn = true;
                        window.LOGIN_STATE.currentUser = currentUser;
                        window.LOGIN_STATE.sessionId = sessionId;
                        try {
                            localStorage.setItem('outtaWebSessionId', sessionId);
                            localStorage.setItem('outtaWebCurrentUser', JSON.stringify(currentUser));
                        } catch {}
                        showApp();
                        document.getElementById('registerForm').reset();
                        alert('Registration successful!');
                        return;
                    } else {
                        // Email confirmation required – do not show app yet
                        alert('We\'ve sent a confirmation link to your email. Please verify your address, then sign in.');
                        return;
                    }
                } catch (e) {
                    console.log('Supabase signup handling error:', e.message);
                }
            }

            // Otherwise, fall back to server registration if it succeeded
            if (serverOk) {
                const data = results[results.length - 1].value;
                currentUser = data.user;
                sessionId = data.sessionId;
                try {
                    localStorage.setItem('outtaWebSessionId', sessionId);
                    localStorage.setItem('outtaWebCurrentUser', JSON.stringify(currentUser));
                } catch {}
                showApp();
                document.getElementById('registerForm').reset();
                alert('Registration successful!');
                return;
            }

            // If we got here, neither path produced a session
            alert('Sign up started, but a session was not created. If email confirmation is enabled, check your inbox.');
            return;
        }

        document.getElementById('verifyForm').addEventListener('submit', function (e) {
            e.preventDefault();
            verifyCode();
        });

        async function verifyCode() {
            const code = document.getElementById('verifyCode').value.trim();
            const email = document.getElementById('verifyEmail').value.trim().toLowerCase();

            try {
                const response = await fetch('/api/auth/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, code })
                });

                const data = await response.json();

                if (data.success) {
                showApp();
                document.getElementById('verifyForm').reset();
                alert('Email verified! Welcome to Business Finder.');
            } else {
                    alert(data.message || 'Incorrect verification code. Please try again.');
                }
            } catch (error) {
                console.error('Verification error:', error);
                alert('Verification failed. Please try again.');
            }
        }



        // Password Reset
        document.getElementById('resetRequestForm').addEventListener('submit', async function (e) {
             e.preventDefault();
             const email = document.getElementById('resetEmail').value.trim().toLowerCase();

            try {
                const response = await fetch('/api/auth/reset-request', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email })
                });

                const data = await response.json();

                if (data.success) {
             document.getElementById('resetRequestForm').classList.add('hidden');
             document.getElementById('resetForm').classList.remove('hidden');
             // Display the reset code on screen
                    document.getElementById('resetCodeText').textContent = data.resetCode;
                } else {
                    alert(data.message || 'Reset request failed. Please try again.');
                }
            } catch (error) {
                console.error('Reset request error:', error);
                alert('Reset request failed. Please try again.');
            }
        });

        document.getElementById('resetForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const code = document.getElementById('resetCode').value.trim();
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            const email = document.getElementById('resetEmail').value.trim().toLowerCase();

            if (newPassword !== confirmNewPassword) {
                alert('Passwords do not match.');
                return;
            }

            try {
                const response = await fetch('/api/auth/reset-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, code, newPassword })
                });

                const data = await response.json();

                if (data.success) {
            alert('Password reset successful! You can now log in.');
            showLogin();
            document.getElementById('resetForm').reset();
            document.getElementById('resetRequestForm').reset();
                } else {
                    alert(data.message || 'Password reset failed. Please try again.');
                }
            } catch (error) {
                console.error('Password reset error:', error);
                alert('Password reset failed. Please try again.');
            }
        });

        // Bulk Location Functions
        function addBulkLocations() {
            document.getElementById('bulkLocationOverlay').classList.remove('hidden');
            document.getElementById('bulkLocationInput').focus();

            // Add event listener for real-time preview
            document.getElementById('bulkLocationInput').addEventListener('input', updateBulkLocationPreview);
        }

        function closeBulkLocationModal() {
            document.getElementById('bulkLocationOverlay').classList.add('hidden');
            document.getElementById('bulkLocationInput').value = '';
            document.getElementById('bulkLocationPreview').style.display = 'none';
            document.getElementById('floatingActionButton').style.display = 'none';
            document.getElementById('manyLocationsWarning').style.display = 'none';
        }

        function updateBulkLocationPreview() {
            const input = document.getElementById('bulkLocationInput').value;
            const preview = document.getElementById('bulkLocationPreview');
            const previewList = document.getElementById('bulkLocationPreviewList');
            const countElement = document.getElementById('bulkLocationCount');
            const floatingButton = document.getElementById('floatingActionButton');
            const warning = document.getElementById('manyLocationsWarning');

            if (!input.trim()) {
                preview.style.display = 'none';
                countElement.textContent = '0';
                floatingButton.style.display = 'none';
                warning.style.display = 'none';
                return;
            }

            const locations = parseBulkLocations(input);
            countElement.textContent = locations.length;

            if (locations.length === 0) {
                preview.style.display = 'none';
                floatingButton.style.display = 'none';
                warning.style.display = 'none';
                return;
            }

            preview.style.display = 'block';
            previewList.innerHTML = '';

            locations.forEach(location => {
                const chip = document.createElement('span');
                chip.className = 'location-chip';
                chip.textContent = location;
                chip.style.margin = '0';
                previewList.appendChild(chip);
            });

            // Show floating button and warning if there are many locations
            if (locations.length > 10) {
                floatingButton.style.display = 'block';
                warning.style.display = 'block';
            } else {
                floatingButton.style.display = 'none';
                warning.style.display = 'none';
            }
        }

        function parseBulkLocations(input) {
            if (!input.trim()) return [];

            // Split by multiple delimiters: commas, newlines, semicolons
            const rawLocations = input.split(/[,\n;]/).map(loc => loc.trim()).filter(loc => loc);

            const processedLocations = [];

            for (const location of rawLocations) {
                if (!location) continue;

                // Try to detect and format the location
                const formattedLocation = detectAndFormatLocation(location);
                if (formattedLocation) {
                    processedLocations.push(formattedLocation);
                }
            }

            return [...new Set(processedLocations)]; // Remove duplicates
        }

        function detectAndFormatLocation(location) {
            // Remove extra whitespace and normalize
            location = location.trim().replace(/\s+/g, ' ');

            // Common patterns for city, state
            const patterns = [
                // "City, State" format
                /^([^,]+),\s*([A-Z]{2})$/i,
                // "City State" format (no comma)
                /^([^,]+)\s+([A-Z]{2})$/i,
                // "City, State Name" format
                /^([^,]+),\s*([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)$/i,
                // "City State Name" format (no comma)
                /^([^,]+)\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)$/i
            ];

            for (const pattern of patterns) {
                const match = location.match(pattern);
                if (match) {
                    const city = match[1].trim();
                    const state = match[2].trim();

                    // Convert state name to abbreviation if needed
                    const stateAbbr = convertStateNameToAbbr(state);

                    return `${city}, ${stateAbbr}`;
                }
            }

            // If no pattern matches, try to guess
            return guessLocationFormat(location);
        }

        function convertStateNameToAbbr(stateName) {
            const stateMap = {
                'alabama': 'AL', 'alaska': 'AK', 'arizona': 'AZ', 'arkansas': 'AR', 'california': 'CA',
                'colorado': 'CO', 'connecticut': 'CT', 'delaware': 'DE', 'florida': 'FL', 'georgia': 'GA',
                'hawaii': 'HI', 'idaho': 'ID', 'illinois': 'IL', 'indiana': 'IN', 'iowa': 'IA',
                'kansas': 'KS', 'kentucky': 'KY', 'louisiana': 'LA', 'maine': 'ME', 'maryland': 'MD',
                'massachusetts': 'MA', 'michigan': 'MI', 'minnesota': 'MN', 'mississippi': 'MS', 'missouri': 'MO',
                'montana': 'MT', 'nebraska': 'NE', 'nevada': 'NV', 'new hampshire': 'NH', 'new jersey': 'NJ',
                'new mexico': 'NM', 'new york': 'NY', 'north carolina': 'NC', 'north dakota': 'ND', 'ohio': 'OH',
                'oklahoma': 'OK', 'oregon': 'OR', 'pennsylvania': 'PA', 'rhode island': 'RI', 'south carolina': 'SC',
                'south dakota': 'SD', 'tennessee': 'TN', 'texas': 'TX', 'utah': 'UT', 'vermont': 'VT',
                'virginia': 'VA', 'washington': 'WA', 'west virginia': 'WV', 'wisconsin': 'WI', 'wyoming': 'WY'
            };

            const normalizedState = stateName.toLowerCase();
            return stateMap[normalizedState] || stateName.toUpperCase();
        }

        function guessLocationFormat(location) {
            // If it's already in a recognizable format, return as is
            if (/^[^,]+,\s*[A-Z]{2}$/i.test(location)) {
                return location;
            }

            // Try to extract city and state from common patterns
            const words = location.split(' ');

            // If we have at least 2 words, assume last word is state
            if (words.length >= 2) {
                const lastWord = words[words.length - 1];
                const city = words.slice(0, -1).join(' ');

                // Check if last word looks like a state abbreviation
                if (/^[A-Z]{2}$/i.test(lastWord)) {
                    return `${city}, ${lastWord.toUpperCase()}`;
                }

                // Check if last word is a state name
                const stateAbbr = convertStateNameToAbbr(lastWord);
                if (stateAbbr !== lastWord.toUpperCase()) {
                    return `${city}, ${stateAbbr}`;
                }
            }

            // If we can't parse it, return as is
            return location;
        }

        function processBulkLocations() {
            const input = document.getElementById('bulkLocationInput').value;
            const locations = parseBulkLocations(input);

            if (locations.length === 0) {
                alert('Please enter at least one valid location.');
                return;
            }

            // Add all locations to the location list
            const container = document.getElementById('locationList');
            locations.forEach(location => {
                // Check if location already exists
                const existingChips = container.querySelectorAll('.location-chip');
                let exists = false;
                for (let chip of existingChips) {
                    if (chip.textContent.toLowerCase() === location.toLowerCase()) {
                        exists = true;
                        break;
                    }
                }

                if (!exists) {
                    const chip = document.createElement('button');
                    chip.className = 'location-chip';
                    chip.textContent = location;
                    chip.onclick = () => chip.remove();
                    container.appendChild(chip);
                }
            });

            closeBulkLocationModal();

            // Show success message
            const notification = document.createElement('div');
            notification.style.cssText = `
                background: #d4edda;
                color: #155724;
                padding: 10px;
                border-radius: 4px;
                margin-top: 10px;
                font-size: 14px;
                border: 1px solid #c3e6cb;
            `;
            notification.innerHTML = `✅ Added ${locations.length} location(s) successfully!`;
            container.parentNode.appendChild(notification);

            // Remove notification after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        function addPopularCities() {
            const popularCities = [
                'New York, NY',
                'Los Angeles, CA',
                'Chicago, IL',
                'Houston, TX',
                'Phoenix, AZ',
                'Philadelphia, PA',
                'San Antonio, TX',
                'San Diego, CA',
                'Dallas, TX',
                'San Jose, CA',
                'Austin, TX',
                'Jacksonville, FL',
                'Fort Worth, TX',
                'Columbus, OH',
                'Charlotte, NC',
                'San Francisco, CA',
                'Indianapolis, IN',
                'Seattle, WA',
                'Denver, CO',
                'Washington, DC'
            ];

            document.getElementById('bulkLocationInput').value = popularCities.join('\n');
            updateBulkLocationPreview();
        }

        function addCaliforniaCities() {
            const californiaCities = [
                'Los Angeles, CA',
                'San Diego, CA',
                'San Jose, CA',
                'San Francisco, CA',
                'Fresno, CA',
                'Sacramento, CA',
                'Long Beach, CA',
                'Oakland, CA',
                'Bakersfield, CA',
                'Anaheim, CA',
                'Santa Ana, CA',
                'Riverside, CA',
                'Stockton, CA',
                'Irvine, CA',
                'Fremont, CA',
                'Chula Vista, CA',
                'Glendale, CA',
                'Modesto, CA',
                'San Bernardino, CA',
                'Fontana, CA'
            ];

            document.getElementById('bulkLocationInput').value = californiaCities.join('\n');
            updateBulkLocationPreview();
        }

        function addTexasCities() {
            const texasCities = [
                'Houston, TX',
                'San Antonio, TX',
                'Dallas, TX',
                'Austin, TX',
                'Fort Worth, TX',
                'El Paso, TX',
                'Arlington, TX',
                'Corpus Christi, TX',
                'Plano, TX',
                'Laredo, TX',
                'Lubbock, TX',
                'Garland, TX',
                'Irving, TX',
                'Amarillo, TX',
                'Grand Prairie, TX',
                'McKinney, TX',
                'Frisco, TX',
                'McAllen, TX',
                'Waco, TX',
                'Carrollton, TX'
            ];

            document.getElementById('bulkLocationInput').value = texasCities.join('\n');
            updateBulkLocationPreview();
        }

        function addFloridaCities() {
            const floridaCities = [
                'Jacksonville, FL',
                'Miami, FL',
                'Tampa, FL',
                'Orlando, FL',
                'St. Petersburg, FL',
                'Hialeah, FL',
                'Tallahassee, FL',
                'Fort Lauderdale, FL',
                'Port St. Lucie, FL',
                'Cape Coral, FL',
                'Gainesville, FL',
                'Coral Springs, FL',
                'Clearwater, FL',
                'Miami Gardens, FL',
                'Palm Bay, FL',
                'West Palm Beach, FL',
                'Sunrise, FL',
                'Lakeland, FL',
                'Boca Raton, FL',
                'Hollywood, FL'
            ];

            document.getElementById('bulkLocationInput').value = floridaCities.join('\n');
            updateBulkLocationPreview();
        }

        function addNewYorkCities() {
            const newYorkCities = [
                'New York, NY',
                'Buffalo, NY',
                'Rochester, NY',
                'Yonkers, NY',
                'Syracuse, NY',
                'Albany, NY',
                'New Rochelle, NY',
                'Mount Vernon, NY',
                'Schenectady, NY',
                'Utica, NY',
                'White Plains, NY',
                'Hempstead, NY',
                'Troy, NY',
                'Niagara Falls, NY',
                'Binghamton, NY',
                'Freeport, NY',
                'Valley Stream, NY',
                'Long Beach, NY',
                'Ithaca, NY',
                'Saratoga Springs, NY'
            ];

            document.getElementById('bulkLocationInput').value = newYorkCities.join('\n');
            updateBulkLocationPreview();
        }

        function clearBulkInput() {
            document.getElementById('bulkLocationInput').value = '';
            document.getElementById('bulkLocationPreview').style.display = 'none';
        }

        function scrollToBottom() {
            const modal = document.querySelector('#bulkLocationOverlay .login-modal');
            modal.scrollTo({
                top: modal.scrollHeight,
                behavior: 'smooth'
            });
        }

        async function logout() {
            currentUser = null;
            sessionId = null;
            try {
                localStorage.removeItem('outtaWebSessionId');
                localStorage.removeItem('outtaWebCurrentUser');
            } catch {}
            try {
                if (window.SUPABASE && window.SUPABASE.auth) {
                    await window.SUPABASE.auth.signOut();
                }
            } catch (e) {
                console.log('ℹ️ Supabase sign-out error:', e.message);
            }
            showLogin();
        }

        async function testServerConnection() {
            console.log('🧪 Testing server connection...');
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                console.log('✅ Server health check:', data);
                alert('✅ Server is working! Check console for details.');
            } catch (error) {
                console.error('❌ Server connection failed:', error);
                alert('❌ Server connection failed! Check console for details.');
            }
        }

        async function testLoginDirectly() {
            console.log('🔥 Testing login directly...');
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'dantedesignzofficial@gmail.com',
                        password: 'yourpassword123'
                    })
                });

                console.log('📥 Login response status:', response.status);
                const data = await response.json();
                console.log('📥 Login response data:', data);

                if (data.success) {
                    console.log('✅ Direct login successful!');
                    currentUser = data.user;
                    sessionId = data.sessionId;
                    localStorage.setItem('outtaWebSessionId', sessionId);
                    showApp();
                    alert('✅ Direct login successful! You should now see the app.');
                } else {
                    console.log('❌ Direct login failed:', data.message);
                    alert('❌ Direct login failed: ' + data.message);
                }
            } catch (error) {
                console.error('💥 Direct login error:', error);
                alert('💥 Direct login error: ' + error.message);
            }
        }

        function forceLogin() {
            console.log('💜 Force login triggered...');

            const user = HARDCODED_USERS[1]; // Dante's account
            console.log('💜 Using user:', user);

            // Set global variables
            currentUser = user;
            sessionId = 'force-session-' + Date.now();

            // Update global state (most reliable)
            window.LOGIN_STATE.isLoggedIn = true;
            window.LOGIN_STATE.currentUser = user;
            window.LOGIN_STATE.sessionId = sessionId;

            // Try localStorage (optional)
            try {
                localStorage.setItem('outtaWebSessionId', sessionId);
                localStorage.setItem('outtaWebCurrentUser', JSON.stringify(user));
                console.log('💜 Data saved to localStorage');
            } catch (error) {
                console.log('💜 localStorage not available, using global state only');
            }

            // Reset form and show app
            document.getElementById('loginForm').reset();
            showApp();

            console.log('💜 Force login completed successfully');
            alert('💜 Force login successful! Welcome ' + user.name + '!');
        }





        function showRegisterForm() {
            showRegister();
        }

        function showLoginForm() {
            showLogin();
        }

        function clearAuthData() {
            console.log('🧹 Clearing all authentication data...');

            // Clear global variables
            currentUser = null;
            sessionId = null;

            // Clear localStorage
            localStorage.removeItem('outtaWebSessionId');
            localStorage.removeItem('outtaWebCurrentUser');
            localStorage.removeItem('businessFinderCurrentUser'); // Also clear the old key just in case

            // Show login screen
            showLogin();

            console.log('🧹 Authentication data cleared');
            alert('🧹 All authentication data cleared. Please login again.');
        }

        function debugAuthState() {
            console.log('🔍 === AUTH DEBUG STATE ===');
            console.log('🔍 currentUser:', currentUser);
            console.log('🔍 sessionId:', sessionId);
            console.log('🔍 localStorage outtaWebCurrentUser:', localStorage.getItem('outtaWebCurrentUser'));
            console.log('🔍 localStorage outtaWebSessionId:', localStorage.getItem('outtaWebSessionId'));
            console.log('🔍 localStorage businessFinderCurrentUser:', localStorage.getItem('businessFinderCurrentUser'));
            console.log('🔍 HARDCODED_USERS:', HARDCODED_USERS);
            console.log('🔍 Login overlay hidden?', document.getElementById('loginOverlay').classList.contains('hidden'));
            console.log('🔍 Container hidden?', document.querySelector('.container').classList.contains('hidden'));
            console.log('🔍 === END DEBUG ===');

            const debugInfo = {
                currentUser: currentUser,
                sessionId: sessionId,
                localStorage: {
                    outtaWebCurrentUser: localStorage.getItem('outtaWebCurrentUser'),
                    outtaWebSessionId: localStorage.getItem('outtaWebSessionId'),
                    businessFinderCurrentUser: localStorage.getItem('businessFinderCurrentUser')
                },
                hardcodedUsers: HARDCODED_USERS,
                uiState: {
                    loginOverlayHidden: document.getElementById('loginOverlay').classList.contains('hidden'),
                    containerHidden: document.querySelector('.container').classList.contains('hidden')
                }
            };

            alert('🔍 Debug info logged to console. Check browser developer tools.');
            return debugInfo;
        }

        function testLocalStorage() {
            console.log('💾 Testing localStorage functionality...');

            try {
                // Test basic localStorage operations
                const testKey = 'outtaWebTest';
                const testValue = 'test-' + Date.now();

                console.log('💾 Setting test value:', testValue);
                localStorage.setItem(testKey, testValue);

                const retrievedValue = localStorage.getItem(testKey);
                console.log('💾 Retrieved test value:', retrievedValue);

                if (retrievedValue === testValue) {
                    console.log('✅ localStorage is working correctly');
                    localStorage.removeItem(testKey);
                    alert('✅ localStorage is working correctly on this domain!');
                } else {
                    console.log('❌ localStorage value mismatch');
                    alert('❌ localStorage is not working correctly - value mismatch');
                }

                // Test JSON storage
                const testObject = { test: true, timestamp: Date.now() };
                localStorage.setItem(testKey + 'JSON', JSON.stringify(testObject));
                const retrievedObject = JSON.parse(localStorage.getItem(testKey + 'JSON'));

                if (retrievedObject.test === true) {
                    console.log('✅ localStorage JSON storage is working');
                    localStorage.removeItem(testKey + 'JSON');
                } else {
                    console.log('❌ localStorage JSON storage failed');
                    alert('❌ localStorage JSON storage is not working correctly');
                }

            } catch (error) {
                console.error('❌ localStorage test failed:', error);
                alert('❌ localStorage test failed: ' + error.message + '\n\nThis might be due to browser privacy settings or Heroku domain restrictions.');
            }
        }

        function ultraSimpleLogin() {
            console.log('🚀 Ultra simple login triggered...');
            
            // Just set the user directly without any storage
            const user = HARDCODED_USERS[1]; // Dante's account
            
            console.log('🚀 Setting user directly:', user);
            
            // Set global variables
            currentUser = user;
            sessionId = 'ultra-simple-' + Date.now();
            
            // Update global state
            window.LOGIN_STATE.isLoggedIn = true;
            window.LOGIN_STATE.currentUser = user;
            window.LOGIN_STATE.sessionId = sessionId;
            
            // Show app immediately
            showApp();
            
            console.log('🚀 Ultra simple login completed');
            alert('🚀 Ultra simple login successful! Welcome ' + user.name + '!\n\nThis bypassed all storage mechanisms.');
        }

        function autoLoginForHeroku() {
            console.log('🌐 Auto-login for Heroku triggered...');
            
            // Automatically log in as Dante
            const user = HARDCODED_USERS[1]; // Dante's account
            
            console.log('🌐 Auto-setting user:', user);
            
            // Set global variables
            currentUser = user;
            sessionId = 'heroku-auto-' + Date.now();
            
            // Update global state
            window.LOGIN_STATE.isLoggedIn = true;
            window.LOGIN_STATE.currentUser = user;
            window.LOGIN_STATE.sessionId = sessionId;
            
            // Force hide login overlay and show app immediately
            const loginOverlay = document.getElementById('loginOverlay');
            if (loginOverlay) {
                loginOverlay.classList.add('hidden');
                console.log('🌐 Login overlay hidden');
            }
            
            // Show app immediately (no login screen)
            showApp();
            
            console.log('🌐 Auto-login for Heroku completed');
            console.log('🌐 User is now logged in as:', user.name);
            
            // Double-check after a short delay
            setTimeout(() => {
                if (loginOverlay && !loginOverlay.classList.contains('hidden')) {
                    console.log('🌐 Force hiding login overlay again...');
                    loginOverlay.classList.add('hidden');
                }
            }, 100);
        }
    </script>
</body>

</html> 